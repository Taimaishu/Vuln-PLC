#!/bin/bash
# Vuln-PLC Control Script
# Simple command to manage the entire ICS training environment

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if running from project directory
if [ ! -f "docker-compose.yml" ]; then
    echo -e "${RED}Error: Must run from Vuln-PLC directory${NC}"
    exit 1
fi

# Check Docker permissions
if ! docker ps >/dev/null 2>&1; then
    echo -e "${YELLOW}Docker requires sudo. Running with sudo...${NC}"
    exec sudo "$0" "$@"
fi

# Parse command
COMMAND="${1:-start}"

case "$COMMAND" in
    start|up)
        echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
        echo -e "${BLUE}║           Starting Vuln-PLC Training Environment          ║${NC}"
        echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
        echo

        echo -e "${GREEN}[1/3]${NC} Building images..."
        docker-compose build

        echo -e "${GREEN}[2/3]${NC} Starting all services..."
        docker-compose up -d

        echo -e "${GREEN}[3/3]${NC} Waiting for services to initialize..."
        sleep 5

        echo
        echo -e "${GREEN}✅ All services started!${NC}"
        echo
        echo -e "${BLUE}Access Points:${NC}"
        echo "  • PLC1 (Tank):        http://localhost:5000  | Modbus: 5502"
        echo "  • PLC2 (Pressure):    http://localhost:5011  | Modbus: 5503"
        echo "  • PLC3 (Temperature): http://localhost:5012  | Modbus: 5504"
        echo "  • PLC4 (Safety):      http://localhost:5013  | Modbus: 5505"
        echo "  • Historian:          http://localhost:8888"
        echo "  • HMI Server:         http://localhost:8000"
        echo "  • System Monitor:     http://localhost:5999"
        echo
        echo -e "${YELLOW}Default Credentials: admin/admin, operator/operator123, guest/guest${NC}"
        echo
        echo -e "Run '${GREEN}vuln-plc status${NC}' to check services"
        echo -e "Run '${GREEN}vuln-plc stop${NC}' to stop all services"
        ;;

    stop|down)
        echo -e "${YELLOW}Stopping all Vuln-PLC services...${NC}"
        docker-compose down
        echo -e "${GREEN}✅ All services stopped${NC}"
        ;;

    restart)
        echo -e "${YELLOW}Restarting Vuln-PLC...${NC}"
        docker-compose restart
        echo -e "${GREEN}✅ All services restarted${NC}"
        ;;

    status)
        echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
        echo -e "${BLUE}║              Vuln-PLC Service Status                      ║${NC}"
        echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
        echo
        docker-compose ps
        echo
        echo -e "${BLUE}Port Status:${NC}"
        for port in 5000 5011 5012 5013 5502 5503 5504 5505 8000 8888 5999; do
            if nc -z localhost $port 2>/dev/null; then
                echo -e "  Port $port: ${GREEN}✓ Open${NC}"
            else
                echo -e "  Port $port: ${RED}✗ Closed${NC}"
            fi
        done
        ;;

    logs)
        SERVICE="${2:-plc1}"
        echo -e "${BLUE}Showing logs for: ${SERVICE}${NC}"
        echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
        docker-compose logs -f "$SERVICE"
        ;;

    rebuild)
        echo -e "${YELLOW}Rebuilding all images...${NC}"
        docker-compose down
        docker-compose build --no-cache
        docker-compose up -d
        echo -e "${GREEN}✅ Rebuild complete${NC}"
        ;;

    update)
        echo -e "${YELLOW}Pulling latest changes and rebuilding...${NC}"
        git pull origin main
        docker-compose down
        docker-compose build
        docker-compose up -d
        echo -e "${GREEN}✅ Update complete${NC}"
        ;;

    test)
        echo -e "${BLUE}Testing Modbus connectivity...${NC}"
        if [ -f "quick_test.py" ]; then
            python3 quick_test.py 5502
        else
            echo -e "${RED}Test script not found${NC}"
        fi
        ;;

    help|--help|-h)
        echo -e "${BLUE}Vuln-PLC Control Script${NC}"
        echo
        echo "Usage: vuln-plc [command]"
        echo
        echo "Commands:"
        echo "  start, up      Start all services (default)"
        echo "  stop, down     Stop all services"
        echo "  restart        Restart all services"
        echo "  status         Show service status"
        echo "  logs [service] Show logs (default: plc1)"
        echo "  rebuild        Rebuild all images from scratch"
        echo "  update         Pull latest code and rebuild"
        echo "  test           Test Modbus connectivity"
        echo "  help           Show this help message"
        echo
        echo "Examples:"
        echo "  vuln-plc              # Start everything"
        echo "  vuln-plc stop         # Stop everything"
        echo "  vuln-plc status       # Check what's running"
        echo "  vuln-plc logs plc2    # View PLC2 logs"
        ;;

    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        echo "Run 'vuln-plc help' for usage information"
        exit 1
        ;;
esac
