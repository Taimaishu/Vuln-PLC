<!DOCTYPE html>
<html>
<head>
    <title>HMI - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #fff;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        .process-diagram {
            position: relative;
            height: 500px;
            background: #1a1a1a;
            border-radius: 10px;
            border: 2px solid #444;
        }
        .tank {
            position: absolute;
            left: 50%;
            top: 50px;
            transform: translateX(-50%);
            width: 200px;
            height: 300px;
            border: 3px solid #00d4ff;
            border-radius: 10px;
            overflow: hidden;
            background: #0a2a3a;
        }
        .tank-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(180deg, #00d4ff 0%, #0080ff 100%);
            transition: height 0.5s ease;
        }
        .tank-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #fff;
            z-index: 10;
        }
        .tank-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            z-index: 10;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .pump {
            position: absolute;
            left: 20%;
            bottom: 50px;
            width: 80px;
            height: 80px;
            background: #333;
            border: 3px solid #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .pump.on {
            border-color: #00ff00;
            background: #003300;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .valve {
            position: absolute;
            right: 20%;
            bottom: 50px;
            width: 60px;
            height: 60px;
            background: #333;
            border: 3px solid #666;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .valve.open {
            border-color: #00ff00;
            background: #003300;
        }
        .sensor {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #00d4ff;
        }
        .sensor h3 {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        .sensor .value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff00;
        }
        .sensor.warning .value { color: #ffaa00; }
        .sensor.critical .value { color: #ff0000; }
        .controls {
            display: grid;
            gap: 15px;
        }
        .control-btn {
            padding: 15px;
            background: #444;
            border: 2px solid #666;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .control-btn:hover {
            background: #555;
            border-color: #00d4ff;
        }
        .control-btn.active {
            background: #003300;
            border-color: #00ff00;
        }
        .control-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .control-btn.disabled:hover {
            background: #444;
            border-color: #666;
        }
        .status-bar {
            background: #1a1a1a;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #444;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üñ•Ô∏è HMI - Human Machine Interface</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/scada">SCADA</a>
            <a href="/process">Process</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div>
                <div class="card">
                    <h2>Process Visualization</h2>
                    <div class="process-diagram">
                        <div class="tank">
                            <div class="tank-label">TANK-001</div>
                            <div class="tank-value" id="tank-level">50%</div>
                            <div class="tank-fill" id="tank-fill" style="height: 50%;"></div>
                        </div>

                        <div class="pump" id="pump">
                            üíß
                        </div>

                        <div class="valve" id="valve">
                            üîß
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>Live Sensors</h2>
                    <div class="sensor" id="sensor-level">
                        <h3>Tank Level</h3>
                        <div class="value">50.0%</div>
                    </div>
                    <div class="sensor" id="sensor-temp">
                        <h3>Temperature</h3>
                        <div class="value">25.0¬∞C</div>
                    </div>
                    <div class="sensor" id="sensor-pressure">
                        <h3>Pressure</h3>
                        <div class="value">101.3 kPa</div>
                    </div>
                    <div class="sensor" id="sensor-flow">
                        <h3>Flow Rate</h3>
                        <div class="value">15.5 L/min</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>Equipment Control</h2>
                    {% if role == 'guest' %}
                    <div style="background: #444; padding: 15px; border-radius: 5px; margin-bottom: 15px; color: #ffaa00;">
                        <strong>‚ö†Ô∏è Read-Only Mode</strong><br>
                        Guest users can view but not control equipment. Login as operator or admin to control.
                    </div>
                    {% endif %}
                    <div class="controls">
                        <div class="control-btn {% if role == 'guest' %}disabled{% endif %}" id="btn-pump" onclick="{% if role != 'guest' %}togglePump(){% else %}showGuestWarning(){% endif %}">
                            <strong>PUMP</strong><br>
                            <span id="pump-status">ON</span>
                        </div>
                        <div class="control-btn {% if role == 'guest' %}disabled{% endif %}" id="btn-valve" onclick="{% if role != 'guest' %}toggleValve(){% else %}showGuestWarning(){% endif %}">
                            <strong>VALVE</strong><br>
                            <span id="valve-status">CLOSED</span>
                        </div>
                        <div class="control-btn {% if role == 'guest' %}disabled{% endif %}" onclick="{% if role != 'guest' %}resetTank(){% else %}showGuestWarning(){% endif %}">
                            <strong>RESET TANK</strong><br>
                            <span>Set to 50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="led"></div>
            <span>System Online</span>
        </div>
        <div>User: {{ username }} ({{ role }})</div>
        <div id="last-update">Last update: --:--:--</div>
    </div>

    <script>
        let pumpStatus = true;
        let valveStatus = false;
        const userRole = '{{ role }}';

        function showGuestWarning() {
            alert('‚ö†Ô∏è Access Denied\n\nGuest users have read-only access.\nLogin as operator or admin to control equipment.');
        }

        function updateProcess() {
            fetch('/api/process/status')
                .then(r => r.json())
                .then(data => {
                    // Update tank
                    const level = data.tank_level.toFixed(1);
                    document.getElementById('tank-level').textContent = level + '%';
                    document.getElementById('tank-fill').style.height = level + '%';

                    // Update sensors
                    updateSensor('sensor-level', data.tank_level, '%', 90, 10);
                    updateSensor('sensor-temp', data.temperature, '¬∞C', 80, 0);
                    updateSensor('sensor-pressure', data.pressure, ' kPa', 140, 0);
                    updateSensor('sensor-flow', data.flow_rate, ' L/min', 45, 0);

                    // Update equipment
                    pumpStatus = data.pump_status;
                    valveStatus = data.valve_status;

                    document.getElementById('pump').className = pumpStatus ? 'pump on' : 'pump';
                    document.getElementById('valve').className = valveStatus ? 'valve open' : 'valve';
                    document.getElementById('pump-status').textContent = pumpStatus ? 'ON' : 'OFF';
                    document.getElementById('valve-status').textContent = valveStatus ? 'OPEN' : 'CLOSED';

                    if (pumpStatus) {
                        document.getElementById('btn-pump').classList.add('active');
                    } else {
                        document.getElementById('btn-pump').classList.remove('active');
                    }

                    if (valveStatus) {
                        document.getElementById('btn-valve').classList.add('active');
                    } else {
                        document.getElementById('btn-valve').classList.remove('active');
                    }

                    // Update timestamp
                    const now = new Date();
                    document.getElementById('last-update').textContent =
                        'Last update: ' + now.toLocaleTimeString();
                });
        }

        function updateSensor(id, value, unit, criticalHigh, criticalLow) {
            const element = document.getElementById(id);
            const valueEl = element.querySelector('.value');
            valueEl.textContent = value.toFixed(1) + unit;

            // Set warning/critical states
            element.className = 'sensor';
            if (value > criticalHigh) {
                element.classList.add('critical');
            } else if (value < criticalLow && criticalLow > 0) {
                element.classList.add('critical');
            } else if (value > criticalHigh * 0.9) {
                element.classList.add('warning');
            }
        }

        function togglePump() {
            pumpStatus = !pumpStatus;
            controlEquipment('pump', pumpStatus);
        }

        function toggleValve() {
            valveStatus = !valveStatus;
            controlEquipment('valve', valveStatus);
        }

        function resetTank() {
            controlEquipment('reset_tank', true);
        }

        function controlEquipment(action, value) {
            fetch('/api/process/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action, value: value})
            })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(err => {
                        throw new Error(err.error || 'Control failed');
                    });
                }
                return r.json();
            })
            .then(data => {
                updateProcess();
            })
            .catch(err => {
                alert('Control Error: ' + err.message);
                console.error('Control error:', err);
            });
        }

        // Update every 2 seconds
        setInterval(updateProcess, 2000);
        updateProcess();
    </script>
</body>
</html>
