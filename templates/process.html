<!DOCTYPE html>
<html>
<head>
    <title>Process Control - VulnPLC-3000</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .navbar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .navbar a { color: white; text-decoration: none; margin-left: 20px; }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .control-group h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2ecc71;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider-input {
            width: 100%;
            margin: 15px 0;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        .value-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-badge.on {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.off {
            background: #f8d7da;
            color: #721c24;
        }
        /* Security Alert Banner Styles */
        .alert-banner {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            padding: 15px 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .alert-banner.show {
            display: flex;
        }
        .alert-banner.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            animation: pulse 1s infinite;
        }
        .alert-banner.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        .alert-banner.high {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
        }
        .alert-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .alert-icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }
        .alert-message {
            flex: 1;
        }
        .alert-message .alert-type {
            font-weight: bold;
            font-size: 16px;
            display: block;
            margin-bottom: 5px;
        }
        .alert-message .alert-details {
            font-size: 14px;
            opacity: 0.9;
        }
        .alert-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .alert-close:hover {
            background: rgba(255,255,255,0.3);
        }
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .alert-history {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        .alert-history.show {
            display: block;
        }
        .alert-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .export-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }
        .export-btn:hover {
            background: #27ae60;
        }
        .alert-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group-title {
            font-weight: bold;
            font-size: 13px;
            color: #333;
            margin-bottom: 3px;
        }
        .filter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            cursor: pointer;
        }
        .filter-checkbox input[type="checkbox"] {
            cursor: pointer;
        }
        .clear-filters-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
            margin-left: auto;
        }
        .clear-filters-btn:hover {
            background: #7f8c8d;
        }
        .alert-count {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>‚öôÔ∏è Process Control Panel</h1>
        <div>
            <a href="/dashboard">Dashboard</a>
            <a href="/hmi">HMI</a>
            <a href="/scada">SCADA</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <!-- Security Alert Banner -->
    <div id="alertBanner" class="alert-banner">
        <div class="alert-content">
            <span class="alert-icon">üö®</span>
            <div class="alert-message">
                <span class="alert-type" id="alertType">SECURITY ALERT</span>
                <span class="alert-details" id="alertDetails">Unauthorized access detected</span>
            </div>
        </div>
        <button class="alert-close" onclick="dismissAlert()">√ó</button>
    </div>

    <div class="container">
        <!-- Alert History Section -->
        <div id="alertHistory" class="alert-history">
            <div class="alert-history-header">
                <strong>‚ö†Ô∏è Recent Security Events: <span id="alertCount" class="alert-count"></span></strong>
                <button class="export-btn" onclick="exportAlerts()">üì• Export to CSV</button>
            </div>

            <!-- Alert Filters -->
            <div class="alert-filters">
                <div class="filter-group">
                    <div class="filter-group-title">Filter by PLC:</div>
                    <div class="filter-options">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc1" checked onchange="applyFilters()">
                            <span>PLC-1</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc2" checked onchange="applyFilters()">
                            <span>PLC-2</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc3" checked onchange="applyFilters()">
                            <span>PLC-3</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-plc4" checked onchange="applyFilters()">
                            <span>PLC-4</span>
                        </label>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-group-title">Filter by Severity:</div>
                    <div class="filter-options">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-critical" checked onchange="applyFilters()">
                            <span>üö® CRITICAL</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-warning" checked onchange="applyFilters()">
                            <span>‚ö†Ô∏è WARNING</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-high" checked onchange="applyFilters()">
                            <span>‚ö†Ô∏è HIGH</span>
                        </label>
                    </div>
                </div>

                <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            </div>

            <div id="alertHistoryContent"></div>
        </div>
        <div class="card">
            <h2>Equipment Control</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <h3>Pump Control</h3>
                    <div class="switch-container">
                        <span>Pump Status:</span>
                        <label class="switch">
                            <input type="checkbox" id="pump-switch" checked onchange="togglePump()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <span class="status-badge on" id="pump-badge">RUNNING</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Valve Control</h3>
                    <div class="switch-container">
                        <span>Valve Position:</span>
                        <label class="switch">
                            <input type="checkbox" id="valve-switch" onchange="toggleValve()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <span class="status-badge off" id="valve-badge">CLOSED</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Motor Speed Control</h3>
                    <div class="slider-input">
                        <input type="range" id="motor-slider" min="0" max="3000" value="1500" oninput="updateMotorSpeed()">
                    </div>
                    <div class="value-display" id="motor-value">1500 RPM</div>
                    <button class="btn" onclick="setMotorSpeed()">Apply Speed</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Process Operations</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <h3>Tank Operations</h3>
                    <button class="btn" onclick="resetTank()">Reset Tank Level (50%)</button>
                    <button class="btn danger" onclick="drainTank()">Emergency Drain</button>
                </div>

                <div class="control-group">
                    <h3>System Operations</h3>
                    <button class="btn" onclick="startProcess()">Start Process</button>
                    <button class="btn danger" onclick="stopProcess()">Emergency Stop</button>
                </div>

                <div class="control-group">
                    <h3>Current Status</h3>
                    <div style="padding: 10px; background: #e8f4f8; border-radius: 5px;">
                        <p><strong>Tank Level:</strong> <span id="status-level">--</span>%</p>
                        <p><strong>Temperature:</strong> <span id="status-temp">--</span>¬∞C</p>
                        <p><strong>Pressure:</strong> <span id="status-pressure">--</span> kPa</p>
                        <p><strong>Flow Rate:</strong> <span id="status-flow">--</span> L/min</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function togglePump() {
            const checked = document.getElementById('pump-switch').checked;
            control('pump', checked);
            updateBadge('pump-badge', checked, 'RUNNING', 'STOPPED');
        }

        function toggleValve() {
            const checked = document.getElementById('valve-switch').checked;
            control('valve', checked);
            updateBadge('valve-badge', checked, 'OPEN', 'CLOSED');
        }

        function updateMotorSpeed() {
            const value = document.getElementById('motor-slider').value;
            document.getElementById('motor-value').textContent = value + ' RPM';
        }

        function setMotorSpeed() {
            const value = document.getElementById('motor-slider').value;
            control('motor_speed', value);
        }

        function resetTank() {
            control('reset_tank', true);
        }

        function drainTank() {
            if (confirm('WARNING: This will drain the tank to 10%. Continue?')) {
                // Simulate by setting very low level
                alert('Emergency drain initiated');
            }
        }

        function startProcess() {
            control('pump', true);
            control('valve', true);
            document.getElementById('pump-switch').checked = true;
            document.getElementById('valve-switch').checked = true;
            updateBadge('pump-badge', true, 'RUNNING', 'STOPPED');
            updateBadge('valve-badge', true, 'OPEN', 'CLOSED');
        }

        function stopProcess() {
            if (confirm('WARNING: This will stop all equipment. Continue?')) {
                control('pump', false);
                control('valve', false);
                document.getElementById('pump-switch').checked = false;
                document.getElementById('valve-switch').checked = false;
                updateBadge('pump-badge', false, 'RUNNING', 'STOPPED');
                updateBadge('valve-badge', false, 'OPEN', 'CLOSED');
            }
        }

        function control(action, value) {
            fetch('/api/process/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action, value: value})
            })
            .then(r => r.json())
            .then(data => {
                updateStatus();
            });
        }

        function updateBadge(id, isOn, onText, offText) {
            const badge = document.getElementById(id);
            badge.textContent = isOn ? onText : offText;
            badge.className = 'status-badge ' + (isOn ? 'on' : 'off');
        }

        function updateStatus() {
            fetch('/api/process/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('status-level').textContent = data.tank_level.toFixed(1);
                    document.getElementById('status-temp').textContent = data.temperature.toFixed(1);
                    document.getElementById('status-pressure').textContent = data.pressure.toFixed(1);
                    document.getElementById('status-flow').textContent = data.flow_rate.toFixed(1);
                });
        }

        // Update status every 3 seconds
        setInterval(updateStatus, 3000);
        updateStatus();

        // Security Alert System
        let currentAlert = null;
        let alertShown = false;
        let alertHistory = [];

        function checkSecurityAlerts() {
            fetch('/api/security/alerts')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.alerts && data.alerts.length > 0) {
                        const latest = data.alerts[data.alerts.length - 1];

                        // Show banner if new alert
                        if (!currentAlert || currentAlert.timestamp !== latest.timestamp) {
                            currentAlert = latest;
                            showAlert(latest);
                        }

                        // Update alert history
                        alertHistory = data.alerts;
                        updateAlertHistory();
                    }
                })
                .catch(err => console.error('Error checking alerts:', err));
        }

        function showAlert(alert) {
            const banner = document.getElementById('alertBanner');
            const alertType = document.getElementById('alertType');
            const alertDetails = document.getElementById('alertDetails');
            const alertIcon = document.querySelector('.alert-icon');

            // Set alert content
            alertType.textContent = alert.type.replace(/_/g, ' ');
            alertDetails.textContent = `[${alert.timestamp}] ${alert.message}`;

            // Set severity class and icon
            banner.className = 'alert-banner show ' + alert.severity.toLowerCase();

            if (alert.severity === 'CRITICAL') {
                alertIcon.textContent = 'üö®';
            } else if (alert.severity === 'HIGH') {
                alertIcon.textContent = '‚ö†Ô∏è';
            } else {
                alertIcon.textContent = '‚ö†Ô∏è';
            }

            // Play alert sound (optional - commented out to avoid annoyance)
            // if (alert.severity === 'CRITICAL') {
            //     playAlertSound();
            // }

            alertShown = true;
        }

        function dismissAlert() {
            const banner = document.getElementById('alertBanner');
            banner.classList.remove('show');
            alertShown = false;
        }

        function getFilteredAlerts() {
            // Get filter states
            const plcFilters = {
                'PLC-1': document.getElementById('filter-plc1').checked,
                'PLC-2': document.getElementById('filter-plc2').checked,
                'PLC-3': document.getElementById('filter-plc3').checked,
                'PLC-4': document.getElementById('filter-plc4').checked
            };

            const severityFilters = {
                'CRITICAL': document.getElementById('filter-critical').checked,
                'WARNING': document.getElementById('filter-warning').checked,
                'HIGH': document.getElementById('filter-high').checked
            };

            // Filter alerts
            return alertHistory.filter(alert => {
                const plc = alert.plc || 'PLC-1'; // Default to PLC-1 for old alerts
                const severity = alert.severity || 'WARNING';

                return plcFilters[plc] && severityFilters[severity];
            });
        }

        function applyFilters() {
            updateAlertHistory();
        }

        function clearFilters() {
            // Check all filters
            document.getElementById('filter-plc1').checked = true;
            document.getElementById('filter-plc2').checked = true;
            document.getElementById('filter-plc3').checked = true;
            document.getElementById('filter-plc4').checked = true;
            document.getElementById('filter-critical').checked = true;
            document.getElementById('filter-warning').checked = true;
            document.getElementById('filter-high').checked = true;

            applyFilters();
        }

        function updateAlertHistory() {
            if (alertHistory.length === 0) {
                document.getElementById('alertHistory').classList.remove('show');
                return;
            }

            document.getElementById('alertHistory').classList.add('show');

            // Get filtered alerts
            const filtered = getFilteredAlerts();
            const recentAlerts = filtered.slice(-10).reverse(); // Last 10 filtered alerts

            // Update alert count
            const countElement = document.getElementById('alertCount');
            if (filtered.length < alertHistory.length) {
                countElement.textContent = `(Showing ${filtered.length} of ${alertHistory.length})`;
            } else {
                countElement.textContent = `(${alertHistory.length} total)`;
            }

            const content = document.getElementById('alertHistoryContent');

            if (recentAlerts.length === 0) {
                content.innerHTML = '<div style="padding: 10px; text-align: center; color: #7f8c8d;">No alerts match current filters</div>';
                return;
            }

            content.innerHTML = recentAlerts.map(alert => {
                const severityColor = {
                    'CRITICAL': '#e74c3c',
                    'HIGH': '#e67e22',
                    'WARNING': '#f39c12'
                }[alert.severity] || '#95a5a6';

                const plc = alert.plc || 'PLC-1';

                return `
                    <div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0;">
                        <span style="color: ${severityColor}; font-weight: bold;">[${alert.timestamp}]</span>
                        <span style="background: #e8f4f8; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 5px;">${plc}</span>
                        <span style="color: ${severityColor};">${alert.type}:</span>
                        ${alert.message}
                    </div>
                `;
            }).join('');
        }

        function exportAlerts() {
            // Get filtered alerts
            const filtered = getFilteredAlerts();

            if (filtered.length === 0) {
                alert('No alerts to export with current filters');
                return;
            }

            // Create CSV content
            const headers = ['Timestamp', 'PLC', 'Severity', 'Type', 'Message', 'Source IP', 'Function Code', 'Address'];
            const rows = filtered.map(alert => [
                alert.timestamp || '',
                alert.plc || 'PLC-1',
                alert.severity || '',
                alert.type || '',
                alert.message || '',
                alert.source_ip || '',
                `0x${(alert.function_code || 0).toString(16).padStart(2, '0')}`,
                alert.address || ''
            ]);

            // Build CSV
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => {
                    // Escape fields with commas or quotes
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_alerts_filtered_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Check for alerts every 2 seconds
        setInterval(checkSecurityAlerts, 2000);
        checkSecurityAlerts();

        console.log('üõ°Ô∏è Security Alert System active - watching for attacks...');
    </script>
</body>
</html>
